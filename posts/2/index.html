<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>王若风的技术博客</title>
  <meta name="author" content="王若风">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://wangruofeng.github.io/posts/2/">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="王若风的技术博客" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://wangruofeng.github.io/posts/2/">
  <meta property="og:title" content="王若风的技术博客">
  <meta property="og:description" content="王若风的技术博客">

  <script src="/javascripts/libs/jquery/jquery-2.1.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">


  
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-72379345-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">王若风的技术博客</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="sitesearch" value="wangruofeng.github.io">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9">
    <div class="blog-index" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="王若风的技术博客" />
    <meta itemprop="description" content="王若风的技术博客" />
    <meta itemprop="url" content="http://wangruofeng.github.io" />
      
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-13T23:18:15+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/13/sqlite-jiao-cheng-%5B%3F%5D/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/13/sqlite-jiao-cheng-%5B%3F%5D/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/13/sqlite-jiao-cheng-%5B%3F%5D/" itemprop="url">SQLite_教程(一)</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h4>简介：</h4>

<p>SQLite 是一个软件库，实现了自给自足的、无服务器的、零配置的、事务性的 SQL 数据库引擎。SQLite 是在世界上最广泛部署的 SQL 数据库引擎。SQLite 源代码不受版权限制。
本教程将告诉您如何使用 SQLite 编程，并让你迅速上手。</p>

<h4>什么是 SQLite？</h4>

<p>SQLite是一个进程内的库，实现了自给自足的、无服务器的、零配置的、事务性的 SQL 数据库引擎。它是一个零配置的数据库，这意味着与其他数据库一样，您不需要在系统中配置。
就像其他数据库，SQLite 引擎不是一个独立的进程，可以按应用程序需求进行静态或动态连接。SQLite 直接访问其存储文件</p>

<h4>为什么要用 SQLite？</h4>

<ul>
<li>不需要一个单独的服务器进程或操作的系统（无服务器的）。</li>
<li>SQLite 不需要配置，这意味着不需要安装或管理。</li>
<li>一个完整的 SQLite 数据库是存储在一个单一的跨平台的磁盘文件。</li>
<li>SQLite 是非常小的，是轻量级的，完全配置时小于 400KiB，省略可选功能配置时小于250KiB。</li>
<li>SQLite 是自给自足的，这意味着不需要任何外部的依赖。</li>
<li>SQLite 事务是完全兼容 ACID 的，允许从多个进程或线程安全访问。</li>
<li>SQLite 支持 SQL92（SQL2）标准的大多数查询语言的功能。</li>
<li>SQLite 使用 ANSI-C 编写的，并提供了简单和易于使用的 API。</li>
<li>SQLite 可在 UNIX（Linux, Mac OS-X, Android, iOS）和 Windows（Win32, WinCE, WinRT）中运行。</li>
</ul>


<h4>SQLite 命令</h4>

<p>与关系数据库进行交互的标准 SQLite 命令类似于 SQL。命令包括 CREATE、SELECT、INSERT、UPDATE、DELETE 和 DROP。这些命令基于它们的操作性质可分为以下几种：</p>

<h4>DDL - 数据定义语言</h4>

<table>
<thead>
<tr>
<th> 命令   </th>
<th> 描述 </th>
</tr>
</thead>
<tbody>
<tr>
<td>CREATE </td>
<td>创建一个新的表，一个表的视图，或者数据库中的其他对象。</td>
</tr>
<tr>
<td>ALTER  </td>
<td>修改数据库中的某个已有的数据库对象，比如一个表。     </td>
</tr>
<tr>
<td>DROP   </td>
<td>删除整个表，或者表的视图，或者数据库中的其他对象。   </td>
</tr>
</tbody>
</table>


<h4>DML - 数据操作语言</h4>

<table>
<thead>
<tr>
<th> 命令   </th>
<th> 描述 </th>
</tr>
</thead>
<tbody>
<tr>
<td>INSERT </td>
<td>创建一条记录。</td>
</tr>
<tr>
<td>UPDATE </td>
<td>修改记录。      </td>
</tr>
<tr>
<td>DELETE </td>
<td>删除记录。      </td>
</tr>
</tbody>
</table>


<h4>DQL - 数据查询语言</h4>

<table>
<thead>
<tr>
<th> 命令   </th>
<th> 描述 </th>
</tr>
</thead>
<tbody>
<tr>
<td>SELECT </td>
<td>   从一个或多个表中检索某些记录。</td>
</tr>
</tbody>
</table>


<h4>在 Mac OS X 上安装 SQLite</h4>

<p>最新版本的 Mac OS X 会预安装 SQLite，但是如果没有可用的安装，只需按照如下步骤进行：
请访问 <a href="http://www.sqlite.org/download.html">SQLite 下载页面</a>，从源代码区下载 sqlite-autoconf-*.tar.gz。
步骤如下：</p>

<pre><code>$tar xvfz sqlite-autoconf-3071502.tar.gz
$cd sqlite-autoconf-3071502
$./configure --prefix=/usr/local
$make
$make install
</code></pre>

<p>上述步骤将在 Mac OS X 机器上安装 SQLite，您可以使用下列命令进行验证：</p>

<pre><code>$sqlite3
SQLite version 3.7.15.2 2013-01-09 11:53:05
Enter ".help" for instructions
Enter SQL statements terminated with a ";"
sqlite&gt;
</code></pre>

<p>最后，在 SQLite 命令提示符下，使用 SQLite 命令做练习。</p>

<h4>SQLite语法</h4>

<p><strong>大小写敏感性</strong></p>

<p>有个重要的点值得注意，SQLite 是不区分大小写的，但也有一些命令是大小写敏感的，比如 GLOB 和 glob 在 SQLite 的语句中有不同的含义。</p>

<p><strong>注释</strong></p>

<p>SQLite 注释是附加的注释，可以在 SQLite 代码中添加注释以增加其可读性，他们可以出现在任何空白处，包括在表达式内和其他 SQL 语句的中间，但它们不能嵌套。
SQL 注释以两个连续的 &ldquo;-&rdquo; 字符（ASCII 0x2d）开始，并扩展至下一个换行符（ASCII 0x0a）或直到输入结束，以先到者为准。
您也可以使用 C 风格的注释，以 &ldquo;/*&rdquo; 开始，并扩展至下一个 &ldquo;*/&rdquo; 字符对或直到输入结束，以先到者为准。SQLite的注释可以跨越多行。</p>

<h4>SQLite 语句</h4>

<p>所有的 SQLite 语句可以以任何关键字开始，如 SELECT、INSERT、UPDATE、DELETE、ALTER、DROP 等，所有的语句以分号（;）结束。</p>

<p>SQLite ANALYZE 语句：</p>

<pre><code>ANALYZE;
or
ANALYZE database_name;
or
ANALYZE database_name.table_name;
</code></pre>

<p>SQLite AND/OR 子句：</p>

<pre><code>SELECT column1, column2....columnN
FROM   table_name
WHERE  CONDITION-1 {AND|OR} CONDITION-2;
</code></pre>

<p>SQLite ALTER TABLE 语句：</p>

<pre><code>ALTER TABLE table_name ADD COLUMN column_def...;
SQLite ALTER TABLE 语句（Rename）：
ALTER TABLE table_name RENAME TO new_table_name;
</code></pre>

<p>SQLite ATTACH DATABASE 语句：</p>

<pre><code>ATTACH DATABASE 'DatabaseName' As 'Alias-Name';
SQLite BEGIN TRANSACTION 语句：
BEGIN;
or
BEGIN EXCLUSIVE TRANSACTION;
</code></pre>

<p>SQLite BETWEEN 子句：</p>

<pre><code>SELECT column1, column2....columnN
FROM   table_name
WHERE  column_name BETWEEN val-1 AND val-2;
</code></pre>

<p>SQLite COMMIT 语句：</p>

<pre><code>COMMIT;
</code></pre>

<p>SQLite CREATE INDEX 语句：</p>

<pre><code>CREATE INDEX index_name
ON table_name ( column_name COLLATE NOCASE );
</code></pre>

<p>SQLite CREATE UNIQUE INDEX 语句：</p>

<pre><code>CREATE UNIQUE INDEX index_name
ON table_name ( column1, column2,...columnN);
</code></pre>

<p>SQLite CREATE TABLE 语句：</p>

<pre><code>CREATE TABLE table_name(
   column1 datatype,
   column2 datatype,
   column3 datatype,
   .....
   columnN datatype,
   PRIMARY KEY( one or more columns )
);
</code></pre>

<p>SQLite CREATE TRIGGER 语句：</p>

<pre><code>CREATE TRIGGER database_name.trigger_name
BEFORE INSERT ON table_name FOR EACH ROW
BEGIN
   stmt1;
   stmt2;
   ....
END;
</code></pre>

<p>SQLite CREATE VIEW 语句：</p>

<pre><code>CREATE VIEW database_name.view_name  AS
SELECT statement....;
</code></pre>

<p>SQLite CREATE VIRTUAL TABLE 语句：</p>

<pre><code>CREATE VIRTUAL TABLE database_name.table_name USING weblog( access.log );
or
CREATE VIRTUAL TABLE database_name.table_name USING fts3( );
</code></pre>

<p>SQLite COMMIT TRANSACTION 语句：</p>

<pre><code>COMMIT;
SQLite COUNT 子句：
SELECT COUNT(column_name)
FROM   table_name
WHERE  CONDITION;
</code></pre>

<p>SQLite DELETE 语句：</p>

<pre><code>DELETE FROM table_name
WHERE  {CONDITION};
</code></pre>

<p>SQLite DETACH DATABASE 语句：</p>

<pre><code>DETACH DATABASE 'Alias-Name';
</code></pre>

<p>SQLite DISTINCT 子句：</p>

<pre><code>SELECT DISTINCT column1, column2....columnN
FROM   table_name;
</code></pre>

<p>SQLite DROP INDEX 语句：</p>

<pre><code>DROP INDEX database_name.index_name;
</code></pre>

<p>SQLite DROP TABLE 语句：</p>

<pre><code>DROP TABLE database_name.table_name;
</code></pre>

<p>SQLite DROP VIEW 语句：</p>

<pre><code>DROP INDEX database_name.view_name;
</code></pre>

<p>SQLite DROP TRIGGER 语句：</p>

<pre><code>DROP INDEX database_name.trigger_name;
</code></pre>

<p>SQLite EXISTS 子句：</p>

<pre><code>SELECT column1, column2....columnN
FROM   table_name
WHERE  column_name EXISTS (SELECT * FROM   table_name );
</code></pre>

<p>SQLite EXPLAIN 语句：</p>

<pre><code>EXPLAIN INSERT statement...;
or
EXPLAIN QUERY PLAN SELECT statement...;
</code></pre>

<p>SQLite GLOB 子句：</p>

<pre><code>SELECT column1, column2....columnN
FROM   table_name
WHERE  column_name GLOB { PATTERN };
</code></pre>

<p>SQLite GROUP BY 子句：</p>

<pre><code>SELECT SUM(column_name)
FROM   table_name
WHERE  CONDITION
GROUP BY column_name;
</code></pre>

<p>SQLite HAVING 子句：</p>

<pre><code>SELECT SUM(column_name)
FROM   table_name
WHERE  CONDITION
GROUP BY column_name
HAVING (arithematic function condition);
</code></pre>

<p>SQLite INSERT INTO 语句：</p>

<pre><code>INSERT INTO table_name( column1, column2....columnN)
VALUES ( value1, value2....valueN);
</code></pre>

<p>SQLite IN 子句：</p>

<pre><code>SELECT column1, column2....columnN
FROM   table_name
WHERE  column_name IN (val-1, val-2,...val-N);
</code></pre>

<p>SQLite Like 子句：</p>

<pre><code>SELECT column1, column2....columnN
FROM   table_name
WHERE  column_name LIKE { PATTERN };
</code></pre>

<p>SQLite NOT IN 子句：</p>

<pre><code>SELECT column1, column2....columnN
FROM   table_name
WHERE  column_name NOT IN (val-1, val-2,...val-N);
</code></pre>

<p>SQLite ORDER BY 子句：</p>

<pre><code>SELECT column1, column2....columnN
FROM   table_name
WHERE  CONDITION
ORDER BY column_name {ASC|DESC};
</code></pre>

<p>SQLite PRAGMA 语句：</p>

<pre><code>PRAGMA pragma_name;

For example:

PRAGMA page_size;
PRAGMA cache_size = 1024;
PRAGMA table_info(table_name);
</code></pre>

<p>SQLite RELEASE SAVEPOINT 语句：</p>

<pre><code>RELEASE savepoint_name;
</code></pre>

<p>SQLite REINDEX 语句：</p>

<pre><code>REINDEX collation_name;
REINDEX database_name.index_name;
REINDEX database_name.table_name;
</code></pre>

<p>SQLite ROLLBACK 语句：</p>

<pre><code>ROLLBACK;
or
ROLLBACK TO SAVEPOINT savepoint_name;
</code></pre>

<p>SQLite SAVEPOINT 语句：</p>

<pre><code>SAVEPOINT savepoint_name;
SQLite SELECT 语句：
SELECT column1, column2....columnN
FROM   table_name;
</code></pre>

<p>SQLite UPDATE 语句：</p>

<pre><code>UPDATE table_name
SET column1 = value1, column2 = value2....columnN=valueN
[ WHERE  CONDITION ];
</code></pre>

<p>SQLite VACUUM 语句：</p>

<pre><code>VACUUM;
</code></pre>

<p>SQLite WHERE 子句：</p>

<pre><code>SELECT column1, column2....columnN
FROM   table_name
WHERE  CONDITION;
</code></pre>

<p>资料整理于：<a href="http://www.runoob.com/sqlite/sqlite-tutorial.html">RUNOOB.COM-SQLite教程</a>
转载请注明出处。</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-13T05:51:18+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/13/cocoapodsshi-yong-zhi-nan/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/13/cocoapodsshi-yong-zhi-nan/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/13/cocoapodsshi-yong-zhi-nan/" itemprop="url">CocoaPods使用指南</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>CocoaPods是iOS最常用的第三方类库管理工具，绝大部分有名的开源类库
支持CocoaPods.
CocoaPods是用Ruby实现的，要使用它首先需要有Ruby的环境。幸亏是
OS X系统默认已经可以运行Ruby了，我么只需执行以下命令：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">sudo</span> <span class="n">gem</span> <span class="n">install</span> <span class="n">cocoapods</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于某些原因，执行时会出现下面的错误提示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="nl">ERROR</span> <span class="p">:</span><span class="n">Could</span> <span class="n">not</span> <span class="n">find</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">gem</span> <span class="err">`</span><span class="n">cocoapods</span><span class="err">`</span> <span class="p">(</span><span class="o">&gt;=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">here</span> <span class="n">is</span> <span class="nl">why</span><span class="p">:</span>
</span><span class='line'>        <span class="n">Unable</span> <span class="n">to</span> <span class="n">download</span> <span class="n">data</span> <span class="n">from</span> <span class="nl">https</span><span class="p">:</span><span class="c1">//rubygems.org/ - Errno::EPIPI:</span>
</span><span class='line'>        <span class="n">Broken</span> <span class="n">pipe</span> <span class="o">-</span> <span class="n">SSL_connect</span>
</span><span class='line'><span class="p">(</span><span class="nl">https</span><span class="p">:</span><span class="c1">//rubygems.org/lastest_specs.4.8.gz)</span>
</span></code></pre></td></tr></table></div></figure>


<p>安装成功后，接着执行命令：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">pod</span> <span class="n">setup</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果Ruby环境不够新，可能需要更新以下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">sudo</span> <span class="n">gem</span> <span class="n">update</span> <span class="o">--</span><span class="n">system</span>
</span></code></pre></td></tr></table></div></figure>


<p>至此安装就完成了，我们可以尝试搜索一个第三方类库：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">pod</span> <span class="n">search</span> <span class="n">AFNetworking</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用CocoaPods第一步，是在当前项目下，新疆一个Podfile文件：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">touch</span> <span class="n">Podfile</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后利用vim打开Podfile文件编辑，加入你想要的类库，格式如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="nl">platform</span> <span class="p">:</span><span class="n">ios</span>
</span><span class='line'><span class="n">pod</span>  <span class="err">&#39;</span><span class="n">Reachability</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="mf">3.1.0</span><span class="err">&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">platform</span> <span class="p">:</span><span class="n">ios</span><span class="p">,</span> <span class="err">&#39;</span><span class="mf">6.0</span><span class="err">&#39;</span>
</span><span class='line'><span class="n">pod</span> <span class="err">&#39;</span><span class="n">JSONKit</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="mf">1.4</span><span class="err">&#39;</span>
</span><span class='line'><span class="n">pod</span> <span class="err">&#39;</span><span class="n">AFNetworking</span><span class="err">&#39;</span><span class="p">,</span> <span class="err">&#39;</span><span class="o">~&gt;</span> <span class="mf">2.3</span><span class="p">,</span><span class="mi">1</span><span class="err">&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果是拷贝别人的项目，或是一个很久没打开过的项目，可能需要先执行一下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">pod</span> <span class="n">update</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后一步，执行命令：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">pod</span> <span class="n">install</span>
</span></code></pre></td></tr></table></div></figure>


<p>当终端出现类似下面的提示后，就代表成功了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">[</span><span class="o">!</span><span class="p">]</span> <span class="n">From</span> <span class="n">now</span> <span class="n">no</span> <span class="n">use</span> <span class="err">`</span><span class="n">Sample0814</span><span class="p">.</span><span class="n">xcworkspace</span><span class="err">`</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个时候会看到项目文件夹多了一个xxx.xcworkspace,以后要通过这个文件
打开项目，老项目xxx.xcodeproj不再使用。</p>

<blockquote><ol>
<li>上面的每一步都可能出现问题，但大部分问题都是因为局域网的原因，用一个网速稳
定的境外VPN可破</li>
<li>如果上面因为权限问题安装失败，必须每次都要删除</li>
</ol>
</blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">User</span><span class="o">/</span><span class="n">loginname</span><span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Caches</span><span class="o">/</span><span class="n">CocoaPods</span><span class="o">/</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为这个缓冲中会存下你的github的东西，造成每次调用上次权限问题的缓存。</p>

<blockquote><ol>
<li>关于Podfile文件编辑时，第三方版本号的各种写法:</li>
</ol>
</blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">pod</span> <span class="err">‘</span><span class="n">AFNetworking</span><span class="err">’</span>      <span class="c1">//不显式指定依赖库版本，表示每次都获取最新版本</span>
</span><span class='line'><span class="n">pod</span> <span class="err">‘</span><span class="n">AFNetworking</span><span class="err">’</span><span class="p">,</span>  <span class="err">‘</span><span class="mf">2.0</span><span class="err">’</span>     <span class="c1">//只使用2.0版本</span>
</span><span class='line'><span class="n">pod</span> <span class="err">‘</span><span class="n">AFNetworking</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="o">&gt;</span><span class="mf">2.0</span><span class="err">′</span>     <span class="c1">//使用高于2.0的版本</span>
</span><span class='line'><span class="n">pod</span> <span class="err">‘</span><span class="n">AFNetworking</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="o">&gt;=</span><span class="mf">2.0</span><span class="err">′</span>     <span class="c1">//使用大于或等于2.0的版本</span>
</span><span class='line'><span class="n">pod</span> <span class="err">‘</span><span class="n">AFNetworking</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="o">&lt;</span><span class="mf">2.0</span><span class="err">′</span>     <span class="c1">//使用小于2.0的版本</span>
</span><span class='line'><span class="n">pod</span> <span class="err">‘</span><span class="n">AFNetworking</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="o">&lt;=</span><span class="mf">2.0</span><span class="err">′</span>     <span class="c1">//使用小于或等于2.0的版本</span>
</span><span class='line'><span class="n">pod</span> <span class="err">‘</span><span class="n">AFNetworking</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="o">~&gt;</span><span class="mf">0.1.2</span><span class="err">′</span>     <span class="c1">//使用大于等于0.1.2但小于0.2的版本，相当于&gt;=0.1.2并且&lt;0.2.0</span>
</span><span class='line'><span class="n">pod</span> <span class="err">‘</span><span class="n">AFNetworking</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="o">~&gt;</span><span class="mf">0.1</span><span class="err">′</span>     <span class="c1">//使用大于等于0.1但小于1.0的版本</span>
</span><span class='line'><span class="n">pod</span> <span class="err">‘</span><span class="n">AFNetworking</span><span class="err">’</span><span class="p">,</span> <span class="err">‘</span><span class="o">~&gt;</span><span class="mi">0</span><span class="err">′</span>     <span class="c1">//高于0的版本，写这个限制和什么都不写是一个效果，都表示使用最新版本</span>
</span></code></pre></td></tr></table></div></figure>


<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com">http://blog.wangruofeng007.com</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-13T05:48:10+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/13/get-and-post/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/13/get-and-post/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/13/get-and-post/" itemprop="url">GET&amp;POST</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><blockquote><p>GET和POST是两种最常用的与服务器进行交互的HTTP方法 .</p></blockquote>

<h3>GET</h3>

<ul>
<li>GET的语义是获取指定的URL资源, 将数据按照 variable = value 的形式, 添加到action所指向的URL后面, 并且两者使用 &lsquo; ? '连接, 各变量之间使用 &rsquo; &amp; &lsquo;连接 .</li>
<li>对用户来说不安全, 因为在传输过程中, 数据被放在请求的URL中.</li>
<li>传输的数据量小, 这主要是因为受URL长度限制.</li>
</ul>


<h3>URL长度限制</h3>

<p> 在http协议中，其实并没有对url长度作出限制，往往url的最大长度和用户浏览器和Web服务器有关，不一样的浏览器，能接受的最大长度往往是不一样的，当然，不一样的Web服务器能够处理的最大长度的URL的能力也是不一样的。</p>

<pre><code>IE浏览器对URL的最大限制为2083个字符，如果超过这个数字，提交按钮没有任何反应。

Firefox浏览器URL的长度限制为65,536个字符 ;

Apache(Server)能够接受的最大URL长度为8192个字符 ;

如果浏览器的编码为UTF8的话，一个汉字最终编码后的字符长度为9个字符。
</code></pre>

<p>GET请求示例</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0602/164040_3SOT_1774273.png" alt="GetRequest" /></p>

<h3>POST</h3>

<ul>
<li>POST语义是向指定URL的资源添加数据.</li>
<li>将数据放在数据体中, 按照变量和值相对应的方式, 传递到action所指向的URL.</li>
<li>所有数据对用户来说不可见.</li>
<li>可以传输大量数据, 上传文件只能使用POST.</li>
</ul>


<p>POST请求示例</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0602/164119_VRKY_1774273.png" alt="PostRequest" /></p>

<h3>在浏览器中判断GET&amp;POST请求</h3>

<p>因为POST请求会向服务器发送数据体, 因此刷新页面时会出现提示窗口. 而GET请求不会向服务器发送数据体, 因此没有提示 .</p>

<p>从请求本质来看, GET请求要比POST更安全, 效率也会更高 .(对服务器而言)</p>

<h3>iOS网络发送网络请求的步骤</h3>

<ol>
<li><p>实例化URL( 网络资源 ) ;</p></li>
<li><p>根据URL建立URLRequest ( 网络请求 ) ;</p>

<p> 默认为GET请求; 对于POST请求,  需要创建请求的数据体 .</p></li>
<li><p>利用 URLConnection 发送网络请求(发送请求并获得结果) ;</p></li>
</ol>


<p>NSURLConnection提供了两个静态方法可以直接以同步或异步的方式向服务器发送网络请求.</p>

<pre><code>同步请求:

sendSynchronousRequest : returningResponse : error :

异步请求:

sendAsynchronousRequest : queue : completionHandler :
</code></pre>

<p>在网络请求过程中, 接收数据的过程实际上是通过 NSURLConnectionDataDelegate来实现的, 常用代理方法包括:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// 服务器开始返回数据</span>
</span><span class='line'><span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connection:didReceiveResponse:</span>
</span><span class='line'><span class="c1">// 收到服务器返回的数据，本方法会被调用多次</span>
</span><span class='line'><span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connection:didReceiveData:</span>
</span><span class='line'><span class="c1">// 数据接收完毕，做数据的最后处理</span>
</span><span class='line'><span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connectionDidFinishLoading:</span>
</span><span class='line'><span class="c1">// 网络连接错误</span>
</span><span class='line'><span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">connection:didFailWithError:</span>
</span></code></pre></td></tr></table></div></figure>


<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com">http://blog.wangruofeng007.com</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-13T05:45:41+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/13/http-post-and-multipart-forms/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/13/http-post-and-multipart-forms/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/13/http-post-and-multipart-forms/" itemprop="url">HTTP POST and Multipart Forms</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h4><code>HTTP POST</code>使用注意事项：</h4>

<ul>
<li>http Body 中的NSData 编码方式要用<code>NSASCIIStringEncoding</code>而不是<code>NSUTF8StringEncoding</code></li>
<li><p>通过</p>

<p>  <code>NSString *postLength = [NSString stringWithFormat:@"%d",[postData length]];</code>     <br/>
计算数据的长度</p></li>
</ul>


<h4>POST参数设置</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'>  <span class="c1">//设置header Content-Length</span>
</span><span class='line'>  <span class="p">[</span><span class="n">request</span> <span class="nl">setValue</span><span class="p">:</span><span class="n">postLength</span> <span class="nl">forHTTPHeaderField</span><span class="p">:</span><span class="s">@&quot;Content-Length&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="c1">//设置header contentType</span>
</span><span class='line'>  <span class="p">[</span><span class="n">request</span> <span class="nl">setValue</span><span class="p">:</span><span class="s">@&quot;application/x-www-form-urlencoded&quot;</span> <span class="nl">forHTTPHeaderField</span><span class="p">:</span><span class="s">@&quot;Current-Type&quot;</span><span class="p">];</span>
</span><span class='line'>  <span class="c1">//设置body</span>
</span><span class='line'>  <span class="p">[</span><span class="n">request</span> <span class="nl">setHTTPBody</span><span class="p">:</span><span class="n">postData</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>备注:普通<code>post</code>的<code>header</code>的<code>Current-Type</code>为<code>application/x-www-form-urlencoded</code></p></blockquote>

<h4>Multipart Forms POST参数设置</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'>  <span class="c1">//设置header contentType</span>
</span><span class='line'>  <span class="bp">NSString</span> <span class="o">*</span><span class="n">contentType</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;multipart/form-data; boundary=%@&quot;</span><span class="p">,</span> <span class="n">boundary</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">request</span> <span class="nl">addValue</span><span class="p">:</span><span class="n">contentType</span> <span class="nl">forHTTPHeaderField</span><span class="p">:</span><span class="s">@&quot;Content-Type&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//设置body contentType</span>
</span><span class='line'>  <span class="p">[</span><span class="n">body</span> <span class="nl">appendData</span><span class="p">:[</span><span class="s">@&quot;Content-Type: application/octet-stream</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span> <span class="nl">dataUsingEncoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">]];</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>备注:<code>Multipart Forms</code>的<code>header</code>的<code>Current-Type</code>为<code>multipart/form-data</code></p></blockquote>

<p>request body like this</p>

<pre><code>    --YOUR_BOUNDARY_STRING
    Content-Disposition: form-data; name="photo"; filename="calm.jpg"
    Content-Type: image/jpeg

    YOUR_IMAGE_DATA_GOES_HERE
    --YOUR_BOUNDARY_STRING
    Content-Disposition: form-data; name="message"

    My first message
    --YOUR_BOUNDARY_STRING
    Content-Disposition: form-data; name="user"

    1
    --YOUR_BOUNDARY_STRING
</code></pre>

<p>I’m sending over three variables: an image named photo, a string named message, and an integer named user. It’s important to note the linebreaks and the dashes before the boundary string. These must be included in order to build a good request. Now lets write some objective-c:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'>  <span class="bp">NSString</span> <span class="o">*</span><span class="n">boundary</span> <span class="o">=</span> <span class="s">@&quot;YOUR_BOUNDARY_STRING&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="bp">NSString</span> <span class="o">*</span><span class="n">contentType</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;multipart/form-data; boundary=%@&quot;</span><span class="p">,</span> <span class="n">boundary</span><span class="p">];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">request</span> <span class="nl">addValue</span><span class="p">:</span><span class="n">contentType</span> <span class="nl">forHTTPHeaderField</span><span class="p">:</span><span class="s">@&quot;Content-Type&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">NSMutableData</span> <span class="o">*</span><span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableData</span> <span class="n">data</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span><span class="n">body</span> <span class="nl">appendData</span><span class="p">:[[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;</span><span class="se">\r\n</span><span class="s">--%@</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boundary</span><span class="p">]</span> <span class="nl">dataUsingEncoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">]];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">body</span> <span class="nl">appendData</span><span class="p">:[[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;Content-Disposition: form-data; name=</span><span class="se">\&quot;</span><span class="s">photo</span><span class="se">\&quot;</span><span class="s">; filename=</span><span class="se">\&quot;</span><span class="s">%@.jpg</span><span class="se">\&quot;\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">self</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">photoKey</span><span class="p">]</span> <span class="nl">dataUsingEncoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">]];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">body</span> <span class="nl">appendData</span><span class="p">:[</span><span class="s">@&quot;Content-Type: application/octet-stream</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span> <span class="nl">dataUsingEncoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">]];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">body</span> <span class="nl">appendData</span><span class="p">:[</span><span class="bp">NSData</span> <span class="nl">dataWithData</span><span class="p">:</span><span class="n">imageData</span><span class="p">]];</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span><span class="n">body</span> <span class="nl">appendData</span><span class="p">:[[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;</span><span class="se">\r\n</span><span class="s">--%@</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boundary</span><span class="p">]</span> <span class="nl">dataUsingEncoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">]];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">body</span> <span class="nl">appendData</span><span class="p">:[[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;Content-Disposition: form-data; name=</span><span class="se">\&quot;</span><span class="s">message</span><span class="se">\&quot;\r\n\r\n</span><span class="s">%@&quot;</span><span class="p">,</span> <span class="nb">self</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">message</span><span class="p">]</span> <span class="nl">dataUsingEncoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">]];</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span><span class="n">body</span> <span class="nl">appendData</span><span class="p">:[[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;</span><span class="se">\r\n</span><span class="s">--%@</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boundary</span><span class="p">]</span> <span class="nl">dataUsingEncoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">]];</span>
</span><span class='line'>  <span class="p">[</span><span class="n">body</span> <span class="nl">appendData</span><span class="p">:[[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;Content-Disposition: form-data; name=</span><span class="se">\&quot;</span><span class="s">user</span><span class="se">\&quot;\r\n\r\n</span><span class="s">%d&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="nl">dataUsingEncoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">]];</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span><span class="n">body</span> <span class="nl">appendData</span><span class="p">:[[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;</span><span class="se">\r\n</span><span class="s">--%@</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boundary</span><span class="p">]</span> <span class="nl">dataUsingEncoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">]];</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span><span class="n">request</span> <span class="nl">setHTTPBody</span><span class="p">:</span><span class="n">body</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now all we need to do is make a connection to the server and send the request:</p>

<pre><code>[request setHTTPBody:body];
</code></pre>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="bp">NSURLResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">;</span>
</span><span class='line'><span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="bp">NSURLConnection</span> <span class="nl">sendSynchronousRequest</span><span class="p">:</span><span class="n">request</span> <span class="nl">returningResponse</span><span class="p">:</span><span class="o">&amp;</span><span class="n">response</span> <span class="nl">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>参考资料：</p>

<ul>
<li><a href="http://nthn.me/posts/2012/objc-multipart-forms.html">Sending Multipart Forms with Objective-C</a></li>
<li><a href="http://stackoverflow.com/questions/24250475/post-multipart-form-data-with-objective-c">POST multipart/form-data with Objective-C</a></li>
<li><a href="http://stackoverflow.com/questions/15749486/sending-an-http-post-request-on-ios">Sending an HTTP POST request on iOS</a></li>
<li><a href="http://www.w3.org/Protocols/rfc1341/7_2_Multipart.html">The Multipart Content-Type&ndash;w3规范</a></li>
</ul>


<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com">http://blog.wangruofeng007.com</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-13T05:39:21+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/13/gong-han-mo-shi-xiang-jie/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/13/gong-han-mo-shi-xiang-jie/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/13/gong-han-mo-shi-xiang-jie/" itemprop="url">工厂模式详解</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h3>3种工厂模式</h3>

<p>概述：工厂模式是个系列，分为简单工厂模式， 工厂方法模式， 抽象工厂模式，这三种模式也非常常用。这些模式最最经典的就例子就是设计计算器。
* Factory Method (工厂方法模式)
* Abstract Factory (抽象工厂模式）
* Simple Factory（简单工厂模式）</p>

<p><code>参考GoF《Design Patterns》一书</code></p>

<p>GOF是这样描述工厂模式的：</p>

<blockquote><p>“Define an interface for creating an object, but let subclasses decide which class to instantiate. Factory Method lets a class defer instantiation to subclasses.”</p>

<p>在基类中定义创建对象的一个接口，让子类决定实例化哪个类。工厂方法让一个类的实例化延迟到子类中进行。</p></blockquote>

<h4>1.简单工厂模式</h4>

<p>  严格的说，简单工厂模式并不是23种常用的设计模式之一，它只算工厂模式的一个特殊实现。简单工厂模式在实际中的应用相对于其他2个工厂模式用的还是相对少得多，因为它只适应很多简单的情况，最最重要的是它违背了我们在概述中说的开放-封闭原则。因为每次你要新添加一个功能，都需要在生switch-case 语句（或者if-else 语句）中去修改代码，添加分支条件</p>

<p>  简单工厂模式角色分配：</p>

<ol>
<li><p>Creator（产品创建者）
简单工厂模式的核心，它负责实现创建所有实例的内部逻辑。工厂类可以被外界直接调用，创建所需的产品对象。</p></li>
<li><p>Product （ 产品抽象类）
简单工厂模式所创建的所有对象的父类，它负责描述所有实例所共有的公共接口。</p></li>
<li><p>Concrete Product （具体产品）
是简单工厂模式的创建目标，所有创建的对象都是充当这个角色的某个具体类的实例。</p></li>
</ol>


<p>简单的工厂模式UML图
<img src="http://ww1.sinaimg.cn/mw690/64124373gw1ezgte12komj20h109smxx.jpg" alt="简单工厂模式" /></p>

<p>考虑下面一个事例： 加入你是一个商人，你做的的是手机生意。现在你生产android 手机和iphone等，考虑到以后你可能还会生产其他手机例如ubuntu手机。假定你选择了简单工厂模式来实现。那么显然，我们需要所有产品的抽象基类（Product） 即是Phone类：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">Phone</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">virtual</span> <span class="o">~</span><span class="n">Phone</span><span class="o">(){};</span><span class="c1">//在删除的时候防止内存泄露  </span>
</span><span class='line'>    <span class="n">virtual</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="n">string</span> <span class="n">number</span><span class="o">)</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'><span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后我们需要具体的产品类 Concrete Product： AndroidPhone 和iOSPhone</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">AndroidPhone</span> <span class="o">:</span> <span class="kd">public</span> <span class="n">Phone</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="n">string</span> <span class="n">number</span><span class="o">){</span> <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;AndroidPhone is calling...&quot;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="o">;}</span>
</span><span class='line'><span class="o">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">IosPhone</span> <span class="o">:</span> <span class="kd">public</span> <span class="n">Phone</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="n">string</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span> <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;IosPhone is calling...&quot;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="o">;}</span>
</span><span class='line'><span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后我们需要Creator</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">PhoneFactory</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">Phone</span><span class="o">*</span> <span class="n">createPhone</span><span class="o">(</span><span class="n">string</span> <span class="n">phoneName</span><span class="o">)</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span><span class="o">(</span><span class="n">phoneName</span> <span class="o">==</span> <span class="s">&quot;AndroidPhone&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">new</span> <span class="nf">AndroidPhone</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span><span class="k">else</span> <span class="nf">if</span><span class="o">(</span><span class="n">phoneName</span> <span class="o">==</span> <span class="s">&quot;IosPhone&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">new</span> <span class="nf">IosPhone</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">NULL</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>客户端这样实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nf">main</span><span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="n">PhoneFactor</span> <span class="n">factory</span><span class="o">;</span>
</span><span class='line'>    <span class="n">Phone</span><span class="o">*</span> <span class="n">myAndroid</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">createPhone</span><span class="o">(</span><span class="s">&quot;AndroidPhone&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">Phone</span><span class="o">*</span> <span class="n">myIPhone</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">createPhone</span><span class="o">(</span><span class="s">&quot;iOSPhone&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">myAndroid</span><span class="o">)</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="n">myAndroid</span><span class="o">-&gt;</span><span class="n">call</span><span class="o">(</span><span class="s">&quot;123&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">delete</span> <span class="n">myAndroid</span><span class="o">;</span>
</span><span class='line'>        <span class="n">myAndroid</span> <span class="o">=</span> <span class="n">NULL</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">myIPhone</span><span class="o">)</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="n">myIPhone</span><span class="o">-&gt;</span><span class="n">call</span><span class="o">(</span><span class="s">&quot;123&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">delete</span>  <span class="n">myIPhone</span><span class="o">;</span>
</span><span class='line'>        <span class="n">myIPhone</span> <span class="o">=</span> <span class="n">NULL</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这就是简单工厂方法，把所有的创建交给creator,creator 通过switch-case(或者if-else)语句来选择具体创建的对象。简单明了。但是就如上面所说，它最致命的问题的违背了开放-封闭原则。每次你要新添加一个功能，都要修改factor里面的createPhone代码。 但是工厂方法模式可以解决这个问题。</p>

<h4>2.工厂方法模式</h4>

<p>个人觉得工厂方法模式在工厂模式家族中是用的最多模式。上面说过了，如果简单工厂模式，要添加一个新功能，比如我现在要增加WinPhone 的生产，那么我要修改PhoneFactory中的createPhone 中的分支判断条件。这违背了开放-封闭原则，那为什么不能将创建方法放到子类中呢？
工厂方法的定义就是：定义一个用于创建对象的接口，让子类决定实例化哪一个类，工厂方法使一个类的实例化延迟到其子类。</p>

<p>  工厂方法模式角色：
1. 抽象工厂(Creator)角色：是工厂方法模式的核心，与应用程序无关。任何在模式中创建的对象的工厂类必须实现这个接口。
2. 具体工厂(Concrete Creator)角色：这是实现抽象工厂接口的具体工厂类，包含与应用程序密切相关的逻辑，并且受到应用程序调用以创建产品对象。
3. 抽象产品(Product)角色：工厂方法模式所创建的对象的超类型，也就是产品对象的共同父类或共同拥有的接口。
4. 具体产品(Concrete Product)角色：这个角色实现了抽象产品角色所定义的接口。某具体产品有专门的具体工厂创建，它们之间往往一一对应</p>

<p>工厂方法模式UML图：
<img src="http://ww1.sinaimg.cn/mw690/64124373gw1ezgtqlod9zj20hy0aijrz.jpg" alt="工厂方法模式" /></p>

<p>看定义看的晕乎乎的？那么我们来看代码：产品接口，以及其相应的子类。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">Phone</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">virtual</span> <span class="o">~</span><span class="n">Phone</span><span class="o">(){};</span><span class="c1">//在删除的时候防止内存泄露  </span>
</span><span class='line'>    <span class="n">virtual</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="n">string</span> <span class="n">number</span><span class="o">)</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'><span class="o">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">AndroidPhone</span> <span class="o">:</span> <span class="kd">public</span> <span class="n">Phone</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="n">string</span> <span class="n">number</span><span class="o">){</span> <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;AndroidPhone is calling...&quot;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="o">;}</span>
</span><span class='line'><span class="o">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">iOSPhone</span> <span class="o">:</span> <span class="kd">public</span> <span class="n">Phone</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="n">string</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span> <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;iOSPhone is calling...&quot;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="o">;}</span>
</span><span class='line'><span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面这个和简单工厂方法还是一样的。接下来不一样的来了&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">PhoneFactory</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">virtual</span> <span class="o">~</span><span class="n">PhoneFactory</span><span class="o">(){};</span>
</span><span class='line'>    <span class="n">virtual</span> <span class="n">Phone</span><span class="o">*</span> <span class="n">createPhone</span><span class="o">()</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'><span class="o">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">AndroidPhoneFactory</span> <span class="o">:</span> <span class="kd">public</span> <span class="n">PhoneFactory</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">virtual</span> <span class="n">Phone</span><span class="o">*</span> <span class="n">createPhone</span><span class="o">()</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">AndroidPhone</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">IosPhoneFactory</span> <span class="o">:</span> <span class="kd">public</span> <span class="n">PhoneFactory</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">virtual</span> <span class="n">Phone</span><span class="o">*</span> <span class="n">createPhone</span><span class="o">()</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">IosPhone</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>工厂方法将PhoneFactory抽象成了基类，PhoneFactory的createPhone不在像以前那样将所有的判断塞到里面。而是改由其子类来实现创建功能，这感觉就是权力下放。
客户端：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nf">main</span><span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="n">PhoneFactory</span><span class="o">*</span>  <span class="n">androidCreator</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">AndroidPhoneFactory</span><span class="o">();</span>
</span><span class='line'>    <span class="n">PhoneFactory</span><span class="o">*</span>  <span class="n">iosCreator</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">IosPhoneFactory</span><span class="o">();</span>
</span><span class='line'>    <span class="n">Phone</span><span class="o">*</span>  <span class="n">myAndroid</span> <span class="o">=</span> <span class="n">androidCreator</span><span class="o">-&gt;</span><span class="n">createPhone</span><span class="o">();</span>
</span><span class='line'>    <span class="n">Phone</span><span class="o">*</span> <span class="n">myIPhone</span> <span class="o">=</span> <span class="n">iosCreator</span><span class="o">-&gt;</span><span class="n">createPhone</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">myAndroid</span><span class="o">)</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="n">myAndroid</span><span class="o">-&gt;</span><span class="n">call</span><span class="o">(</span><span class="s">&quot;123&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">delete</span> <span class="n">myAndroid</span><span class="o">;</span>
</span><span class='line'>        <span class="n">myAndroid</span> <span class="o">=</span> <span class="n">NULL</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">myIPhone</span><span class="o">)</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="n">myIPhone</span><span class="o">-&gt;</span><span class="n">call</span><span class="o">(</span><span class="s">&quot;123&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">delete</span>  <span class="n">myIPhone</span><span class="o">;</span>
</span><span class='line'>        <span class="n">myIPhone</span> <span class="o">=</span> <span class="n">NULL</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">delete</span> <span class="n">androidCreator</span><span class="o">;</span>
</span><span class='line'>    <span class="n">delete</span> <span class="n">iosCreator</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在工厂方法模式中，核心工厂类不在负责产品的创建，而是将具体的创建工作交给子类去完成。也就是后所这个核心工厂仅仅只是提供创建的接口，具体实现方法交给继承它的子类去完成。当我们的系统需要增加其他新功能时，只需要继承PhoneFactory这个类，并且实现createPhone接口。 不需要对原工厂PhoneFactory进行任何修改，这样很好地符合了“开放-封闭“原则。</p>

<p>虽然工厂方法模式满足了"开放-封闭”原则，但是这个模式也仍然有缺点：每次增加一个产品时，都需要增加一个具体类和对象实现工厂，是的系统中类的个数成倍增加，在一定程度上增加了系统的复杂度，同时也增加了系统具体类的依赖。这并不是什么好事。</p>

<h4>3.抽象工厂模式</h4>

<p>在工厂方法模式中，其实我们有一个潜在意识的意识。那就是我们生产的都是同一类产品，例如我们生产的都是手机！那么现在假如现在我们又要生产平板了了呢？那么就要用到抽象工厂模式。我抽象工厂模式也用的比较多在工厂模式家族中，仅次于工厂方法模式。在了解抽象工厂模式之前，还是老生常谈的理清下产品等级结构和产品簇的概念。下面的图还是老图。但是我讲讲我的理解：</p>

<p><img src="http://ww2.sinaimg.cn/mw690/64124373gw1ezgtxoyognj20d8087wes.jpg" alt="抽象工厂模式" />
产品等级结构：产品的等级结构也就是产品的继承结构。我理解就是同一类产品，比如手机是一个系列，有android手机，ios手机，win手机，那么这个抽象类手机和他的子类就构成了一个产品等级结构。那其他的平板显然不是和手机一个系列的，一个平板，一个是手机，所以他们是不同的产品等级结构。</p>

<p>产品族: 在抽象工厂模式中，产品族是指由同一个工厂生产的，位于不同产品等级结构中的一组产品。比如分为android产品，和ios产品。其中一个ios产品包含ios手机和ios平板。显然ios手机和ios平板不是同一个产品等级结构的，因为一个是手机，一个是平板。但他们是同一个产品簇&mdash;都是ios产品。
希望大家通过上面的例子大家明白了这两个概念。</p>

<p> 抽象工厂模式的UML图：
 <img src="http://ww4.sinaimg.cn/mw690/64124373gw1ezgtzs7hwaj20db09p0ta.jpg" alt="抽象工厂模式" /></p>

<p>接着上面的话题，现在假如我要增加对平板的支持，那么我们肯定先添加两个产品等级结构，一个是手机，一个是平板：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="c1">//产品等级结构--手机  </span>
</span><span class='line'><span class="kd">class</span> <span class="nc">Phone</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">virtual</span> <span class="o">~</span><span class="n">Phone</span><span class="o">(){};</span><span class="c1">//在删除的时候防止内存泄露  </span>
</span><span class='line'>    <span class="n">virtual</span> <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="n">string</span> <span class="n">number</span><span class="o">)</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'><span class="o">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">AndroidPhone</span> <span class="o">:</span> <span class="kd">public</span> <span class="n">Phone</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="n">string</span> <span class="n">number</span><span class="o">){</span> <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;AndroidPhone is calling...&quot;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">IosPhone</span> <span class="o">:</span> <span class="kd">public</span> <span class="n">Phone</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">call</span><span class="o">(</span><span class="n">string</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span> <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;IosPhone is calling...&quot;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//产品等级结构--平板  </span>
</span><span class='line'><span class="kd">class</span> <span class="nc">Pad</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">virtual</span> <span class="o">~</span><span class="n">Pad</span><span class="o">(){};</span>
</span><span class='line'>    <span class="n">virtual</span> <span class="kt">void</span> <span class="nf">playMovie</span><span class="o">()</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'><span class="o">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">AndroidPad</span> <span class="o">:</span> <span class="kd">public</span> <span class="n">Pad</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">virtual</span> <span class="kt">void</span> <span class="nf">playMovie</span><span class="o">(){</span> <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;AndriodPad is playing movie...&quot;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">IosPad</span> <span class="o">:</span> <span class="kd">public</span> <span class="n">Pad</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">virtual</span> <span class="kt">void</span> <span class="nf">playMovie</span><span class="o">(){</span> <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">&quot;IosPad is playing movie...&quot;</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="o">;</span> <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后具体的工厂我们整个工厂是生产移动设备的所以我们取名为MobileFactory,然后工厂可以生产平板和手机，故有了createPhone 和createPad两个接口。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">MobileFactory</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">virtual</span> <span class="o">~</span><span class="n">MobileFactory</span><span class="o">(){};</span>
</span><span class='line'>    <span class="n">virtual</span> <span class="n">Phone</span><span class="o">*</span> <span class="n">createPhone</span><span class="o">()</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>    <span class="n">virtual</span> <span class="n">Pad</span><span class="o">*</span> <span class="n">createPad</span><span class="o">()</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'><span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>接着是 android 产品簇 的工厂类，负责生产android 的手机和平板：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">AndroidFactory</span> <span class="o">:</span> <span class="kd">public</span> <span class="n">MobileFactory</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">Phone</span><span class="o">*</span> <span class="n">createPhone</span><span class="o">()</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">AndroidPhone</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">Pad</span><span class="o">*</span> <span class="n">createPad</span><span class="o">()</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">AndroidPad</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>接着是ios的产品簇的工厂类，负责生产ios的手机和平板：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">IosFactory</span> <span class="o">:</span> <span class="kd">public</span> <span class="n">MobileFactory</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'><span class="kd">public</span><span class="o">:</span>
</span><span class='line'>    <span class="n">Phone</span><span class="o">*</span> <span class="n">createPhone</span><span class="o">()</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">IosPhone</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Pad</span><span class="o">*</span> <span class="n">createPad</span><span class="o">()</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">IosPad</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后客户端这样实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nf">main</span><span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="n">MobileFactory</span><span class="o">*</span>  <span class="n">androidCreator</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">AndroidFactory</span><span class="o">();</span>
</span><span class='line'>    <span class="n">MobileFactory</span><span class="o">*</span>  <span class="n">iosCreator</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">IosFactory</span><span class="o">();</span>
</span><span class='line'>    <span class="n">Phone</span><span class="o">*</span>  <span class="n">myAndroidPhone</span> <span class="o">=</span> <span class="n">androidCreator</span><span class="o">-&gt;</span><span class="n">createPhone</span><span class="o">();</span>
</span><span class='line'>    <span class="n">Pad</span><span class="o">*</span> <span class="n">myAndroidPad</span> <span class="o">=</span> <span class="n">androidCreator</span><span class="o">-&gt;</span><span class="n">createPad</span><span class="o">();</span>
</span><span class='line'>    <span class="n">Phone</span><span class="o">*</span> <span class="n">myIosPhone</span> <span class="o">=</span> <span class="n">iosCreator</span><span class="o">-&gt;</span><span class="n">createPhone</span><span class="o">();</span>
</span><span class='line'>    <span class="n">Pad</span><span class="o">*</span> <span class="n">myIosPad</span> <span class="o">=</span> <span class="n">iosCreator</span><span class="o">-&gt;</span><span class="n">createPad</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">myAndroidPhone</span><span class="o">-&gt;</span><span class="n">call</span><span class="o">(</span><span class="s">&quot;123&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">myAndroidPad</span><span class="o">-&gt;</span><span class="n">playMovie</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">myIosPhone</span><span class="o">-&gt;</span><span class="n">call</span><span class="o">(</span><span class="s">&quot;123&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">myIosPad</span><span class="o">-&gt;</span><span class="n">playMovie</span><span class="o">();</span>
</span><span class='line'>    <span class="c1">//这里没有做释放和判断，请自己判断和释放  </span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>总结：
抽象工厂模式适用于那些有多种产品的产品簇，并且每次使用其中的某一产品簇的产品。
缺点 ： 抽象工厂模式的添加新功能也非常麻烦，比工厂方法模式都还要复杂的多。
优点： 当一个产品族中的多个对象被设计成一起工作时，它能够保证客户端始终只使用同一个产品族中的对象</p>

<h4>主要用途：</h4>

<p>工厂方法要解决的问题是对象的创建时机，它提供了一种扩展的策略，很好地符合了开放封闭原则。工厂方法也叫做虚构造器（Virtual Constructor）。</p>

<p><img src="http://cdn.cocimg.com/cms/uploads/allimg/130516/4196_130516112054_1.png" alt="工厂方法的类结构图" /></p>

<h4>什么时候使用工厂方法</h4>

<p>当是如下情况是，可以使用工厂方法：一个类不知道它所必须创建的对象的类时，一个类希望有它的子类决定所创建的对象时。</p>

<p>更多关于工厂方法的介绍，可以参考本文最后给出的参考内容。下面我们就来看看在iOS中工厂方法的一种实现方法。</p>

<h4>iOS中工厂方法的实现实例</h4>

<p>如下有一个类图，该图描述了下面即将实现的工厂方法（利用工厂方法，创建出不同的形状）。其中BVShapeFactory为工厂方法的基类，BVShape为形状的基类，BVClient通过BVShapeFactory，利用 BVShapeFactory的子类（BVCircleShapeFactory和BVSquareShapeFactory）分别创建出BVCircleShape和BVSquareShape。
<img src="http://cdn.cocimg.com/cms/uploads/allimg/130516/4196_130516112123_1.png" alt="工厂方法" /></p>

<p>github下载地址:<a href="https://github.com/BeyondVincent/ios_patterns/tree/master/FactoryMethodPattern">https://github.com/BeyondVincent/ios_patterns/tree/master/FactoryMethodPattern</a></p>

<p>参考资料</p>

<ul>
<li><a href="http://doc.okbase.net/luozhonglan/archive/103843.html">iOS设计模式——工厂方法（简单工厂模式，工厂方法模式， 抽象工厂模式）</a></li>
<li><a href="http://www.cocoachina.com/ios/20130516/6219.html">iOS设计模式(03):工厂方法</a></li>
<li><a href="http://www.cocoachina.com/ios/20141124/10296.html">Objective-C类族和工厂模式</a></li>
<li><a href="http://crosbymichael.com/objective-c-design-patterns-factory.html">Objective C Design Patterns - Factory</a></li>
<li><a href="https://developer.apple.com/library/ios/documentation/General/Conceptual/CocoaEncyclopedia/ClassFactoryMethods/ClassFactoryMethods.html">Class Factory Methods</a>&ndash;Apple</li>
<li><a href="http://www.raywenderlich.com/46988/ios-design-patterns">iOS Design Patterns</a>&ndash;raywenderlich</li>
<li><a href="http://www.knowstack.com/abstract-factory-design-pattern-objective-c/">Abstract Factory Design Pattern Objective C</a></li>
<li><a href="https://www.binpress.com/tutorial/the-factory-design-pattern-explained-by-example/142">The factory design pattern explained by example</a>-php</li>
<li><a href="https://www.safaribooksonline.com/blog/2014/12/10/design-patterns-series-day-3-factory-singleton-patterns/">Design Patterns Series, Day 3: Factory and Singleton Patterns</a>&ndash;safaribooksonline</li>
<li><a href="http://www.bobmccune.com/2011/04/08/automagic-factories-in-objective-c/">Automagic Factories in Objective-C</a>&ndash;bobmccune</li>
</ul>


<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com">http://blog.wangruofeng007.com</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-13T05:36:48+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/13/duo-xian-cheng-zhi-nsthread/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/13/duo-xian-cheng-zhi-nsthread/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/13/duo-xian-cheng-zhi-nsthread/" itemprop="url">多线程之NSThread</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h2>本文目录</h2>

<ul>
<li>前言</li>
<li>1.获取当前线程</li>
<li>2.获取主线程</li>
<li>3.NSThread的创建</li>
<li>4.暂停当前线程</li>
<li>5.线程的其他操作</li>
<li>6.优缺点</li>
</ul>


<h3>前言</h3>

<p>每个iOS应用程序都有个专门用来更新显示UI界面、处理用户触摸事件的主线程，因此不能将其他太耗时的操作放在主线程中执行，不然会造成主线程堵塞(出现卡机现象)，带来极坏的用户体验。一般的解决方案就是将那些耗时的操作放到另外一个线程中去执行，多线程编程是防止主线程堵塞，增加运行效率的最佳方法。</p>

<p>iOS中有3种常见的多线程编程方法
1. <code>NSThread</code>
这种方法需要管理线程的生命周期、同步、加锁问题，会导致一定的性能开销</p>

<ol>
<li><p><code>NSOperation</code>和<code>NSOperationQueue</code>
是基于OC实现的。NSOperation以面向对象的方式封装了需要执行的操作，然后可以将这个操作放到一个NSOperationQueue中去异步执行。不必关心线程管理、同步等问题。</p></li>
<li><p><code>Grand Centeral Dispatch</code>
简称GCD，iOS4才开始支持，是纯C语言的API。自iPad2开始，苹果设备开始有了双核CPU，为了充分利用这2个核，GCD提供了一些新特性来支持多核并行编程</p></li>
</ol>


<p>这篇文章简单介绍<code>NSThread这</code>个类，一个<code>NSThread</code>实例就代表着一条线程</p>

<h3>1.获取当前线程</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="bp">NSThread</span> <span class="o">*</span><span class="n">current</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSThread</span> <span class="n">currentThread</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2.获取主线程</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="bp">NSThread</span> <span class="o">*</span><span class="n">main</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSThread</span> <span class="n">mainThread</span><span class="p">];</span>
</span><span class='line'><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;主线程:%@&quot;</span><span class="p">,</span> <span class="n">main</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>打印结果是：</p>

<pre><code>2013-04-18 21:36:38.599 thread[7499:c07] 主线程:&lt;NSThread: 0x71434e0&gt;{name = (null), num = 1}
</code></pre>

<p>num相当于线程的id，主线程的num是为1的</p>

<h3>3.NSThread的创建</h3>

<h4>a.动态方法</h4>

<pre><code>- (id)initWithTarget:(id)target selector:(SEL)selector object:(id)argument;
</code></pre>

<p>在第2行创建了一条新线程，然后在第4行调用<code>start</code>方法启动线程，线程启动后会调用self的<code>run:</code>方法，并且将@&ldquo;mj"作为方法参数</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// 初始化线程</span>
</span><span class='line'><span class="bp">NSThread</span> <span class="o">*</span><span class="kr">thread</span> <span class="o">=</span> <span class="p">[[[</span><span class="bp">NSThread</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithTarget</span><span class="p">:</span><span class="nb">self</span> <span class="nl">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">run</span><span class="p">:)</span> <span class="nl">object</span><span class="p">:</span><span class="s">@&quot;mj&quot;</span><span class="p">]</span> <span class="n">autorelease</span><span class="p">];</span>
</span><span class='line'><span class="c1">// 开启线程</span>
</span><span class='line'><span class="p">[</span><span class="kr">thread</span> <span class="n">start</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>假如run:方法是这样的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">run:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">string</span> <span class="p">{</span>
</span><span class='line'>     <span class="bp">NSThread</span> <span class="o">*</span><span class="n">current</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSThread</span> <span class="n">currentThread</span><span class="p">];</span>
</span><span class='line'>     <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;执行了run:方法-参数：%@，当前线程：%@&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>打印结果为：</p>

<pre><code>2013-04-18 21:40:33.102 thread[7542:3e13] 执行了run:方法-参数：mj，当前线程：&lt;NSThread: 0x889e8d0&gt;{name = (null), num = 3}
</code></pre>

<p>可以发现，这条线程的num值为3，说明不是主线程，主线程的num为1</p>

<h4>b.静态方法</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">detachNewThreadSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">selector</span> <span class="nf">toTarget:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">target</span> <span class="nf">withObject:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">argument</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">[</span><span class="bp">NSThread</span> <span class="nl">detachNewThreadSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">run</span><span class="p">:)</span> <span class="nl">toTarget</span><span class="p">:</span><span class="nb">self</span> <span class="nl">withObject</span><span class="p">:</span><span class="s">@&quot;mj&quot;</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<h4>c.隐式创建线程</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">[</span><span class="nb">self</span> <span class="nl">performSelectorInBackground</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">run</span><span class="p">:)</span> <span class="nl">withObject</span><span class="p">:</span><span class="s">@&quot;mj&quot;</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>会隐式地创建一条新线程，并且在这条线程上调用self的run:方法，以@&ldquo;mj"为方法参数</p>

<h3>4.暂停当前线程</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">[</span><span class="bp">NSThread</span> <span class="nl">sleepForTimeInterval</span><span class="p">:</span><span class="mi">2</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="bp">NSDate</span> <span class="o">*</span><span class="n">date</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSDate</span> <span class="nl">dateWithTimeInterval</span><span class="p">:</span><span class="mi">2</span> <span class="nl">sinceDate</span><span class="p">:[</span><span class="bp">NSDate</span> <span class="n">date</span><span class="p">]];</span>
</span><span class='line'><span class="p">[</span><span class="bp">NSThread</span> <span class="nl">sleepUntilDate</span><span class="p">:</span><span class="n">date</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面两种做法都是暂停当前线程2秒</p>

<h3>5.线程的其他操作</h3>

<h4>a.在指定线程上执行操作</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'> <span class="p">[</span><span class="nb">self</span> <span class="nl">performSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">run</span><span class="p">)</span> <span class="nl">onThread</span><span class="p">:</span><span class="kr">thread</span> <span class="nl">withObject</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">waitUntilDone</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>上面代码的意思是在thread这条线程上调用self的run方法</li>
<li>最后的YES代表：上面的代码会阻塞，等run方法在thread线程执行完毕后，上面的代码才会通过</li>
</ul>


<h4>b.在主线程上执行操作</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">[</span><span class="nb">self</span> <span class="nl">performSelectorOnMainThread</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">run</span><span class="p">)</span> <span class="nl">withObject</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">waitUntilDone</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>在主线程调用self的run方法</p>

<h4>c.在当前线程执行操作</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">[</span><span class="nb">self</span> <span class="nl">performSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">run</span><span class="p">)</span> <span class="nl">withObject</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>在当前线程调用self的run方法</p>

<h3>6.优缺点</h3>

<ol>
<li>优点：<code>NSThread</code>比其他多线程方案较轻量级，更直观地控制线程对象</li>
<li>缺点：需要自己管理线程的生命周期，线程同步。线程同步对数据的加锁会有一定的系统开销</li>
</ol>


<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com">http://blog.wangruofeng007.com</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-13T05:18:36+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/13/nsoperation-and-nsoperationqueue-tutorial-in-swift/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/13/nsoperation-and-nsoperationqueue-tutorial-in-swift/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/13/nsoperation-and-nsoperationqueue-tutorial-in-swift/" itemprop="url">NSOperation and NSOperationQueue Tutorial in Swift</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><ul>
<li>译自 Written by <a href="http://www.raywenderlich.com/u/jrturton"> Richard Turton</a> — on October 7, 2014</li>
<li>原文链接：<a href="http://www.raywenderlich.com/76341/use-nsoperation-nsoperationqueue-swift">http://www.raywenderlich.com/76341/use-nsoperation-nsoperationqueue-swift</a></li>
<li>译者<a href="https://twitter.com/oneruofeng">@oneruofeng</a></li>
</ul>


<p><strong>Post info</strong>: Updated for Xcode 7.1 and Swift 2.1 &ndash; 1 January 2016</p>

<p><strong>Update note</strong>: This tutorial was updated to iOS 8, Xcode 6.1 and Swift by Richard Turton.</p>

<blockquote><p><a href="http://www.raywenderlich.com/76341/use-nsoperation-nsoperationqueue-swift">Original post</a> by Tutorial Team member <a href="http://www.raywenderlich.com/u/Canopus">Soheil Azarpour</a>.</p></blockquote>

<p>每个人都有点击一个按钮或者进入一些文本在iOS或者Mac App上的令人沮丧的经历，就是突然-WHAM，用户交互停止了响应。</p>

<p>在Mac上，你的用户开始盯着一个沙漏或者一个七彩的轮子开始旋转直到它们再次恢复UI交互为止。在一个iOS app中，用户期望App立即响应它们的触摸事件，无响应的app给人的感觉是笨重和缓慢，这样通常会导致收到差评。</p>

<p>保持你的app的可交互的状态说起来容易做起来难，一旦你的app需要执行不仅仅是少量的任务，事情很快就变得很复杂，我们并没有多少事件在主事件循环执行繁重的工作并且同时提供一个可以响应的UI。</p>

<p>低级的开发者是怎样做的呢？解决方案就是把工作从主线程中移除通过并发。并发意味着你应用所有的操作同时执行在多个流（或者线程）中&ndash;这样的话用户界面就能保持响应的要执行的工作。</p>

<p>一种实现并发操作在iOS是通过<code>NSOperation</code>和<code>NSOperationQueue</code>这两个类。在这个教程中，你将学会怎样使用它们！你将从一个没有使用并发的App开始，所以它将出现的非常迟钝和无响应。然后你将重做你的应用给它们添加并发操作并且&ndash;希望&ndash;呈现一个更加响应良好的可交互界面给用户！</p>

<h3>我们开始吧</h3>

<p>这份样品工程的总的目标的就是展示一个滤镜处理过的图片的表视图。图片将从网络上下载，经过一个滤镜处理后，然后在表视图中显示。</p>

<p>下面是这个app模型的示意图</p>

<p><img src="http://ww2.sinaimg.cn/mw690/64124373gw1ezk3rh3ebyj20i20nmq4k.jpg" alt="app模型的示意图" /></p>

<!--
<img src = "http://ww2.sinaimg.cn/mw690/64124373gw1ezk3rh3ebyj20i20nmq4k.jpg" with= 300 height = 600>-->


<h3>第一个版本尝试</h3>

<p>下载你将在这个教程中使用的<a href="http://cdn5.raywenderlich.com/wp-content/uploads/2014/10/ClassicPhotos-Starter63.zip">第一个版本的项目</a></p>

<blockquote><p>注意：所以的图片来自<a href="http://sxc.hu/"> stock.xchng.</a>。一下图片在数据源故意错误命名，以便这里有些例子是图片下载失败好处理失败的情况。</p></blockquote>

<p>构建并且运行这个工程，最终你将看到这个app运行起来显示一列照片。尝试滚动这个列表，很痛苦，不是吗？
<img src="http://ww3.sinaimg.cn/mw690/64124373gw1ezk45qmdigj205x08wdga.jpg" alt="list of photoes" /></p>

<p><em>传统的相册，运行缓慢</em></p>

<p>所有的操作都发生在<code>ListViewController.swift</code>里，并且最主要的是发生在<code>tableView(_:cellForRowAtIndexPath:)</code>方法里。看一下那个方法和注释这里有两件相当集中的事情需要思考：</p>

<ol>
<li><code>从网络载入图片数据</code>。即使网络状况良好，app将仍然必须等待直到下载完成了才能继续。</li>
<li>使用<em>Core Image</em>给图片加滤镜。这个方法给图片应用一个深褐色的滤镜，假如你想了解更多关于<code>Core Image</code>滤镜的知识，请点击<a href="http://www.raywenderlich.com/76285/beginning-core-image-swift">Beginning Core Image in Swift</a></li>
</ol>


<p>还有，你将载入一系列图片请求从网络当它第一次被请求时:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'>  <span class="n">lazy</span> <span class="k">var</span> <span class="n">photos</span> <span class="o">=</span> <span class="bp">NSDictionary</span><span class="p">(</span><span class="nl">contentsOfURL</span><span class="p">:</span><span class="n">dataSourceURL</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>所有的工作发生在应用的主线程。由于主线程也负责用户交互，让它一直忙于从网络下载东西和给图片加滤镜消磨掉了响应中的app。你可以通过使用Xcode的仪表测量视图获得这样一个快速的概述。你可以通过显示<code>调试导航</code>(Commnad+6)接入这个仪表视图,让后选择<code>CPU</code>当app正在运行的时候。</p>

<p><img src="http://ww4.sinaimg.cn/mw690/64124373gw1ezk4seggwgj20jg0a0ta0.jpg" alt="gauges" /></p>

<p><em>Xcode的仪表视图表明，主线程的任务非常重</em></p>

<p>你会看到那些所有的长钉在<code>Thread 1</code>，那就是app的主线程。更多详细的信息你可以运行app的<code>Instruments</code>,但是那个在<a href="http://www.raywenderlich.com/?p=23037"> whole other tutorial :].</a>中</p>

<p>是时候考虑怎样改善一下你的用户体验了！</p>

<h3>任务，线程和进程</h3>

<p>在你专研这篇教程之前，这里有一下技术上的慨念需要理一下，我将定义一些专用术语：</p>

<ul>
<li><strong>任务</strong> ：一个简单单个的需要完成的工作</li>
<li><strong>线程</strong> ：操作系统提供的机制允许多个用户操作同时进行在一个应用中</li>
<li><strong>进程</strong> ：一个可执行的代码块，它可以由多个线程构成</li>
</ul>


<blockquote><p>注意：在iOS和OS X中，线程的功能由POSIX线程API（或者 pthreads）实现，并且它使操作系统的一部分。而这个又是相当底层的东西，你将发现它很容易犯错误；或许关于线程最糟糕的事情是那些很难被发现的错误！</p>

<p><code>Foundation</code>框架包含了一个叫做<code>NSThread</code>的类，这让我们处理事情更容易，但是用<code>NSThread</code>管理多个线程仍是一件令人头疼的事情。<code>NSOperation</code>和<code>NSOperationQueue</code>是为了最大化简化处理多线程的更高级的类。</p></blockquote>

<p>在这个图解中，你会看到进程，线程和任务之间的关系：</p>

<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1ezk5dwtbhuj20go03n0t2.jpg" alt="the relationship between a process, threads, and tasks" /></p>

<p><em>进程，线程和任务</em></p>

<p>正如你所见，一个进程可以包涵多个执行的线程，每个线程能够同时执行多个任务。</p>

<p>在这个图集中, <code>thread 2</code>执行文件的读的工作，同时<code>thread 1</code>执行UI相关的代码。这和你应该怎样在iOS中构建你的代码（主线程执行任何和UI相关的工作，第二线程应当执行慢的或者长时间运行的耗时操作例如读取文件，接入网络等等）有点相似。</p>

<h3>NSOperation vs. Grand Central Dispatch (GCD)</h3>

<p>你应该听说过<a href="http://developer.apple.com/library/ios/#documentation/Performance/Reference/GCD_libdispatch_Ref/Reference/reference.html">Grand Central Dispatch (GCD).</a>。简单的来说，<code>GCD</code>由语言的特征，运行时库和系统增强组成来提供一个在<code>iOS</code>和<code>OS X</code>多核硬件中支持并发系统并且综合的改良。假如你想了解更多关于GCD相关的知识，有可以阅读我们的<a href="http://www.raywenderlich.com/?p=4295">Multithreading and Grand Central Dispatch on iOS for Beginners Tutorial</a>。</p>

<p><code>NSOperation</code>和<code>NSOperationQueue</code>构建在GCD之上。普遍来说，苹果推荐使用最高级别抽象，当需要显示他们一些需要的测量工作时回到最底层。</p>

<p>下面是关于这两者的一些简单比较，将帮助你决定何时何地选择使用<code>GCD</code>或者<code>NSOperation</code>：</p>

<ul>
<li><p><strong>GCD</strong> 是一个轻量级的方式来描述将要被并发执行的工作单元。你不必定制这个工作单元的时刻表；系统为你定制时刻表。在blocks中增加依赖是一件头疼的事情。取消或者暂停一个block来进行额外的工作为作为开发者的你！ :]</p></li>
<li><p><strong>NSOperation</strong> 和GCD相比增加了一些额外开支，但是你能够在各种操作之间增加依赖并且恢复，取消，暂停他们。</p></li>
</ul>


<p>这个教程将使用<code>NSOperation</code>,因为你将处理一个列表为了好的表现并且由于它大量的消耗的资源你需要能够取消一个操作针对某个图片，假如用户已经将那张图片滚出屏幕。即使这些操作在后台线程，假如这里有一打事情在队列里等着它们去处理，这将表现得跟糟糕。</p>

<h3>重构 App Model</h3>

<p>是时候重构开始的非多线程的模型了！假如你仔细观察先前的模型，你会发现这里有三个可以被改进的线程受困区域。通过切割这三个区域让后把他们放在单独的线程里，主线程的压力将得到缓解并且能够保持和用户交互。</p>

<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1ezk6m9a5xzj20i20nm416.jpg" alt="NSOperation_model_improved" /></p>

<p><em>改进后的 model</em></p>

<p>为了摆脱你应用的瓶颈，你需要一个指定一个线程来响应你的用户时间，一个线程专注于下载资源和图片，一个线程执行图片滤镜操作。在新的模型中，app从主线程启动让后载入一个空的表视图。同时，app启动第二个线程开始下载数据资源。</p>

<p>一旦数据资源下载完成，你将通知表视图重新载入。这些事情必须在主线程完成，因为它涉及到用户界面相关的操作。从这一点来说，表视图知道有多少行，并且它知道他将显示图片的URL地址，但是她不知道它是否真的有图片！假如你立即开始下载所有的图片在这个点上，这可能导致效率极其低下，因为你不需要一次性把所有图片下载完！</p>

<p>为了让这个变得更好我们能够做什么？</p>

<p>一个更好的模型就是可交互的行在屏幕范围内可见时才开始下载图片。所以你的代码开始将询问表视图有多少行可见。因此，代码应该直到这里有一个未加滤镜的图片等待处理时才开始处理图片加滤镜操作。</p>

<p>为了使app更加快速响应，代码将要让图片一旦下载完毕立即显示。让后才开始进行图片加滤镜操作，让后更新UI界面来显示已经经过滤镜处理后的图片。下面的图标显示了这个过程的控制流：</p>

<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1ezk75nd4bdj20i206yq3q.jpg" alt="Control Flow" /></p>

<p><em>Cotroll Flow</em></p>

<p>为了获得这些对象，你需要跟踪这张图片现在是否正在被下载，一旦完成下载，假如图片的滤镜被应用上。你需要跟跟踪每个操作的状态，它是否正在下载中或者执行滤镜操作，以便你能够取消，暂停或者恢复每个操作当用户滚动的时候。</p>

<p>Okey！ 现在你准备好开始码代码了！ :]</p>

<p>打开你下载的工程，添加一个新的<strong>Swift File</strong>到你的工程中命名为<strong> PhotoOperations.swift</strong>。添加下面代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">class</span> <span class="n">PendingOperations</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">lazy</span> <span class="k">var</span> <span class="n">downloadsInProgress</span> <span class="o">=</span> <span class="p">[</span><span class="nl">NSIndexPath</span><span class="p">:</span><span class="bp">NSOperation</span><span class="p">]()</span>
</span><span class='line'>  <span class="n">lazy</span> <span class="k">var</span> <span class="nl">downloadQueue</span><span class="p">:</span><span class="bp">NSOperationQueue</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="n">queue</span> <span class="o">=</span> <span class="bp">NSOperationQueue</span><span class="p">()</span>
</span><span class='line'>    <span class="n">queue</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Download queue&quot;</span>
</span><span class='line'>    <span class="n">queue</span><span class="p">.</span><span class="n">maxConcurrentOperationCount</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">queue</span>
</span><span class='line'>    <span class="p">}()</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">lazy</span> <span class="k">var</span> <span class="n">filtrationsInProgress</span> <span class="o">=</span> <span class="p">[</span><span class="nl">NSIndexPath</span><span class="p">:</span><span class="bp">NSOperation</span><span class="p">]()</span>
</span><span class='line'>  <span class="n">lazy</span> <span class="k">var</span> <span class="nl">filtrationQueue</span><span class="p">:</span><span class="bp">NSOperationQueue</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="n">queue</span> <span class="o">=</span> <span class="bp">NSOperationQueue</span><span class="p">()</span>
</span><span class='line'>    <span class="n">queue</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Image Filtration queue&quot;</span>
</span><span class='line'>    <span class="n">queue</span><span class="p">.</span><span class="n">maxConcurrentOperationCount</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">queue</span>
</span><span class='line'>    <span class="p">}()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这回类包含了2个字典为了跟踪激活和正在进行中的下载和滤镜操作对表中的每一行，并且两个操作队列都有各自的操作类型。</p>

<p>所有的值被懒加载的方式创建，意味着他们不会被初始化知道他们第一次被接入。这样改善了你app的表现性能。</p>

<p>创建一个<code>NSOperationQueue</code>是非常简单的，正如你所见，给你的队列命名是非常有用的，因为名字会在仪器或者调速器中显示。<code>maxConcurrentOperationCount</code>在这里由于这个教程的缘故被设置成1，是为了让你看到操作一个接一个完成。你可以离开这一部分允许队列决定他一次处理多少个操作&ndash;这样会进一步改善性能。</p>

<p>队列是怎样决定一次运行多少个操作的呢？这是一个非常好的问题！ :] 这取决于硬件。默认，<code>NSOperationQueue</code>将要处理一写计算在屏幕背后，决定什么是最好的需要看代码是运行在某个具体的平台，和将载入的最大数量的线程数。</p>

<p>考虑到下面的例子，假设系统此时是空闲的，这里有很多资源可用，所以这个队列能够载入可能8条并发的线程。下一个时刻你运行程序，系统可能忙于其他不相关的正在抢夺资源的操作，这时队列就仅仅载入2个并发的线程。因为你已经设置了一个最大并发操作数，在这个app中一次只会进行一个操作。</p>

<blockquote><p>注意：你可能想知道为什么你必须跟踪所有的激活的和正在进行中操作。队列有一个<code>operations</code>的方法，它将返回一个操作的数组，所有为什么不用它呢？在这个工程中这样做效果不是很好。你需要跟踪更表视图行数关联的操作，它可能会重复执行数组每次你需要一个的时候。把它们储存在一个字典中用index path来作为他的key方便快速和高效的查找。</p></blockquote>

<p>是时候考虑下载和过滤操作了。添加下列代码到<code>PhotoOperations.swift:</code>文件的末尾：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">class</span> <span class="nl">ImageDownloader</span><span class="p">:</span> <span class="bp">NSOperation</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//1</span>
</span><span class='line'>  <span class="k">let</span> <span class="nl">photoRecord</span><span class="p">:</span> <span class="n">PhotoRecord</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//2</span>
</span><span class='line'>  <span class="k">init</span><span class="p">(</span><span class="nl">photoRecord</span><span class="p">:</span> <span class="n">PhotoRecord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">photoRecord</span> <span class="o">=</span> <span class="n">photoRecord</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//3</span>
</span><span class='line'>  <span class="kr">override</span> <span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//4</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">self</span><span class="p">.</span><span class="n">cancelled</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="c1">//5</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">imageData</span> <span class="o">=</span> <span class="bp">NSData</span><span class="p">(</span><span class="nl">contentsOfURL</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">photoRecord</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//6</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">self</span><span class="p">.</span><span class="n">cancelled</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//7</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">imageData</span><span class="o">?</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">photoRecord</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">UIImage</span><span class="p">(</span><span class="nl">data</span><span class="p">:</span><span class="n">imageData</span><span class="o">!</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">photoRecord</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">.</span><span class="n">Downloaded</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">photoRecord</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">.</span><span class="n">Failed</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">photoRecord</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="bp">UIImage</span><span class="p">(</span><span class="nl">named</span><span class="p">:</span> <span class="s">&quot;Failed&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>NSOperation</code>是一个抽象类，为它的子类而设计。每个子类代表了一个特别的<code>任务</code>正如呈现在列表早期那样。</p>

<p>下面是上面代码每行注释到底发生了什么的说明：</p>

<ol>
<li>添加一个常量引用到和操作相关的<code>PhotoRecord</code>对象</li>
<li>创建一个设计初始化方法允许<code>photo record</code>参数可以被传进来</li>
<li><code>main</code>是你在<code>NSOperation</code>子类中需要重写的方法，用来执行相关工作</li>
<li>在启动开始前检查是否被取消，操作应该定期检查是否已经被取消在尝试长时间或密集的工作之前</li>
<li>下载图片数据</li>
<li>再次检查是否被取消</li>
<li>假如这里有数据，创建一个图片对象然后把它添加到记录中，同时改变它的状态，假如这里没有数据，把这条记录标记成失败然后设置适当的图片</li>
</ol>


<p>下一步，你将创建另一个操作来处理图片加滤镜的操作！添加下面的代码到<code>PhotoOperations.swift</code>文件末尾：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">class</span> <span class="nl">ImageFiltration</span><span class="p">:</span> <span class="bp">NSOperation</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">let</span> <span class="nl">photoRecord</span><span class="p">:</span> <span class="n">PhotoRecord</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">init</span><span class="p">(</span><span class="nl">photoRecord</span><span class="p">:</span> <span class="n">PhotoRecord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">photoRecord</span> <span class="o">=</span> <span class="n">photoRecord</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kr">override</span> <span class="k">func</span> <span class="n">main</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">self</span><span class="p">.</span><span class="n">cancelled</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="nb">self</span><span class="p">.</span><span class="n">photoRecord</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="p">.</span><span class="n">Downloaded</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="k">let</span> <span class="n">filteredImage</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">applySepiaFilter</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">photoRecord</span><span class="p">.</span><span class="n">image</span><span class="o">!</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">photoRecord</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">filteredImage</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">photoRecord</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="p">.</span><span class="n">Filtered</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>除了你对图片应用滤镜（使用一个未实现的方法，因此编译1错误）而不是下载它之外，这个看起来和下载操作非常相像。</p>

<p>添加遗失的图片滤镜处理方法到<code>ImageFiltration</code>类中:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="p">(</span><span class="nl">image</span><span class="p">:</span><span class="bp">UIImage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">UIImage</span><span class="o">?</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">inputImage</span> <span class="o">=</span> <span class="bp">CIImage</span><span class="p">(</span><span class="nl">data</span><span class="p">:</span><span class="n">UIImagePNGRepresentation</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nb">self</span><span class="p">.</span><span class="n">cancelled</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">nil</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">context</span> <span class="o">=</span> <span class="bp">CIContext</span><span class="p">(</span><span class="nl">options</span><span class="p">:</span><span class="nb">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">filter</span> <span class="o">=</span> <span class="bp">CIFilter</span><span class="p">(</span><span class="nl">name</span><span class="p">:</span><span class="s">&quot;CISepiaTone&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">filter</span><span class="p">.</span><span class="n">setValue</span><span class="p">(</span><span class="n">inputImage</span><span class="p">,</span> <span class="nl">forKey</span><span class="p">:</span> <span class="n">kCIInputImageKey</span><span class="p">)</span>
</span><span class='line'>  <span class="n">filter</span><span class="p">.</span><span class="n">setValue</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="nl">forKey</span><span class="p">:</span> <span class="s">&quot;inputIntensity&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">outputImage</span> <span class="o">=</span> <span class="n">filter</span><span class="p">.</span><span class="n">outputImage</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="nb">self</span><span class="p">.</span><span class="n">cancelled</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">nil</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">let</span> <span class="n">outImage</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">createCGImage</span><span class="p">(</span><span class="n">outputImage</span><span class="p">,</span> <span class="nl">fromRect</span><span class="p">:</span> <span class="n">outputImage</span><span class="p">.</span><span class="n">extent</span><span class="p">())</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">returnImage</span> <span class="o">=</span> <span class="bp">UIImage</span><span class="p">(</span><span class="nl">CGImage</span><span class="p">:</span> <span class="n">outImage</span><span class="p">)</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">returnImage</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>图片添加滤镜操作使用先前<code>ListViewController</code>中相同的实现。已经把它移动到这里来了以至于它它能在后台的一个单独的操作中完成。再次强调，你应该非常频繁的检查取消操作；最佳实践是在进行任何耗时操作调用之前和之后。一旦加滤镜操作完成，你应该立即设置photo record 实例的值。</p>

<p>很棒！现在你已经有了所有的工具和基础为了处理后台任务进程的操作。是时候回到控制器修改它以便能利用所有这些新的福利。</p>

<p>切换到<code>ListViewController.swift</code>文件，然后删除<code>lazy var photos</code>接口声明。添加下面声明：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">var</span> <span class="n">photos</span> <span class="o">=</span> <span class="p">[</span><span class="n">PhotoRecord</span><span class="p">]()</span>
</span><span class='line'><span class="k">let</span> <span class="n">pendingOperations</span> <span class="o">=</span> <span class="n">PendingOperations</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>这些将持有一个数组的你在开始创建的<code>PhotoDetails</code>对象，<code>PendingOperations</code>对象来管理操作。</p>

<p>添加一个下载<code>photos property</code>列表新的方法到类中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">func</span> <span class="nf">fetchPhotoDetails</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">request</span> <span class="o">=</span> <span class="bp">NSURLRequest</span><span class="p">(</span><span class="nl">URL</span><span class="p">:</span><span class="n">dataSourceURL</span><span class="o">!</span><span class="p">)</span>
</span><span class='line'>  <span class="bp">UIApplication</span><span class="p">.</span><span class="n">sharedApplication</span><span class="p">().</span><span class="n">networkActivityIndicatorVisible</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">NSURLConnection</span><span class="p">.</span><span class="n">sendAsynchronousRequest</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nl">queue</span><span class="p">:</span> <span class="bp">NSOperationQueue</span><span class="p">.</span><span class="n">mainQueue</span><span class="p">())</span> <span class="p">{</span><span class="n">response</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">error</span> <span class="k">in</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">data</span> <span class="o">!=</span> <span class="nb">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">let</span> <span class="n">datasourceDictionary</span> <span class="o">=</span> <span class="bp">NSPropertyListSerialization</span><span class="p">.</span><span class="n">propertyListWithData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nl">options</span><span class="p">:</span> <span class="n">Int</span><span class="p">(</span><span class="n">NSPropertyListMutabilityOptions</span><span class="p">.</span><span class="n">Immutable</span><span class="p">.</span><span class="n">rawValue</span><span class="p">),</span> <span class="nl">format</span><span class="p">:</span> <span class="nb">nil</span><span class="p">,</span> <span class="nl">error</span><span class="p">:</span> <span class="nb">nil</span><span class="p">)</span> <span class="kt">as</span><span class="o">!</span> <span class="bp">NSDictionary</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">for</span><span class="p">(</span><span class="nl">key</span> <span class="p">:</span> <span class="n">AnyObject</span><span class="p">,</span><span class="nl">value</span> <span class="p">:</span> <span class="n">AnyObject</span><span class="p">)</span> <span class="k">in</span> <span class="n">datasourceDictionary</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="n">key</span> <span class="kt">as</span><span class="o">?</span> <span class="n">String</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">url</span> <span class="o">=</span> <span class="bp">NSURL</span><span class="p">(</span><span class="nl">string</span><span class="p">:</span><span class="n">value</span> <span class="kt">as</span><span class="o">?</span> <span class="n">String</span> <span class="o">??</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="nb">nil</span> <span class="o">&amp;&amp;</span> <span class="n">url</span> <span class="o">!=</span> <span class="nb">nil</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">let</span> <span class="n">photoRecord</span> <span class="o">=</span> <span class="n">PhotoRecord</span><span class="p">(</span><span class="nl">name</span><span class="p">:</span><span class="n">name</span><span class="o">!</span><span class="p">,</span> <span class="nl">url</span><span class="p">:</span><span class="n">url</span><span class="o">!</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">self</span><span class="p">.</span><span class="n">photos</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">photoRecord</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">reloadData</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">error</span> <span class="o">!=</span> <span class="nb">nil</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">let</span> <span class="n">alert</span> <span class="o">=</span> <span class="bp">UIAlertView</span><span class="p">(</span><span class="nl">title</span><span class="p">:</span><span class="s">&quot;Oops!&quot;</span><span class="p">,</span><span class="nl">message</span><span class="p">:</span><span class="n">error</span><span class="p">.</span><span class="n">localizedDescription</span><span class="p">,</span> <span class="nl">delegate</span><span class="p">:</span><span class="nb">nil</span><span class="p">,</span> <span class="nl">cancelButtonTitle</span><span class="p">:</span><span class="s">&quot;OK&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">alert</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="bp">UIApplication</span><span class="p">.</span><span class="n">sharedApplication</span><span class="p">().</span><span class="n">networkActivityIndicatorVisible</span> <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个方法创建一个异步的网络请求，当完成的时候，将执行<code>completion block</code>在主线程。当下载完成property list的数据被萃取成一个<code>NSDictionary</code>,然后再次处理一个数组的<code>PhotoRecord</code>的对象。你不能直接使用这里的<code>NSOperation</code>,你应该在主线程中接入它使用<code>NSOperationQueue.mainQueue()</code>。</p>

<p>在<code>viewDidLoad</code>调用新方法</p>

<blockquote><p>fetchPhotoDetails()</p></blockquote>

<p>下一步找到<code>tableView(_:cellForRowAtIndexPath:)</code>然后替换它用下面的实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="kr">override</span> <span class="k">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="nl">tableView</span><span class="p">:</span> <span class="bp">UITableView</span><span class="p">,</span> <span class="n">cellForRowAtIndexPath</span> <span class="nl">indexPath</span><span class="p">:</span> <span class="bp">NSIndexPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">UITableViewCell</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="p">.</span><span class="n">dequeueReusableCellWithIdentifier</span><span class="p">(</span><span class="s">&quot;CellIdentifier&quot;</span><span class="p">,</span> <span class="nl">forIndexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span> <span class="kt">as</span><span class="o">!</span> <span class="bp">UITableViewCell</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//1</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">cell</span><span class="p">.</span><span class="n">accessoryView</span> <span class="o">==</span> <span class="nb">nil</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">indicator</span> <span class="o">=</span> <span class="bp">UIActivityIndicatorView</span><span class="p">(</span><span class="nl">activityIndicatorStyle</span><span class="p">:</span> <span class="p">.</span><span class="n">Gray</span><span class="p">)</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">accessoryView</span> <span class="o">=</span> <span class="n">indicator</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">indicator</span> <span class="o">=</span> <span class="n">cell</span><span class="p">.</span><span class="n">accessoryView</span> <span class="kt">as</span><span class="o">!</span> <span class="bp">UIActivityIndicatorView</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//2</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">photoDetails</span> <span class="o">=</span> <span class="n">photos</span><span class="p">[</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//3</span>
</span><span class='line'>  <span class="n">cell</span><span class="p">.</span><span class="n">textLabel</span><span class="o">?</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">photoDetails</span><span class="p">.</span><span class="n">name</span>
</span><span class='line'>  <span class="n">cell</span><span class="p">.</span><span class="n">imageView</span><span class="o">?</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">photoDetails</span><span class="p">.</span><span class="n">image</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//4</span>
</span><span class='line'>  <span class="k">switch</span> <span class="p">(</span><span class="n">photoDetails</span><span class="p">.</span><span class="n">state</span><span class="p">){</span>
</span><span class='line'>  <span class="k">case</span> <span class="p">.</span><span class="nl">Filtered</span><span class="p">:</span>
</span><span class='line'>    <span class="n">indicator</span><span class="p">.</span><span class="n">stopAnimating</span><span class="p">()</span>
</span><span class='line'>  <span class="k">case</span> <span class="p">.</span><span class="nl">Failed</span><span class="p">:</span>
</span><span class='line'>    <span class="n">indicator</span><span class="p">.</span><span class="n">stopAnimating</span><span class="p">()</span>
</span><span class='line'>    <span class="n">cell</span><span class="p">.</span><span class="n">textLabel</span><span class="o">?</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&quot;Failed to load&quot;</span>
</span><span class='line'>  <span class="k">case</span> <span class="p">.</span><span class="n">New</span><span class="p">,</span> <span class="p">.</span><span class="nl">Downloaded</span><span class="p">:</span>
</span><span class='line'>    <span class="n">indicator</span><span class="p">.</span><span class="n">startAnimating</span><span class="p">()</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">startOperationsForPhotoRecord</span><span class="p">(</span><span class="n">photoDetails</span><span class="p">,</span><span class="nl">indexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">cell</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>花点时间来通读注释区域下面的解释：</p>

<ol>
<li>为了给用户提供反馈，创建<code>UIActivityIndicatorView</code>让后把它设成cell的accessory view。</li>
<li>数据源包含<code>PhotoRecord</code>实例。抓取正确的数据基于当前行的<code>indexPath</code>。</li>
<li>cell的文本标签总是一样的，图片被正确的设置在<code>PhotoRecord</code>中当它被处理的时候，以便你能够设置他们两者，而不管记录的状态。</li>
<li>检查记录，正确的设置activity indicator和文本，然后开始操作（暂时还没实现）</li>
</ol>


<p>你可以移除<code>applySepiaFilter</code>的实现，因为那个将不再被调用了，添加下面的方法到类中来开始操作：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">func</span> <span class="nf">startOperationsForPhotoRecord</span><span class="p">(</span><span class="nl">photoDetails</span><span class="p">:</span> <span class="n">PhotoRecord</span><span class="p">,</span> <span class="nl">indexPath</span><span class="p">:</span> <span class="bp">NSIndexPath</span><span class="p">){</span>
</span><span class='line'>  <span class="k">switch</span> <span class="p">(</span><span class="n">photoDetails</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="p">.</span><span class="nl">New</span><span class="p">:</span>
</span><span class='line'>    <span class="n">startDownloadForRecord</span><span class="p">(</span><span class="n">photoDetails</span><span class="p">,</span> <span class="nl">indexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>
</span><span class='line'>  <span class="k">case</span> <span class="p">.</span><span class="nl">Downloaded</span><span class="p">:</span>
</span><span class='line'>    <span class="n">startFiltrationForRecord</span><span class="p">(</span><span class="n">photoDetails</span><span class="p">,</span> <span class="nl">indexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>
</span><span class='line'>  <span class="k">default</span><span class="o">:</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">&quot;do nothing&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里，你将传递一个<code>PhotoRecord</code>类型的实例带有它的<code>index path</code>。
依据<code>photo record</code>的状态，你选开始进行下载还是加滤镜的步骤。</p>

<blockquote><p>注意：下载图片和给图片加滤镜的方法分开实现，因为这里有可能出现当一个图片正在被下载，用户可能把它滚开了，这样你就不必对它应用滤镜操作。当下一次用户又来到相同的哪行时，你不必重新下载图片；你只需对它应用
图片滤镜即可！ Efficiency rocks! :]</p></blockquote>

<p>现在你需要实现你在上面调用的方法。记住你创建的自定义的类，<code>PendingOperations</code>,保持跟踪操作；现在实际上你可以使用它了！添加下面的方法到类中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">func</span> <span class="nf">startDownloadForRecord</span><span class="p">(</span><span class="nl">photoDetails</span><span class="p">:</span> <span class="n">PhotoRecord</span><span class="p">,</span> <span class="nl">indexPath</span><span class="p">:</span> <span class="bp">NSIndexPath</span><span class="p">){</span>
</span><span class='line'>  <span class="c1">//1</span>
</span><span class='line'>  <span class="k">if</span> <span class="k">let</span> <span class="n">downloadOperation</span> <span class="o">=</span> <span class="n">pendingOperations</span><span class="p">.</span><span class="n">downloadsInProgress</span><span class="p">[</span><span class="n">indexPath</span><span class="p">]</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//2</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">downloader</span> <span class="o">=</span> <span class="n">ImageDownloader</span><span class="p">(</span><span class="nl">photoRecord</span><span class="p">:</span> <span class="n">photoDetails</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">//3</span>
</span><span class='line'>  <span class="n">downloader</span><span class="p">.</span><span class="n">completionBlock</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">downloader</span><span class="p">.</span><span class="n">cancelled</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">pendingOperations</span><span class="p">.</span><span class="n">downloadsInProgress</span><span class="p">.</span><span class="n">removeValueForKey</span><span class="p">(</span><span class="n">indexPath</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">reloadRowsAtIndexPaths</span><span class="p">([</span><span class="n">indexPath</span><span class="p">],</span> <span class="nl">withRowAnimation</span><span class="p">:</span> <span class="p">.</span><span class="n">Fade</span><span class="p">)</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">//4</span>
</span><span class='line'>  <span class="n">pendingOperations</span><span class="p">.</span><span class="n">downloadsInProgress</span><span class="p">[</span><span class="n">indexPath</span><span class="p">]</span> <span class="o">=</span> <span class="n">downloader</span>
</span><span class='line'>  <span class="c1">//5</span>
</span><span class='line'>  <span class="n">pendingOperations</span><span class="p">.</span><span class="n">downloadQueue</span><span class="p">.</span><span class="n">addOperation</span><span class="p">(</span><span class="n">downloader</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">func</span> <span class="nf">startFiltrationForRecord</span><span class="p">(</span><span class="nl">photoDetails</span><span class="p">:</span> <span class="n">PhotoRecord</span><span class="p">,</span> <span class="nl">indexPath</span><span class="p">:</span> <span class="bp">NSIndexPath</span><span class="p">){</span>
</span><span class='line'>  <span class="k">if</span> <span class="k">let</span> <span class="n">filterOperation</span> <span class="o">=</span> <span class="n">pendingOperations</span><span class="p">.</span><span class="n">filtrationsInProgress</span><span class="p">[</span><span class="n">indexPath</span><span class="p">]{</span>
</span><span class='line'>    <span class="k">return</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">let</span> <span class="n">filterer</span> <span class="o">=</span> <span class="n">ImageFiltration</span><span class="p">(</span><span class="nl">photoRecord</span><span class="p">:</span> <span class="n">photoDetails</span><span class="p">)</span>
</span><span class='line'>  <span class="n">filterer</span><span class="p">.</span><span class="n">completionBlock</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">filterer</span><span class="p">.</span><span class="n">cancelled</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">pendingOperations</span><span class="p">.</span><span class="n">filtrationsInProgress</span><span class="p">.</span><span class="n">removeValueForKey</span><span class="p">(</span><span class="n">indexPath</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">reloadRowsAtIndexPaths</span><span class="p">([</span><span class="n">indexPath</span><span class="p">],</span> <span class="nl">withRowAnimation</span><span class="p">:</span> <span class="p">.</span><span class="n">Fade</span><span class="p">)</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">pendingOperations</span><span class="p">.</span><span class="n">filtrationsInProgress</span><span class="p">[</span><span class="n">indexPath</span><span class="p">]</span> <span class="o">=</span> <span class="n">filterer</span>
</span><span class='line'>  <span class="n">pendingOperations</span><span class="p">.</span><span class="n">filtrationQueue</span><span class="p">.</span><span class="n">addOperation</span><span class="p">(</span><span class="n">filterer</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Okey!下面是一个快速列表来帮助你立即上面的代码到底做了什么：</p>

<ol>
<li>首先，检查特定的<code>indexPath</code>来看这里是否已经有一个操作在<code>downloadsInProgress</code>中。假如有，忽略它。</li>
<li>假如没有，通过<code>designated initializer</code>创建一个<code>ImageDownloader</code>实例</li>
<li>添加一个当操作完成时执行的完成block。这是最好的地方让你其余的应用知道一个操作已经完成。注意完成block必须被执行即使这个操作被取消，这相当的重要，所以你需要使用GCD来触发重新载入表视图在主线程。</li>
<li>添加操作到<code>downloadsInProgress</code>中来保持跟踪一些事情。</li>
<li>添加操作到下载队列中。这是你实际获取这些操作开始运行的方法&ndash;队列需要注意的是一旦你添加了操作它就会执行。</li>
</ol>


<p>过滤图片的方法遵循下面相同的类型，除了它使用<code>ImageFiltration</code>和<code>filtrationsInProgress</code>来跟踪操作。作为经验，你应该尝试不要重复这个区域的代码 :]</p>

<p>你做到了！你的工程完成了。构建让后运行看有什么改进在操作上！当你滚动表视图的时候，app并没有停止，还是像它们变得可见一样继续下载图片和给图片加滤镜操作。</p>

<p><img src="http://ww2.sinaimg.cn/mw690/64124373gw1ezkc6fh23sj205x08wdga.jpg" alt="classicphotos-stalled-screenshot" /></p>

<p><em>原来的图片，现在可以滚动了</em></p>

<p>是不是很酷？你能看到随做你的进步让你的应用更易于响应能做出的努力 &ndash;对用户来说更有趣！</p>

<h3>细微的调整</h3>

<p>你已经随着这个教程走过漫长的路！你的小项目现在反应灵敏表明了在原来的版本基础上有很多改进。然而，这里任然有一些遗留的细节我们需要考虑。你是想成为一名伟大的程序员，而不仅仅是一名优秀的程序员！</p>

<p>你可能已经注意到了当你滚动表视图时，那些离屏的cell仍然在处理下载和给图片加滤镜的操作。假如你快速滚动，app将忙于下载和给图片处理滤镜的操作，在列表中从最前面甚至到不可见的地方。理想的情况下app应该对离开屏幕的cells就是现在不可见的取消滤镜操作。</p>

<p>难道你没有把取消的规定放进你的代码里？ 是的，你做了&ndash;现在你应该充分利用它们！:]</p>

<p>回到Xcode，让后打开<code>ListViewController.swift</code>文件。去到<code>tableView(_:cellForRowAtIndexPath:)</code>方法的实现，封装<code>startOperationsForPhotoRecord</code>调用在一个if条件向下面的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tableView</span><span class="p">.</span><span class="n">dragging</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tableView</span><span class="p">.</span><span class="n">decelerating</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nb">self</span><span class="p">.</span><span class="n">startOperationsForPhotoRecord</span><span class="p">(</span><span class="n">photoDetails</span><span class="p">,</span> <span class="nl">indexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>你需要告诉表视图开始操作仅仅当表视图没有滚动的时候。这实际上是<code>UIScrollView</code>的接口，由于<code>UITableView</code>是<code>UIScrollView</code>的子类，你自动继承了这些接口。</p>

<p>下一步，添加到下面<code>UIScrollView</code>代理方法的实现到类中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="kr">override</span> <span class="k">func</span> <span class="nf">scrollViewWillBeginDragging</span><span class="p">(</span><span class="nl">scrollView</span><span class="p">:</span> <span class="bp">UIScrollView</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//1</span>
</span><span class='line'>  <span class="n">suspendAllOperations</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">override</span> <span class="k">func</span> <span class="nf">scrollViewDidEndDragging</span><span class="p">(</span><span class="nl">scrollView</span><span class="p">:</span> <span class="bp">UIScrollView</span><span class="p">,</span> <span class="n">willDecelerate</span> <span class="nl">decelerate</span><span class="p">:</span> <span class="n">Bool</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// 2</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">!</span><span class="n">decelerate</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">loadImagesForOnscreenCells</span><span class="p">()</span>
</span><span class='line'>    <span class="n">resumeAllOperations</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">override</span> <span class="k">func</span> <span class="nf">scrollViewDidEndDecelerating</span><span class="p">(</span><span class="nl">scrollView</span><span class="p">:</span> <span class="bp">UIScrollView</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// 3</span>
</span><span class='line'>  <span class="n">loadImagesForOnscreenCells</span><span class="p">()</span>
</span><span class='line'>  <span class="n">resumeAllOperations</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>快速走查上面的代码显示在下面：</p>

<ol>
<li>当用户开始滚动，你想暂停所有的操作让后看看用户想看到什么。你将要实现<code>suspendAllOperations</code>在一会儿工夫。</li>
<li>假如<code>decelerate</code>的值是<code>false</code>,那就意味着停止拖拽表视图，因此你想恢复暂停的，因为cell离开屏幕取消的操作，启动在屏幕内cells的操作。你将要一起实现<code>loadImagesForOnscreenCells</code>和<code>resumeAllOperations</code>。</li>
<li>代理方法告诉你表视图已经停止滚动，所以你将做和#2条相同的处理。</li>
</ol>


<p>现在，添加下面这些遗失的方法的实现到<code>ListViewController.swift</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">func</span> <span class="nf">suspendAllOperations</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">pendingOperations</span><span class="p">.</span><span class="n">downloadQueue</span><span class="p">.</span><span class="n">suspended</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'>  <span class="n">pendingOperations</span><span class="p">.</span><span class="n">filtrationQueue</span><span class="p">.</span><span class="n">suspended</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">func</span> <span class="nf">resumeAllOperations</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">pendingOperations</span><span class="p">.</span><span class="n">downloadQueue</span><span class="p">.</span><span class="n">suspended</span> <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'>  <span class="n">pendingOperations</span><span class="p">.</span><span class="n">filtrationQueue</span><span class="p">.</span><span class="n">suspended</span> <span class="o">=</span> <span class="nb">false</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">func</span> <span class="nf">loadImagesForOnscreenCells</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//1</span>
</span><span class='line'>  <span class="k">if</span> <span class="k">let</span> <span class="n">pathsArray</span> <span class="o">=</span> <span class="n">tableView</span><span class="p">.</span><span class="n">indexPathsForVisibleRows</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//2</span>
</span><span class='line'>    <span class="k">var</span> <span class="n">allPendingOperations</span> <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">pendingOperations</span><span class="p">.</span><span class="n">downloadsInProgress</span><span class="p">.</span><span class="n">keys</span><span class="p">.</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'>    <span class="n">allPendingOperations</span><span class="p">.</span><span class="n">unionInPlace</span><span class="p">(</span><span class="n">pendingOperations</span><span class="p">.</span><span class="n">filtrationsInProgress</span><span class="p">.</span><span class="n">keys</span><span class="p">.</span><span class="n">array</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//3</span>
</span><span class='line'>    <span class="k">var</span> <span class="n">toBeCancelled</span> <span class="o">=</span> <span class="n">allPendingOperations</span>
</span><span class='line'>    <span class="k">let</span> <span class="n">visiblePaths</span> <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">pathsArray</span> <span class="kt">as</span><span class="o">!</span> <span class="p">[</span><span class="bp">NSIndexPath</span><span class="p">])</span>
</span><span class='line'>    <span class="n">toBeCancelled</span><span class="p">.</span><span class="n">subtractInPlace</span><span class="p">(</span><span class="n">visiblePaths</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//4</span>
</span><span class='line'>    <span class="k">var</span> <span class="n">toBeStarted</span> <span class="o">=</span> <span class="n">visiblePaths</span>
</span><span class='line'>    <span class="n">toBeStarted</span><span class="p">.</span><span class="n">subtractInPlace</span><span class="p">(</span><span class="n">allPendingOperations</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 5</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">indexPath</span> <span class="k">in</span> <span class="n">toBeCancelled</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="k">let</span> <span class="n">pendingDownload</span> <span class="o">=</span> <span class="n">pendingOperations</span><span class="p">.</span><span class="n">downloadsInProgress</span><span class="p">[</span><span class="n">indexPath</span><span class="p">]</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">pendingDownload</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">pendingOperations</span><span class="p">.</span><span class="n">downloadsInProgress</span><span class="p">.</span><span class="n">removeValueForKey</span><span class="p">(</span><span class="n">indexPath</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="k">let</span> <span class="n">pendingFiltration</span> <span class="o">=</span> <span class="n">pendingOperations</span><span class="p">.</span><span class="n">filtrationsInProgress</span><span class="p">[</span><span class="n">indexPath</span><span class="p">]</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">pendingFiltration</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">pendingOperations</span><span class="p">.</span><span class="n">filtrationsInProgress</span><span class="p">.</span><span class="n">removeValueForKey</span><span class="p">(</span><span class="n">indexPath</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 6</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">indexPath</span> <span class="k">in</span> <span class="n">toBeStarted</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">let</span> <span class="n">indexPath</span> <span class="o">=</span> <span class="n">indexPath</span> <span class="kt">as</span> <span class="bp">NSIndexPath</span>
</span><span class='line'>      <span class="k">let</span> <span class="n">recordToProcess</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="n">photos</span><span class="p">[</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">]</span>
</span><span class='line'>      <span class="n">startOperationsForPhotoRecord</span><span class="p">(</span><span class="n">recordToProcess</span><span class="p">,</span> <span class="nl">indexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>suspendAllOperations</code>和<code>resumeAllOperations</code>有一个简单的实现。<code>NSOperationQueues</code>能够被暂停，通过设置<code>suspended</code>接口为<code>true</code>。这将暂停队列里面的所有操作&ndash;你不能单独暂停一个操作。</p>

<p><code>loadImagesForOnscreenCells</code>有一点小复杂。这里发生了什么事？</p>

<ol>
<li>以一个包含了现在表视图可见的<code>index paths</code>的数组开始开始</li>
<li>构造一个所有进行中的操作的集合通过结合所有在下载的进度+所有在处理滤镜的进度。</li>
<li>构造一个<code>index paths</code>集合用来取消操作。开始所有的操作，然后移除可见行的<code>index paths</code>，这样讲留下一个离开屏幕的行正在执行的操作集合</li>
<li>构造一个<code>index paths</code>集合，需要操作启动，用所有可见行的<code>index paths</code>启动，让后移除它们中在进行的操作。</li>
<li>遍历那些被取消的操作，取消它们，然后移除它们的引用从<code>PendingOperations</code>。</li>
<li>遍历那些将要开始的操作，然后对他们每个调用<code>startOperationsForPhotoRecord</code>。</li>
</ol>


<p>构建运行然后你发现一个更流畅，资源管理德更好的应用！给你自己一轮掌声！</p>

<p><img src="http://ww2.sinaimg.cn/mw690/64124373gw1ezkdl5q55nj20jg09qq4h.jpg" alt="improved app" /></p>

<p><em>原来的相册，载入东西一次一个</em></p>

<p>注意到当你完成滚动表视图，在可见区域行的cell的图片立即开始处理。</p>

<h3>何去何从？</h3>

<p>这里是<a href="http://cdn2.raywenderlich.com/wp-content/uploads/2014/10/ClassicPhotos-Final63.zip">completed version of the project</a>。</p>

<blockquote><p>注意：此教程写于<code>Update 17 April 2015: Updated for Xcode 6.3 and Swift 1.2</code>,现在Swift最新版本2.1使用Xcode7+以上编辑会报错，这里打包一个新语法修改版<a href="https://github.com/wangruofeng/ClassicPhotos-Starter-fixed/archive/master.zip">completed fixed version of the project</a>。</p></blockquote>

<p>假如你完成这个工程应该花时间来真正理解它，恭喜你！你可以认为你自己是一位更有价值iOS开发者了比起在教程刚开始的时候！大多数开发的公司是非常幸运的有一个或者两个人正在知道这个东西。</p>

<p>当时请当心 &ndash; 像多层嵌套的blocks,不必要的使用多线程可能让一个工程变得难以理解对维护你代码的人来说。线程可能引入一些难以捉摸的bugs，将永远不出现知道你网络非常慢，或者代码运行在一个更快（或更慢）的设备上，或一个不同数量的核的芯片上时。小心测试，尽量使用<code>Instruments</code>（或者你自己的观察）来确定引入多线程真的有很大改进。</p>

<p>一个有用的特征使用操作时在这里没涉及到就是依赖（<code>dependency</code>）。你可以给一个操作添加一个或者更多的操作的依赖。这个操作不会开始直到它所有依赖的操作完成时。例如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="c1">// MyDownloadOperation is a subclass of NSOperation</span>
</span><span class='line'><span class="k">let</span> <span class="n">downloadOperation</span> <span class="o">=</span> <span class="n">MyDownloadOperation</span><span class="p">()</span>
</span><span class='line'><span class="c1">// MyFilterOperation  is a subclass of NSOperation</span>
</span><span class='line'><span class="k">let</span> <span class="n">filterOperation</span> <span class="o">=</span> <span class="n">MyFilterOperation</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">filterOperation</span><span class="p">.</span><span class="n">addDependency</span><span class="p">(</span><span class="n">downloadOperation</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>移除依赖：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="n">filterOperation</span><span class="p">.</span><span class="n">removeDependency</span><span class="p">(</span><span class="n">downloadOperation</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个工程是否能使用依赖简化呢？把你学到的新技能用起来试一试 ：]
有件非常重要的事需要注意的就是一个依赖操作将仍然启动假如它依赖的操作被取消，还有它将自然完成。你需要牢记在心。</p>

<p>假如你有任何评论或者问题关于这个教程或者<code>NSOperations</code>,请加<a href="https://github.com/wangruofeng/Github_Blog/pulls">Pull request</a>。</p>

<p>译者注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com">http://blog.wangruofeng007.com</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-13T05:14:59+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/13/duo-xian-cheng-zhi-nsoperation/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/13/duo-xian-cheng-zhi-nsoperation/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/13/duo-xian-cheng-zhi-nsoperation/" itemprop="url">多线程之NSOperation</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h3>本文目录</h3>

<ul>
<li>前言</li>
<li>1.NSInvocationOperation</li>
<li>2.NSBlokcOperation</li>
<li>3.NSOperation的其他用法</li>
<li>4.自定义NSOperation</li>
</ul>


<h2>前言</h2>

<p>1.虽然<code>NSThread</code>也可以实现多线程编程，但是需要我们去管理线程的生命周期，还要考虑线程同步、加锁问题，造成一些性能上的开销。我们也可以配合使用<code>NSOperation</code>和<code>NSOperationQueue</code>实现多线程编程，实现步骤大致是这样的</p>

<ul>
<li>先将需要执行的操作封装到一个NSOperation对象中</li>
<li>然后将NSOperation对象添加到NSOperationQueue中</li>
<li>系统会自动将<code>NSOperation</code>中封装的操作放到一条新线程中执行在此过程中，我们根本不用考虑线程的生命周期、同步、加锁等问题下面列举一个应用场景，比如微博的粉丝列表：</li>
</ul>


<p><img src="http://images.cnitblog.com/blog/497279/201304/19122046-b40c752b60a5413290b569f5377ef7f3.png" alt="微博的粉丝列表" /></p>

<p>每一行的头像肯定要从新浪服务器下载图片后才能显示的，而且是需要异步下载。这时候你就可以把每一行的图片下载操作封装到一个<code>NSOperation</code>对象中，上面有6行，所以要创建6个<code>NSOperation</code>对象，然后添加到<code>NSOperationQueue</code>中，分别下载不同的图片，下载完毕后，回到对应的行将图片显示出来。</p>

<p>2 .默认情况下，<code>NSOperation</code>并不具备封装操作的能力，必须使用它的子类，使用NSOperation子类的方式有3种：</p>

<ul>
<li>NSInvocationOperation</li>
<li>NSBlockOperation</li>
<li>自定义子类继承NSOperation，实现内部相应的方法</li>
</ul>


<p>这讲先介绍如何用<code>NSOperation</code>封装一个操作，后面再结合<code>NSOperationQueue</code>来使用。</p>

<h2>1.NSInvocationOperation</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="bp">NSInvocationOperation</span> <span class="o">*</span><span class="n">operation</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSInvocationOperation</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithTarget</span><span class="p">:</span><span class="nb">self</span> <span class="nl">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">run</span><span class="p">:)</span> <span class="nl">object</span><span class="p">:</span><span class="s">@&quot;mj&quot;</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">operation</span> <span class="n">start</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>第1行初始化了一个<code>NSInvocationOperation</code>对象，它是基于一个对象和selector来创建操作</li>
<li>第2行调用了start方法，紧接着会马上执行封装好的操作，也就是会调用self的run:方法，并且将@&ldquo;mj"作为方法参数</li>
<li>这里要注意：默认情况下，调用了start方法后并不会开一条新线程去执行操作，而是在当前线程同步执行操作。只有将operation放到一个NSOperationQueue中，才会异步执行操作。</li>
</ul>


<h2>2.NSBlockOperation</h2>

<h3>a.同步执行一个操作</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="bp">NSBlockOperation</span> <span class="o">*</span><span class="n">operation</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSBlockOperation</span> <span class="nl">blockOperationWithBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(){</span>
</span><span class='line'>         <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;执行了一个新的操作&quot;</span><span class="p">);</span>
</span><span class='line'> <span class="p">}];</span>
</span><span class='line'>  <span class="c1">// 开始执行任务</span>
</span><span class='line'><span class="p">[</span><span class="n">operation</span> <span class="n">start</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>第1行初始化了一个NSBlockOperation对象，它是用一个Block来封装需要执行的操作</li>
<li>第2行调用了start方法，紧接着会马上执行Block中的内容</li>
<li>这里还是在当前线程同步执行操作，并没有异步执行</li>
</ul>


<h3>b.并发执行多个操作</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="bp">NSBlockOperation</span> <span class="o">*</span><span class="n">operation</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSBlockOperation</span> <span class="nl">blockOperationWithBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(){</span>
</span><span class='line'><span class="err">　　</span><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;执行第1次操作，线程：%@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">NSThread</span> <span class="n">currentThread</span><span class="p">]);</span>
</span><span class='line'><span class="p">}];</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="n">operation</span> <span class="nl">addExecutionBlock</span><span class="p">:</span><span class="o">^</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'><span class="err">　　</span><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;又执行了1个新的操作，线程：%@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">NSThread</span> <span class="n">currentThread</span><span class="p">]);</span>
</span><span class='line'><span class="p">}];</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="n">operation</span> <span class="nl">addExecutionBlock</span><span class="p">:</span><span class="o">^</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'><span class="err">　　</span><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;又执行了1个新的操作，线程：%@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">NSThread</span> <span class="n">currentThread</span><span class="p">]);</span>
</span><span class='line'><span class="p">}];</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="n">operation</span> <span class="nl">addExecutionBlock</span><span class="p">:</span><span class="o">^</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'><span class="err">　　</span><span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;又执行了1个新的操作，线程：%@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="bp">NSThread</span> <span class="n">currentThread</span><span class="p">]);</span>
</span><span class='line'><span class="p">}];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 开始执行任务</span>
</span><span class='line'><span class="p">[</span><span class="n">operation</span> <span class="n">start</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>`</p>

<ul>
<li>第1行初始化了一个NSBlockOperation对象</li>
<li>分别在第5、9、13行通过addExecutionBlock:方法添加了新的操作，包括第1行的操作，一共封装了4个操作</li>
<li><p>在第18行调用start方法后，就会并发地执行这4个操作，也就是会在不同线程中执行</p>

<pre><code>  1 2013-02-02 21:38:46.102 thread[4602:c07] 又执行了1个新的操作，线程：&lt;NSThread: 0x7121d50&gt;{name = (null), num = 1}
  2 2013-02-02 21:38:46.102 thread[4602:3f03] 又执行了1个新的操作，线程：&lt;NSThread: 0x742e1d0&gt;{name = (null), num = 5}
  3 2013-02-02 21:38:46.102 thread[4602:1b03] 执行第1次操作，线程：&lt;NSThread: 0x742de50&gt;{name = (null), num = 3}
  4 2013-02-02 21:38:46.102 thread[4602:1303] 又执行了1个新的操作，线程：&lt;NSThread: 0x7157bf0&gt;{name = (null), num = 4}
</code></pre></li>
</ul>


<p>可以看出，每个操作所在线程的num值都不一样，说明是不同线程</p>

<h2>3.NSOperation的其他用法</h2>

<h3>a.取消操作</h3>

<p>operation开始执行之后, 默认会一直执行操作直到完成，我们也可以调用cancel方法中途取消操作</p>

<pre><code>[operation cancel];
</code></pre>

<h3>b.在操作完成后做一些事情</h3>

<p>如果想在一个NSOperation执行完毕后做一些事情，就调用NSOperation的setCompletionBlock方法来设置想做的事情</p>

<pre><code>operation.completionBlock = ^() {
    NSLog(@"执行完毕");
};
</code></pre>

<p>当operation封装的操作执行完毕后，就会回调Block里面的内容</p>

<h2>4.自定义NSOperation</h2>

<p>如果<code>NSInvocationOperation</code>和<code>NSBlockOperation</code>不能满足需求，我们可以直接新建子类继承NSOperation，并添加任何需要执行的操作。如果只是简单地自定义NSOperation，只需要重载<code>-(void)main</code>这个方法，在这个方法里面添加需要执行的操作。</p>

<p>下面写个子类DownloadOperation来下载图片</p>

<h3>a.继承NSOperation，重写main方法</h3>

<p><em>DownloadOperation.h</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#import &lt;Foundation/Foundation.h&gt;</span>
</span><span class='line'><span class="k">@protocol</span> <span class="nc">DownloadOperationDelegate</span>;
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">DownloadOperation</span> : <span class="bp">NSOperation</span>
</span><span class='line'><span class="c1">// 图片的url路径</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">copy</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">imageUrl</span><span class="p">;</span>
</span><span class='line'><span class="c1">// 代理</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">assign</span><span class="p">)</span> <span class="kt">id</span><span class="o">&lt;</span><span class="n">DownloadOperationDelegate</span><span class="o">&gt;</span> <span class="n">delegate</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithUrl:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">url</span> <span class="nf">delegate:</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">DownloadOperationDelegate</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">delegate</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 图片下载的协议</span>
</span><span class='line'><span class="k">@protocol</span> <span class="nc">DownloadOperationDelegate</span> <span class="o">&lt;</span><span class="bp">NSObject</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">downloadFinishWithImage</span><span class="p">:(</span><span class="bp">UIImage</span> <span class="o">*</span><span class="p">)</span><span class="n">image</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>*DownloadOperation.m</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#import &quot;DownloadOperation.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">DownloadOperation</span>
</span><span class='line'><span class="k">@synthesize</span> <span class="n">delegate</span> <span class="o">=</span> <span class="n">_delegate</span><span class="p">;</span>
</span><span class='line'><span class="k">@synthesize</span> <span class="n">imageUrl</span> <span class="o">=</span> <span class="n">_imageUrl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 初始化</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithUrl:</span><span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">url</span> <span class="nf">delegate:</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">DownloadOperationDelegate</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">delegate</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">self</span><span class="p">.</span><span class="n">imageUrl</span> <span class="o">=</span> <span class="n">url</span><span class="p">;</span>
</span><span class='line'>        <span class="nb">self</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">delegate</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// 释放内存</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">dealloc</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">super</span> <span class="n">dealloc</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">_imageUrl</span> <span class="k">release</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 执行主任务</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">main</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 新建一个自动释放池，如果是异步执行操作，那么将无法访问到主线程的自动释放池</span>
</span><span class='line'>    <span class="k">@autoreleasepool</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ....</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>在第22行重载了main方法，等会就把下载图片的代码写到这个方法中</li>
<li>如果这个DownloadOperation是在异步线程中执行操作，也就是说main方法在异步线程调用，那么将无法访问主线程的自动释放池，所以在第24行创建了一个属于当前线程的自动释放池</li>
</ul>


<h3>b.正确响应取消事件</h3>

<ul>
<li>默认情况下，一个NSOperation开始执行之后，会一直执行任务到结束，就比如上面的DownloadOperation，默认会执行完main方法中的所有代码</li>
<li>NSOperation提供了一个cancel方法，可以取消当前的操作。</li>
<li>如果是自定义NSOperation的话，需要手动处理这个取消事件。比如，一旦调用了cancel方法，应该马上终止main方法的执行，并及时回收一些资源。</li>
<li>处理取消事件的具体做法是：在<code>main</code>方法中定期地调用<code>isCancelled</code>方法检测操作是否已经被取消，也就是说是否调用了<code>cancel</code>方法，如果返回YES，表示已取消，则立即让main方法返回。</li>
<li>以下地方可能需要调用<code>isCancelled</code>方法:

<ol>
<li>在执行任何实际的工作之前，也就是在main方法的开头。因为取消可能发生在任何时候，甚至在operation执行之前。</li>
<li>执行了一段耗时的操作之后也需要检测操作是否已经被取消</li>
</ol>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">main</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 新建一个自动释放池，如果是异步执行操作，那么将无法访问到主线程的自动释放池</span>
</span><span class='line'>    <span class="k">@autoreleasepool</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">isCancelled</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 获取图片数据</span>
</span><span class='line'>        <span class="bp">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURL</span> <span class="nl">URLWithString</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">imageUrl</span><span class="p">];</span>
</span><span class='line'>        <span class="bp">NSData</span> <span class="o">*</span><span class="n">imageData</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSData</span> <span class="nl">dataWithContentsOfURL</span><span class="p">:</span><span class="n">url</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">isCancelled</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">url</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>            <span class="n">imageData</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 初始化图片</span>
</span><span class='line'>        <span class="bp">UIImage</span> <span class="o">*</span><span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="bp">UIImage</span> <span class="nl">imageWithData</span><span class="p">:</span><span class="n">imageData</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">isCancelled</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">image</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">([</span><span class="nb">self</span><span class="p">.</span><span class="n">delegate</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">downloadFinishWithImage</span><span class="p">:)])</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// 把图片数据传回到主线程</span>
</span><span class='line'>            <span class="p">[(</span><span class="bp">NSObject</span> <span class="o">*</span><span class="p">)</span><span class="nb">self</span><span class="p">.</span><span class="n">delegate</span> <span class="nl">performSelectorOnMainThread</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">downloadFinishWithImage</span><span class="p">:)</span> <span class="nl">withObject</span><span class="p">:</span><span class="n">image</span> <span class="nl">waitUntilDone</span><span class="p">:</span><span class="nb">NO</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>在第4行main方法的开头就先判断operation有没有被取消。如果被取消了，那就没有必要往下执行了</li>
<li>经过第8行下载图片后，在第10行也需要判断操作有没有被取消</li>
<li>总之，执行了一段比较耗时的操作之后，都需要判断操作有没有被取消</li>
<li>图片下载完毕后，在第26行将图片数据传递给了代理(delegate)对象</li>
</ul>


<p>资料参考：</p>

<ul>
<li>NSHipster 的<a href="http://nshipster.com/nsoperation/">NSOperation</a></li>
<li>雷纯锋的博客的<a href="http://www.leichunfeng.com/blog/2015/07/29/ios-concurrency-programming-operation-queues/">《iOS 并发编程之 Operation Queues》</a></li>
<li>objc的并发编程指南<a href="http://www.objc.io/issue-2/">《Concurrent Programming》</a></li>
<li><a href="http://stackoverflow.com/questions/10373331/nsoperation-vs-grand-central-dispatch">StackOverflow: NSOperation vs. Grand Central Dispatch</a></li>
<li><a href="http://eschatologist.net/blog/?p=232">Blog: When to use NSOperation vs. GCD</a></li>
</ul>


<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com">http://blog.wangruofeng007.com</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-13T05:05:09+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/13/ioszhong-de-hong-mo-shi-jian-he-shou-shi-chu-li/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/13/ioszhong-de-hong-mo-shi-jian-he-shou-shi-chu-li/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/13/ioszhong-de-hong-mo-shi-jian-he-shou-shi-chu-li/" itemprop="url">iOS中的触摸事件和手势处理</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h3>iOS触摸事件分类</h3>

<ul>
<li>触摸事件</li>
<li>加速事件</li>
<li>远程事件</li>
</ul>


<h3>谁能处理触摸事件?</h3>

<p><strong>响应者对象</strong></p>

<p>在iOS中不是任何对象都能处理事件,只有继承了UIResponder的对象才能接收并处理事件.我们称之为<strong>响应者对象</strong>.</p>

<p><code>UIApplication</code>,<code>UIViewController</code>,<code>UIView</code>都继承自<code>UIResponder</code>,因此它们都是响应者对象,都能够接收并处理事件.</p>

<h3>UIResponder</h3>

<p>UIResponder内部提供了方法来处理事件</p>

<ol>
<li><p>触摸事件</p>

<p> 一次完成的触摸过程,会经历3个状态;
 UIView的触摸事件处理</p>

<p> 1.一根或多根手指开始触摸view,系统会自动调用view下面的方法:</p>

<pre><code> - (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event;  //触摸开始
</code></pre>

 2.一根或者多根手指在view上移动，系统会自动调用view下面的方法（随着手指的移动，会持续调用该方法）

<pre><code> - (void)touchesMoved:(NSSet *)touches withEvent:(UIEvent *)event;  //触摸移动
</code></pre>

 3.一根或者多根手指离开view，系统会自动调用view下面的方法

<pre><code> - (void)touchesEnded:(NSSet *)touches withEvent:(UIEvent *)event;  //触摸结束
</code></pre>

 4.触摸结束前，某个系统事件（例如电话呼入 ）会打断触摸过程，系统会自动调用view下面的方法

<pre><code> - (void)touchesCancelled:(NSSet *)touches withEvent:(UIEvent *)event; //触摸取消(可能会经历)
</code></pre>

 4个触摸事件的处理方法中，都有 NSSet <em>touches 和 UIEvent </em>event 两个参数:

<ul>
<li>一次完整的触摸过程，只会产生一个事件对象，4个触摸方法都是同一个event参数</li>
<li>如果两根手指同时触摸一个view，那么view只会调用一次 touchesBegan:withEvent: 方法，touches参数中装着两个UITouch对象；</li>
<li>如果这两根手指一前一后分开触摸同一个view，那么view会分别调用两次 touchesBegan:withEvent:方法， 并且每次调用时的touches参数只包含一个UITouch对象；</li>
<li>根据touches中UITouch个数可以判断出使单点触摸还是多点触摸</li>
</ul>


<p> 提示：touches中存放的都是UITouch对象。</p></li>
<li><p>加速计事件</p>

<pre><code> - (void)motionBegan:(UIEventSubtype)motion withEvent:(UIEvent *)event;
 - (void)motionEnded:(UIEventSubtype)motion withEvent:(UIEvent *)event;
 - (void)motionCancelled:(UIEventSubtype)motion withEvent:(UIEvent *)event;
</code></pre></li>
<li><p>远程控制事件</p>

<pre><code> - (void)remoteControlReceivedWithEvent:(UIEvent *)event;
</code></pre></li>
</ol>


<h3>UITouch</h3>

<p>当用户用一根手指触摸屏幕时，会创建一个与手指相关联的UITouch对象；一根手指对应一个UITouch对象
UITouch的作用:</p>

<ul>
<li>保存跟手指相关的信息，比如触摸的位置、时间、阶段；</li>
<li>当手指移动时，系统会更新同一个UITouch对象，使之能够一直保存该手指的触摸位置；</li>
<li>当手指离开屏幕时，系统会销毁相应的UITouch对象。</li>
</ul>


<p>提示：iPhone开发中，要避免使用双击事件。</p>

<p>UITouch的属性:
触摸产生时所处的窗口:</p>

<pre><code>@property(nonatomic,readonly,retain) UIWindow *window;
</code></pre>

<p>触摸产生时所处的视图</p>

<pre><code> @property(nonatomic,readonly,retain) UIView *view;
</code></pre>

<p>短时间内点按屏幕的次数，可以根据tapCount判断单击、双击或更多地点击</p>

<pre><code> @property(nonatomic,readonly) NSUInteger tapCount;
</code></pre>

<p>记录了触摸事件产生或变化时的时间，单位是秒</p>

<pre><code> @property(nonatomic,readonly) NSTimeInterval timestamp;
</code></pre>

<p>当前触摸事件所处的状态</p>

<pre><code>@property(nonatomic,readonly) UITouchPhase phase;
/*
UITouchPhase是一个枚举类型，包含：
UITouchPhaseBegan（触摸开始）
UITouchPhaseMoved（接触点移动）
UITouchPhaseStationary（接触点无移动）
UITouchPhaseEnded（触摸结束）
UITouchPhaseCancelled（触摸取消）*/
</code></pre>

<p>UITouch的方法：</p>

<pre><code>- (CGPoint)locationInView:(UIView *)view;
</code></pre>

<p>1.返回值表示触摸在view上的位置；</p>

<p>2.这里返回的位置是针对view坐标系的,（以view的左上角为原点（0，0））；</p>

<p>3.调用时传入的view参数为nil 的话，返回的是触摸点在UIWindow的位置。</p>

<pre><code>- (CGPoint)previousLocationInView:(UIView *)view;
</code></pre>

<p>该方法记录了前一个触摸点的位置；</p>

<h3>UIEvent</h3>

<blockquote><p>每产生一个事件，就会产生一个UIEvent对象；</p>

<p>UIEvent:称为事件对象，记录事件产生的时刻和类型。</p></blockquote>

<p>常见属性：
1.事件类型</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">@property</span><span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span><span class="k">readonly</span><span class="p">)</span> <span class="n">UIEventType</span>  <span class="n">type</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span><span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span><span class="k">readonly</span><span class="p">)</span> <span class="n">UIEventSubtype</span>  <span class="n">subtype</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span>
</span><span class='line'><span class="nf">NS_ENUM</span><span class="p">(</span><span class="bp">NSInteger</span><span class="p">,</span> <span class="n">UIEventType</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">UIEventTypeTouches</span><span class="p">,</span>
</span><span class='line'>    <span class="n">UIEventTypeMotion</span><span class="p">,</span>
</span><span class='line'>    <span class="n">UIEventTypeRemoteControl</span><span class="p">,</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="k">typedef</span>
</span><span class='line'><span class="nf">NS_ENUM</span><span class="p">(</span><span class="bp">NSInteger</span><span class="p">,</span> <span class="n">UIEventSubtype</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// available in iPhone OS 3.0</span>
</span><span class='line'>    <span class="n">UIEventSubtypeNone</span>                              <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">// for UIEventTypeMotion, available in iPhone OS 3.0</span>
</span><span class='line'>    <span class="n">UIEventSubtypeMotionShake</span>                       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">// for UIEventTypeRemoteControl, available in iOS 4.0</span>
</span><span class='line'>    <span class="n">UIEventSubtypeRemoteControlPlay</span>                 <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span><span class='line'>    <span class="n">UIEventSubtypeRemoteControlPause</span>                <span class="o">=</span> <span class="mi">101</span><span class="p">,</span>
</span><span class='line'>    <span class="n">UIEventSubtypeRemoteControlStop</span>                 <span class="o">=</span> <span class="mi">102</span><span class="p">,</span>
</span><span class='line'>    <span class="n">UIEventSubtypeRemoteControlTogglePlayPause</span>      <span class="o">=</span> <span class="mi">103</span><span class="p">,</span>
</span><span class='line'>    <span class="n">UIEventSubtypeRemoteControlNextTrack</span>            <span class="o">=</span> <span class="mi">104</span><span class="p">,</span>
</span><span class='line'>    <span class="n">UIEventSubtypeRemoteControlPreviousTrack</span>        <span class="o">=</span> <span class="mi">105</span><span class="p">,</span>
</span><span class='line'>    <span class="n">UIEventSubtypeRemoteControlBeginSeekingBackward</span> <span class="o">=</span> <span class="mi">106</span><span class="p">,</span>
</span><span class='line'>    <span class="n">UIEventSubtypeRemoteControlEndSeekingBackward</span>   <span class="o">=</span> <span class="mi">107</span><span class="p">,</span>
</span><span class='line'>    <span class="n">UIEventSubtypeRemoteControlBeginSeekingForward</span>  <span class="o">=</span> <span class="mi">108</span><span class="p">,</span>
</span><span class='line'>    <span class="n">UIEventSubtypeRemoteControlEndSeekingForward</span>    <span class="o">=</span> <span class="mi">109</span><span class="p">,</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>2.事件产生的时间</p>

<pre><code>@property(nonatomic,readonly) NSTimeInterval  timestamp;
</code></pre>

<p> UIEvent还提供了相应的方法可以获得在某个view上面的触摸对象（UITouch）。</p>

<p> 触摸事件的产生：</p>

<ol>
<li><p>发生触摸事件后，系统会将该事件加入到一个由UIApplication管理的事件队列中；</p></li>
<li><p>UIApplication会从事件队列中取出最前面的事件，并将事件分发下去以便处理，通常，先发送事件给应用程序的主窗口（keyWindow）；</p></li>
<li><p>主窗口会在视图层次结构中找到一个最合适的视图控件来处理触摸事件，这也是整个事件处理过程的第一步；</p></li>
<li><p>找到合适的视图控件后，就会调用视图控件的touches方法来做具体的事件处理。</p></li>
</ol>


<p>触摸事件的传递：</p>

<blockquote><p>触摸事件的传递是从父控件传递到子控件；</p>

<p>如果父控件不能接收触摸事件，那么子控件就不可能接收到触摸事件。</p></blockquote>

<p><img src="http://ww4.sinaimg.cn/mw690/64124373gw1eznrp087anj205t07rdfx.jpg" alt="触摸事件" />
<img src="http://ww2.sinaimg.cn/mw690/64124373gw1eznrrf36ymj2097077dhc.jpg" alt="触摸事件2" /></p>

<p>UIView不接收触摸事件的三种情况:
不接受用户交互 ：</p>

<ol>
<li><p>userInteractionEnable = NO;</p></li>
<li><p>隐藏 ：hidden = YES;</p></li>
<li><p>透明：alpha = 0.0 ~ 0.01</p></li>
</ol>


<p>提示：UIImageView的userInteractionEnable默认就是NO，因此UIImageView以及它的子控件默认是不能接收触摸事件的。</p>

<p>触摸事件处理的详细过程：</p>

<ol>
<li><p>用户点击屏幕后产生的一个触摸事件，经过一些列的传递过程后，会找到最合适的视图控件来处理这个事件</p></li>
<li><p>找到最合适的视图控件后，就会调用控件的touches方法来作具体的事件处理</p>

<p> touchesBegan…</p>

<p> touchesMoved…</p>

<p> touchedEnded…</p></li>
</ol>


<p>这些touches方法的默认做法是将事件顺着响应者链条向上传递，将事件交给上一个响应者进行处理</p>

<p>响应者链的事件传递过程：</p>

<ol>
<li><p>如果view的控制器存在，就传递给控制器；如果控制器不存在，则将其传递给它的父视图；</p></li>
<li><p>在视图层次结构最顶级的视图，如果也不能处理收到的事件或消息，则其将事件或消息传递给window对象进行处理。</p></li>
<li><p>如果window对象也不处理，则其将事件或消息传递给UIApplication对象；</p></li>
<li><p>如果UIApplication也不能处理该事件或消息，则将其丢弃</p></li>
</ol>


<h3>监听触摸事件的做法</h3>

<p>如果想监听一个view上面的触摸事件，之前的做法是：</p>

<ol>
<li><p>自定义一个view；</p></li>
<li><p>实现view的touches方法，在方法内部实现具体处理代码。</p>

<p> 通过touches方法监听view触摸事件，有很明显的几个缺点：</p>

<ul>
<li><p>必须得自定义view；</p></li>
<li><p>由于是在view内部的touches方法中监听触摸事件，因此默认情况下，无法让其他外界对象监听view的触摸事件；</p></li>
<li><p>不容易区分用户的具体手势行为。</p></li>
</ul>
</li>
</ol>


<p>iOS 3.2之后，苹果推出了手势识别功能（Gesture Recognizer）,在触摸事件处理方面，大大简化了开发者的开发难度。</p>

<h3>UIGestureRescognizer</h3>

<p>为了完成手势识别，必须借助于手势识别器：UIGestureRecognizer 。</p>

<p>利用UIGestureRecognizer,能轻松识别用户在某个view上面做的一些常见手势。</p>

<p>UIGestureRecognizer是一个抽象类，定义了所有的手势基本行为，使用它的子类才能处理具体的手势</p>

<ul>
<li>UITapGestureRecognizer(敲击)</li>
<li>UIPinchGestureRecognizer(捏合，用于缩放)</li>
<li>UIPanGestureRecognizer(拖拽)</li>
<li>UISwipeGestureRecognizer(轻扫)</li>
<li>UIRotationGestureRecognizer(旋转)</li>
<li>UILongPressGestureRecognizer(长按)</li>
</ul>


<p>每一个手势识别器的用法都差不多，比如UITapGestureRecognizer的使用步骤如下:</p>

<ol>
<li><p>创建手势识别器对象；</p>

<p> UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc] init];</p></li>
<li><p>设置手势识别器对象的具体属性；</p>

<pre><code> // 连续敲击2次
 tap.numberOfTapsRequired = 2;
 // 需要2根手指一起敲击
 tap.numberOfTouchesRequired = 2;
</code></pre></li>
<li><p>添加手势识别器到对应的view上</p>

<p> [self.iconView addGestureRecognizer:tap];</p></li>
<li><p>监听手势的触发</p>

<p> [tap addTarget:self action:@selector(tapIconView:)];</p></li>
</ol>


<p>手势识别的状态</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">typedef</span> <span class="nf">NS_ENUM</span><span class="p">(</span><span class="bp">NSInteger</span><span class="p">,</span> <span class="n">UIGestureRecognizerState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// 没有触摸事件发生，所有手势识别的默认状态</span>
</span><span class='line'>    <span class="n">UIGestureRecognizerStatePossible</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">// 一个手势已经开始但尚未改变或者完成时</span>
</span><span class='line'>    <span class="n">UIGestureRecognizerStateBegan</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">// 手势状态改变</span>
</span><span class='line'>    <span class="n">UIGestureRecognizerStateChanged</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">// 手势完成</span>
</span><span class='line'>    <span class="n">UIGestureRecognizerStateEnded</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">// 手势取消，恢复至Possible状态</span>
</span><span class='line'>    <span class="n">UIGestureRecognizerStateCancelled</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">// 手势失败，恢复至Possible状态</span>
</span><span class='line'>    <span class="n">UIGestureRecognizerStateFailed</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">// 识别到手势识别</span>
</span><span class='line'>    <span class="n">UIGestureRecognizerStateRecognized</span> <span class="o">=</span> <span class="n">UIGestureRecognizerStateEnded</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>参考资料：<a href="http://my.oschina.net/aofe/blog/268749">傲风凌寒的博客</a></p>

<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com">http://blog.wangruofeng007.com</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-13T04:46:48+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/13/iosli-cheng-bei-shi-jian/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/13/iosli-cheng-bei-shi-jian/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/13/iosli-cheng-bei-shi-jian/" itemprop="url">iOS里程碑事件</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><blockquote><p>记录iOS各种重要里程碑事件</p></blockquote>

<h2>私有成员变量的实现</h2>

<p>1.0时代，在.h文件采用<code>@private</code>关键词</p>

<pre><code>@interface ViewController : UIViewController {
    @private
    NSInteger _value;
}
</code></pre>

<p>2.0时代 通过在.m文件通过<code>匿名Category</code></p>

<pre><code>@interface ViewController ()

@property (nonatomic) NSInteger value;

@end
</code></pre>

<p>3.0时代 2013 年的 WWDC 允许在 .m 的 <code>@implementation</code>中</p>

<pre><code>@implementation ViewController {
    NSInteger _value;
}
</code></pre>

<h2>ARC推出</h2>

<p>2011</p>

<h2>自动生成getter和setter方法的<code>@synthesize</code></h2>

<p>2012</p>

<h2>AutoLayout引入</h2>

<p>iOS 6.0</p>

<h2>Swift</h2>

<ul>
<li><a href="http://baike.baidu.com/view/404495.htm">WWDC</a> 1.0 版本发布 &ndash; 2014.06.02</li>
<li>Swift 2.0发布   &ndash; 2015.08.07</li>
<li>Open Source &ndash; 2015.12.04</li>
</ul>


<h2>Size Classes</h2>

<p>iOS 8.0</p>

<h2>Blocks</h2>

<p><a href="https://en.wikipedia.org/wiki/Mac_OS_X_Snow_Leopard">Mac OS X 10.6 &ldquo;Snow Leopard&rdquo;</a> and <a href="https://en.wikipedia.org/wiki/IOS">iOS 4.0</a></p>

<h2>Objective-C 2.0</h2>

<p>At the <a href="https://en.wikipedia.org/wiki/Apple_Worldwide_Developers_Conference">2006 Worldwide Developers Conference</a> release of <a href="https://en.wikipedia.org/wiki/Objective-C#Objective-C_2.0">Objective-C 2.0</a></p>

<h2>Watch OS</h2>

<p>2015.05.21</p>

<h2>iOS 2.1 to iOS 2.2 API Differences</h2>

<p>Added frameworks:</p>

<ul>
<li>AVFoundation</li>
</ul>


<h2>iOS 2.2 to iOS 3.0 API Differences</h2>

<p>Added frameworks:</p>

<ul>
<li>CoreData</li>
<li>ExternalAccessory</li>
<li>GameKit</li>
<li>MapKit</li>
<li>MessageUI</li>
<li>MobileCoreServices</li>
<li>StoreKit</li>
</ul>


<h2>iOS 3.2 to iOS 4.0 API Differences</h2>

<p>Added frameworks:</p>

<ul>
<li>Accelerate</li>
<li>AssetsLibrary</li>
<li>CoreMedia</li>
<li>CoreMotion</li>
<li>CoreTelephony</li>
<li>CoreVideo</li>
<li>EventKit</li>
<li>EventKitUI</li>
<li>iAd</li>
<li>ImageIO</li>
<li>QuickLook</li>
</ul>


<h2>iOS 4.3 to iOS 5.0 API Differences</h2>

<p>Added frameworks</p>

<ul>
<li>Accounts</li>
<li>CoreBluetooth</li>
<li>CoreImage</li>
<li>GLKit</li>
<li>GSS</li>
<li>NewsstandKit</li>
<li>Twitter</li>
</ul>


<h2>5.1 to iOS 6.0 API Differences</h2>

<p>Added frameworks</p>

<ul>
<li>AdSupport</li>
<li>MediaToolbox</li>
<li>PassKit</li>
<li>Social</li>
</ul>


<h2>6.1 to iOS 7.0 API Differences</h2>

<p>Added frameworks</p>

<ul>
<li>GameController</li>
<li>JavaScriptCore</li>
<li>MediaAccessibility</li>
<li>MultipeerConnectivity</li>
<li>SafariServices</li>
<li>SpriteKit</li>
</ul>


<h2>iOS 7.1 to iOS 8.0 API Differences</h2>

<p>Added frameworks</p>

<ul>
<li>Accelerate</li>
<li>Accounts</li>
<li>AddressBook</li>
<li>AddressBookUI</li>
<li>AudioToolbox</li>
<li>AudioUnit</li>
<li>AVFoundation</li>
<li>AVKit (Added)</li>
<li>CFNetwork</li>
<li>CloudKit (Added)</li>
<li>CoreAudio</li>
<li>CoreAudioKit (Added)</li>
<li>CoreAuthentication (Added)</li>
<li>CoreBluetooth</li>
<li>CoreData</li>
<li>CoreFoundation</li>
<li>CoreImage</li>
<li>CoreLocation</li>
<li>CoreMedia</li>
<li>CoreMotion</li>
<li>CoreText</li>
<li>CoreVideo</li>
<li>EventKit</li>
<li>EventKitUI</li>
<li>ExternalAccessory</li>
<li>Foundation</li>
<li>GameController</li>
<li>GameKit</li>
<li>GLKit</li>
<li>GSS</li>
<li>HealthKit (Added)</li>
<li>HomeKit (Added)</li>
<li>iAd</li>
<li>ImageIO</li>
<li>IOKit</li>
<li>JavaScriptCore</li>
<li>LocalAuthentication (Added)</li>
<li>MapKit</li>
<li>MediaAccessibility</li>
<li>MediaPlayer</li>
<li>MessageUI</li>
<li>Metal (Added)</li>
<li>MobileCoreServices</li>
<li>MultipeerConnectivity</li>
<li>NetworkExtension (Added)</li>
<li>NewsstandKit</li>
<li>NotificationCenter (Added)</li>
<li>OpenGLES</li>
<li>PassKit</li>
<li>Photos (Added)</li>
<li>PhotosUI (Added)</li>
<li>PushKit (Added)</li>
<li>QuartzCore</li>
<li>QuickLook</li>
<li>SceneKit (Added)</li>
<li>Security</li>
<li>Social</li>
<li>SpriteKit</li>
<li>StoreKit</li>
<li>UIKit</li>
<li>VideoToolbox</li>
<li>WebKit (Added)</li>
</ul>


<h2>iOS 8.3 to iOS 9.0 API Differences</h2>

<p>Added frameworks</p>

<p>Objective-C</p>

<ul>
<li>/usr/include</li>
<li>Accelerate</li>
<li>Accounts</li>
<li>AddressBook</li>
<li>AddressBookUI</li>
<li>AssetsLibrary</li>
<li>AudioToolbox</li>
<li>AudioUnit</li>
<li>AVFoundation</li>
<li>AVKit</li>
<li>CFNetwork</li>
<li>CloudKit</li>
<li>Contacts (Added)</li>
<li>ContactsUI (Added)</li>
<li>CoreAudio</li>
<li>CoreAudioKit</li>
<li>CoreBluetooth</li>
<li>CoreData</li>
<li>CoreFoundation</li>
<li>CoreGraphics</li>
<li>CoreImage</li>
<li>CoreLocation</li>
<li>CoreMedia</li>
<li>CoreMIDI</li>
<li>CoreMotion</li>
<li>CoreSpotlight (Added)</li>
<li>CoreTelephony</li>
<li>CoreText</li>
<li>CoreVideo</li>
<li>EventKit</li>
<li>EventKitUI</li>
<li>ExternalAccessory</li>
<li>Foundation</li>
<li>GameController</li>
<li>GameKit</li>
<li>GameplayKit (Added)</li>
<li>GLKit</li>
<li>GSS</li>
<li>HealthKit</li>
<li>HomeKit</li>
<li>iAd</li>
<li>ImageIO</li>
<li>JavaScriptCore</li>
<li>LocalAuthentication</li>
<li>MapKit</li>
<li>MediaPlayer</li>
<li>MediaToolbox</li>
<li>MessageUI</li>
<li>Metal</li>
<li>MetalKit (Added)</li>
<li>MetalPerformanceShaders (Added)</li>
<li>MobileCoreServices</li>
<li>ModelIO (Added)</li>
<li>MultipeerConnectivity</li>
<li>NetworkExtension</li>
<li>NewsstandKit</li>
<li>OpenAL</li>
<li>PassKit</li>
<li>Photos</li>
<li>PushKit</li>
<li>QuartzCore</li>
<li>QuickLook</li>
<li>ReplayKit (Added)</li>
<li>SafariServices</li>
<li>SceneKit</li>
<li>Security</li>
<li>SpriteKit</li>
<li>StoreKit</li>
<li>SystemConfiguration</li>
<li>UIKit</li>
<li>VideoToolbox</li>
<li>WatchConnectivity (Added)</li>
<li>WatchKit</li>
<li>WebKit</li>
</ul>


<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com">http://blog.wangruofeng007.com</a></p>
</div>
  
  


        </article>
      
    </div>

    <ul class="pager">
      
        <li class="previous"><a href="/posts/3">&larr;&nbsp;Older</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
        <li class="next"><a href="/index.html">Newer&nbsp;&rarr;</a></li>
      
    </ul>
  </div>

  
    <aside class="sidebar col-md-3">
      
        <section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/animation/'>animation (2)</a></li>
<li class='category'><a href='/blog/categories/database/'>database (7)</a></li>
<li class='category'><a href='/blog/categories/design-patterns/'>design_patterns (1)</a></li>
<li class='category'><a href='/blog/categories/efficiency/'>efficiency (2)</a></li>
<li class='category'><a href='/blog/categories/favorite/'>favorite (3)</a></li>
<li class='category'><a href='/blog/categories/ios/'>ios (20)</a></li>
<li class='category'><a href='/blog/categories/memory-management/'>memory_management (1)</a></li>
<li class='category'><a href='/blog/categories/multithreading/'>multithreading (1)</a></li>
<li class='category'><a href='/blog/categories/networking/'>networking (6)</a></li>
<li class='category'><a href='/blog/categories/objective-c/'>objective-c (4)</a></li>
<li class='category'><a href='/blog/categories/skill/'>skill (5)</a></li>
<li class='category'><a href='/blog/categories/swift/'>swift (1)</a></li>

  </ul>
</section>
<section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/blog/2016/01/18/tableviewxing-neng-you-hua/">TableView性能优化</a>
    
    <a class="list-group-item " href="/blog/2016/01/16/ios-animation-swift-ban/">iOS Animation Swift 版</a>
    
    <a class="list-group-item " href="/blog/2016/01/15/nsurlsession/">NSURLSession 教程</a>
    
    <a class="list-group-item " href="/blog/2016/01/14/iosxian-cheng-an-quan-suo/">iOS线程安全-锁</a>
    
    <a class="list-group-item " href="/blog/2016/01/14/sqlite-jiao-cheng-qi/">SQLite_教程(七)</a>
    
    <a class="list-group-item " href="/blog/2016/01/14/sqlite-jiao-cheng-liu/">SQLite_教程(六)</a>
    
    <a class="list-group-item " href="/blog/2016/01/14/sqlite-jiao-cheng-wu/">SQLite_教程(五)</a>
    
    <a class="list-group-item " href="/blog/2016/01/13/sqlite-jiao-cheng-si/">SQLite_教程(四)</a>
    
    <a class="list-group-item " href="/blog/2016/01/13/sqlite-jiao-cheng-san/">SQLite_教程(三)</a>
    
    <a class="list-group-item " href="/blog/2016/01/13/sqlite-jiao-cheng-er/">SQLite_教程(二)</a>
    
    <a class="list-group-item " href="/blog/2016/01/13/sqlite-jiao-cheng-%5B%3F%5D/">SQLite_教程(一)</a>
    
    <a class="list-group-item " href="/blog/2016/01/13/cocoapodsshi-yong-zhi-nan/">CocoaPods使用指南</a>
    
  </div>
</section>





<section>
  <h2>About Me</h2>
  <p>嗨,我是王若风。🍀</p>
  <p>来自美丽的天府の国,现居深圳。</p>
  <p>专注于移动互联网,热爱摄影旅行。</p>
  <p>正在修行,探寻程序の美!</p>
</section>

      
    </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  <small>
  本站点采用<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享 署名-非商业性使用-相同方式共享 4.0 国际 许可协议</a>
  Copyright &copy; 2016 - 王若风<br>
  </small>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'wangruofeng';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr.js"></script>


  </body>
</html>
