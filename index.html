<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>王若风的技术博客</title>
  <meta name="author" content="王若风">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://wangruofeng.github.io/">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="王若风的技术博客" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://wangruofeng.github.io/">
  <meta property="og:title" content="王若风的技术博客">
  <meta property="og:description" content="王若风的技术博客">

  <script src="/javascripts/libs/jquery/jquery-2.1.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">


  
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  
   <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-72379345-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">王若风的技术博客</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li >
                    <a href="/about">About</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="sitesearch" value="wangruofeng.github.io">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9">
    <div class="blog-index" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="王若风的技术博客" />
    <meta itemprop="description" content="王若风的技术博客" />
    <meta itemprop="url" content="http://wangruofeng.github.io" />
      
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-18T22:00:04+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/18/tableviewxing-neng-you-hua/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/18/tableviewxing-neng-you-hua/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/18/tableviewxing-neng-you-hua/" itemprop="url">TableView性能优化</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><blockquote><p>此文整理一下TableView优化相关的方案和思路。</p></blockquote>

<h4>TableView为什么会卡？</h4>

<p>主要由以下原因：</p>

<ul>
<li><code>cellForRowAtIndexPath:</code>方法中处理了过多业务</li>
<li>tableviewCell的subview层级太复杂，做了大量透明处理</li>
<li>cell的height动态变化时计算方式不对</li>
</ul>


<h4>优化核心思想：<code>UITableViewCell</code>重用机制</h4>

<p>简单的理解就是：UITableView只会创建一屏幕（或一屏幕多一点）的UITableViewCell，其他都是从中取出来重用的。每当Cell滑出屏幕时，就会放入到一个集合（或数组）中（这里就相当于一个重用池），当要显示某一位置的Cell时，会先去集合（或数组）中取，如果有，就直接拿来显示；如果没有，才会创建。这样做的好处可想而知，极大的减少了内存的开销。</p>

<h4>Tips：</h4>

<ol>
<li>提前计算并缓存好高度（布局），因为<code>heightForRowAtIndexPath:</code>是调用最频繁的方法；</li>
<li>异步绘制,遇到复杂界面,参考<code>Facebook</code>的<code>AsyncDisplayKit</code>和<a href="https://github.com/ibireme/YYAsyncLayer">YYAsyncLayer</a>异步绘制框架；</li>
<li>缓存图片（<code>SDWebImage</code>），提前处理好<code>UIImageView</code>图片的尺寸按需加载而不是加载原图；</li>
<li>计算等耗时操作异步处理，处理完再回主线程更新UI；</li>
<li>图文混排不定高度采用<code>CoreText</code>排版，缓存Cell高度参考<a href="https://github.com/ibireme/YYKit">YYKit</a>；</li>
<li>实现Cell的<code>drawRect:</code>方法直接绘制，减少<code>UIView</code>，<code>UIImageView</code>，<code>UILabel</code>等容器的使用。</li>
</ol>


<h4>Bonus：</h4>

<ol>
<li>正确使用reuseIdentifier来重用Cell；</li>
<li>尽量少用或不用透明图层或View；</li>
<li>如果Cell内现实的内容来自web，使用异步加载，缓存请求结果；</li>
<li>减少subviews的数量在<code>heightForRowAtIndexPath:</code>中尽量不使用<code>cellForRowAtIndexPath:</code>，如果你需要用到它，只用一次然后缓存结果；</li>
<li>尽量少用addView给Cell动态添加View，可以初始化时就添加，然后通过hide来控制是否显示；</li>
<li>固定高度不要实现<code>heightForRowAtIndexPath:</code>方法。</li>
</ol>


<p>可以通过实现以下方法，可以减少高度计算次数</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">)</span> <span class="n">CGFloat</span> <span class="n">rowHeight</span><span class="p">;</span>             <span class="c1">// will return the default value if unset</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">)</span> <span class="n">CGFloat</span> <span class="n">sectionHeaderHeight</span><span class="p">;</span>   <span class="c1">// will return the default value if unset</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">)</span> <span class="n">CGFloat</span> <span class="n">sectionFooterHeight</span><span class="p">;</span>   <span class="c1">// will return the default value if unset</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">)</span> <span class="n">CGFloat</span> <span class="n">estimatedRowHeight</span> <span class="n">NS_AVAILABLE_IOS</span><span class="p">(</span><span class="mi">7</span><span class="n">_0</span><span class="p">);</span> <span class="c1">// default is 0, which means there is no estimate</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">)</span> <span class="n">CGFloat</span> <span class="n">estimatedSectionHeaderHeight</span> <span class="n">NS_AVAILABLE_IOS</span><span class="p">(</span><span class="mi">7</span><span class="n">_0</span><span class="p">);</span> <span class="c1">// default is 0, which means there is no estimate</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">)</span> <span class="n">CGFloat</span> <span class="n">estimatedSectionFooterHeight</span> <span class="n">NS_AVAILABLE_IOS</span><span class="p">(</span><span class="mi">7</span><span class="n">_0</span><span class="p">);</span> <span class="c1">// default is 0, which means there is no estimate</span>
</span></code></pre></td></tr></table></div></figure>


<p>参考资料：</p>

<ul>
<li><a href="http://ealui.com/index.php/blog/view/code-uitableviewcell-optimizations">code-uitableviewcell-optimizations-part-1</a></li>
<li><a href="http://ealui.com/blog/view/code-uitableviewcell-optimization-part-2">code-uitableviewcell-optimization-part-2</a></li>
<li><a href="https://medium.com/ios-os-x-development/perfect-smooth-scrolling-in-uitableviews-fd609d5275a5#.b176bxlm3">Perfect smooth scrolling in UITableViews</a></li>
<li><a href="http://blog.sunnyxx.com/2015/05/17/cell-height-calculation/">优化UITableViewCell高度计算的那些事</a></li>
<li><a href="http://www.cocoachina.com/ios/20150602/11968.html">详细整理：UITableView优化技巧</a></li>
<li><a href="http://www.cnblogs.com/wengzilin/p/4288027.html">UITableview性能优化总结</a></li>
<li><a href="https://github.com/nixzhu/dev-blog/blob/master/2014-11-22-asyncdisplaykit-tutorial-achieving-60-fps-scrolling.md">AsyncDisplayKit 教程：达到 60 FPS 的滚动帧率</a></li>
<li><a href="https://github.com/facebook/AsyncDisplayKit">AsyncDisplayKit</a></li>
<li><a href="https://github.com/ibireme/YYAsyncLayer">YYAsyncLayer</a></li>
</ul>

</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-16T19:34:06+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/16/ios-animation-swift-ban/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/16/ios-animation-swift-ban/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/16/ios-animation-swift-ban/" itemprop="url">iOS Animation Swift 版</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p><img src="http://ww2.sinaimg.cn/large/64124373gw1f01qjo2k00j21g00ejjvd.jpg" alt="coreAnimation" /></p>

<h3>简介</h3>

<p>此文主要记录我学习iOS的动画相关内容用<code>Swift</code>语言，记录下来以供参考，不定时更新。</p>

<h3>目录结构</h3>

<ul>
<li>Section I: View 动画

<ul>
<li>View animation</li>
<li>弹簧动画 - Springs</li>
<li>转场动画 - Transitions</li>
<li>关键帧动画 - Keyframe</li>
</ul>
</li>
<li>Section II: Auto Layout 动画</li>
<li>Section III: Layer 动画</li>
<li>Section IV: 3D 动画</li>
<li>Section V: 未来类型的动画</li>
<li>Section VI: View Controller 动画</li>
<li>Section VII：第三方动画库</li>
</ul>


<h4>Section I: View 动画</h4>

<h5>1.View animation</h5>

<p>简介：view 的动画主要是通过UIView的类方法创建，动画内容一般
放在block里面，可以镶嵌使用，构成链式动画，主要有3个方法,三个访法只需会参数最多的那个就行，函数名<code>animateWithDuration(_:delay:options:animations:completion:)</code>，其他的使用起来都类似。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">class</span> <span class="k">func</span> <span class="n">animateWithDuration</span><span class="p">(</span><span class="n">_</span> <span class="nl">duration</span><span class="p">:</span> <span class="n">NSTimeInterval</span><span class="p">,</span> <span class="n">animations</span> <span class="nl">animations</span><span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Void</span><span class="p">)</span>
</span><span class='line'><span class="k">class</span> <span class="k">func</span> <span class="n">animateWithDuration</span><span class="p">(</span><span class="n">_</span> <span class="nl">duration</span><span class="p">:</span> <span class="n">NSTimeInterval</span><span class="p">,</span> <span class="n">animations</span> <span class="nl">animations</span><span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Void</span><span class="p">,</span> <span class="n">completion</span> <span class="nl">completion</span><span class="p">:</span> <span class="p">((</span><span class="n">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Void</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
</span><span class='line'><span class="k">class</span> <span class="k">func</span> <span class="n">animateWithDuration</span><span class="p">(</span><span class="n">_</span> <span class="nl">duration</span><span class="p">:</span> <span class="n">NSTimeInterval</span><span class="p">,</span> <span class="n">delay</span> <span class="nl">delay</span><span class="p">:</span> <span class="n">NSTimeInterval</span><span class="p">,</span> <span class="n">options</span> <span class="nl">options</span><span class="p">:</span> <span class="n">UIViewAnimationOptions</span><span class="p">,</span> <span class="n">animations</span> <span class="nl">animations</span><span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Void</span><span class="p">,</span> <span class="n">completion</span> <span class="nl">completion</span><span class="p">:</span> <span class="p">((</span><span class="n">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Void</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="bp">UIView</span><span class="p">.</span><span class="n">animateWithDuration</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nl">delay</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nl">options</span><span class="p">:</span> <span class="p">[],</span> <span class="nl">animations</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//do something</span>
</span><span class='line'>  <span class="p">},</span> <span class="nl">completion</span><span class="p">:</span> <span class="p">{</span><span class="n">_</span> <span class="k">in</span>
</span><span class='line'>    <span class="c1">//do something</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>说明：<code>options</code>，动画选项，这个运行你设置一个动画选项集合，传<code>[]</code>表示不需要选项，单个时可以省略放括号例如<code>.Repeat</code>,多个用逗号连接<code>[.Repeat, .CurveEaseInOut]</code></p>

<p><code>completion</code>闭包需要一个参数，不需要使用参数可以用<code>_</code>表示，不需要实现可以直接传<code>nil</code></p></blockquote>

<p>或者像下面这样写</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="bp">UIView</span><span class="p">.</span><span class="n">animateWithDuration</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nl">delay</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nl">options</span><span class="p">:</span> <span class="p">[],</span> <span class="nl">animations</span><span class="p">:</span> <span class="p">{</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Void</span> <span class="k">in</span>
</span><span class='line'>  <span class="c1">//do something</span>
</span><span class='line'>  <span class="p">})</span> <span class="p">{</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Void</span> <span class="k">in</span>
</span><span class='line'>  <span class="c1">//do something</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h5>2.弹簧动画 - Springs</h5>

<p>简介：弹簧动画是iOS 7.0新增的API，函数名<code>animateWithDuration(_:delay:usingSpringWithDamping:initialSpringVelocity:opti ons:animations:completion:)</code>，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">class</span> <span class="k">func</span> <span class="n">animateWithDuration</span><span class="p">(</span><span class="n">_</span> <span class="nl">duration</span><span class="p">:</span> <span class="n">NSTimeInterval</span><span class="p">,</span> <span class="n">delay</span> <span class="nl">delay</span><span class="p">:</span> <span class="n">NSTimeInterval</span><span class="p">,</span> <span class="n">usingSpringWithDamping</span> <span class="nl">dampingRatio</span><span class="p">:</span> <span class="n">CGFloat</span><span class="p">,</span> <span class="n">initialSpringVelocity</span> <span class="nl">velocity</span><span class="p">:</span> <span class="n">CGFloat</span><span class="p">,</span> <span class="n">options</span> <span class="nl">options</span><span class="p">:</span> <span class="n">UIViewAnimationOptions</span><span class="p">,</span> <span class="n">animations</span> <span class="nl">animations</span><span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Void</span><span class="p">,</span> <span class="n">completion</span> <span class="nl">completion</span><span class="p">:</span> <span class="p">((</span><span class="n">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Void</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="bp">UIView</span><span class="p">.</span><span class="n">animateWithDuration</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="nl">delay</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="nl">usingSpringWithDamping</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="nl">initialSpringVelocity</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nl">options</span><span class="p">:</span> <span class="p">[],</span> <span class="nl">animations</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'><span class="c1">// do something</span>
</span><span class='line'><span class="p">},</span> <span class="nl">completion</span><span class="p">:</span> <span class="nb">nil</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>说明：<code>usingSpringWithDamping</code>:设置弹簧的阻尼，范围（0.0-1.0），越接近0.0弹簧越有弹性，越接近1.0，效果越僵硬，你可以把当成弹簧的刚度来理解，
<code>initialSpringVelocity</code>:设置弹簧初始化的速度，设置1.0表示用1秒在动画跨度上完成整个动画距离，值越大或者越小会导致动画有相应的大的或者较小的速度，可以当成弹簧的初始动量来理解。</p></blockquote>

<h5>3.转场动画 - Transitions</h5>

<p>简介：前两种创建的动画是基于可动画的接口例如，position，alpha，frame等等，Transitions是专门处理添加或者移除一个view的动画,系统有2个标准函数，一个是对单个view的处理，一个是处理2个view替换。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">class</span> <span class="k">func</span> <span class="n">transitionWithView</span><span class="p">(</span><span class="n">_</span> <span class="nl">view</span><span class="p">:</span> <span class="bp">UIView</span><span class="p">,</span> <span class="n">duration</span> <span class="nl">duration</span><span class="p">:</span> <span class="n">NSTimeInterval</span><span class="p">,</span> <span class="n">options</span> <span class="nl">options</span><span class="p">:</span> <span class="n">UIViewAnimationOptions</span><span class="p">,</span> <span class="n">animations</span> <span class="nl">animations</span><span class="p">:</span> <span class="p">(()</span> <span class="o">-&gt;</span> <span class="n">Void</span><span class="p">)</span><span class="o">?</span><span class="p">,</span> <span class="n">completion</span> <span class="nl">completion</span><span class="p">:</span> <span class="p">((</span><span class="n">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Void</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
</span><span class='line'><span class="k">class</span> <span class="k">func</span> <span class="n">transitionFromView</span><span class="p">(</span><span class="n">_</span> <span class="nl">fromView</span><span class="p">:</span> <span class="bp">UIView</span><span class="p">,</span> <span class="n">toView</span> <span class="nl">toView</span><span class="p">:</span> <span class="bp">UIView</span><span class="p">,</span> <span class="n">duration</span> <span class="nl">duration</span><span class="p">:</span> <span class="n">NSTimeInterval</span><span class="p">,</span> <span class="n">options</span> <span class="nl">options</span><span class="p">:</span> <span class="n">UIViewAnimationOptions</span><span class="p">,</span> <span class="n">completion</span> <span class="nl">completion</span><span class="p">:</span> <span class="p">((</span><span class="n">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Void</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="c1">//add the new view via transition</span>
</span><span class='line'><span class="bp">UIView</span><span class="p">.</span><span class="n">transitionWithView</span><span class="p">(</span><span class="n">animationContainerView</span><span class="o">!</span><span class="p">,</span> <span class="nl">duration</span><span class="p">:</span> <span class="mf">0.33</span><span class="p">,</span>
</span><span class='line'><span class="nl">options</span><span class="p">:</span> <span class="p">[.</span><span class="n">CurveEaseOut</span><span class="p">,</span> <span class="p">.</span><span class="n">TransitionFlipFromBottom</span><span class="p">],</span> <span class="nl">animations</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'><span class="nb">self</span><span class="p">.</span><span class="n">animationContainerView</span><span class="o">!</span><span class="p">.</span><span class="n">addSubview</span><span class="p">(</span><span class="n">newView</span><span class="p">)</span> <span class="p">},</span> <span class="nl">completion</span><span class="p">:</span> <span class="nb">nil</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//remove the view via transition</span>
</span><span class='line'><span class="bp">UIView</span><span class="p">.</span><span class="n">transitionWithView</span><span class="p">(</span><span class="n">animationContainerView</span><span class="o">!</span><span class="p">,</span> <span class="nl">duration</span><span class="p">:</span> <span class="mf">0.33</span><span class="p">,</span>
</span><span class='line'><span class="nl">options</span><span class="p">:</span> <span class="p">[.</span><span class="n">CurveEaseOut</span><span class="p">,</span> <span class="p">.</span><span class="n">TransitionFlipFromBottom</span><span class="p">],</span> <span class="nl">animations</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'><span class="nb">self</span><span class="p">.</span><span class="n">newView</span><span class="p">.</span><span class="n">removeFromSuperview</span><span class="p">()</span> <span class="p">},</span> <span class="nl">completion</span><span class="p">:</span> <span class="nb">nil</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//hide the view via transition</span>
</span><span class='line'><span class="bp">UIView</span><span class="p">.</span><span class="n">transitionWithView</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">newView</span><span class="p">,</span> <span class="nl">duration</span><span class="p">:</span> <span class="mf">0.33</span><span class="p">,</span> <span class="nl">options</span><span class="p">:</span> <span class="p">[.</span><span class="n">CurveEaseOut</span><span class="p">,</span> <span class="p">.</span><span class="n">TransitionFlipFromBottom</span><span class="p">],</span> <span class="nl">animations</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'><span class="nb">self</span><span class="p">.</span><span class="n">newView</span><span class="p">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="nb">true</span> <span class="p">},</span> <span class="nl">completion</span><span class="p">:</span> <span class="nb">nil</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//replace via transition</span>
</span><span class='line'><span class="bp">UIView</span><span class="p">.</span><span class="n">transitionFromView</span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">oldView</span><span class="o">!</span><span class="p">,</span> <span class="nl">toView</span><span class="p">:</span> <span class="nb">self</span><span class="p">.</span><span class="n">newView</span><span class="o">!</span><span class="p">,</span> <span class="nl">duration</span><span class="p">:</span> <span class="mf">0.33</span><span class="p">,</span> <span class="nl">options</span><span class="p">:</span> <span class="p">[.</span><span class="n">TransitionFlipFromTop</span><span class="p">],</span>
</span><span class='line'><span class="nl">completion</span><span class="p">:</span> <span class="nb">nil</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h5>4.关键帧动画 - Keyframe</h5>

<p>简介：关键帧顾名思义就是设定关键的一些帧然后系统会根据一套算法计算中间的其他帧，这样改变的可动画属性时看看起来更加流畅自然，主要有两个函数,一个创建关键帧动画，一个设置具体每帧内容</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">class</span> <span class="k">func</span> <span class="n">animateKeyframesWithDuration</span><span class="p">(</span><span class="n">_</span> <span class="nl">duration</span><span class="p">:</span> <span class="n">NSTimeInterval</span><span class="p">,</span> <span class="n">delay</span> <span class="nl">delay</span><span class="p">:</span> <span class="n">NSTimeInterval</span><span class="p">,</span> <span class="n">options</span> <span class="nl">options</span><span class="p">:</span> <span class="n">UIViewKeyframeAnimationOptions</span><span class="p">,</span> <span class="n">animations</span> <span class="nl">animations</span><span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Void</span><span class="p">,</span> <span class="n">completion</span> <span class="nl">completion</span><span class="p">:</span> <span class="p">((</span><span class="n">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Void</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
</span><span class='line'><span class="o">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">addKeyframeWithRelativeStartTime</span><span class="p">:(</span><span class="kt">double</span><span class="p">)</span><span class="n">frameStartTime</span> <span class="nl">relativeDuration</span><span class="p">:(</span><span class="kt">double</span><span class="p">)</span><span class="n">frameDuration</span> <span class="nl">animations</span><span class="p">:(</span><span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="p">)(</span><span class="kt">void</span><span class="p">))</span><span class="n">animations</span>
</span></code></pre></td></tr></table></div></figure>


<p>例如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">func</span> <span class="nf">planeDepart</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">UIView</span><span class="p">.</span><span class="n">animateKeyframesWithDuration</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="nl">delay</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nl">options</span><span class="p">:</span> <span class="p">[],</span> <span class="nl">animations</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//add keyframes</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">UIView</span><span class="p">.</span><span class="n">addKeyframeWithRelativeStartTime</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nl">relativeDuration</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="nl">animations</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">planeImage</span><span class="p">.</span><span class="n">center</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="mf">100.0</span>
</span><span class='line'>      <span class="nb">self</span><span class="p">.</span><span class="n">planeImage</span><span class="p">.</span><span class="n">center</span><span class="p">.</span><span class="n">y</span> <span class="o">-=</span> <span class="mf">10.0</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>
</span><span class='line'>      <span class="bp">UIView</span><span class="p">.</span><span class="n">addKeyframeWithRelativeStartTime</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="nl">relativeDuration</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">self</span><span class="p">.</span><span class="n">planeImage</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">CGAffineTransformMakeRotation</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">(</span><span class="o">-</span><span class="n">M_PI_4</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="bp">UIView</span><span class="p">.</span><span class="n">addKeyframeWithRelativeStartTime</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="nl">relativeDuration</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">self</span><span class="p">.</span><span class="n">planeImage</span><span class="p">.</span><span class="n">center</span><span class="p">.</span><span class="n">x</span> <span class="o">+=</span> <span class="mf">100.0</span>
</span><span class='line'>        <span class="nb">self</span><span class="p">.</span><span class="n">planeImage</span><span class="p">.</span><span class="n">center</span><span class="p">.</span><span class="n">y</span> <span class="o">-=</span> <span class="mf">60.0</span>
</span><span class='line'>        <span class="nb">self</span><span class="p">.</span><span class="n">planeImage</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="bp">UIView</span><span class="p">.</span><span class="n">addKeyframeWithRelativeStartTime</span><span class="p">(</span><span class="mf">0.51</span><span class="p">,</span> <span class="nl">relativeDuration</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">self</span><span class="p">.</span><span class="n">planeImage</span><span class="p">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">CGAffineTransformIdentity</span>
</span><span class='line'>        <span class="nb">self</span><span class="p">.</span><span class="n">planeImage</span><span class="p">.</span><span class="n">center</span> <span class="o">=</span> <span class="bp">CGPoint</span><span class="p">(</span><span class="nl">x</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="nl">y</span><span class="p">:</span> <span class="n">originalCenter</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="bp">UIView</span><span class="p">.</span><span class="n">addKeyframeWithRelativeStartTime</span><span class="p">(</span><span class="mf">0.55</span><span class="p">,</span> <span class="nl">relativeDuration</span><span class="p">:</span> <span class="mf">0.45</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">self</span><span class="p">.</span><span class="n">planeImage</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span>
</span><span class='line'>        <span class="nb">self</span><span class="p">.</span><span class="n">planeImage</span><span class="p">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">originalCenter</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">},</span> <span class="nl">completion</span><span class="p">:</span> <span class="nb">nil</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>说明：这是设计一个飞机沿一条路径起飞然后再归位的一段动画，<code>addKeyframeWithRelativeStartTime(_:relativeDuration:animations:)</code>,第一个参数相对开始时间，是相对于动画持续时间的百分比，例如0.1就是10%，0.25就是25%，如果整个动画持续2秒，0.1就是在2*0.1=0.2秒的时候开始，后面的一个参数是相对持续时间，范围更第一参数类似也(0.0-1.0),只从相对开始时间起，往后推移的相对时间。</p></blockquote>

<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com">http://blog.wangruofeng007.com</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-15T18:15:01+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/15/nsurlsession/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/15/nsurlsession/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/15/nsurlsession/" itemprop="url">NSURLSession 教程</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>本文翻译自 <a href="http://www.raywenderlich.com/51127/nsurlsession-tutorial">http://www.raywenderlich.com/51127/nsurlsession-tutorial</a></p>

<p>原作者： Charlie Fulton</p>

<p>译者：<a href="https://twitter.com/oneruofeng">@oneruofeng</a></p>

<p>注意：这是一篇来自我们作为即将发布<a href="http://www.raywenderlich.com/?p=49762"> iOS 7 Feast</a>的一部分<a href="http://www.raywenderlich.com/?page_id=48020">iOS 7 by Tutorials</a>的简短版本的章节。我们希望你们喜欢。</p>

<p>每一个新的iOS版本发布都会包含一些极好的新的网络APIs，iOS7也不例外，在iOS7中，Apple引入了<code>NSURLSession</code>,这是为了取代<code>NSURLConnection</code>作为偏好的网络请求的一系列类。</p>

<p>在这个<code>NSURLSession</code>的教程中，你将了解到这个新类究竟是什么，为什么你要使用它以及你怎样使用它，它和以前的类库比较而言怎样，最后最重要的是：获得一个整合到一个真正的App的实践。</p>

<p>请注意：这个课程是假设你熟悉基本的网络概念。假如网络对你来说完全是新的，你仍然可以跟我一起一步一步的学习，但是可能有些你不熟悉的概念需要需要自己查询在这个过程中。</p>

<h4>为什么使用<code>NSURLSession</code></h4>

<p>为什么你要使用<code>NSURLSession</code>? 饿，因为它可以带给你一些好处和优势相比以前的：</p>

<ul>
<li><strong>后台上传和下载</strong> ： 当你创建<code>NSURLSession</code>的时候你只需配置一个选项即可，你便可以进行所有的后台网络任务。这将有对你的电池寿命有利，它支持<code>UIKit</code>多任务并且当切换线程的时候使用相同的代理模型。</li>
<li><strong>使你的网络操作可以暂停和恢复</strong> ：你稍后将会看到，任何使用<code>NSURLSession</code>API的网络任务都可以被暂停，停止，重新开始。而没有使用<code>NSOperation</code>子类的必要。</li>
<li><strong>可配置的容器</strong>：对于放进里面的请求而言每一个<code>NSURLSession</code>都是可配置的。例如，假如你需要设置一个HTTP header选项，你只需要设置一次然后每个在session中的请求就都会有相同的配置了。</li>
<li><strong>可子类化和私密存储</strong>： <code>NSURLSession</code>是可子类化的并且你可以配置一个session用来作为私密存储在某个会话中。这允许你拥有私密存储对象在全局状态下。</li>
<li><strong>优化的授权处理机制</strong>：授权被完成基于某个特定的连接。当使用<code>NSURLConnection</code>的时候假如发生了一处授权改变，这个改变将返回一个随意的请求，你不能确定你具体得到的那个。使用<code>NSURLSession</code>的话，代理回来处理授权。</li>
<li><strong>丰富的代理模型</strong>：<code>NSURLConnection</code>有些基于block的同步方法，然而代理就不能使用它们了。当一个请求建立了无论它是成功还是失败，哪怕需要授权。使用<code>NSURLSession</code>就就可以混合接入，使用基于block的异步方法同时也可以设置代理来处理授权。</li>
<li><strong>通过文件系统上传和下载</strong>：苹果鼓励把（文件内容）数据跟(URL和一些设置)元数据分开。</li>
</ul>


<h4><code>NSURLSession</code> vs <code>NSURLConnection</code></h4>

<p>&ldquo;哇哦，<code>NSURLSession</code>听起来很复杂呀！&rdquo;,你可能这么想。"我可能还是继续使用我的老朋友<code>NSURLConnection</code>。"</p>

<p>别担心&ndash;使用<code>NSURLSession</code>使用起来其实和它的前辈<code>NSURLConnection</code>一样简单对于简单的任务来说。例如，让我来看一个在获取伦敦最新的天气的一个简单网络请求，通过它来获取JSON数据的例子。</p>

<p>假设你用这个<code>NSString</code>来构造这个<code>NSURL</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="bp">NSString</span> <span class="o">*</span><span class="n">londonWeatherUrl</span> <span class="o">=</span> <span class="s">@&quot;http://api.openweathermap.org/data/2.5/weather?q=London,uk&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里是第一步你使用<code>NSURLConnection</code>来调用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="bp">NSURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURLRequest</span> <span class="nl">requestWithURL</span><span class="p">:</span>
</span><span class='line'><span class="p">[</span><span class="bp">NSURL</span> <span class="nl">URLWithString</span><span class="p">:</span><span class="n">londonWeatherUrl</span><span class="p">]];</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="bp">NSURLConnection</span> <span class="nl">sendAsynchronousRequest</span><span class="p">:</span><span class="n">request</span>
</span><span class='line'>   <span class="nl">queue</span><span class="p">:[</span><span class="bp">NSOperationQueue</span> <span class="n">mainQueue</span><span class="p">]</span>
</span><span class='line'>   <span class="nl">completionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSURLResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">,</span>
</span><span class='line'>                       <span class="bp">NSData</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
</span><span class='line'>                       <span class="bp">NSError</span> <span class="o">*</span><span class="n">connectionError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// handle response</span>
</span><span class='line'><span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在让我们来使用<code>NSURLSession</code>。注意这是使用<code>NSURLSession</code>的最简单的方式来快速构造一个请求。在后面的课程你将看到怎样配置session和设置其他特征比如像代理。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="bp">NSURLSession</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURLSession</span> <span class="n">sharedSession</span><span class="p">];</span>
</span><span class='line'><span class="p">[[</span><span class="n">session</span> <span class="nl">dataTaskWithURL</span><span class="p">:[</span><span class="bp">NSURL</span> <span class="nl">URLWithString</span><span class="p">:</span><span class="n">londonWeatherUrl</span><span class="p">]</span>
</span><span class='line'>          <span class="nl">completionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSData</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
</span><span class='line'>                              <span class="bp">NSURLResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">,</span>
</span><span class='line'>                              <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// handle response</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}]</span> <span class="n">resume</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意你并不需要指定它运行在那个队列中。除了你特别指定，这个调用将会在后台线程。你可能很难注意到这两者之间有什么不同，它就是故意这样的。Apple提到打算使用<code>dataTaskWithURL</code>来取代在<code>NSURLConnection</code>中的<code>sendAsynchronousRequest</code>。</p>

<p>所有从根本上来讲&ndash;对于简单的任务使用<code>NSURLSession</code>就和使用<code>NSURLConnection</code>一样简单，并且它还有一些列额外的定制功能当你需要它的时候。</p>

<h4><code>NSURLSession</code> vs <code>AFNetworking</code></h4>

<p>不提到<code>AFNetworking</code>框架就谈不上谈论网络编程。这个事在<code>iOS/OS X</code>上最流行的框架，有杰出的<code>Mattt Thompson</code>创建。</p>

<blockquote><p>注意：想了解更多关于<code>AFNetworking</code>,请检出在<a href="https://github.com/AFNetworking/AFNetworking">https://github.com/AFNetworking/AFNetworking</a>的github页面。我们也有一个关于它的课程：<a href="http://www.raywenderlich.com/30445/afnetworking-crash-course">http://www.raywenderlich.com/30445/afnetworking-crash-course</a></p></blockquote>

<p>下面是的使用<code>AFNetworking</code> 1.x版本处理相同的数据任务的代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="bp">NSURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURLRequest</span> <span class="nl">requestWithURL</span><span class="p">:</span>
</span><span class='line'>                         <span class="p">[</span><span class="bp">NSURL</span> <span class="nl">URLWithString</span><span class="p">:</span><span class="n">londonWeatherUrl</span><span class="p">]];</span>
</span><span class='line'>
</span><span class='line'><span class="n">AFJSONRequestOperation</span> <span class="o">*</span><span class="n">operation</span> <span class="o">=</span>
</span><span class='line'><span class="p">[</span><span class="n">AFJSONRequestOperation</span> <span class="nl">JSONRequestOperationWithRequest</span><span class="p">:</span><span class="n">request</span>
</span><span class='line'>    <span class="nl">success</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSURLRequest</span>  <span class="o">*</span><span class="n">request</span><span class="p">,</span>
</span><span class='line'>              <span class="bp">NSHTTPURLResponse</span>  <span class="o">*</span><span class="n">response</span><span class="p">,</span>
</span><span class='line'>              <span class="kt">id</span> <span class="n">JSON</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// handle response</span>
</span><span class='line'><span class="p">}</span> <span class="nl">failure</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">operation</span> <span class="n">start</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用<code>AFNetworking</code>的一个好处是处理响应的数据的数据根据类型被归类。使用<code>AFJSONRequestOperation</code>(或者诸如<code>XML</code>和plist相似的类),成功block已经被解析根据响应并且为你返回你想要的数据。使用<code>NSURLSession</code>你将收到一个<code>NSData</code>对象在<code>completion handler</code>,所有你只需要把<code>NSData</code>转换成<code>JOSN</code>或者其他形式。</p>

<blockquote><p>注意：你能够很方便的把数据从<code>NSData</code>转换成<code>JSON</code>使用在iOS 5引入的<code>NSJSONSerialization</code>这个类。如果你想了解更多，请查看23章的iOS 5 教程，“Working with JSON”。</p></blockquote>

<p>你或许想知道你是应该使用<code>AFNetworking</code>还是仅仅是继续使用<code>NSURLSession</code>。</p>

<p>就个人而言，我认为对于简单的需求最好还是继续使用<code>NSURLSession</code>&ndash;这样可以避免不必要的引入一个第三方库在你的工程中。另外，使用新的代理，配置，和基于很多添加到<code>AFNetworking</code>中的的“遗失特征”现在都被包括了的API的任务。</p>

<p>然而，假如你想使用一些在<code>AFNetworking</code>中2.0版本的新特性，诸如序列化和将来对
<code>UIKit</code>的整合（添加到<code>UIIImageView</code>分类中），然后这样很难争辩不使用它！</p>

<blockquote><p>注意：在<code>AFNetworking</code>2.0分支中，它们已经转换到使用<code>NSURLSession</code>。更多信息看这篇帖子：<a href="https://github.com/AFNetworking/AFNetworking/wiki/AFNetworking-2.0-Migration-Guide">https://github.com/AFNetworking/AFNetworking/wiki/AFNetworking-2.0-Migration-Guide</a></p></blockquote>

<h4>介绍 Byte Club</h4>

<p>在这篇<code>NSURLSession</code>教程中，你将探索这个新的API通过构建一篇日记好图片分享app基于<code>Dropbox Core API</code>,因为是顶级机密组织因此姑且命名它<code>Byte Club</code>。</p>

<p>考虑到这个课程是你接受到<code>Byte Club</code>的官方邀请！什么是你可能会问到的关于<code>Byte Club</code>的第一条规则？没人谈论<code>Byte Club</code>&ndash;除了那些足够炫酷的人将会阅读这个教程。并且那些Android用户完全不知道；他们被他们俩的生活劫持了。 ：]</p>

<p>开始构建app迎战下一个章节，将充当被<code>Byte Club</code>组织邀请。</p>

<p>主要到这个教程是假设你对基本的网络有基本的了解在先前的版本iOS。它非常有用假如你已经使用过诸如<code>NSURLConnection</code>或者<code>NSURLSession</code>在过去。假如在iOS方面你是网络方面的新手，在继续这个课程之前你应该查询我们的iOS学徒系列作为最初的开发者。</p>

<h4>现在开始吧</h4>

<p><code>Byte Club</code>是iOS 开发者专有的组织，一起来加入挑战你的编程吧。由于每个成员都是远程工作，在这个挑战中有一个是跨越世界，成员通过分享他们“战场”的全景照片也能找到它的乐趣。</p>

<p>例如，下面是Ray的办公场所的全景照片：
<img src="http://ww4.sinaimg.cn/mw690/64124373gw1ezzf1ygxi8j20go03njs2.jpg" alt="Ray's office setup" /></p>

<blockquote><p>注意：你可能想创建你自己办公室的全景照片&ndash;它很有趣，在这个课程的后续中我们将会处理。</p>

<p>在 iOS 7中，你可以通过打开相机选择一个叫<code>Pano</code>（全景）的标签照一张全景照片。</p>

<p>加入你喜欢那张，把它设置成你锁屏界面的墙纸通过打开<code>设置</code>让后选择<code>墙纸</code>  \选择墙纸 \我的全景照片。</p></blockquote>

<p>当然-<code>Byte Club</code>有它自己的app，我们来见证奇迹。你可以和其他成员使用app来完成编程挑战或者分享全景照片。在幕后，这是通过网络实现-明确的说，就是通过<code>Dropbox API</code>来分享文件。</p>

<h4>开始的工程概述</h4>

<p>首先，下载<a href="http://cdn1.raywenderlich.com/downloads/ByteClub_Starter.zip">教程开始的工程</a>。</p>

<p>开始的工程包含了为你预先准备好的UI，所以你只需把精力集中在这个教程中app的网络部分。开始的工程也包含一些处理<code>Dropbox</code>授权的代码,在后面你将学到更多。</p>

<p>在Xcode中打开工程让后在你设备或者模拟器上运行，你应该看到像下面这样：</p>

<p><img src="http://ww1.sinaimg.cn/mw690/64124373gw1ezzf1vk3t1j205b09edg2.jpg" alt="networking2" /></p>

<p>然而你还并不能登录它-你不得不先配置app，你将做一点。</p>

<p>下一步打开<code>Main.storyboard</code>纵览一下整个app的设计：</p>

<p><img src="http://ww2.sinaimg.cn/mw690/64124373gw1ezzf1x56zfj20go0a9q3e.jpg" alt="networking2" /></p>

<p>这是一个最基本的使用2个标签的的TabBarController app：一个是为了挑战编程，另
一个是为了放全景照片。这里也有预先让用户登录到app中的一步。你将要配置登录在你创建完<code>Dropbox</code>平台下的App后。</p>

<p>感到很轻松浏览一下App剩余的部分并且找到到目前为止相似的地方。你将会注意到除了授权组件，这里没有检索挑战编程或者全景照片的网络代码-那就是你的工作！</p>

<h4>创建一个新的<code>Dropbox</code>平台App</h4>

<p>为了开始你的新的<code>Dropbox</code> App,打开 Dropbox App 位于<a href="https://www.dropbox.com/developers/apps">https://www.dropbox.com/developers/apps</a>的控制台</p>

<p>用你的<code>Dropbox</code>账号登录，假如没有，没问题：马上创建一个免费的Dropbox账号。假如这是你第一次使用Dropbox的API，你需要通知Dropbox的条款和条件。</p>

<p>经过这个法定的材料以后就是上路了，选择创建App选项。将呈现给你一系列问题-提供下面的答案</p>

<ul>
<li>What type of app do you want to create?

<ul>
<li>Choose: <strong>Dropbox API app</strong></li>
</ul>
</li>
<li>What type of data does your app need to store on Dropbox?

<ul>
<li>Choose: <strong>Files and Datastore</strong></li>
</ul>
</li>
<li>Can your app be limited to its own, private folder?

<ul>
<li>Choose: <strong>No – My App needs access to files already on Dropbox</strong></li>
</ul>
</li>
<li>What type of files does your app need access to?

<ul>
<li>Choose: <strong>All File Types</strong></li>
</ul>
</li>
</ul>


<p>最终，为你的App准备一个名字，选择什么并没有关系只有它是唯一的。假如你选择了一个别人已经在使用的名字<code>Dropbox</code>将会告诉你。你的屏幕应该看起来像下面这样：</p>

<p><img src="http://ww2.sinaimg.cn/mw690/64124373gw1ezzf38fs1nj20go0epdhp.jpg" alt="networking3" /></p>

<p>点击<code>Create App</code>，你将开始上路了！</p>

<p>下一个屏幕你将看到显示到屏幕中的包含 <strong>App key</strong> 和 <strong>App secret</strong> :</p>

<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1ezzfuk4ucmj208z08rglt.jpg" alt="networking5" /></p>

<p>先不要关闭这个屏幕，你将需要需要下一步的<code>App Key</code>和<code>App Secret</code>。</p>

<p>打开<code>Dropbox.m</code>文件找到下面这些行：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#warning INSERT YOUR OWN API KEY and SECRET HERE</span>
</span><span class='line'><span class="k">static</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">apiKey</span> <span class="o">=</span> <span class="s">@&quot;YOUR_KEY&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">static</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">appSecret</span> <span class="o">=</span> <span class="s">@&quot;YOUR_SECRET&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>填写你的app key 和 secret，让后删除 #warning line，现在你可以关闭<code>Dropbox</code> Web App 页面。</p>

<p>下面，创建一个文件夹在你Dropbox主文件下的根目录给它命一个你想要的名字。假如你把这个文件夹个和其他的Dropbox用户分享，发送他们在构建 Byte Club App的时候，他们将能够创建笔记并且能够上传所有人都能看得见的照片。</p>

<p>在Dropbox.m中找打下面这些行：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#warning THIS FOLDER MUST BE CREATED AT THE TOP LEVEL OF YOUR DROPBOX FOLDER, you can then share this folder with others</span>
</span><span class='line'><span class="bp">NSString</span> <span class="o">*</span> <span class="k">const</span> <span class="n">appFolder</span> <span class="o">=</span> <span class="s">@&quot;byteclub&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>改变字符串的值，设置成你创建的Dropbox文件夹的名字，让后删除 #warning pragma.</p>

<p>为了把这个app分发给其他用户，给他们接入<code>access tokens</code>,你将需要为你的Dropbox 平台 App打开<code>Enable additional users</code>设置。</p>

<p>去在<a href="https://www.dropbox.com/developers/apps">https://www.dropbox.com/developers/apps</a>Dropbox app的控制台。点击你app 名称。然后点击<code>Enable Additional Users</code>按钮。将出现一个状态对话框表明你已经增加了你的用户限制。点击Okay关闭对话框。你的App 页面将像下面这样显示：</p>

<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1ezzg9htvs2j20go056jrj.jpg" alt="networking5" /></p>

<blockquote><p>注意：你可能注意到当你正在开发你的app的时候，你可以接入多达100个用户。当你准备发布app销售的时候，你必须申请生产状态，你可以通过点击<code>Apply for production</code>按钮来发送给<code>Dropbox</code>一些额外的信息。</p>

<p>Dropbox 将随后审核你的App 来确保它遵守指南，假如所有的一切进行得顺利的话，你将打开你的app的 API接入无线的用户。</p></blockquote>

<h4>Dropbox 授权: 概览</h4>

<p>假如你曾经使用过第三方<code>twitter</code>客服端app，像<code>TweetBot</code>,你将会熟悉<code>OAuth</code>授权处理步骤从一个用户的角度。<code>OAuth</code>授权接入过程对你app来说是完全一样的。</p>

<p>构建运行你的app，按照步骤登录。你将看到一个有2个标签的空白屏幕，一个是Notes，一个是PanoPhotos，如下图显示：</p>

<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1ezzglpqm1aj209f0fa0t7.jpg" alt="networking7" /></p>

<p><code>OAuth</code>授权发生在3和高级的步骤：</p>

<ol>
<li>获取用来处理剩下的授权一个OAuth请求 token。这是请求token。</li>
<li>一个web 页面被呈现到用户面前通过他们的web浏览器。没有这一步的用户授权，对你的应用想获取一个第三步中的接入token几乎不可能。</li>
<li>在第二步完成后，应用调用web服务来交换临时请求token（从第一步中的）为了一个将存储在app里面的持久接入token。</li>
</ol>


<blockquote><p>注意：为了保证这个教程的简洁，我们不打算进行更详细的讲解关于这里Dropbox授权工作。然而，假如你想了解更多点击整个教程的完全版本，它是<a href="http://www.raywenderlich.com/?page_id=48020">iOS 7 by Tutorials.</a>的一部分。</p></blockquote>

<h4>NSURLSession 的一系列类</h4>

<p>Apple已经把<code>NSURLSession</code>描述成一个新类和一系列旧类的组合。这些新的工具是为了处理 上传，下载，处理授权已经处理在HTTP协议里面的任何事情。</p>

<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1ezzgzutn43j20go0dwgn3.jpg" alt="networking12" /></p>

<p>一个<code>NSURLSession</code>用一个带可选代理的<code>NSURLSessionConfiguration</code>构造。在你创建会话以后，你应该能够满足你的网络需要通过创建<code>NSURLSessionTask</code>的任务。</p>

<h4>NSURLSessionConfiguration</h4>

<p>这里有三种方式创建<code>NSURLSessionConfiguration</code>:</p>

<ul>
<li><strong>defaultSessionConfiguration</strong> - 创建一个使用全局缓存，cookie的配置对象和凭证存储的对象。这个配置会使你的会话最像<code>NSURLConnection</code>。</li>
<li><strong>ephemeralSessionConfiguration</strong> - 这个配置是用来作为‘私有的’会话并且不会持久化存储缓存，cookie，或者信用存储对象。</li>
<li><strong>backgroundSessionConfiguration</strong> - 当你想要从远程推送或者当app被暂时挂起时进行网络业务使用这个这个配置。参考17章和18章在<a href="http://www.raywenderlich.com/?page_id=48020"> iOS 7 by Tutorials</a>,<code>Beginning and Intermediate Multitasking</code>,有更详细的讲解。</li>
</ul>


<p>一旦你创建一个<code>NSURLSessionConfiguration</code>对象，你就可以在它上面设置各种接口像这样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="bp">NSURLSessionConfiguration</span> <span class="o">*</span><span class="n">sessionConfig</span> <span class="o">=</span>
</span><span class='line'><span class="p">[</span><span class="bp">NSURLSessionConfiguration</span> <span class="n">defaultSessionConfiguration</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="n">sessionConfig</span><span class="p">.</span><span class="n">allowsCellularAccess</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'><span class="p">[</span><span class="n">sessionConfig</span> <span class="nl">setHTTPAdditionalHeaders</span><span class="p">:</span>
</span><span class='line'>          <span class="l">@{</span><span class="s">@&quot;Accept&quot;</span><span class="o">:</span> <span class="s">@&quot;application/json&quot;</span><span class="l">}</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 3</span>
</span><span class='line'><span class="n">sessionConfig</span><span class="p">.</span><span class="n">timeoutIntervalForRequest</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">;</span>
</span><span class='line'><span class="n">sessionConfig</span><span class="p">.</span><span class="n">timeoutIntervalForResource</span> <span class="o">=</span> <span class="mf">60.0</span><span class="p">;</span>
</span><span class='line'><span class="n">sessionConfig</span><span class="p">.</span><span class="n">HTTPMaximumConnectionsPerHost</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>你限制了网络操作只有wifi才能进行。</li>
<li>这将设置所有的请求只接受 JSON类型的响应。</li>
<li>这些接口将配置资源或者请求超时时间。你也可以限制你的app对你的主机只能有一个网络连接。</li>
</ol>


<p>这些仅仅是你能配置的一些东西，确保检查所有列表的文档。</p>

<h4>NSURLSession</h4>

<p><code>NSURLSession</code>被设计成替代<code>NSURLConnection</code>的API。Sessions做了他们的工作通过他们的部下，也就是非常出名的<code>NSURLSessionTask</code>对象。使用<code>NSURLSession</code>你能够创建任务使用基于block的便利方法，设置一个代理，或者同时两者。例如，假如你想要下载一张
图片（ <em>challenge hint </em>）,你就需要创建一个<code>NSURLSessionDownloadTask</code>。</p>

<p>第一步，你需要创建(会话)session。 这里有一个例子：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="bp">NSString</span> <span class="o">*</span><span class="n">imageUrl</span> <span class="o">=</span>
</span><span class='line'><span class="s">@&quot;http://www.raywenderlich.com/images/store/iOS7_PDFonly_280@2x_authorTBA.png&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'><span class="bp">NSURLSessionConfiguration</span> <span class="o">*</span><span class="n">sessionConfig</span> <span class="o">=</span>
</span><span class='line'>  <span class="p">[</span><span class="bp">NSURLSessionConfiguration</span> <span class="n">defaultSessionConfiguration</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 3</span>
</span><span class='line'><span class="bp">NSURLSession</span> <span class="o">*</span><span class="n">session</span> <span class="o">=</span>
</span><span class='line'>  <span class="p">[</span><span class="bp">NSURLSession</span> <span class="nl">sessionWithConfiguration</span><span class="p">:</span><span class="n">sessionConfig</span>
</span><span class='line'>                                <span class="nl">delegate</span><span class="p">:</span><span class="nb">self</span>
</span><span class='line'>                           <span class="nl">delegateQueue</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok,这个仅仅是你目前所看到的一点点不同。让我们一步步重温。</p>

<ol>
<li>用这个代码片段我们将一样进行下载在两个任务中。</li>
<li>你总是以创建<code>NSURLConfiguration</code>开始。</li>
<li>这里创建一个会话使用现在的类作为代理。</li>
</ol>


<p>在你创建会话后，你可以通过创建一个带一个<code>completion handler</code>的任务下载这张图片，想下面这样:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="bp">NSURLSessionDownloadTask</span> <span class="o">*</span><span class="n">getImageTask</span> <span class="o">=</span>
</span><span class='line'><span class="p">[</span><span class="n">session</span> <span class="nl">downloadTaskWithURL</span><span class="p">:[</span><span class="bp">NSURL</span> <span class="nl">URLWithString</span><span class="p">:</span><span class="n">imageUrl</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nl">completionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSURL</span> <span class="o">*</span><span class="n">location</span><span class="p">,</span>
</span><span class='line'>                        <span class="bp">NSURLResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">,</span>
</span><span class='line'>                        <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 2</span>
</span><span class='line'>        <span class="bp">UIImage</span>  <span class="o">*</span><span class="n">downloadedImage</span> <span class="o">=</span>
</span><span class='line'>          <span class="p">[</span><span class="bp">UIImage</span> <span class="nl">imageWithData</span><span class="p">:</span>
</span><span class='line'>              <span class="p">[</span><span class="bp">NSData</span> <span class="nl">dataWithContentsOfURL</span><span class="p">:</span><span class="n">location</span><span class="p">]];</span>
</span><span class='line'>      <span class="c1">//3</span>
</span><span class='line'>      <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="c1">// do stuff with image</span>
</span><span class='line'>         <span class="n">_imageWithBlock</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">downloadedImage</span><span class="p">;</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'><span class="p">}];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 4</span>
</span><span class='line'><span class="p">[</span><span class="n">getImageTask</span> <span class="n">resume</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ah ha!现在这个看起来有点像网络代码！</p>

<ol>
<li><p>任务总是被sessions创建。任务一旦被基于block的方法创建。记住你仍然可以使用<code>NSURLSessionDownloadDelegate</code>来跟踪下载进度。所以你将获得最好的两个单词！（ <em>hint for challenge </em>）</p>

<p> -URLSession:downloadTask
 :didWriteData:totalBytesWritten
 :totalBytesExpectedToWrite:</p></li>
<li><p>这里你使用在 <code>completion handler</code>提供的本地变量来获取一个指向图片的指针。</p></li>
<li>最终你能够，例如，更新 <code>UIIImageView</code>的图片来显示新的文件。(hint hint ☺)</li>
<li>你总得自己启动任务！</li>
<li>记住我在前面所说的，一个会话也可以创建将要发送消息给代理方法来通知你完成等的任务。</li>
</ol>


<p>应该长成这样，使用相同的会话从上面：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="bp">NSURLSessionDownloadTask</span> <span class="o">*</span><span class="n">getImageTask</span> <span class="o">=</span>
</span><span class='line'>  <span class="p">[</span><span class="n">session</span> <span class="nl">downloadTaskWithURL</span><span class="p">:[</span><span class="bp">NSURL</span> <span class="nl">URLWithString</span><span class="p">:</span><span class="n">imageUrl</span><span class="p">]];</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="n">getImageTask</span> <span class="n">resume</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>这当然是确定使用更少的代码☺ 然而，假如你只这样做，你将什么都看不到。
你需要让你的代理实现一些<code>NSURLSessionDownloadDelegate</code>协议的方法。</li>
</ol>


<p>首先我们需要获得通知当下载完成时：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">URLSession:</span><span class="p">(</span><span class="bp">NSURLSession</span> <span class="o">*</span><span class="p">)</span><span class="nv">session</span>
</span><span class='line'>     <span class="nf">downloadTask:</span><span class="p">(</span><span class="bp">NSURLSessionDownloadTask</span> <span class="o">*</span><span class="p">)</span><span class="nv">downloadTask</span>
</span><span class='line'><span class="nf">didFinishDownloadingToURL:</span><span class="p">(</span><span class="bp">NSURL</span> <span class="o">*</span><span class="p">)</span><span class="nv">location</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// use code above from completion handler</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>再有你需要提供将要下载的文件存放的位置，然后你就可以使用这个来处理图片。</p>

<p>最后，假如你需要跟踪下载进度，对于任务创建方法，你需要像下面这样用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">URLSession:</span><span class="p">(</span><span class="bp">NSURLSession</span> <span class="o">*</span><span class="p">)</span><span class="nv">session</span>
</span><span class='line'>     <span class="nf">downloadTask:</span><span class="p">(</span><span class="bp">NSURLSessionDownloadTask</span> <span class="o">*</span><span class="p">)</span><span class="nv">downloadTask</span>
</span><span class='line'>     <span class="nf">didWriteData:</span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="nv">bytesWritten</span>
</span><span class='line'><span class="nf">totalBytesWritten:</span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="nv">totalBytesWritten</span>
</span><span class='line'><span class="nf">totalBytesExpectedToWrite:</span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="nv">totalBytesExpectedToWrite</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;%f / %f&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">totalBytesWritten</span><span class="p">,</span>
</span><span class='line'>    <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">totalBytesExpectedToWrite</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>正如你所见，<code>NSURLSessionTask</code>是一匹通过网络来干活的真实的驮马。</p>

<h4>NSURLSessionTask</h4>

<p>目前为止你已经知道<code>NSURLSessionDataTask</code>和<code>NSURLSessionDownloadTask</code>怎样使用了。这两个的任务是来自他们共同的基类<code>NSURLSessionTask</code>，你可以在这类看到：</p>

<p><img src="http://ww1.sinaimg.cn/mw690/64124373gw1ezzij54674j20go0d53zc.jpg" alt="networking13" /></p>

<p><code>NSURLSessionTask</code>在你的会话中是任务的基类；他们只能通过一个会话创建并且它们是下面子类中的一个。</p>

<h4>NSURLSessionDataTask</h4>

<p>这个任务发起HTTP GET请求来从服服务器拉取数据。数据被返回以NSData的形式返回。你应该在随后将其把这个数据转换成正确的数据类型比如<code>XML</code>,<code>JSON</code>,UIImage，plist等等。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="bp">NSURLSessionDataTask</span> <span class="o">*</span><span class="n">jsonData</span> <span class="o">=</span> <span class="p">[</span><span class="n">session</span> <span class="nl">dataTaskWithURL</span><span class="p">:</span><span class="n">yourNSURL</span>
</span><span class='line'>      <span class="nl">completionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSData</span>  <span class="o">*</span><span class="n">data</span><span class="p">,</span>
</span><span class='line'>                          <span class="bp">NSURLResponse</span>  <span class="o">*</span><span class="n">response</span><span class="p">,</span>
</span><span class='line'>                          <span class="bp">NSError</span>  <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// handle NSData</span>
</span><span class='line'><span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure>


<h4>NSURLSessionUploadTask</h4>

<p>使用这个类当你需要上传一些东西到web服务器时，使用HTTP <code>POST</code> 或者 <code>PUT</code> 命令。任务带来也允许你监视网络状况当它正在传输的时候。</p>

<p>上传一张图片：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="bp">NSData</span> <span class="o">*</span><span class="n">imageData</span> <span class="o">=</span> <span class="n">UIImageJPEGRepresentation</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="bp">NSURLSessionUploadTask</span> <span class="o">*</span><span class="n">uploadTask</span> <span class="o">=</span>
</span><span class='line'>  <span class="p">[</span><span class="n">upLoadSession</span> <span class="nl">uploadTaskWithRequest</span><span class="p">:</span><span class="n">request</span>
</span><span class='line'>                              <span class="nl">fromData</span><span class="p">:</span><span class="n">imageData</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>在这类任务被创建从一个会话中并且图片以NSData的形式上传。这里也可以通使用一个文件或者流的方法来进行上传。</p>

<h4>NSURLSessionDownloadTask</h4>

<p><code>NSURLSessionDownloadTask</code>让通过远程服务下载文件变得超级简单，并且可以暂停和恢复下载只要你想。这个子类有别于其他两个。</p>

<ul>
<li>这个类型的任务直接写入一个临时文件。</li>
<li>在下载会话中将调用<code>URLSession:downloadTask:didWriteData:totalBytesWritten:totalBytesExpectedToWrite:</code>来更新状态信息。</li>
<li>当任务完成时，<code>URLSession:downloadTask:didFinishDownloadingToURL:</code>被调用。这就是你该保存文件从临时位置到一个永久位置的时候。</li>
<li>当下载失败或者取消时，你可以让数据重新开始下载。</li>
</ul>


<p>这个特性将极其有用当你在下载一个<code>Byte Club</code>定位 全景照片给你的设备的相机胶卷。你看到的一个下载任务例子在上面下载图片片段中。</p>

<h5>上述全部</h5>

<p>所有的上述任务被创建在一个暂停的状态；在创建一个任务时你需要调用它的继续方法像下面演示的那样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">[</span><span class="n">uploadTask</span> <span class="n">resume</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>当你一次不只管理一个任务时，<code>taskIdentifier</code>接口允许你唯一标示一个在会话中的任务</p>

<p>这就是！既然你已经知道了<code>NSURLSession</code>系列的主要类，让我们尝试一下。</p>

<h4>Sharing notes with NSURLSession</h4>

<p>OK，这不是死亡诗社，这是<code>Byte Club</code>!是时候开始看看一下这个的网络代码在起作用了。</p>

<p>你需要一个方法来给<code>Byte Club</code>的其他成员发送消息。既然你已经设置了接入token，下一步就是实例化<code>NSURLSesssion</code>对象，让后调用你的第一个Dropbox API。</p>

<h5>Creating an NSURLSession</h5>

<p>添加下面的接口到 <strong>NotesViewController.m</strong> 文件，就在 NSArray  *notes 行的后面：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="bp">NSURLSession</span> <span class="o">*</span><span class="n">session</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>你将创造所有你的下属从上面的session中。</p>

<p>添加下面的方法到<code>NotesViewController.m</code>就在<code>initWithStyle</code>方法的上面：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">initWithCoder:</span><span class="p">(</span><span class="bp">NSCoder</span> <span class="o">*</span><span class="p">)</span><span class="nv">aDecoder</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="nl">initWithCoder</span><span class="p">:</span><span class="n">aDecoder</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 1</span>
</span><span class='line'>        <span class="bp">NSURLSessionConfiguration</span>  <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURLSessionConfiguration</span> <span class="n">ephemeralSessionConfiguration</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 2</span>
</span><span class='line'>        <span class="p">[</span><span class="n">config</span> <span class="nl">setHTTPAdditionalHeaders</span><span class="p">:</span><span class="l">@{</span><span class="s">@&quot;Authorization&quot;</span><span class="o">:</span> <span class="p">[</span><span class="n">Dropbox</span> <span class="n">apiAuthorizationHeader</span><span class="p">]</span><span class="l">}</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 3</span>
</span><span class='line'>         <span class="n">_session</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURLSession</span> <span class="nl">sessionWithConfiguration</span><span class="p">:</span><span class="n">config</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面是上面代码注释的注释的解释：</p>

<ol>
<li>你的app调用 <code>initWithCoder</code>当你实例化一个控制器从一个故事版中;因此这是一个完美的时刻初始化和创建<code>NSURLSession</code>。你并不想积极缓存或者持久化这里，所有你使用<code>ephemeralSessionConfiguration</code>便利方法，它返回一个没有持久化缓存，cookies，或者认证存储的会话。这是一个"私有浏览"配置。</li>
<li>下一步，你添加授权HTTP头道配置对象中。apiAuthorizationHeader是一个我写的辅助方法，返回一个字符串，以授权制定的格式。这个字符串包含access token，token secret和你的 Dropbox App API 秘钥。记住这是必要的因为每个对 Dropbox API 的调用都需要被授权。</li>
<li>最后，你使用上面的配置创建了<code>NSURLSession</code>。</li>
</ol>


<p>会话现在准备好创建在你app中你所需要的任何网络任务。</p>

<h5>GET Notes through the Dropbox API</h5>

<p>为了模拟一条笔记被另一个用户添加，添加任何你在设置在你的Dropbox根目录下的文件夹中选择的文本文件。例如位于Dropbox文件夹下 <strong>byteclub</strong> 下面显示的 <strong>test.txt</strong>：</p>

<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1ezzkkwyf6ej20go03tglw.jpg" alt="networking14" /></p>

<p>等待直到<code>Dropbox</code>确认它已经同步完你的文件，让后继续下面代码。</p>

<p>添加下面的代码到空的<code>notesOnDropBox</code>方法中在<code>NotesViewController.m</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">[</span><span class="bp">UIApplication</span> <span class="n">sharedApplication</span><span class="p">].</span><span class="n">networkActivityIndicatorVisible</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="bp">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dropbox</span> <span class="n">appRootURL</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'><span class="bp">NSURLSessionDataTask</span> <span class="o">*</span><span class="n">dataTask</span> <span class="o">=</span>
</span><span class='line'><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">session</span> <span class="nl">dataTaskWithURL</span><span class="p">:</span><span class="n">url</span>
</span><span class='line'>            <span class="nl">completionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSData</span>  <span class="o">*</span><span class="n">data</span><span class="p">,</span>
</span><span class='line'>                                <span class="bp">NSURLResponse</span>  <span class="o">*</span><span class="n">response</span><span class="p">,</span>
</span><span class='line'>                                <span class="bp">NSError</span>  <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// TODO 1: More coming here!</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 3  </span>
</span><span class='line'><span class="p">[</span><span class="n">dataTask</span> <span class="n">resume</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个方法的目标是检索在app的Dropbox文件下的文件列表。让我们来重温一下这是怎样工作的一步步。</p>

<ol>
<li>在Dropbox中，你能看到一个文件夹的内容通过进行一个已经授权的<code>GET</code>请求到某个特别的URL - 像<a href="https://api.dropbox.com/1/metadata/dropbox/byteclub.">https://api.dropbox.com/1/metadata/dropbox/byteclub.</a> 我已经创建了一个便利的方法在Dropbox类中来为你产生这个URL。</li>
<li><code>NSURLSession</code>用便利构造方法来简单的创建各种类型的任务。这是你创建的一个数据任务为了执行一个GET请求到那个URL。当请求完成时，你的<code>completionHandler</code> block被调用。一会儿你将添加一下代码到这里。</li>
<li>记住一个任务默认是一个<code>暂停</code>的状态,因此你需要调用恢复方法来启动运行。</li>
</ol>


<p>那就是所有你需要做的来开始一个<code>GET</code>请求-现在让我们添加代码到解析的结果中。添加下面的这些行到"TUDO 1"注释的后面:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="bp">NSHTTPURLResponse</span> <span class="o">*</span><span class="n">httpResp</span> <span class="o">=</span> <span class="p">(</span><span class="bp">NSHTTPURLResponse</span> <span class="o">*</span><span class="p">)</span> <span class="n">response</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">httpResp</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">NSError</span>  <span class="o">*</span><span class="n">jsonError</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 2</span>
</span><span class='line'>    <span class="bp">NSDictionary</span>  <span class="o">*</span><span class="n">notesJSON</span> <span class="o">=</span>
</span><span class='line'>      <span class="p">[</span><span class="bp">NSJSONSerialization</span> <span class="nl">JSONObjectWithData</span><span class="p">:</span><span class="n">data</span>
</span><span class='line'>        <span class="nl">options</span><span class="p">:</span><span class="n">NSJSONReadingAllowFragments</span>
</span><span class='line'>        <span class="nl">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">jsonError</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">NSMutableArray</span>  <span class="o">*</span><span class="n">notesFound</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSMutableArray</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jsonError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// TODO 2: More coming here!</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面是两个主要的部分:</p>

<ol>
<li><p>你知道你已经发送一个HTTP请求，所以响应将是一个HTTPP响应。因此这里你可以抛出<code>NSURLResponse</code>到一个<code>NSHTTPURLRequest</code>响应以便你能够接入到接口的状态码。
假如你收到了一个HTTP状态码200，然后一切正常。</p>

<p>  HTTP 错误码举例：</p>

<ul>
<li>400 - 输入参数错误。错误消息将表明那个和为什么错误。</li>
<li>401 - token错误或者失效。这个可能发生假如用户或者<code>Dropbox</code>被撤销或者接入token过期。你可以通过重新授权修复这个用户。</li>
<li>403 - 错误的授权请求（错误的用户键，坏的随机数，时间戳过期&hellip;）。不信的是，重新授权用户在这里并没有用。</li>
<li>404 - 指定路径下的文件或者文件夹没找到。</li>
<li>405 - 未知的请求方法（通常应该是 GET 或者 POST）。</li>
<li>429 - 你的app发送太多请求超出了限制的速率，429能够触发在每个app或者每个用户根部。</li>
<li>503 - 假如响应包括重发后的头，这就意味做你的<code>OAuth</code> 1.0 app 正在被限速。否则，这个表明了一个短暂的服务器错误，并且你的app应该重新发送这这个请求。</li>
<li>507 - 用户超出 Dropbox 储存配额。</li>
<li>5xx - 服务器错误。</li>
</ul>
</li>
<li><p>Dropbox API返回JSON类型的数据。所有你收到一个200的响应，然后应该把数据转发成JSON使用iOS的构建JSON序列化的方法。了解更多关于JSON和NSJSONSerialization，查看第23章在 <code>iOS 5 by Tutorials</code>,&ldquo;Working with JSON.&rdquo;</p></li>
</ol>


<p>JSON 数据返回从Dropbox将看起来像下面这样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="s">&quot;hash&quot;</span><span class="o">:</span> <span class="s">&quot;6a29b68d106bda4473ffdaf2e94c4b61&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;revision&quot;</span><span class="o">:</span> <span class="mi">73052</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;rev&quot;</span><span class="o">:</span> <span class="s">&quot;11d5c00e1cf6c&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;thumb_exists&quot;</span><span class="o">:</span> <span class="nb">false</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;bytes&quot;</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;modified&quot;</span><span class="o">:</span> <span class="s">&quot;Sat, 10 Aug 2013 21:56:50 +0000&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;path&quot;</span><span class="o">:</span> <span class="s">&quot;/byteclub&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;is_dir&quot;</span><span class="o">:</span> <span class="nb">true</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;icon&quot;</span><span class="o">:</span> <span class="s">&quot;folder&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;root&quot;</span><span class="o">:</span> <span class="s">&quot;dropbox&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&quot;contents&quot;</span><span class="o">:</span> <span class="p">[{</span>
</span><span class='line'>        <span class="s">&quot;revision&quot;</span><span class="o">:</span> <span class="mi">73054</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;rev&quot;</span><span class="o">:</span> <span class="s">&quot;11d5e00e1cf6c&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;thumb_exists&quot;</span><span class="o">:</span> <span class="nb">false</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;bytes&quot;</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;modified&quot;</span><span class="o">:</span> <span class="s">&quot;Sat, 10 Aug 2013 23:21:03 +0000&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;client_mtime&quot;</span><span class="o">:</span> <span class="s">&quot;Sat, 10 Aug 2013 23:21:02 +0000&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;path&quot;</span><span class="o">:</span> <span class="s">&quot;/byteclub/test.txt&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;is_dir&quot;</span><span class="o">:</span> <span class="nb">false</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;icon&quot;</span><span class="o">:</span> <span class="s">&quot;page_white_text&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;root&quot;</span><span class="o">:</span> <span class="s">&quot;dropbox&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;mime_type&quot;</span><span class="o">:</span> <span class="s">&quot;text/plain&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&quot;size&quot;</span><span class="o">:</span> <span class="s">&quot;16 bytes&quot;</span>
</span><span class='line'>    <span class="p">}],</span>
</span><span class='line'>    <span class="s">&quot;size&quot;</span><span class="o">:</span> <span class="s">&quot;0 bytes&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>所有最后一段添加的代码是拉取的部分你感兴趣的从JSON中。特别的，你想循环遍历“contents”数组来把“is_dir”设置成<code>false</code>。</p>

<p>这样做，添加下面的代码到“TODO 2”注释后面：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="bp">NSArray</span> <span class="o">*</span><span class="n">contentsOfRootDirectory</span> <span class="o">=</span> <span class="n">notesJSON</span><span class="p">[</span><span class="s">@&quot;contents&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="n">data</span> <span class="k">in</span> <span class="n">contentsOfRootDirectory</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s">@&quot;is_dir&quot;</span><span class="p">]</span> <span class="n">boolValue</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">DBFile</span>  <span class="o">*</span><span class="n">note</span> <span class="o">=</span> <span class="p">[[</span><span class="n">DBFile</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithJSONData</span><span class="p">:</span><span class="n">data</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">notesFound</span> <span class="nl">addObject</span><span class="p">:</span><span class="n">note</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="n">notesFound</span> <span class="nl">sortUsingComparator</span><span class="p">:</span>
</span><span class='line'>  <span class="o">^</span><span class="n">NSComparisonResult</span><span class="p">(</span><span class="kt">id</span> <span class="n">obj1</span><span class="p">,</span> <span class="kt">id</span> <span class="n">obj2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">obj1</span> <span class="nl">compare</span><span class="p">:</span><span class="n">obj2</span><span class="p">];</span>
</span><span class='line'><span class="p">}];</span>
</span><span class='line'>
</span><span class='line'><span class="nb">self</span><span class="p">.</span><span class="n">notes</span> <span class="o">=</span> <span class="n">notesFound</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 6</span>
</span><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="bp">UIApplication</span> <span class="n">sharedApplication</span><span class="p">].</span><span class="n">networkActivityIndicatorVisible</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里有两部分：</p>

<ol>
<li><p>你拉取数组对象从“contents”键中，让后循环便利数组。每个数组入口是一个文件，所以你创建一个相应的<code>DBFile</code>文件模型为每一个文件。</p>

<p> <code>DBFile</code>是一个我为你创建的辅助类，为了拉取信息从一个JSON字典到一个文件中 - 轻轻一瞥就能看到它是怎样工作的。</p>

<p> 当你完成时，你添加所有的笔记到<code>self.notes</code>接口中。表视图被设置来显示数组中的任何记录。</p></li>
</ol>


<p>既然你的表视图数据源已经更新了，你需要重载表的数据。无论何时你正在处理异步网络请求时，你必须保证更新UIKit在主线程。</p>

<p>机敏的读者将会注意到在上述代码中没有错误处理；假如你感觉你像一个哭丧女（大多数Byte Club 都是！）添加一些代码在这里（在随后的代码块中你将添加），代码在错误和警告用户的时候将重试。</p>

<p>构建运行你的app；你应该看你添加到你的<code>Dropbox</code>文件夹的文件是否显示在列表中，就像下面例子一样显示：</p>

<p><img src="http://ww2.sinaimg.cn/mw690/64124373gw1ezzmc48hezj20aa0gojs1.jpg" alt="networking16" /></p>

<p>事情本来是小事，当时这证明了你正确的调用了Dropbox API。</p>

<p>下一步是发布比较然后向其他俱乐部成员发起挑战，再一次使用Dropbox API 就当你是传送机构。</p>

<h5>POST Notes through the Dropbox API</h5>

<p>轻点右上角的 + 号，你将看到笔记add/edit屏幕出现，就像下面演示的一样：</p>

<p><img src="http://ww4.sinaimg.cn/mw690/64124373gw1ezzmc5whzij20a90gojru.jpg" alt="networking17" /></p>

<p>开始的app已经安装了DBFile 模型对象到NoteDetailsViewController在<code>prepareForSegue:sender:</code>方法中：</p>

<p>加入你瞥一眼这个方法，你将看到<code>NoteViewController</code>被设置成<code>NoteDetailsViewController</code>的代理。这种方法，<code>NoteDetailsViewController</code>能够通知<code>NoteViewController</code>当用户完成编辑一篇笔记或者取消编辑一篇笔记时。</p>

<p>打开<code>NotesViewController.m</code>,添加下面这行到<code>prepareForSegue:sender:</code>中，就在<code>showNote.delegate = self</code>行的后面；</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="n">showNote</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">_session</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>NoteDetailsViewController</code>已经有一个<code>NSURLSession</code>的接口名字叫做<code>session</code>,因此你能够设置它在<code>prepareForSegue:sender:</code>载入之前。</p>

<p>现在detail view controller将获得相同的<code>NSURLSession</code>,所有detail view controller能够使用它来进行DropBox 的API调用。</p>

<p><code>Cancel</code>和<code>Done</code>按钮已经呈现在你的app中；你只需要添加一些在他们背后保存或者取消在尚未完工的笔记逻辑。</p>

<p>在<code>NoteDetailsViewController.m</code>,找到下面这一行在<code>(IBAction)done:(id)sender:</code>方法中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// - UPLOAD FILE TO DROPBOX - //</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">delegate</span> <span class="nl">noteDetailsViewControllerDoneWithDetails</span><span class="p">:</span><span class="nb">self</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>&hellip;用下面的替换它：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// 1</span>
</span><span class='line'><span class="bp">NSURL</span>  <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dropbox</span> <span class="nl">uploadURLForPath</span><span class="p">:</span> <span class="n">_note</span><span class="p">.</span><span class="n">path</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2</span>
</span><span class='line'><span class="bp">NSMutableURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span>
</span><span class='line'>  <span class="p">[[</span><span class="bp">NSMutableURLRequest</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithURL</span><span class="p">:</span><span class="n">url</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">request</span> <span class="nl">setHTTPMethod</span><span class="p">:</span><span class="s">@&quot;PUT&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 3</span>
</span><span class='line'><span class="bp">NSData</span> <span class="o">*</span><span class="n">noteContents</span> <span class="o">=</span> <span class="p">[</span><span class="n">_note</span><span class="p">.</span><span class="n">contents</span> <span class="nl">dataUsingEncoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 4</span>
</span><span class='line'><span class="bp">NSURLSessionUploadTask</span> <span class="o">*</span><span class="n">uploadTask</span> <span class="o">=</span> <span class="p">[</span><span class="n">_session</span>
</span><span class='line'>  <span class="nl">uploadTaskWithRequest</span><span class="p">:</span><span class="n">request</span>
</span><span class='line'>  <span class="nl">fromData</span><span class="p">:</span><span class="n">noteContents</span>
</span><span class='line'>  <span class="nl">completionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSData</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
</span><span class='line'>  <span class="bp">NSURLResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">,</span>
</span><span class='line'>  <span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="bp">NSHTTPURLResponse</span> <span class="o">*</span><span class="n">httpResp</span> <span class="o">=</span> <span class="p">(</span><span class="bp">NSHTTPURLResponse</span><span class="o">*</span><span class="p">)</span> <span class="n">response</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">httpResp</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>       <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">delegate</span> <span class="nl">noteDetailsViewControllerDoneWithDetails</span><span class="p">:</span><span class="nb">self</span><span class="p">];</span>
</span><span class='line'>   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>       <span class="c1">// alert for error saving / updating note</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">}];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 5</span>
</span><span class='line'><span class="p">[</span><span class="n">uploadTask</span> <span class="n">resume</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个实现了你需要保存和分享你的笔记的所有事情。假如仔细观察每一块的注释，你将发现做了下面的事：</p>

<ol>
<li>为了上传一个文件到Dropbox，你需要再次使用某个API URL。就像先前你需要一个URL来列出在一个文件夹中的文件，我已经构造了一个辅助方法来为你产生URL。你可以在这里调用。</li>
<li>下一步是你的老朋友<code>NSMutableURLRequest</code>,新的APIs能够同时使用普通的URL是和<code>NSURLRequest</code>对象，但是这里你需要可变的形式来使Dropbox API让它的请求变成PUT请求。设置HTTP方法作为PUT发信号给Dropbox来让它为你创建一个新的文件。</li>
<li>下一步是将文本从你的<code>UITextView</code>编码成NSData对象。</li>
<li>既然你已经创建好了请求和NSData数据，你下一步就是创建一个<code>NSURLSessionUploadTask</code>然后设置<code>completion handler</code> block.一旦成功，你就调用代理方法<code>noteDetailsViewControllerDoneWithDetails:</code>来关闭呈现的内容。在生产级别的应用中你可以回传一个新的BDFile给代理然后同步你需要持久化的数据。为了这个应用，你只需要刷新<code>NotesViewController</code>用一个网络调用。</li>
<li>再次提到，所有的任务以暂停的状态被创建，所以你必须调用恢复来启动他们。</li>
</ol>


<p>构建然后运行你的App，点击笔记标签上的+号。在<code>challenge name</code>字段上输入你的名字，输入一些文本在<code>note</code>字段想Ray发布一份挑战书，和下面的例子相似：</p>

<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1f008ujjji0j20aa0godgy.jpg" alt="networking17" /></p>

<p>当你清点<code>Done</code>时，<code>NoteViewController</code>将返回并且给你列出新的笔记像下面显示的那样：</p>

<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1f008ukjg7bj20aa0go3z4.jpg" alt="networking18" />
)</p>

<p>你已经正式的给Ray下发挑战书；然而，他有朋友在非常高的位置所有你最好尽力完成这场比赛。</p>

<p>但是这里有一条非常重要的消息遗漏了。你能告诉我是什么么？</p>

<p>轻点笔记包含的挑战；<code>NoteDetailsViewController</code>自己呈现，当时笔记的内容确实空白的。</p>

<p>Ray并不会找到你的发的非常有威胁的挑战假如他没有读的话！</p>

<p>现在，app只是调用<code>Dropbox</code>元数据API来检索文件列表。你也需要添加一些代码来抓取笔记的内容。</p>

<p>打开<code>NoteDetailsViewController.m</code>,用下面的实现替换空白的<code>retreiveNoteText</code>的实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-(</span><span class="kt">void</span><span class="p">)</span><span class="nf">retreiveNoteText</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="bp">NSString</span>  <span class="o">*</span><span class="n">fileApi</span> <span class="o">=</span>
</span><span class='line'>      <span class="s">@&quot;https://api-content.dropbox.com/1/files/dropbox&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="bp">NSString</span>  <span class="o">*</span><span class="n">escapedPath</span> <span class="o">=</span> <span class="p">[</span> <span class="n">_note</span><span class="p">.</span><span class="n">path</span>
</span><span class='line'>      <span class="nl">stringByAddingPercentEscapesUsingEncoding</span><span class="p">:</span>
</span><span class='line'>      <span class="n">NSUTF8StringEncoding</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">NSString</span>  <span class="o">*</span><span class="n">urlStr</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span> <span class="s">@&quot;%@/%@&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">fileApi</span><span class="p">,</span><span class="n">escapedPath</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">NSURL</span>  <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURL</span> <span class="nl">URLWithString</span><span class="p">:</span> <span class="n">urlStr</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="bp">UIApplication</span> <span class="n">sharedApplication</span><span class="p">].</span><span class="n">networkActivityIndicatorVisible</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 2</span>
</span><span class='line'>    <span class="p">[[</span> <span class="n">_session</span> <span class="nl">dataTaskWithURL</span><span class="p">:</span><span class="n">url</span> <span class="nl">completionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSData</span>  <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="bp">NSURLResponse</span>  <span class="o">*</span><span class="n">response</span><span class="p">,</span> <span class="bp">NSError</span>  <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="bp">NSHTTPURLResponse</span>  <span class="o">*</span><span class="n">httpResp</span> <span class="o">=</span> <span class="p">(</span><span class="bp">NSHTTPURLResponse</span><span class="o">*</span><span class="p">)</span> <span class="n">response</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">httpResp</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// 3</span>
</span><span class='line'>                <span class="bp">NSString</span>  <span class="o">*</span><span class="n">text</span> <span class="o">=</span>
</span><span class='line'>                 <span class="p">[[</span><span class="bp">NSString</span> <span class="n">alloc</span><span class="p">]</span><span class="nl">initWithData</span><span class="p">:</span><span class="n">data</span>
</span><span class='line'>                   <span class="nl">encoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">];</span>
</span><span class='line'>                <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>                    <span class="p">[</span><span class="bp">UIApplication</span> <span class="n">sharedApplication</span><span class="p">].</span><span class="n">networkActivityIndicatorVisible</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
</span><span class='line'>                    <span class="nb">self</span><span class="p">.</span><span class="n">textView</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">;</span>
</span><span class='line'>                <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// HANDLE BAD RESPONSE //</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// ALWAYS HANDLE ERRORS :-] //</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">// 4</span>
</span><span class='line'>    <span class="p">}]</span> <span class="n">resume</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面在笔记中的代码（没有错误检查）下面来解释：</p>

<ol>
<li>设置请求的路径和你期望检索的文件的URL地址；/文件的端点在Dropbox API中将会返回给你一个指定文件的内容。</li>
<li>用指向感兴趣的文件的URL创建数据任务。这个调用应该开始，只要你纵览整个app你会相当熟悉。</li>
<li>假如你响应的代码表明所有的都是好的，在主线程用你在先前的步骤中检索到的文件内容设置textView。记住，UI更新必须切换到主线程。</li>
<li>一旦这个任务被初始化，调用恢复。这里有写不一样的方法和以前的相比，当恢复被直接调用时在任务还没有指派时。</li>
</ol>


<p>构建运行你的App，在列表中对你的挑战轻点，内容将直接正确的显示在view中，像下面这样：</p>

<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1f008ulhco4j20a90got9d.jpg" alt="networking19" /></p>

<p>你可以扮演Ray然后通过向笔记中输入文本响应这个挑战；文件将很快更新当你轻点<code>Done</code>。</p>

<h4>使用<code>NSURLSessionTask</code>代理发送照片</h4>

<p>你已经看到怎样使用<code>NSURLSession</code>异步便利构造方法。但是假如你想把注意力集中在文件传输上，例如上传一个大文件并且显示一个进度条怎么样？</p>

<p>对于这种异步的，耗时任务类型你需要实现<code>NSURLSessionTaskDelegate</code>协议方。通过实现这个方法，你能够检索回调当一个任务接收到数据和完成接收数据时。</p>

<p>你可能已经注意到<code>PanoPhotos</code>标签是空的当你启动App的时候。然而，<code>Byte Club</code>组织的创办成员已经慷慨的提供了一些他们自己的全景照片，你可以用它来填充你的app。</p>

<p>下载这些 我们为你放在一起的<a href="http://cdn4.raywenderlich.com/downloads/ByteClub_photos.zip">全景照片</a>。解压文件，拷贝到你的app在Dropbox目录下的照片目录。你文件夹的内容应该和下面一样：</p>

<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1f00a5m7rhhj20go06ddhi.jpg" alt="networking20" /></p>

<p>Dropbox和核心API可以提供照片的缩略图；使用一个 UITableView cell这听起来想一件非常完美的事。</p>

<p>打开<code>PhotosViewController.m</code>然后在<code>“GO GET THUMBNAILS</code>注释后面添加下面的代码到<code>tableView:cellForRowAtIndexPath:</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">[</span><span class="bp">UIApplication</span> <span class="n">sharedApplication</span><span class="p">].</span><span class="n">networkActivityIndicatorVisible</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'><span class="bp">NSURLSessionDataTask</span> <span class="o">*</span><span class="n">dataTask</span> <span class="o">=</span> <span class="p">[</span><span class="n">_session</span> <span class="nl">dataTaskWithURL</span><span class="p">:</span><span class="n">url</span>
</span><span class='line'>  <span class="nl">completionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSData</span>  <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="bp">NSURLResponse</span>  <span class="o">*</span><span class="n">response</span><span class="p">,</span>
</span><span class='line'>  <span class="bp">NSError</span>  <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="bp">UIImage</span>  <span class="o">*</span><span class="n">image</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">UIImage</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithData</span><span class="p">:</span><span class="n">data</span><span class="p">];</span>
</span><span class='line'>      <span class="n">photo</span><span class="p">.</span><span class="n">thumbNail</span> <span class="o">=</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'>      <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="bp">UIApplication</span> <span class="n">sharedApplication</span><span class="p">].</span><span class="n">networkActivityIndicatorVisible</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
</span><span class='line'>        <span class="n">cell</span><span class="p">.</span><span class="n">thumbnailImage</span><span class="p">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">photo</span><span class="p">.</span><span class="n">thumbNail</span><span class="p">;</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// HANDLE ERROR //</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}];</span>
</span><span class='line'><span class="p">[</span><span class="n">dataTask</span> <span class="n">resume</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面的代码显示了照片的缩略图图在表视图的cell中。。。或者至少它会是，假如<code>_photoThumbnails</code>现在不是空的话。</p>

<p>找到<code>refreshPhotos</code>用下面的实现替换：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">refreshPhotos</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[[</span><span class="bp">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="nl">setNetworkActivityIndicatorVisible</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
</span><span class='line'>    <span class="bp">NSString</span>  <span class="o">*</span><span class="n">photoDir</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;https://api.dropbox.com/1/search/dropbox/%@/photos?query=.jpg&quot;</span><span class="p">,</span><span class="n">appFolder</span><span class="p">];</span>
</span><span class='line'>    <span class="bp">NSURL</span>  <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURL</span> <span class="nl">URLWithString</span><span class="p">:</span><span class="n">photoDir</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[[</span> <span class="n">_session</span> <span class="nl">dataTaskWithURL</span><span class="p">:</span><span class="n">url</span> <span class="nl">completionHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSData</span>
</span><span class='line'>       <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="bp">NSURLResponse</span>  <span class="o">*</span><span class="n">response</span><span class="p">,</span> <span class="bp">NSError</span>  <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="bp">NSHTTPURLResponse</span>  <span class="o">*</span><span class="n">httpResp</span> <span class="o">=</span>
</span><span class='line'>             <span class="p">(</span><span class="bp">NSHTTPURLResponse</span><span class="o">*</span><span class="p">)</span> <span class="n">response</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">httpResp</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>                <span class="bp">NSError</span>  <span class="o">*</span><span class="n">jsonError</span><span class="p">;</span>
</span><span class='line'>                <span class="bp">NSArray</span>  <span class="o">*</span><span class="n">filesJSON</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSJSONSerialization</span>
</span><span class='line'>                  <span class="nl">JSONObjectWithData</span><span class="p">:</span><span class="n">data</span>
</span><span class='line'>                  <span class="nl">options</span><span class="p">:</span><span class="n">NSJSONReadingAllowFragments</span>
</span><span class='line'>                  <span class="nl">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">jsonError</span><span class="p">];</span>
</span><span class='line'>                <span class="bp">NSMutableArray</span>  <span class="o">*</span><span class="n">dbFiles</span> <span class="o">=</span>
</span><span class='line'>                  <span class="p">[[</span><span class="bp">NSMutableArray</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">jsonError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">for</span> <span class="p">(</span><span class="bp">NSDictionary</span>  <span class="o">*</span><span class="n">fileMetadata</span> <span class="k">in</span>
</span><span class='line'>                      <span class="n">filesJSON</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">DBFile</span>  <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="p">[[</span><span class="n">DBFile</span> <span class="n">alloc</span><span class="p">]</span>
</span><span class='line'>                          <span class="nl">initWithJSONData</span><span class="p">:</span><span class="n">fileMetadata</span><span class="p">];</span>
</span><span class='line'>                        <span class="p">[</span><span class="n">dbFiles</span> <span class="nl">addObject</span><span class="p">:</span><span class="n">file</span><span class="p">];</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                    <span class="p">[</span><span class="n">dbFiles</span> <span class="nl">sortUsingComparator</span><span class="p">:</span><span class="o">^</span><span class="n">NSComparisonResult</span><span class="p">(</span><span class="kt">id</span> <span class="n">obj1</span><span class="p">,</span> <span class="kt">id</span> <span class="n">obj2</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">return</span> <span class="p">[</span><span class="n">obj1</span> <span class="nl">compare</span><span class="p">:</span><span class="n">obj2</span><span class="p">];</span>
</span><span class='line'>                    <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>                     <span class="n">_photoThumbnails</span> <span class="o">=</span> <span class="n">dbFiles</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>                        <span class="p">[[</span><span class="bp">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="nl">setNetworkActivityIndicatorVisible</span><span class="p">:</span><span class="nb">NO</span><span class="p">];</span>
</span><span class='line'>                        <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
</span><span class='line'>                    <span class="p">});</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// HANDLE BAD RESPONSE //</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// ALWAYS HANDLE ERRORS :-] //</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}]</span> <span class="n">resume</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个和你早期载入挑战笔记时写的代码很像。这次，API调用来查找在<code>photos</code>目录的内容，并且只会以.jpg拓展的文件。</p>

<p>既然<code>_photoThumbnails</code>数组已经填充好了，缩略图将出现在表视图中并且异步更新。</p>

<p>构建运行你的app，然后切换到<code>PanoPhotos</code>标签；缩略图将载入并且像下面这样出现：</p>

<p>！<a href="http://ww2.sinaimg.cn/mw690/64124373gw1f00ahhaw20j20a90go0uz.jpg">networking21</a></p>

<p>照片看起来非常的棒&ndash;只是请当心Matthijs家撕裂代码的猫🐱！</p>

<h4>上传一张全景照片</h4>

<p>你的app能够下载相片，如果它也能上传照片并且显示上传进度的话就非常棒了。</p>

<p>为了跟踪上传的进度，<code>PhotosViewController</code>必须成为<code>NSURLSessionDelegate</code>和<code>NSURLSessionTaskDelegate</code>协议的代理，以便你能收到进度回调。</p>

<p>修改在<code>PhotosViewController.m</code>中<code>PhotosViewController</code>的接口声明，添加<code>NSURLSessionTaskDelegate</code>,像下面这样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'> <span class="p">@</span> <span class="n">interface</span> <span class="n">PhotosViewController</span> <span class="p">()</span><span class="bp">UITableViewDelegate</span><span class="p">,</span> <span class="bp">UITableViewDataSource</span><span class="p">,</span> <span class="bp">UIImagePickerControllerDelegate</span><span class="p">,</span> <span class="bp">UINavigationControllerDelegate</span><span class="p">,</span> <span class="bp">NSURLSessionTaskDelegate</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>下一步，添加下面的私有接口：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span>
</span><span class='line'>  <span class="bp">NSURLSessionUploadTask</span> <span class="o">*</span><span class="n">uploadTask</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面的指针引用了任务对象；通过哪种方式，你就可以接入到对象的成员中来跟踪上传任务的进度了。</p>

<p>当用户选择一张图片上传时，<code>didFinishPickingMediaWithInfo</code>调用<code>uploadImage:</code>方法来执行文件上传。
现在，那个方法空了-这是你的工作让它丰满起来。</p>

<p>替换<code>uploadImage:</code>用下面的代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">uploadImage:</span><span class="p">(</span><span class="bp">UIImage</span><span class="o">*</span><span class="p">)</span><span class="nv">image</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="bp">NSData</span>  <span class="o">*</span><span class="n">imageData</span> <span class="o">=</span> <span class="n">UIImageJPEGRepresentation</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="bp">NSURLSessionConfiguration</span>  <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURLSessionConfiguration</span> <span class="n">defaultSessionConfiguration</span><span class="p">];</span>
</span><span class='line'>    <span class="n">config</span><span class="p">.</span><span class="n">HTTPMaximumConnectionsPerHost</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">[</span><span class="n">config</span> <span class="nl">setHTTPAdditionalHeaders</span><span class="p">:</span><span class="l">@{</span><span class="s">@&quot;Authorization&quot;</span><span class="o">:</span> <span class="p">[</span><span class="n">Dropbox</span> <span class="n">apiAuthorizationHeader</span><span class="p">]</span><span class="l">}</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 2</span>
</span><span class='line'>    <span class="bp">NSURLSession</span>  <span class="o">*</span><span class="n">upLoadSession</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSURLSession</span> <span class="nl">sessionWithConfiguration</span><span class="p">:</span><span class="n">config</span> <span class="nl">delegate</span><span class="p">:</span><span class="nb">self</span> <span class="nl">delegateQueue</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// for now just create a random file name, dropbox will handle it if we overwrite a file and create a new name..</span>
</span><span class='line'>    <span class="bp">NSURL</span>  <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dropbox</span> <span class="n">createPhotoUploadURL</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">NSMutableURLRequest</span>  <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSMutableURLRequest</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithURL</span><span class="p">:</span><span class="n">url</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">request</span> <span class="nl">setHTTPMethod</span><span class="p">:</span><span class="s">@&quot;PUT&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 3</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">uploadTask</span> <span class="o">=</span> <span class="p">[</span><span class="n">upLoadSession</span> <span class="nl">uploadTaskWithRequest</span><span class="p">:</span><span class="n">request</span> <span class="nl">fromData</span><span class="p">:</span><span class="n">imageData</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 4</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">uploadView</span><span class="p">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
</span><span class='line'>    <span class="p">[[</span><span class="bp">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="nl">setNetworkActivityIndicatorVisible</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 5</span>
</span><span class='line'>    <span class="p">[</span> <span class="n">_uploadTask</span> <span class="n">resume</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面是上面的代码做的事：</p>

<ol>
<li>起先，你使用设置在<code>initWithCoder</code>的会话和相关的便利方法来创建异步任务。这个时候，你使用一个<code>NSURLSessionConfiguration</code>,它只允许一个连接连接到远程主机，因为你上传进度处理一次就是一个文件。</li>
<li>上传和下载任务报告信息通过它们的代理返回；你将简短的实现。</li>
<li>这里你设置了<code>uploadTask</code>接口使用从<code>UIImagePicker</code>获得的JPEG图片。</li>
<li>下一步，你显示<code>UIProgressView</code>让它隐藏在<code>PhotosViewController</code>内部。</li>
<li>开始任务&ndash;额，抱歉，是恢复任务。</li>
</ol>


<p>既然代理已经设置了，你就可以实现<code>NSURLSessionTaskDelegate</code>方法来更新进度视图。</p>

<p>添加下面的代码到<code>PhotosViewController.m</code>文件末尾：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="cp">#pragma mark - NSURLSessionTaskDelegate methods</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">URLSession:</span><span class="p">(</span><span class="bp">NSURLSession</span> <span class="o">*</span><span class="p">)</span><span class="nv">session</span>
</span><span class='line'>  <span class="nf">task:</span><span class="p">(</span><span class="bp">NSURLSessionTask</span> <span class="o">*</span><span class="p">)</span><span class="nv">task</span>
</span><span class='line'>  <span class="nf">didSendBodyData:</span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="nv">bytesSent</span>
</span><span class='line'>  <span class="nf">totalBytesSent:</span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="nv">totalBytesSent</span>
</span><span class='line'>  <span class="nf">totalBytesExpectedToSend:</span><span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="nv">totalBytesExpectedToSend</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="p">[</span> <span class="n">_progress</span> <span class="nl">setProgress</span><span class="p">:</span>
</span><span class='line'>          <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">totalBytesSent</span> <span class="o">/</span>
</span><span class='line'>          <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">totalBytesExpectedToSend</span> <span class="nl">animated</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面的代理方法将定期报告信息给调用者关于上传任务的信息。它同时会更新<code>UIProgressView</code>（ _progress）的进度以便显示 totalBytesSent/totalBytesExpectedToSend,这比显示一个完成的百分比跟有意义（也更极客）。</p>

<p>剩下唯一的事就是当上传任务结束时指示一下。添加下面的代码到<code>PhotosViewController.m</code>文件末尾：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">URLSession:</span><span class="p">(</span><span class="bp">NSURLSession</span> <span class="o">*</span><span class="p">)</span><span class="nv">session</span> <span class="nf">task:</span><span class="p">(</span><span class="bp">NSURLSessionTask</span> <span class="o">*</span><span class="p">)</span><span class="nv">task</span> <span class="nf">didCompleteWithError:</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// 1</span>
</span><span class='line'>    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>        <span class="p">[[</span><span class="bp">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="nl">setNetworkActivityIndicatorVisible</span><span class="p">:</span><span class="nb">NO</span><span class="p">];</span>
</span><span class='line'>         <span class="n">_uploadView</span><span class="p">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'>        <span class="p">[</span> <span class="n">_progress</span> <span class="nl">setProgress</span><span class="p">:</span><span class="mf">0.5</span><span class="p">];</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 2</span>
</span><span class='line'>        <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>            <span class="p">[</span><span class="nb">self</span> <span class="n">refreshPhotos</span><span class="p">];</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Alert for error</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里没有很多代码，但是它执行了两项非常重要的任务：</p>

<ol>
<li>打开网络指示器，然后隐藏<code>_uploadView</code>作为上传完成的一点点清理工作。</li>
<li>刷新<code>PhotosViewController</code>以便包含你刚刚上传的照片，由于demo app是不能进行任何本地储存的上传
。在一个真正的app中，你应该把图片在本地进行储存和缓存。</li>
</ol>


<p>构建运行你的app，导航到<code>PanoPhotos</code>标签，点击照相图标选择一张照片。</p>

<p><img src="http://ww4.sinaimg.cn/mw690/64124373gw1f00bn13wq4j20di09ojs2.jpg" alt="networking22" /></p>

<blockquote><p>注意：假如你说使用模拟器测试app，很显然你不能用你的Mac拍照，所有仅仅是拷贝一张全景照片
给模拟器然后上传。这样做，可以确保没有其他的Xcode工程现在连接到这个模拟器，在Xcode中选择 <strong>Xcode   Open Developer Tool   iOS Simulator</strong>。</p>

<p>从Finder中拖拽一张全景照片带模拟器中，在模拟器中图片将会在Safari中打开。长按图片然后保存图片到图库中。</p></blockquote>

<p>在选择一张图片后上传，uploadView显示在屏幕的中央，并且带有上传进度，乡下面这一样显示：</p>

<p>！<a href="http://ww1.sinaimg.cn/mw690/64124373gw1f00bn4hmqwj209e0gomzu.jpg">networking23</a></p>

<p>你可能注意到一张图片上传需要花一些时间由于上传任务设置了<code>better quality</code>缩放因子。对于那些A类性格的人，你应该提供一个取消函数假如上传花费太长的时间。</p>

<p>取消按钮在<code>uploadView</code>已经被封装起来在故事板中，所有你只需实现清楚逻辑来杀死下载操作就行。</p>

<p>用下面的代码替换<code>PhotosViewController.m</code>的<code>cancelUpload:</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">IBAction</span><span class="p">)</span><span class="nf">cancelUpload:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">sender</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span> <span class="n">_uploadTask</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">NSURLSessionTaskStateRunning</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">[</span> <span class="n">_uploadTask</span> <span class="n">cancel</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在这类你会看到，取消一个任务相当简单就是调用一个取消方法。</p>

<p>现在构建运行你的app，选择一张照片上传然后点击<code>Cancel</code>。图片上传将会停止并且<code>uploadView</code>将会被隐藏。</p>

<p>就这样&ndash;<code>Byte Club</code>完成了！</p>

<h4>何去何从？</h4>

<p>这里是<a href="http://cdn5.raywenderlich.com/downloads/ByteClub_Completed.zip">完成的工程</a>在这个<code>NSURLSession</code>教程中。</p>

<p>假如你做到这一步，恭喜你可以享受到<code>Byte Club</code>的时光！不要告诉任何<code>Android</code>的小伙伴们！ :]
你现在能够处理在你app需要的任何网络任务了。</p>

<p>假如你喜欢这个课程，你可能想要查阅我们的新书<a href="http://www.raywenderlich.com/?page_id=48020"> iOS 7 by Tutorials</a>,这是这本书的一个简略版本，这本书几乎涵盖了在iOS 7中最新和最多的APIs，这些你应该清楚的知道作为一个开发者。</p>

<p>我几乎忘记了。。。</p>

<pre><code>/slap &lt;you the reader&gt; have been slapped around a bit with a large trout.
</code></pre>

<p>（不要问我为什么 hehe！😄）</p>

<p>假如你有任何问题或者评论关于这个教程或者<code>NSURLSession</code>,请加入到下面的论坛讨论！</p>

<p>参考资料：</p>

<ul>
<li><a href="http://objccn.io/issue-5-4/">从 NSURLConnection 到 NSURLSession</a></li>
<li><a href="http://www.raywenderlich.com/51127/nsurlsession-tutorial">NSURLSession Tutorial</a></li>
</ul>


<p>译者注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com">http://blog.wangruofeng007.com</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-14T02:08:36+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/14/iosxian-cheng-an-quan-suo/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/14/iosxian-cheng-an-quan-suo/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/14/iosxian-cheng-an-quan-suo/" itemprop="url">iOS线程安全-锁</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h3>“Object－C”语言</h3>

<p>1.<strong>使用 @synchronized 类实现锁</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// 实例类person</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">person</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="c1">// 线程A</span>
</span><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="k">@synchronized</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="n">person</span> <span class="n">personA</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="bp">NSThread</span> <span class="nl">sleepForTimeInterval</span><span class="p">:</span><span class="mi">3</span><span class="p">];</span>
</span><span class='line'>        <span class="c1">// 线程休眠3秒</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="c1">// 线程B</span>
</span><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="k">@synchronized</span><span class="p">(</span><span class="n">person</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="n">person</span> <span class="n">personB</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>2.<strong>使用 NSRecursiveLock 类实现锁</strong></p>

<blockquote><p>递归锁，递归或循环方法时使用此方法实现锁，可避免死锁等问题</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// 实例类person</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">person</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 创建锁对象</span>
</span><span class='line'><span class="bp">NSRecursiveLock</span> <span class="o">*</span><span class="n">theLock</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSRecursiveLock</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 创建递归方法</span>
</span><span class='line'><span class="k">static</span> <span class="nf">void</span> <span class="p">(</span><span class="o">^</span><span class="n">testCode</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>
</span><span class='line'><span class="n">testCode</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">theLock</span> <span class="n">tryLock</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="n">person</span> <span class="n">personA</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="bp">NSThread</span> <span class="nl">sleepForTimeInterval</span><span class="p">:</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>        <span class="n">testCode</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">[</span><span class="n">theLock</span> <span class="n">unlock</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//线程A</span>
</span><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="n">testCode</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//线程B</span>
</span><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">theLock</span> <span class="n">lock</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">person</span> <span class="n">personB</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">theLock</span> <span class="n">unlock</span><span class="p">];</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>3.<strong>使用 NSConditionLock（条件锁）类实现锁</strong></p>

<blockquote><p>使用此方法可以指定，只有满足条件的时候才可以解锁</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// 实例类person</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">person</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="c1">// 创建条件锁</span>
</span><span class='line'><span class="bp">NSConditionLock</span> <span class="o">*</span><span class="n">conditionLock</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSConditionLock</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="c1">// 线程A</span>
</span><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">conditionLock</span> <span class="n">lock</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">person</span> <span class="n">personA</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="bp">NSThread</span> <span class="nl">sleepForTimeInterval</span><span class="p">:</span><span class="mi">5</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">conditionLock</span> <span class="nl">unlockWithCondition</span><span class="p">:</span><span class="mi">10</span><span class="p">];</span>
</span><span class='line'> <span class="p">});</span>
</span><span class='line'><span class="c1">// 线程B</span>
</span><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">conditionLock</span> <span class="nl">lockWhenCondition</span><span class="p">:</span><span class="mi">10</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">person</span> <span class="n">personB</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">conditionLock</span> <span class="n">unlock</span><span class="p">];</span>
</span><span class='line'> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>4.<strong>NSDistributedLock（分布式锁）</strong></p>

<blockquote><p>在iOS中不需要用到，也没有这个方法，因此本文不作介绍，这里写出来只是想让大家知道有这个锁存在。
如果想要学习NSDistributedLock的话，你可以创建MAC OS的项目自己演练，方法请自行Google，谢谢</p></blockquote>

<h3>C语言</h3>

<p>1.<strong>使用 pthread_mutex_t 实现锁</strong></p>

<blockquote><p>注意：必须在头文件导入：#import &lt;pthread.h></p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// 实例类person</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">person</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="c1">// 创建锁对象</span>
</span><span class='line'><span class="k">__block</span> <span class="kt">pthread_mutex_t</span> <span class="n">mutex</span><span class="p">;</span>
</span><span class='line'><span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'><span class="c1">// 线程A</span>
</span><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span><span class='line'>    <span class="p">[</span><span class="n">person</span> <span class="n">personA</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="bp">NSThread</span> <span class="nl">sleepForTimeInterval</span><span class="p">:</span><span class="mi">5</span><span class="p">];</span>
</span><span class='line'>    <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="c1">// 线程B</span>
</span><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span><span class='line'>    <span class="p">[</span><span class="n">person</span> <span class="n">personB</span><span class="p">];</span>
</span><span class='line'>    <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>2.<strong>使用 GCD 实现“锁”(信号量）</strong></p>

<blockquote><p>GCD提供一种信号的机制，使用它我们可以创建“锁”</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// 实例类person</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">person</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 创建并设置信量</span>
</span><span class='line'><span class="kt">dispatch_semaphore_t</span> <span class="n">semaphore</span> <span class="o">=</span> <span class="n">dispatch_semaphore_create</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 线程A</span>
</span><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="n">dispatch_semaphore_wait</span><span class="p">(</span><span class="n">semaphore</span><span class="p">,</span> <span class="n">DISPATCH_TIME_FOREVER</span><span class="p">);</span>
</span><span class='line'>    <span class="p">[</span><span class="n">person</span> <span class="n">personA</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="bp">NSThread</span> <span class="nl">sleepForTimeInterval</span><span class="p">:</span><span class="mi">5</span><span class="p">];</span>
</span><span class='line'>    <span class="n">dispatch_semaphore_signal</span><span class="p">(</span><span class="n">semaphore</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 线程B</span>
</span><span class='line'><span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="n">dispatch_semaphore_wait</span><span class="p">(</span><span class="n">semaphore</span><span class="p">,</span> <span class="n">DISPATCH_TIME_FOREVER</span><span class="p">);</span>
</span><span class='line'>    <span class="p">[</span><span class="n">person</span> <span class="n">personB</span><span class="p">];</span>
</span><span class='line'>    <span class="n">dispatch_semaphore_signal</span><span class="p">(</span><span class="n">semaphore</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>我在这里解释一下代码。<code>dispatch_semaphore_wait</code>方法是把信号量加1，<code>dispatch_semaphore_signal</code>
是把信号量减1。</p>

<p>我们把信号量当作是一个计数器，当计数器是一个非负整数时，所有通过它的线程都应该把这个整数减1。</p>

<p>如果计数器大于0，那么则允许访问，并把计数器减1。如果为0，则访问被禁止，所有通过它的线程都处于
等待的状态。</p>

<p>3.<strong>使用POSIX（条件锁）创建锁）</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='objective-c'><span class='line'><span class="c1">// 实例类person</span>
</span><span class='line'><span class="n">Person</span> <span class="o">*</span><span class="n">person</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 创建互斥锁</span>
</span><span class='line'> <span class="k">__block</span> <span class="kt">pthread_mutex_t</span> <span class="n">mutex</span><span class="p">;</span>
</span><span class='line'> <span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="c1">// 创建条件锁</span>
</span><span class='line'> <span class="k">__block</span> <span class="kt">pthread_cond_t</span> <span class="n">cond</span><span class="p">;</span>
</span><span class='line'> <span class="n">pthread_cond_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'> <span class="c1">// 线程A</span>
</span><span class='line'> <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>     <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span><span class='line'>     <span class="n">pthread_cond_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span><span class='line'>     <span class="p">[</span><span class="n">person</span> <span class="n">personA</span><span class="p">];</span>
</span><span class='line'>     <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span><span class='line'> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'> <span class="c1">// 线程B</span>
</span><span class='line'> <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">DISPATCH_QUEUE_PRIORITY_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>     <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span><span class='line'>     <span class="p">[</span><span class="n">person</span> <span class="n">personB</span><span class="p">];</span>
</span><span class='line'>     <span class="p">[</span><span class="bp">NSThread</span> <span class="nl">sleepForTimeInterval</span><span class="p">:</span><span class="mi">5</span><span class="p">];</span>
</span><span class='line'>     <span class="n">pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cond</span><span class="p">);</span>
</span><span class='line'>     <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">);</span>
</span><span class='line'> <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>效果：程序会首先调用线程B，在5秒后再调用线程A。因为在线程A中创建了等待条件锁，线程B有激活锁，只有当线程B执行完后会激活线程A。</p>

<p><code>pthread_cond_wait</code>方法为等待条件锁。</p>

<p><code>pthread_cond_signal</code>方法为激活一个相同条件的条件锁。</p>

<p>参考资料：<a href="http://www.liuhaihua.cn/archives/25316.html">http://www.liuhaihua.cn/archives/25316.html</a></p>

<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com">http://blog.wangruofeng007.com</a></p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-14T01:46:57+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/14/sqlite-jiao-cheng-qi/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/14/sqlite-jiao-cheng-qi/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/14/sqlite-jiao-cheng-qi/" itemprop="url">SQLite_教程(七)</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h4>SQLite Order By</h4>

<p>SQLite 的 <strong>ORDER BY</strong> 子句是用来基于一个或多个列按升序或降序顺序排列数据。</p>

<hr />

<p><strong>语法</strong></p>

<p>ORDER BY 子句的基本语法如下：</p>

<pre><code>SELECT column-list
FROM table_name
[WHERE condition]
[ORDER BY column1, column2, .. columnN] [ASC | DESC];
</code></pre>

<p>您可以在 ORDER BY 子句中使用多个列。确保您使用的排序列在列清单中。</p>

<p><strong>实例</strong></p>

<p>假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面是一个实例，它会将结果按 SALARY 升序排序：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY ORDER BY SALARY ASC;
</code></pre>

<p>这将产生以下结果：</p>

<pre><code>    ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
7           James       24          Houston     10000.0
2           Allen       25          Texas       15000.0
1           Paul        32          California  20000.0
3           Teddy       23          Norway      20000.0
6           Kim         22          South-Hall  45000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
</code></pre>

<p>下面是一个实例，它会将结果按 NAME 和 SALARY 升序排序：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY ORDER BY NAME, SALARY ASC;
</code></pre>

<p>这将产生以下结果：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
2           Allen       25          Texas       15000.0
5           David       27          Texas       85000.0
7           James       24          Houston     10000.0
6           Kim         22          South-Hall  45000.0
4           Mark        25          Rich-Mond   65000.0
1           Paul        32          California  20000.0
3           Teddy       23          Norway      20000.0
</code></pre>

<p>下面是一个实例，它会将结果按 NAME 降序排序：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY ORDER BY NAME DESC;
</code></pre>

<p>这将产生以下结果：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
3           Teddy       23          Norway      20000.0
1           Paul        32          California  20000.0
4           Mark        25          Rich-Mond   65000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
5           David       27          Texas       85000.0
2           Allen       25          Texas       15000.0
</code></pre>

<h4>SQLite Group By</h4>

<p>SQLite 的 <strong>GROUP BY</strong> 子句用于与 SELECT 语句一起使用，来对相同的数据进行分组。
在 SELECT 语句中，GROUP BY 子句放在 WHERE 子句之后，放在 ORDER BY 子句之前。</p>

<hr />

<p><strong>语法</strong></p>

<p>下面给出了 GROUP BY 子句的基本语法。GROUP BY 子句必须放在 WHERE 子句中的条件之后，必须放在 ORDER BY 子句之前。</p>

<pre><code>SELECT column-list
FROM table_name
WHERE [ conditions ]
GROUP BY column1, column2....columnN
ORDER BY column1, column2....columnN
</code></pre>

<p>您可以在 GROUP BY 子句中使用多个列。确保您使用的分组列在列清单中。</p>

<p><strong>实例</strong></p>

<p>假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>如果您想了解每个客户的工资总额，则可使用 GROUP BY 查询，如下所示：</p>

<pre><code>sqlite&gt; SELECT NAME, SUM(SALARY) FROM COMPANY GROUP BY NAME;
</code></pre>

<p>这将产生以下结果：</p>

<pre><code>NAME        SUM(SALARY)
----------  -----------
Allen       15000
David       85000
James       20000
Kim         45000
Mark        65000
Paul        40000
Teddy       20000
</code></pre>

<p>让我们把 ORDER BY 子句与 GROUP BY 子句一起使用，如下所示：</p>

<pre><code>sqlite&gt;  SELECT NAME, SUM(SALARY)
         FROM COMPANY GROUP BY NAME ORDER BY NAME DESC;
</code></pre>

<p>这将产生以下结果：</p>

<pre><code>NAME        SUM(SALARY)
----------  -----------
Teddy       20000
Paul        40000
Mark        65000
Kim         45000
James       20000
David       85000
Allen       15000
</code></pre>

<h4>SQLite Having 子句</h4>

<p>HAVING 子句允许指定条件来过滤将出现在最终结果中的分组结果。</p>

<p>WHERE 子句在所选列上设置条件，而 HAVING 子句则在由 GROUP BY 子句创建的分组上设置条件。</p>

<hr />

<p><strong>语法</strong></p>

<p>下面是 HAVING 子句在 SELECT 查询中的位置：</p>

<pre><code>SELECT
FROM
WHERE
GROUP BY
HAVING
ORDER BY
</code></pre>

<p>在一个查询中，HAVING 子句必须放在 GROUP BY 子句之后，必须放在 ORDER BY 子句之前。下面是包含 HAVING 子句的 SELECT 语句的语法：</p>

<pre><code>SELECT column1, column2
FROM table1, table2
WHERE [ conditions ]
GROUP BY column1, column2
HAVING [ conditions ]
ORDER BY column1, column2
</code></pre>

<p><strong>实例</strong></p>

<p>假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
8           Paul        24          Houston     20000.0
9           James       44          Norway      5000.0
10          James       45          Texas       5000.0
</code></pre>

<p>下面是一个实例，它将显示名称计数小于 2 的所有记录：</p>

<pre><code>sqlite &gt; SELECT * FROM COMPANY GROUP BY name HAVING count(name) &lt; 2;
</code></pre>

<p>这将产生以下结果：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
2           Allen       25          Texas       15000
5           David       27          Texas       85000
6           Kim         22          South-Hall  45000
4           Mark        25          Rich-Mond   65000
3           Teddy       23          Norway      20000
</code></pre>

<p>下面是一个实例，它将显示名称计数大于 2 的所有记录,注意其实这里只返回最后一条记录：</p>

<pre><code>sqlite &gt; SELECT * FROM COMPANY GROUP BY name HAVING count(name) &gt; 2;
</code></pre>

<p>这将产生以下结果：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
10          James       45          Texas       5000
</code></pre>

<h4>SQLite Distinct 关键字</h4>

<p>SQLite 的 <strong>DISTINCT</strong> 关键字与 SELECT 语句一起使用，来消除所有重复的记录，并只获取唯一一次记录。
有可能出现一种情况，在一个表中有多个重复的记录。当提取这样的记录时，DISTINCT 关键字就显得特别有意义，它只获取唯一一次记录，而不是获取重复记录。</p>

<hr />

<p><strong>语法</strong></p>

<p>用于消除重复记录的 DISTINCT 关键字的基本语法如下：</p>

<pre><code>SELECT DISTINCT column1, column2,.....columnN
FROM table_name
WHERE [condition]
</code></pre>

<p><strong>实例</strong></p>

<p>假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
8           Paul        24          Houston     20000.0
9           James       44          Norway      5000.0
10          James       45          Texas       5000.0
</code></pre>

<p>首先，让我们来看看下面的 SELECT 查询，它将返回重复的工资记录：</p>

<pre><code>sqlite&gt; SELECT name FROM COMPANY;
</code></pre>

<p>这将产生以下结果：</p>

<pre><code>NAME
----------
Paul
Allen
Teddy
Mark
David
Kim
James
Paul
James
James
</code></pre>

<p>现在，让我们在上述的 SELECT 查询中使用 DISTINCT 关键字：</p>

<pre><code>sqlite&gt; SELECT DISTINCT name FROM COMPANY;
</code></pre>

<p>这将产生以下结果，没有任何重复的条目：</p>

<pre><code>NAME
----------
Paul
Allen
Teddy
Mark
David
Kim
James
</code></pre>

<p>资料整理于：<a href="http://www.runoob.com/sqlite/sqlite-tutorial.html">RUNOOB.COM-SQLite教程</a>
转载请注明出处。</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-14T01:41:01+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/14/sqlite-jiao-cheng-liu/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/14/sqlite-jiao-cheng-liu/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/14/sqlite-jiao-cheng-liu/" itemprop="url">SQLite_教程(六)</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h4>SQLite Delete 语句</h4>

<p>SQLite 的 <strong>DELETE</strong> 查询用于删除表中已有的记录。可以使用带有 WHERE 子句的 DELETE 查询来删除选定行，否则所有的记录都会被删除。</p>

<hr />

<p><strong>语法</strong></p>

<p>带有 WHERE 子句的 DELETE 查询的基本语法如下：</p>

<pre><code>DELETE FROM table_name
WHERE [condition];
</code></pre>

<p>您可以使用 AND 或 OR 运算符来结合 N 个数量的条件。</p>

<p><strong>实例</strong></p>

<p>假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>现在，COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
</code></pre>

<p>如果您想要从 COMPANY 表中删除所有记录，则不需要使用 WHERE 子句，DELETE 查询如下：</p>

<pre><code>sqlite&gt; DELETE FROM COMPANY;
</code></pre>

<p>现在，COMPANY 表中没有任何的记录，因为所有的记录已经通过 DELETE 语句删除。</p>

<h4>SQLite Like 子句</h4>

<p>SQLite 的 <strong>LIKE</strong> 运算符是用来匹配通配符指定模式的文本值。如果搜索表达式与模式表达式匹配，LIKE 运算符将返回真（true），也就是 1。这里有两个通配符与 LIKE 运算符一起使用：</p>

<ul>
<li>百分号 （%）</li>
<li>下划线 （_）</li>
</ul>


<p>百分号（%）代表零个、一个或多个数字或字符。下划线（_）代表一个单一的数字或字符。这些符号可以被组合使用。</p>

<hr />

<p><strong>语法</strong></p>

<p>% 和 _ 的基本语法如下：</p>

<pre><code>SELECT FROM table_name
WHERE column LIKE 'XXXX%'

or

SELECT FROM table_name
WHERE column LIKE '%XXXX%'

or

SELECT FROM table_name
WHERE column LIKE 'XXXX_'

or

SELECT FROM table_name
WHERE column LIKE '_XXXX'

or

SELECT FROM table_name
WHERE column LIKE '_XXXX_'
</code></pre>

<p>您可以使用 AND 或 OR 运算符来结合 N 个数量的条件。在这里，XXXX 可以是任何数字或字符串值。</p>

<p><strong>实例</strong></p>

<p>下面一些实例演示了 带有 &lsquo;%&rsquo; 和 &lsquo;_&rsquo; 运算符的 LIKE 子句不同的地方：</p>

<table>
<thead>
<tr>
<th> 语句                        </th>
<th>描述             </th>
</tr>
</thead>
<tbody>
<tr>
<td>WHERE SALARY LIKE &lsquo;200%&rsquo;   </td>
<td>查找以 200 开头的任意值</td>
</tr>
<tr>
<td>WHERE SALARY LIKE &lsquo;%200%&rsquo;  </td>
<td>查找任意位置包含 200 的任意值</td>
</tr>
<tr>
<td>WHERE SALARY LIKE &lsquo;_00\%&rsquo; </td>
<td>查找第二位和第三位为 00 的任意值</td>
</tr>
<tr>
<td> WHERE SALARY LIKE &lsquo;2_%_%&rsquo;</td>
<td>查找以 2 开头，且长度至少为 3 个字符的任意值</td>
</tr>
<tr>
<td>WHERE SALARY LIKE &lsquo;%2&rsquo;    </td>
<td>查找以 2 结尾的任意值</td>
</tr>
<tr>
<td>WHERE SALARY LIKE &lsquo;_2%3&rsquo;  </td>
<td>查找第二位为 2，且以 3 结尾的任意值</td>
</tr>
<tr>
<td>WHERE SALARY LIKE &lsquo;2___3&rsquo; </td>
<td>查找长度为 5 位数，且以 2 开头以 3 结尾的任意值</td>
</tr>
</tbody>
</table>


<p>让我们举一个实际的例子，假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面是一个实例，它显示 COMPANY 表中 AGE 以 2 开头的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE AGE  LIKE '2%';
</code></pre>

<p>这将产生以下结果：</p>

<pre><code>    ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面是一个实例，它显示 COMPANY 表中 ADDRESS 文本里包含一个连字符（-）的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE ADDRESS  LIKE '%-%';
</code></pre>

<p>这将产生以下结果：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
4           Mark        25          Rich-Mond   65000.0
6           Kim         22          South-Hall  45000.0
</code></pre>

<h4>SQLite Glob 子句</h4>

<p>SQLite 的 <strong>GLOB</strong> 运算符是用来匹配通配符指定模式的文本值。如果搜索表达式与模式表达式匹配，GLOB 运算符将返回真（true），也就是 1。与 LIKE 运算符不同的是，GLOB 是大小写敏感的，对于下面的通配符，它遵循 UNIX 的语法。</p>

<ul>
<li>星号 （*）</li>
<li>问号 （?）</li>
</ul>


<p>星号（*）代表零个、一个或多个数字或字符。问号（?）代表一个单一的数字或字符。这些符号可以被组合使用。</p>

<hr />

<p><strong>语法</strong></p>

<p>* 和 ? 的基本语法如下：</p>

<pre><code>SELECT FROM table_name
WHERE column GLOB 'XXXX*'

or

SELECT FROM table_name
WHERE column GLOB '*XXXX*'

or

SELECT FROM table_name
WHERE column GLOB 'XXXX?'

or

SELECT FROM table_name
WHERE column GLOB '?XXXX'

or

SELECT FROM table_name
WHERE column GLOB '?XXXX?'

or

SELECT FROM table_name
WHERE column GLOB '????'
</code></pre>

<p>您可以使用 AND 或 OR 运算符来结合 N 个数量的条件。在这里，XXXX 可以是任何数字或字符串值。</p>

<hr />

<p><strong>实例</strong></p>

<p>下面一些实例演示了 带有 &lsquo;*&rsquo; 和 &lsquo;?&rsquo; 运算符的 GLOB 子句不同的地方：</p>

<table>
<thead>
<tr>
<th> 语句                                  </th>
<th>描述         </th>
</tr>
</thead>
<tbody>
<tr>
<td>WHERE SALARY GLOB &lsquo;200*&rsquo;              </td>
<td>查找以 200 开头的任意值</td>
</tr>
<tr>
<td>WHERE SALARY GLOB &lsquo;*200*&rsquo;            </td>
<td>查找任意位置包含 200 的任意值</td>
</tr>
<tr>
<td>WHERE SALARY GLOB &lsquo;?00*&rsquo;              </td>
<td>查找第二位和第三位为 00 的任意值</td>
</tr>
<tr>
<td>WHERE SALARY GLOB &lsquo;2??&rsquo;                </td>
<td>查找以 2 开头，且长度至少为 3 个字符的任意值</td>
</tr>
<tr>
<td>WHERE SALARY GLOB &lsquo;*2&rsquo;                </td>
<td>查找以 2 结尾的任意值 </td>
</tr>
<tr>
<td>WHERE SALARY GLOB &lsquo;?2*3&rsquo;               </td>
<td>查找第二位为 2，且以 3 结尾的任意值</td>
</tr>
<tr>
<td>WHERE SALARY GLOB &lsquo;2???3&rsquo;              </td>
<td>查找长度为 5 位数，且以 2 开头以 3 结尾的任意值</td>
</tr>
</tbody>
</table>


<p>让我们举一个实际的例子，假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面是一个实例，它显示 COMPANY 表中 AGE 以 2 开头的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE AGE  GLOB '2*';
</code></pre>

<p>这将产生以下结果：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面是一个实例，它显示 COMPANY 表中 ADDRESS 文本里包含一个连字符（-）的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE ADDRESS  GLOB '*-*';
</code></pre>

<p>这将产生以下结果：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
4           Mark        25          Rich-Mond   65000.0
6           Kim         22          South-Hall  45000.0
</code></pre>

<h4>SQLite Limit 子句</h4>

<p>SQLite 的 <strong>LIMIT</strong> 子句用于限制由 SELECT 语句返回的数据数量。</p>

<hr />

<p><strong>语法</strong></p>

<p>带有 LIMIT 子句的 SELECT 语句的基本语法如下：</p>

<pre><code>SELECT column1, column2, columnN
FROM table_name
LIMIT [no of rows]
</code></pre>

<p>下面是 <code>LIMIT</code> 子句与 <code>OFFSET</code> 子句一起使用时的语法：</p>

<pre><code>SELECT column1, column2, columnN
FROM table_name
LIMIT [no of rows] OFFSET [row num]
</code></pre>

<p>SQLite 引擎将返回从下一行开始直到给定的 <code>OFFSET</code> 为止的所有行，如下面的最后一个实例所示。</p>

<p><strong>实例</strong></p>

<p>假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面是一个实例，它限制了您想要从表中提取的行数：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY LIMIT 6;
</code></pre>

<p>这将产生以下结果：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
</code></pre>

<p>但是，在某些情况下，可能需要从一个特定的偏移开始提取记录(<code>OFFSET下标从0开始</code>)。下面是一个实例，从第三位开始提取 3 个记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY LIMIT 3 OFFSET 2;
</code></pre>

<p>这将产生以下结果：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
</code></pre>

<p>资料整理于：<a href="http://www.runoob.com/sqlite/sqlite-tutorial.html">RUNOOB.COM-SQLite教程</a>
转载请注明出处。</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-14T01:35:50+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/14/sqlite-jiao-cheng-wu/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/14/sqlite-jiao-cheng-wu/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/14/sqlite-jiao-cheng-wu/" itemprop="url">SQLite_教程(五)</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h4>SQL表达式</h4>

<p>表达式是一个或多个值、运算符和计算值的SQL函数的组合。</p>

<p>SQL 表达式与公式类似，都写在查询语言中。您还可以使用特定的数据集来查询数据库。</p>

<hr />

<p><strong>语法</strong></p>

<p>假设 SELECT 语句的基本语法如下：</p>

<pre><code>SELECT column1, column2, columnN
FROM table_name
WHERE [CONTION | EXPRESSION];
</code></pre>

<p>有不同类型的 SQLite 表达式，具体讲解如下：</p>

<h4>SQLite - 布尔表达式</h4>

<p>SQLite 的布尔表达式在匹配单个值的基础上获取数据。语法如下：</p>

<pre><code>SELECT column1, column2, columnN
FROM table_name
WHERE SINGLE VALUE MATCHTING EXPRESSION;
</code></pre>

<p>假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面的实例演示了 SQLite 布尔表达式的用法：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE SALARY = 10000;
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
4           James        24          Houston   10000.0
</code></pre>

<h4>SQLite - 数值表达式</h4>

<p>这些表达式用来执行查询中的任何数学运算。语法如下：</p>

<pre><code>SELECT numerical_expression as  OPERATION_NAME
[FROM table_name WHERE CONDITION] ;
</code></pre>

<p>在这里，numerical_expression 用于数学表达式或任何公式。下面的实例演示了 SQLite 数值表达式的用法：</p>

<pre><code>sqlite&gt; SELECT (15 + 6) AS ADDITION
ADDITION = 21
</code></pre>

<p>有几个内置的函数，比如 avg()、sum()、count()，等等，执行被称为对一个表或一个特定的表列的汇总数据计算。</p>

<pre><code>sqlite&gt; SELECT COUNT(*) AS "RECORDS" FROM COMPANY;
RECORDS = 7
</code></pre>

<hr />

<h4>SQLite - 日期表达式</h4>

<p>日期表达式返回当前系统日期和时间值，这些表达式将被用于各种数据操作。</p>

<pre><code>sqlite&gt;  SELECT CURRENT_TIMESTAMP;
CURRENT_TIMESTAMP = 2016-01-13 16:29:56
</code></pre>

<h4>SQLite Where 子句</h4>

<p>SQLite的 WHERE 子句用于指定从一个表或多个表中获取数据的条件。</p>

<p>如果满足给定的条件，即为真（true）时，则从表中返回特定的值。您可以使用 WHERE 子句来过滤记录，只获取需要的记录。</p>

<p>WHERE 子句不仅可用在 SELECT 语句中，它也可用在 UPDATE、DELETE 语句中，等等，这些我们将在随后的章节中学习到。</p>

<hr />

<p><strong>语法</strong></p>

<p>SQLite 的带有 WHERE 子句的 SELECT 语句的基本语法如下：</p>

<pre><code>SELECT column1, column2, columnN
FROM table_name
WHERE [condition]
</code></pre>

<p><strong>实例</strong></p>

<p>您还可以使用比较或逻辑运算符指定条件，比如 >、&lt;、=、LIKE、NOT，等等。假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面的实例演示了 SQLite 逻辑运算符的用法。下面的 SELECT 语句列出了 AGE 大于等于 25 且工资大于等于 65000.00 的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE AGE &gt;= 25 AND SALARY &gt;= 65000;
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
</code></pre>

<p>下面的 SELECT 语句列出了 AGE 大于等于 25 或工资大于等于 65000.00 的所有记录：</p>

<p>sqlite> SELECT * FROM COMPANY WHERE AGE >= 25 OR SALARY >= 65000;</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
</code></pre>

<p>下面的 SELECT 语句列出了 AGE 不为 NULL 的所有记录，结果显示所有的记录，意味着没有一个记录的 AGE 等于 NULL：</p>

<pre><code>sqlite&gt;  SELECT * FROM COMPANY WHERE AGE IS NOT NULL;
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面的 SELECT 语句列出了 NAME 以 &lsquo;Ki&rsquo; 开始的所有记录，'Ki' 之后的字符不做限制（不区分大小写）：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE NAME LIKE 'Ki%';
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
6           Kim         22          South-Hall  45000.0
</code></pre>

<p>下面的 SELECT 语句列出了 NAME 以 &lsquo;Ki&rsquo; 开始的所有记录，'Ki' 之后的字符不做限制（区分大小写）：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE NAME GLOB 'Ki*';
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
6           Kim         22          South-Hall  45000.0
</code></pre>

<p>下面的 SELECT 语句列出了 AGE 的值为 25 或 27 的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE AGE IN ( 25, 27 );
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
2           Allen       25          Texas       15000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
</code></pre>

<h4>SQLite AND/OR 运算符</h4>

<p>SQLite 的 AND 和 OR 运算符用于编译多个条件来缩小在 SQLite 语句中所选的数据。这两个运算符被称为连接运算符。</p>

<p>这些运算符为同一个 SQLite 语句中不同的运算符之间的多个比较提供了可能。</p>

<hr />

<h4>AND 运算符</h4>

<p>AND 运算符允许在一个 SQL 语句的 WHERE 子句中的多个条件的存在。使用 AND 运算符时，只有当所有条件都为真（true）时，整个条件为真（true）。例如，只有当 condition1 和 condition2 都为真（true）时，[condition1] AND [condition2] 为真（true）。</p>

<p><strong>语法</strong></p>

<p>带有 WHERE 子句的 AND 运算符的基本语法如下：</p>

<pre><code>SELECT column1, column2, columnN
FROM table_name
WHERE [condition1] AND [condition2]...AND [conditionN];
</code></pre>

<p>您可以使用 AND 运算符来结合 N 个数量的条件。SQLite 语句需要执行的动作是，无论是事务或查询，所有由 AND 分隔的条件都必须为真（TRUE）。</p>

<p><strong>实例</strong></p>

<p>假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面的 SELECT 语句列出了 AGE 大于等于 25 且工资大于等于 65000.00 的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE AGE &gt;= 25 AND SALARY &gt;= 65000;
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
</code></pre>

<h4>OR 运算符</h4>

<p>OR 运算符也用于结合一个 SQL 语句的 WHERE 子句中的多个条件。使用 OR 运算符时，只要当条件中任何一个为真（true）时，整个条件为真（true）。例如，只要当 condition1 或 condition2 有一个为真（true）时，[condition1] OR [condition2] 为真（true）</p>

<p><strong>语法</strong></p>

<p>带有 WHERE 子句的 OR 运算符的基本语法如下：</p>

<pre><code>SELECT column1, column2, columnN
FROM table_name
WHERE [condition1] OR [condition2]...OR [conditionN]
</code></pre>

<p>您可以使用 OR 运算符来结合 N 个数量的条件。SQLite 语句需要执行的动作是，无论是事务或查询，只要任何一个由 OR 分隔的条件为真（TRUE）即可。</p>

<p><strong>实例</strong></p>

<p>假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面的 SELECT 语句列出了 AGE 大于等于 25 或工资大于等于 65000.00 的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE AGE &gt;= 25 OR SALARY &gt;= 65000;
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
</code></pre>

<h4>SQLite Update 语句</h4>

<p>SQLite 的 <strong>UPDATE </strong>查询用于修改表中已有的记录。可以使用带有 WHERE 子句的 UPDATE 查询来更新选定行，否则所有的行都会被更新。</p>

<hr />

<p><strong>语法</strong></p>

<p>带有 WHERE 子句的 UPDATE 查询的基本语法如下：</p>

<pre><code>UPDATE table_name
SET column1 = value1, column2 = value2...., columnN = valueN
WHERE [condition];
</code></pre>

<p>您可以使用 AND 或 OR 运算符来结合 N 个数量的条件。</p>

<hr />

<p><strong>实例</strong></p>

<p>假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面是一个实例，它会更新 ID 为 6 的客户地址：</p>

<pre><code>sqlite&gt; UPDATE COMPANY SET ADDRESS = 'Texas' WHERE ID = 6;
</code></pre>

<p>现在，COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          Texas       45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>如果您想修改 COMPANY 表中 ADDRESS 和 SALARY 列的所有值，则不需要使用 WHERE 子句，UPDATE 查询如下：</p>

<pre><code>sqlite&gt; UPDATE COMPANY SET ADDRESS = 'Texas', SALARY = 20000.00;
</code></pre>

<p>现在，COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          Texas       20000.0
2           Allen       25          Texas       20000.0
3           Teddy       23          Texas       20000.0
4           Mark        25          Texas       20000.0
5           David       27          Texas       20000.0
6           Kim         22          Texas       20000.0
7           James       24          Texas       20000.0
</code></pre>

<p>资料整理于：<a href="http://www.runoob.com/sqlite/sqlite-tutorial.html">RUNOOB.COM-SQLite教程</a>
转载请注明出处。</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-13T23:37:18+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/13/sqlite-jiao-cheng-si/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/13/sqlite-jiao-cheng-si/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/13/sqlite-jiao-cheng-si/" itemprop="url">SQLite_教程(四)</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h3>SQLite 运算符</h3>

<p><strong>SQLite 运算符是什么？</strong></p>

<p>运算符是一个保留字或字符，主要用于 SQLite 语句的 WHERE 子句中执行操作，如比较和算术运算。</p>

<p>运算符用于指定 SQLite 语句中的条件，并在语句中连接多个条件。</p>

<ul>
<li>算术运算符</li>
<li>比较运算符</li>
<li>逻辑运算符</li>
<li>位运算符</li>
</ul>


<hr />

<h4>SQLite 算术运算符</h4>

<p>假设变量 a=10，变量 b=20，则：</p>

<table>
<thead>
<tr>
<th>运算符  </th>
<th>描述                      </th>
<th>实例      </th>
</tr>
</thead>
<tbody>
<tr>
<td>+      </td>
<td>加法 - 把运算符两边的值相加</td>
<td>a + b 将得到 30</td>
</tr>
<tr>
<td>-      </td>
<td>减法 - 左操作数减去右操作数</td>
<td>a - b 将得到 -10</td>
</tr>
<tr>
<td>*      </td>
<td>乘法 - 把运算符两边的值相乘</td>
<td>a * b 将得到 200</td>
</tr>
<tr>
<td>/      </td>
<td>除法 - 左操作数除以右操作数</td>
<td>b / a 将得到 2</td>
</tr>
<tr>
<td>%      </td>
<td>取模 - 左操作数除以右操作数后得到的余数</td>
<td>b % a will give 0</td>
</tr>
</tbody>
</table>


<p><strong>实例</strong></p>

<p>下面是 SQLite 算术运算符的简单实例：</p>

<pre><code>sqlite&gt; .mode line
sqlite&gt; select 10 + 20;
10 + 20 = 30


sqlite&gt; select 10 - 20;
10 - 20 = -10


sqlite&gt; select 10 * 20;
10 * 20 = 200


sqlite&gt; select 10 / 5;
10 / 5 = 2


sqlite&gt; select 12 %  5;
12 %  5 = 2
</code></pre>

<h4>SQLite 比较运算符</h4>

<p>假设变量 a=10，变量 b=20，则：</p>

<table>
<thead>
<tr>
<th>运算符  </th>
<th>描述                                       </th>
<th>实例     </th>
</tr>
</thead>
<tbody>
<tr>
<td>==     </td>
<td>检查两个操作数的值是否相等，如果相等则条件为真。</td>
<td>(a == b) 不为真。</td>
</tr>
<tr>
<td>=      </td>
<td>检查两个操作数的值是否相等，如果相等则条件为真。</td>
<td>(a = b) 不为真。</td>
</tr>
<tr>
<td>!=     </td>
<td>检查两个操作数的值是否相等，如果不相等则条件为真。</td>
<td>(a != b) 为真。</td>
</tr>
<tr>
<td>&lt;>     </td>
<td>检查两个操作数的值是否相等，如果不相等则条件为真。</td>
<td>(a &lt;> b) 为真。</td>
</tr>
<tr>
<td>>      </td>
<td>检查左操作数的值是否大于右操作数的值，如果是则条件为真。</td>
<td>(a > b) 不为真。</td>
</tr>
<tr>
<td>&lt;      </td>
<td>检查左操作数的值是否小于右操作数的值，如果是则条件为真。</td>
<td>(a &lt; b) 为真。</td>
</tr>
<tr>
<td>>=     </td>
<td>检查左操作数的值是否大于等于右操作数的值，如果是则条件为真。</td>
<td>(a >= b) 不为真。</td>
</tr>
<tr>
<td>&lt;=     </td>
<td>检查左操作数的值是否小于等于右操作数的值，如果是则条件为真。</td>
<td>(a &lt;= b) 为真。</td>
</tr>
<tr>
<td>!&lt;     </td>
<td>检查左操作数的值是否不小于右操作数的值，如果是则条件为真。</td>
<td>(a !&lt; b) 为假</td>
</tr>
<tr>
<td>!>     </td>
<td>检查左操作数的值是否不大于右操作数的值，如果是则条件为真。</td>
<td>(a !> b) 为真</td>
</tr>
</tbody>
</table>


<p><strong>实例</strong>
假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面的实例演示了各种 SQLite 比较运算符的用法。</p>

<blockquote><p>在这里，我们使用 WHERE 子句，这将会在后边单独的一个章节中讲解，但现在您需要明白，WHERE 子句是用来设置 SELECT 语句的条件语句。</p></blockquote>

<p>下面的 SELECT 语句列出了 SALARY 大于 50,000.00 的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE SALARY &gt; 50000;
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
</code></pre>

<p>下面的 SELECT 语句列出了 SALARY 等于 20,000.00 的所有记录：</p>

<pre><code>sqlite&gt;  SELECT * FROM COMPANY WHERE SALARY = 20000;
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
3           Teddy       23          Norway      20000.0
</code></pre>

<p>下面的 SELECT 语句列出了 SALARY 不等于 20,000.00 的所有记录：</p>

<pre><code>sqlite&gt;  SELECT * FROM COMPANY WHERE SALARY != 20000;
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
2           Allen       25          Texas       15000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面的 SELECT 语句列出了 SALARY 不等于 20,000.00 的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE SALARY &lt;&gt; 20000;
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
2           Allen       25          Texas       15000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面的 SELECT 语句列出了 SALARY 大于等于 65,000.00 的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE SALARY &gt;= 65000;
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
</code></pre>

<h4>SQLite 逻辑运算符</h4>

<p>下面是 SQLite 中所有的逻辑运算符列表。</p>

<table>
<thead>
<tr>
<th>运算符    </th>
<th>描述                              </th>
</tr>
</thead>
<tbody>
<tr>
<td>AND      </td>
<td>AND 运算符允许在一个 SQL 语句的 WHERE 子句中的多个条件的存在。</td>
</tr>
<tr>
<td>BETWEEN  </td>
<td>BETWEEN 运算符用于在给定最小值和最大值范围内的一系列值中搜索值。</td>
</tr>
<tr>
<td>EXISTS   </td>
<td>EXISTS 运算符用于在满足一定条件的指定表中搜索行的存在。</td>
</tr>
<tr>
<td>IN       </td>
<td>IN 运算符用于把某个值与一系列指定列表的值进行比较。</td>
</tr>
<tr>
<td>NOT IN   </td>
<td>IN 运算符的对立面，用于把某个值与不在一系列指定列表的值进行比较。</td>
</tr>
<tr>
<td>LIKE     </td>
<td>LIKE 运算符用于把某个值与使用通配符运算符的相似值进行比较。</td>
</tr>
<tr>
<td>GLOB     </td>
<td>GLOB 运算符用于把某个值与使用通配符运算符的相似值进行比较。GLOB 与 LIKE 不同之处在于，它是大小写敏感的。</td>
</tr>
<tr>
<td>NOT      </td>
<td>NOT 运算符是所用的逻辑运算符的对立面。比如 NOT EXISTS、NOT BETWEEN、NOT IN，等等。它是否定运算符。</td>
</tr>
<tr>
<td>OR       </td>
<td>OR 运算符用于结合一个 SQL 语句的 WHERE 子句中的多个条件。</td>
</tr>
<tr>
<td>IS NULL  </td>
<td>NULL 运算符用于把某个值与 NULL 值进行比较。</td>
</tr>
<tr>
<td>IS       </td>
<td>IS 运算符与 = 相似。</td>
</tr>
<tr>
<td>IS NOT   </td>
<td>IS NOT 运算符与 != 相似。</td>
</tr>
<tr>
<td>||     </td>
<td>连接两个不同的字符串，得到一个新的字符串。</td>
</tr>
<tr>
<td>UNIQUE   </td>
<td>UNIQUE 运算符搜索指定表中的每一行，确保唯一性（无重复）。</td>
</tr>
</tbody>
</table>


<p><strong>实例</strong>
假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面的实例演示了 SQLite 逻辑运算符的用法。
下面的 SELECT 语句列出了 AGE 大于等于 25 且工资大于等于 65000.00 的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE AGE &gt;= 25 AND SALARY &gt;= 65000;
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
</code></pre>

<p>下面的 SELECT 语句列出了 AGE 大于等于 25 或工资大于等于 65000.00 的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE AGE &gt;= 25 OR SALARY &gt;= 65000;
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
</code></pre>

<p>下面的 SELECT 语句列出了 AGE 不为 NULL 的所有记录，结果显示所有的记录，意味着没有一个记录的 AGE 等于 NULL：</p>

<pre><code>sqlite&gt;  SELECT * FROM COMPANY WHERE AGE IS NOT NULL;
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面的 SELECT 语句列出了 NAME 以 &lsquo;Ki&rsquo; 开始的所有记录，'Ki' 之后的字符不做限制：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE NAME LIKE 'Ki%';
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
6           Kim         22          South-Hall  45000.0
</code></pre>

<p>下面的 SELECT 语句列出了 NAME 以 &lsquo;Ki&rsquo; 开始的所有记录，'Ki' 之后的字符不做限制：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE NAME GLOB 'Ki*';
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
6           Kim         22          South-Hall  45000.0
</code></pre>

<p>下面的 SELECT 语句列出了 AGE 的值为 25 或 27 的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE AGE IN ( 25, 27 );
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
2           Allen       25          Texas       15000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
</code></pre>

<p>下面的 SELECT 语句列出了 AGE 的值既不是 25 也不是 27 的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE AGE NOT IN ( 25, 27 );
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
3           Teddy       23          Norway      20000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面的 SELECT 语句使用 SQL 子查询，子查询查找 SALARY > 65000 的带有 AGE 字段的所有记录，后边的 WHERE 子句与 EXISTS 运算符一起使用，列出了外查询中的 AGE 存在于子查询返回的结果中的所有记录：</p>

<pre><code>sqlite&gt; SELECT AGE FROM COMPANY
        WHERE EXISTS (SELECT AGE FROM COMPANY WHERE SALARY &gt; 65000);
AGE
----------
32
25
23
25
27
22
24
</code></pre>

<p>下面的 SELECT 语句使用 SQL 子查询，子查询查找 SALARY > 65000 的带有 AGE 字段的所有记录，后边的 WHERE 子句与 > 运算符一起使用，列出了外查询中的 AGE 大于子查询返回的结果中的年龄的所有记录：</p>

<pre><code>sqlite&gt; SELECT * FROM COMPANY
        WHERE AGE &gt; (SELECT AGE FROM COMPANY WHERE SALARY &gt; 65000);
ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
</code></pre>

<h4>SQLite 位运算符</h4>

<p>位运算符作用于位，并逐位执行操作。真值表 &amp; 和 | 如下：</p>

<table>
<thead>
<tr>
<th>p  </th>
<th>q  </th>
<th>p&amp;q</th>
<th>p|q</th>
</tr>
</thead>
<tbody>
<tr>
<td>0  </td>
<td>0  </td>
<td>0  </td>
<td>0</td>
</tr>
<tr>
<td>0  </td>
<td>1  </td>
<td>0  </td>
<td>1</td>
</tr>
<tr>
<td>1  </td>
<td>1  </td>
<td>1  </td>
<td>1</td>
</tr>
<tr>
<td>1  </td>
<td>0  </td>
<td>0  </td>
<td>1</td>
</tr>
</tbody>
</table>


<p>假设如果 A = 60，且 B = 13，现在以二进制格式，它们如下所示：</p>

<p>A = 0011 1100</p>

<p>B = 0000 1101</p>

<hr />

<p>A&amp;B = 0000 1100</p>

<p>A|B = 0011 1101</p>

<p>~A  = 1100 0011</p>

<p>下表中列出了 SQLite 语言支持的位运算符。假设变量 A=60，变量 B=13，则：</p>

<table>
<thead>
<tr>
<th>运算符  </th>
<th>描述                              </th>
<th>实例     </th>
</tr>
</thead>
<tbody>
<tr>
<td>&amp;      </td>
<td>   如果同时存在于两个操作数中，二进制 AND 运算符复制一位到结果中。    </td>
<td>(A &amp; B) 将得到 12，即为 0000 1100</td>
</tr>
<tr>
<td>|     </td>
<td>如果存在于任一操作数中，二进制 OR 运算符复制一位到结果中。  </td>
<td>(A | B) 将得到 61，即为 0011 1101</td>
</tr>
<tr>
<td>~      </td>
<td>二进制补码运算符是一元运算符，具有"翻转"位效应。    </td>
<td>(~A ) 将得到 -61，即为 1100 0011，2 的补码形式，带符号的二进制数。</td>
</tr>
<tr>
<td>&lt;&lt;     </td>
<td>二进制左移运算符。左操作数的值向左移动右操作数指定的位数。    </td>
<td>A &lt;&lt; 2 将得到 240，即为 1111 0000</td>
</tr>
<tr>
<td>>>     </td>
<td>二进制右移运算符。左操作数的值向右移动右操作数指定的位数。    </td>
<td>A >> 2 将得到 15，即为 0000 1111</td>
</tr>
</tbody>
</table>


<p><strong>实例</strong></p>

<p>下面的实例演示了 SQLite 位运算符的用法：</p>

<pre><code>sqlite&gt; .mode line
sqlite&gt; select 60 | 13;
60 | 13 = 61

sqlite&gt; select 60 &amp; 13;
60 &amp; 13 = 12

sqlite&gt; select  60 ^ 13;
10 * 20 = 200


sqlite&gt;  select  (~60);
(~60) = -61

sqlite&gt;  select  (60 &lt;&lt; 2);
(60 &lt;&lt; 2) = 240

sqlite&gt;  select  (60 &gt;&gt; 2);
(60 &gt;&gt; 2) = 15
</code></pre>

<p>资料整理于：<a href="http://www.runoob.com/sqlite/sqlite-tutorial.html">RUNOOB.COM-SQLite教程</a>
转载请注明出处。</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-13T23:22:37+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/13/sqlite-jiao-cheng-san/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/13/sqlite-jiao-cheng-san/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/13/sqlite-jiao-cheng-san/" itemprop="url">SQLite_教程(三)</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h4>SQLite Insert 语句</h4>

<p>SQLite 的 INSERT INTO 语句用于向数据库的某个表中添加新的数据行。</p>

<hr />

<p><strong>语法</strong></p>

<p>INSERT INTO 语句有两种基本语法，如下所示：</p>

<pre><code>INSERT INTO TABLE_NAME (column1, column2, column3,...columnN)]  
VALUES (value1, value2, value3,...valueN);
</code></pre>

<p>在这里，column1, column2,&hellip;columnN 是要插入数据的表中的列的名称。
如果要为表中的所有列添加值，您也可以不需要在 SQLite 查询中指定列名称。但要确保值的顺序与列在表中的顺序一致。SQLite 的 INSERT INTO 语法如下：</p>

<pre><code>INSERT INTO TABLE_NAME VALUES (value1,value2,value3,...valueN);
</code></pre>

<hr />

<p><strong>实例</strong></p>

<p>假设您已经在 testDB.db 中创建了 COMPANY表，如下所示：</p>

<pre><code>sqlite&gt; CREATE TABLE COMPANY(
   ID INT PRIMARY KEY     NOT NULL,
   NAME           TEXT    NOT NULL,
   AGE            INT     NOT NULL,
   ADDRESS        CHAR(50),
   SALARY         REAL
);
</code></pre>

<p>现在，下面的语句将在 COMPANY 表中创建六个记录：</p>

<pre><code>INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY)
VALUES (1, 'Paul', 32, 'California', 20000.00 );

INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY)
VALUES (2, 'Allen', 25, 'Texas', 15000.00 );

INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY)
VALUES (3, 'Teddy', 23, 'Norway', 20000.00 );

INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY)
VALUES (4, 'Mark', 25, 'Rich-Mond ', 65000.00 );

INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY)
VALUES (5, 'David', 27, 'Texas', 85000.00 );

INSERT INTO COMPANY (ID,NAME,AGE,ADDRESS,SALARY)
VALUES (6, 'Kim', 22, 'South-Hall', 45000.00 );
</code></pre>

<p>您也可以使用第二种语法在 COMPANY 表中创建一个记录，如下所示：</p>

<pre><code>INSERT INTO COMPANY VALUES (7, 'James', 24, 'Houston', 10000.00 );
</code></pre>

<p>上面的所有语句将在 COMPANY 表中创建下列记录。下一章会教您如何从一个表中显示所有这些记录。</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<h4>使用一个表来填充另一个表</h4>

<p>您可以通过在一个有一组字段的表上使用 select 语句，填充数据到另一个表中。下面是语法：</p>

<pre><code>INSERT INTO first_table_name [(column1, column2, ... columnN)]
   SELECT column1, column2, ...columnN
   FROM second_table_name
   [WHERE condition];
</code></pre>

<h4>SQLite Select 语句</h4>

<p>SQLite 的 SELECT 语句用于从 SQLite 数据库表中获取数据，以结果表的形式返回数据。这些结果表也被称为结果集。</p>

<hr />

<p><strong>语法</strong></p>

<p>SQLite 的 SELECT 语句的基本语法如下：</p>

<pre><code>SELECT column1, column2, columnN FROM table_name;
</code></pre>

<p>在这里，column1, column2&hellip;是表的字段，他们的值即是您要获取的。如果您想获取所有可用的字段，那么可以使用下面的语法：</p>

<pre><code>SELECT * FROM table_name;
</code></pre>

<hr />

<p><strong>实例</strong></p>

<p>假设 COMPANY 表有以下记录：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>下面是一个实例，使用 SELECT 语句获取并显示所有这些记录。在这里，前三个命令被用来设置正确格式化的输出。</p>

<pre><code>sqlite&gt;.header on
sqlite&gt;.mode column
sqlite&gt; SELECT * FROM COMPANY;
</code></pre>

<p>最后，将得到以下的结果：</p>

<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>

<p>如果只想获取 COMPANY 表中指定的字段，则使用下面的查询：</p>

<pre><code>sqlite&gt; SELECT ID, NAME, SALARY FROM COMPANY;
</code></pre>

<p>上面的查询会产生以下结果：</p>

<pre><code>ID          NAME        SALARY
----------  ----------  ----------
1           Paul        20000.0
2           Allen       15000.0
3           Teddy       20000.0
4           Mark        65000.0
5           David       85000.0
6           Kim         45000.0
7           James       10000.0
</code></pre>

<hr />

<p><strong>设置输出列的宽度</strong></p>

<p>有时，由于要显示的列的默认宽度导致 .mode column，这种情况下，输出被截断。此时，您可以使用 .width num, num&hellip;. 命令设置显示列的宽度，如下所示：</p>

<pre><code>sqlite&gt;.width 10, 20, 10
sqlite&gt;SELECT * FROM COMPANY;
</code></pre>

<p>上面的 .width 命令设置第一列的宽度为 10，第二列的宽度为 20，第三列的宽度为 10。因此上述 SELECT 语句将得到以下结果：</p>

<pre><code>ID          NAME                  AGE         ADDRESS     SALARY
----------  --------------------  ----------  ----------  ----------
1           Paul                  32          California  20000.0
2           Allen                 25          Texas       15000.0
3           Teddy                 23          Norway      20000.0
4           Mark                  25          Rich-Mond   65000.0
5           David                 27          Texas       85000.0
6           Kim                   22          South-Hall  45000.0
7           James                 24          Houston     10000.0
</code></pre>

<p><strong>Schema 信息</strong>
因为所有的点命令只在 SQLite 提示符中可用，所以当您进行带有 SQLite 的编程时，您要使用下面的带有 sqlite_master 表的 SELECT 语句来列出所有在数据库中创建的表：</p>

<pre><code>sqlite&gt; SELECT tbl_name FROM sqlite_master WHERE type = 'table';
</code></pre>

<p>假设在 testDB.db 中已经存在唯一的 COMPANY 表，则将产生以下结果：</p>

<pre><code>tbl_name
----------
COMPANY
</code></pre>

<p>您可以列出关于 COMPANY 表的完整信息，如下所示：</p>

<pre><code>sqlite&gt; SELECT sql FROM sqlite_master WHERE type = 'table' AND tbl_name = 'COMPANY';
</code></pre>

<p>假设在 testDB.db 中已经存在唯一的 COMPANY 表，则将产生以下结果：</p>

<pre><code>CREATE TABLE COMPANY(
   ID INT PRIMARY KEY     NOT NULL,
   NAME           TEXT    NOT NULL,
   AGE            INT     NOT NULL,
   ADDRESS        CHAR(50),
   SALARY         REAL
)
</code></pre>

<p>资料整理于：<a href="http://www.runoob.com/sqlite/sqlite-tutorial.html">RUNOOB.COM-SQLite教程</a>
转载请注明出处。</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2016-01-13T23:21:34+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
           | <a href="/blog/2016/01/13/sqlite-jiao-cheng-er/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://wangruofeng.github.io/blog/2016/01/13/sqlite-jiao-cheng-er/">Comments</a>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2016/01/13/sqlite-jiao-cheng-er/" itemprop="url">SQLite_教程(二)</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><h4>SQLite 数据类型</h4>

<p>SQLite 数据类型是一个用来指定任何对象的数据类型的属性。SQLite 中的每一列，每个变量和表达式都有相关的数据类型。</p>

<p>您可以在创建表的同时使用这些数据类型。SQLite 使用一个更普遍的动态类型系统。在 SQLite 中，值的数据类型与值本身是相关的，而不是与它的容器相关。</p>

<h4>SQLite 存储类</h4>

<p>每个存储在 SQLite 数据库中的值都具有以下存储类之一：</p>

<table>
<thead>
<tr>
<th>存储类  </th>
<th>描述                      </th>
</tr>
</thead>
<tbody>
<tr>
<td>NULL   </td>
<td>值是一个 NULL 值。        </td>
</tr>
<tr>
<td>INTEGER</td>
<td>   值是一个带符号的整数，根据值的大小存储在 1、2、3、4、6 或 8 字节中。</td>
</tr>
<tr>
<td>REAL   </td>
<td>值是一个浮点值，存储为 8 字节的 IEEE 浮点数字。</td>
</tr>
<tr>
<td>TEXT   </td>
<td>值是一个文本字符串，使用数据库编码（UTF-8、UTF-16BE 或 |UTF-16LE）存储。</td>
</tr>
<tr>
<td>BLOB   </td>
<td>值是一个 blob 数据，完全根据它的输入存储。</td>
</tr>
</tbody>
</table>


<p>SQLite 的存储类稍微比数据类型更普遍。INTEGER 存储类，例如，包含 6 种不同的不同长度的整数数据类型。</p>

<hr />

<h4>SQLite Affinity 类型</h4>

<p>SQLite 支持列上的类型 affinity 概念。任何列仍然可以存储任何类型的数据，但列的首选存储类是它的 <strong>affinity</strong>。在 SQLite3 数据库中，每个表的列分配为以下类型的 affinity 之一：</p>

<table>
<thead>
<tr>
<th>Affinity </th>
<th>描述                    </th>
</tr>
</thead>
<tbody>
<tr>
<td>TEXT     </td>
<td>该列使用存储类 NULL、TEXT 或 BLOB 存储所有数据。</td>
</tr>
<tr>
<td>NUMERIC  </td>
<td>该列可以包含使用所有五个存储类的值。</td>
</tr>
<tr>
<td>INTEGER  </td>
<td>与带有 NUMERIC affinity 的列相同，在 CAST 表达式中带有异常。</td>
</tr>
<tr>
<td>REAL     </td>
<td>与带有 NUMERIC affinity 的列相似，不同的是，它会强制把整数值转换为浮点表示。</td>
</tr>
<tr>
<td>NONE     </td>
<td>带有 affinity NONE 的列，不会优先使用哪个存储类，也不会尝试把数据从一个存储类强制转换为另一个存储类。</td>
</tr>
</tbody>
</table>


<h4>SQLite Affinity 及类型名称</h4>

<p>下表列出了当创建 SQLite3 表时可使用的各种数据类型名称，同时也显示了相应的应用 Affinity：</p>

<table>
<thead>
<tr>
<th>数据类型  </th>
<th>Affinity                     </th>
</tr>
</thead>
<tbody>
<tr>
<td>INT <br> INTEGERTINYINT <br> SMALLINT <br> MEDIUMINT <br> BIGINT <br> UNSIGNED BIG INT <br> INT2 <br> INT8  <br> </td>
<td> INTEGER  </td>
</tr>
<tr>
<td>CHARACTER(20) <br> VARCHAR(255) <br> VARYING CHARACTER(255) <br> NCHAR(55) <br> NATIVE CHARACTER(70) <br> NVARCHAR(100) <br> TEXT <br> CLOB                                              </td>
<td> TEXT    </td>
</tr>
<tr>
<td>BLOB <br> no datatype specified                 </td>
<td> NONE    </td>
</tr>
<tr>
<td>REAL <br> DOUBLE <br> DOUBLE PRECISION <br> FLOAT </td>
<td> REAL  </td>
</tr>
<tr>
<td>NUMERIC <br> DECIMAL(10,5) <br> BOOLEAN <br> DATE <br> DATETIME </td>
<td> NUMERIC </td>
</tr>
</tbody>
</table>


<hr />

<h4>Boolean 数据类型</h4>

<p>SQLite 没有单独的 Boolean 存储类。相反，布尔值被存储为整数 0（false）和 1（true）。</p>

<hr />

<h4>Date 与 Time 数据类型</h4>

<p>SQLite 没有一个单独的用于存储日期和/或时间的存储类，但 SQLite 能够把日期和时间存储为 TEXT、REAL 或 INTEGER 值。</p>

<table>
<thead>
<tr>
<th>存储类    </th>
<th>日期格式                      </th>
</tr>
</thead>
<tbody>
<tr>
<td>TEXT     </td>
<td>格式为 &ldquo;YYYY-MM-DD HH:MM:SS.SSS&rdquo; 的日期。</td>
</tr>
<tr>
<td>REAL     </td>
<td>从公元前 4714 年 11 月 24 日格林尼治时间的正午开始算起的天数。</td>
</tr>
<tr>
<td>INTEGER  </td>
<td> 从 1970-01-01 00:00:00 UTC 算起的秒数。</td>
</tr>
</tbody>
</table>


<p>您可以以任何上述格式来存储日期和时间，并且可以使用内置的日期和时间函数来自由转换不同格式。</p>

<h4>SQLite 创建数据库</h4>

<p>SQLite 的 sqlite3 命令被用来创建新的 SQLite 数据库。您不需要任何特殊的权限即可创建一个数据。</p>

<hr />

<p><strong>语法</strong></p>

<p>sqlite3 命令的基本语法如下：</p>

<pre><code>$sqlite3 DatabaseName.db
</code></pre>

<p>通常情况下，数据库名称在 RDBMS 内应该是唯一的。</p>

<p><strong>实例</strong></p>

<p>如果您想创建一个新的数据库 &lt;testDB.db>，SQLITE3 语句如下所示：</p>

<pre><code>$sqlite3 testDB.db
SQLite version 3.8.10.2 2015-05-20 18:17:19
Enter ".help" for usage hints.
sqlite&gt;
</code></pre>

<p>上面的命令将在当前目录下创建一个文件 testDB.db。该文件将被 SQLite 引擎用作数据库。如果您已经注意到 sqlite3 命令在成功创建数据库文件之后，将提供一个 sqlite> 提示符。
一旦数据库被创建，您就可以使用 SQLite 的 .databases 命令来检查它是否在数据库列表中，如下所示：</p>

<pre><code>sqlite&gt;.databases
seq  name             file                                                      
---- ---------------- --------------------------------------------
0    main             /Users/wangruofeng/Documents/SQLitePractice/testDB.db
</code></pre>

<p>您可以使用 SQLite .quit 命令退出 sqlite 提示符，如下所示：</p>

<pre><code>sqlite&gt;.quit
$
</code></pre>

<h4>.dump 命令</h4>

<p>您可以在命令提示符中使用 SQLite .dump 点命令来导出完整的数据库在一个文本文件中，如下所示：</p>

<pre><code>$sqlite3 testDB.db .dump &gt; testDB.sql
</code></pre>

<p>上面的命令将转换整个 testDB.db 数据库的内容到 SQLite 的语句中，并将其转储到 ASCII 文本文件 testDB.sql 中。您可以通过简单的方式从生成的 testDB.sql 恢复，如下所示：</p>

<pre><code>$sqlite3 testDB.db &lt; testDB.sql
</code></pre>

<p>此时的数据库是空的，一旦数据库中有表和数据，您可以尝试上述两个程序。现在，让我们继续学习下一章。</p>

<h4>SQLite 附加数据库</h4>

<p>假设这样一种情况，当在同一时间有多个数据库可用，您想使用其中的任何一个。SQLite 的 ATTACH DTABASE 语句是用来选择一个特定的数据库，使用该命令后，所有的 SQLite 语句将在附加的数据库下执行。相当于给数据库取一个别名</p>

<hr />

<p><strong>语法</strong></p>

<p>SQLite 的 ATTACH DATABASE 语句的基本语法如下：</p>

<pre><code>ATTACH DATABASE 'DatabaseName' As 'Alias-Name';
</code></pre>

<p>如果数据库尚未被创建，上面的命令将创建一个数据库，如果数据库已存在，则把数据库文件名称与逻辑数据库 &lsquo;Alias-Name&rsquo; 绑定在一起。</p>

<hr />

<p><strong>实例</strong>
如果想附加一个现有的数据库 testDB.db，则 ATTACH DATABASE 语句将如下所示：</p>

<pre><code>sqlite&gt; ATTACH DATABASE 'testDB.db' as 'TEST';
</code></pre>

<p>使用 SQLite .database 命令来显示附加的数据库。</p>

<pre><code>sqlite&gt; .database
seq  name             file
---  ---------------  ----------------------
0    main             /home/sqlite/testDB.db
2    test             /home/sqlite/testDB.db
</code></pre>

<p>数据库名称 main 和 temp 被保留用于主数据库和存储临时表及其他临时数据对象的数据库。这两个数据库名称可用于每个数据库连接，且不应该被用于附加，否则将得到一个警告消息，如下所示：</p>

<pre><code>sqlite&gt;  ATTACH DATABASE 'testDB.db' as 'TEMP';
Error: database TEMP is already in use
sqlite&gt;  ATTACH DATABASE 'testDB.db' as 'main';
Error: database main is already in use
</code></pre>

<hr />

<h4>SQLite 分离数据库</h4>

<p>SQLite的 <strong>DETACH DTABASE</strong> 语句是用来把命名数据库从一个数据库连接分离和游离出来，连接是之前使用 ATTACH 语句附加的。如果同一个数据库文件已经被附加上多个别名，DETACH 命令将只断开给定名称的连接，而其余的仍然有效。您无法分离 main 或 temp 数据库。</p>

<blockquote><p>如果数据库是在内存中或者是临时数据库，则该数据库将被摧毁，且内容将会丢失。</p></blockquote>

<p><strong>语法</strong></p>

<p>SQLite 的 DETACH DATABASE &lsquo;Alias-Name&rsquo; 语句的基本语法如下：</p>

<pre><code>DETACH DATABASE 'Alias-Name';
</code></pre>

<p>在这里，'Alias-Name' 与您之前使用 ATTACH 语句附加数据库时所用到的别名相同。</p>

<p><strong>实例</strong></p>

<p>假设在前面的章节中您已经创建了一个数据库，并给它附加了 &lsquo;test&rsquo; 和 &lsquo;currentDB'，使用 .database/.databases 命令，我们可以看到：</p>

<pre><code>sqlite&gt; .databases
seq  name             file
---  ---------------  ----------------------
0    main             /home/sqlite/testDB.db
2    test             /home/sqlite/testDB.db
3    currentDB        /home/sqlite/testDB.db
</code></pre>

<p>现在，让我们尝试把 &lsquo;currentDB&rsquo; 从 testDB.db 中分离出来，如下所示：</p>

<pre><code>sqlite&gt; DETACH DATABASE 'currentDB';
</code></pre>

<p>现在，如果检查当前附加的数据库，您会发现，testDB.db 仍与 &lsquo;test&rsquo; 和 &lsquo;main&rsquo; 保持连接。</p>

<pre><code>sqlite&gt; .databases
seq  name             file
---  ---------------  ----------------------
0    main             /home/sqlite/testDB.db
2    test             /home/sqlite/testDB.db
</code></pre>

<hr />

<h4>SQLite 创建表</h4>

<p>SQLite 的 CREATE TABLE 语句用于在任何给定的数据库创建一个新表。创建基本表，涉及到命名表、定义列及每一列的数据类型。</p>

<hr />

<p><strong>语法</strong></p>

<p>CREATE TABLE 语句的基本语法如下：</p>

<pre><code>CREATE TABLE database_name.table_name(
   column1 datatype  PRIMARY KEY(one or more columns),
   column2 datatype,
   column3 datatype,
   .....
   columnN datatype,
);
</code></pre>

<p>CREATE TABLE 是告诉数据库系统创建一个新表的关键字。CREATE TABLE 语句后跟着表的唯一的名称或标识。您也可以选择指定带有 table_name 的 <em>database_name</em>。</p>

<p><strong>实例</strong></p>

<p>下面是一个实例，它创建了一个 COMPANY 表，ID 作为主键，NOT NULL 的约束表示在表中创建纪录时这些字段不能为 NULL：</p>

<pre><code>sqlite&gt; CREATE TABLE COMPANY(
   ID INT PRIMARY KEY     NOT NULL,
   NAME           TEXT    NOT NULL,
   AGE            INT     NOT NULL,
   ADDRESS        CHAR(50),
   SALARY         REAL
);
</code></pre>

<p>让我们再创建一个表，我们将在随后章节的练习中使用：</p>

<pre><code>sqlite&gt; CREATE TABLE DEPARTMENT(
   ID INT PRIMARY KEY      NOT NULL,
   DEPT           CHAR(50) NOT NULL,
   EMP_ID         INT      NOT NULL
);
</code></pre>

<p>您可以使用 SQLIte 命令中的 .tables/.table 命令来验证表是否已成功创建，该命令用于列出附加数据库中的所有表。</p>

<pre><code>sqlite&gt; .tables
COMPANY          DEPARTMENT       TEST.COMPANY     TEST.DEPARTMENT
</code></pre>

<p>在这里，可以看到 COMPANY 表出现两次，一个是主数据库的 COMPANY 表，一个是为 testDB.db 创建的 &lsquo;test&rsquo; 别名的 test.COMPANY 表。您可以使用 SQLite .schema 命令得到表的完整信息，如下所示：</p>

<pre><code>sqlite&gt;.schema COMPANY
CREATE TABLE COMPANY(
   ID INT PRIMARY KEY     NOT NULL,
   NAME           TEXT    NOT NULL,
   AGE            INT     NOT NULL,
   ADDRESS        CHAR(50),
   SALARY         REAL
);
</code></pre>

<h4>SQLite 删除表</h4>

<p>SQLite 的 DROP TABLE 语句用来删除表定义及其所有相关数据、索引、触发器、约束和该表的权限规范。</p>

<blockquote><p>使用此命令时要特别注意，因为一旦一个表被删除，表中所有信息也将永远丢失。</p></blockquote>

<hr />

<p><strong>语法</strong></p>

<p>DROP TABLE 语句的基本语法如下。您可以选择指定带有表名的数据库名称，如下所示：</p>

<pre><code>DROP TABLE database_name.table_name;
</code></pre>

<p><strong>实例</strong></p>

<p>让我们先确认 COMPANY 表已经存在，然后我们将其从数据库中删除。</p>

<pre><code>sqlite&gt; .tables
COMPANY       test.COMPANY
</code></pre>

<p>这意味着 COMPANY 表已存在数据库中，接下来让我们把它从数据库中删除，如下：</p>

<pre><code>sqlite&gt; DROP TABLE COMPANY;
sqlite&gt;
</code></pre>

<p>现在，如果尝试 .TABLES 命令，那么将无法找到 COMPANY 表了：</p>

<pre><code>sqlite&gt; .tables
sqlite&gt;
</code></pre>

<p>显示结果为空，意味着已经成功从数据库删除表。</p>

<p>资料整理于：<a href="http://www.runoob.com/sqlite/sqlite-tutorial.html">RUNOOB.COM-SQLite教程</a>
转载请注明出处。</p>
</div>
  
  


        </article>
      
    </div>

    <ul class="pager">
      
        <li class="previous"><a href="/posts/2">&larr;&nbsp;Older</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
        <li class="next disabled"><a href="#">Newer&nbsp;&rarr;</a></li>
      
    </ul>
  </div>

  
    <aside class="sidebar col-md-3">
      
        <section>
  <h1>Categories</h1>
  <ul id="categories">
    <li class='category'><a href='/blog/categories/animation/'>animation (2)</a></li>
<li class='category'><a href='/blog/categories/database/'>database (7)</a></li>
<li class='category'><a href='/blog/categories/design-patterns/'>design_patterns (1)</a></li>
<li class='category'><a href='/blog/categories/efficiency/'>efficiency (2)</a></li>
<li class='category'><a href='/blog/categories/favorite/'>favorite (3)</a></li>
<li class='category'><a href='/blog/categories/ios/'>ios (20)</a></li>
<li class='category'><a href='/blog/categories/memory-management/'>memory_management (1)</a></li>
<li class='category'><a href='/blog/categories/multithreading/'>multithreading (1)</a></li>
<li class='category'><a href='/blog/categories/networking/'>networking (6)</a></li>
<li class='category'><a href='/blog/categories/objective-c/'>objective-c (4)</a></li>
<li class='category'><a href='/blog/categories/skill/'>skill (5)</a></li>
<li class='category'><a href='/blog/categories/swift/'>swift (1)</a></li>

  </ul>
</section>
<section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/blog/2016/01/18/tableviewxing-neng-you-hua/">TableView性能优化</a>
    
    <a class="list-group-item " href="/blog/2016/01/16/ios-animation-swift-ban/">iOS Animation Swift 版</a>
    
    <a class="list-group-item " href="/blog/2016/01/15/nsurlsession/">NSURLSession 教程</a>
    
    <a class="list-group-item " href="/blog/2016/01/14/iosxian-cheng-an-quan-suo/">iOS线程安全-锁</a>
    
    <a class="list-group-item " href="/blog/2016/01/14/sqlite-jiao-cheng-qi/">SQLite_教程(七)</a>
    
    <a class="list-group-item " href="/blog/2016/01/14/sqlite-jiao-cheng-liu/">SQLite_教程(六)</a>
    
    <a class="list-group-item " href="/blog/2016/01/14/sqlite-jiao-cheng-wu/">SQLite_教程(五)</a>
    
    <a class="list-group-item " href="/blog/2016/01/13/sqlite-jiao-cheng-si/">SQLite_教程(四)</a>
    
    <a class="list-group-item " href="/blog/2016/01/13/sqlite-jiao-cheng-san/">SQLite_教程(三)</a>
    
    <a class="list-group-item " href="/blog/2016/01/13/sqlite-jiao-cheng-er/">SQLite_教程(二)</a>
    
    <a class="list-group-item " href="/blog/2016/01/13/sqlite-jiao-cheng-%5B%3F%5D/">SQLite_教程(一)</a>
    
    <a class="list-group-item " href="/blog/2016/01/13/cocoapodsshi-yong-zhi-nan/">CocoaPods使用指南</a>
    
  </div>
</section>






      
    </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  <small>
  本站点采用<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享 署名-非商业性使用-相同方式共享 4.0 国际 许可协议</a>
  Copyright &copy; 2016 - 王若风<br>
  </small>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'wangruofeng';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr.js"></script>


  </body>
</html>
