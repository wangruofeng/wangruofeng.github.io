<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.wangruofeng007.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":"default","style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

        <meta name="description" content="王若风的技术博客">
<meta property="og:type" content="website">
<meta property="og:title" content="王若风的技术博客">
<meta property="og:url" content="https://blog.wangruofeng007.com/page/3/index.html">
<meta property="og:site_name" content="王若风的技术博客">
<meta property="og:description" content="王若风的技术博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="王若风">
<meta property="article:tag" content="技术博客, Flutter, iOS">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.wangruofeng007.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

        <title>
            王若风的技术博客
        </title>
        






        <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

    <link rel="alternate" href="/atom.xml" title="王若风的技术博客" type="application/atom+xml">
</head>

    <body itemscope="itemscope" itemtype="http://schema.org/WebPage">
        <div class="container use-motion">
            <div class="headband"></div>

            <header
                class="header"
                itemscope="itemscope"
                itemtype="http://schema.org/WPHeader">
                <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">王若风的技术博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">世界尽头の冷酷仙境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
            </header>

            
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


            <main class="main">
                <div class="main-inner">
                    <div class="content-wrap">
                        

                        <div class="content index posts-expand">
                            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2017/03/10/2017-03-10-layer-animations-tips/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/03/10/2017-03-10-layer-animations-tips/" class="post-title-link" itemprop="url">Layer Animations Tips</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-03-10 22:49:01" itemprop="dateCreated datePublished" datetime="2017-03-10T22:49:01+08:00">2017-03-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 11:36:52" itemprop="dateModified" datetime="2024-11-02T11:36:52+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>672</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="beginTime的妙用"><a href="#beginTime的妙用" class="headerlink" title="beginTime的妙用"></a>beginTime的妙用</h3><p>创建一个动画，添加到不同的图层上，可以实现复用，通过调节<code>beginTime</code>可以调节动画开始执行的时间。</p>
<p>例如，我们创建一个水平位移动画，添加到不同的图层对象上，并且让他们轮流执行。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> flyRight <span class="operator">=</span> <span class="type">CABasicAnimation</span>(keyPath: <span class="string">&quot;position.x&quot;</span>)</span><br><span class="line">flyRight.fromValue <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">flyRight.toValue <span class="operator">=</span> <span class="number">100</span></span><br><span class="line">flyRight.duration <span class="operator">=</span> <span class="number">0.5</span></span><br><span class="line">flyRight.fillMode <span class="operator">=</span> kCAFillModeBoth</span><br><span class="line"></span><br><span class="line">firstView.layer.addAnimation(flyRight, forKey: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// make secondView perform animation on delay 0.3 seconds.</span></span><br><span class="line">flyRight.beginTime <span class="operator">=</span> <span class="type">CACurrentMediaTime</span>() <span class="operator">+</span> <span class="number">0.3</span></span><br><span class="line">secondView.layer.addAnimation(flyRight, forKey: <span class="literal">nil</span>)</span><br><span class="line">secondView.layer.position.x <span class="operator">=</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// make thirdView perform animation on delay 0.4 seconds.</span></span><br><span class="line">flyRight.beginTime <span class="operator">=</span> <span class="type">CACurrentMediaTime</span>() <span class="operator">+</span> <span class="number">0.4</span></span><br><span class="line">thirdView.layer.addAnimation(flyRight, forKey: <span class="literal">nil</span>)</span><br><span class="line">thirdView.layer.position.x <span class="operator">=</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>

<p>动画的<code>beginTime</code>属性可以设置将要执行的动画的绝对开始时间，通过<code>CACurrentMediaTime()</code>函数获取当前时间再加上你想要延迟执行的时间的，单位秒。</p>
<h3 id="动画代理"><a href="#动画代理" class="headerlink" title="动画代理"></a>动画代理</h3><p>动画代理可以监听动画的进行状态，在动画开始和结束的时候回通知代理.<br>也就是会调用以下两个函数：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">animationDidStart</span>(<span class="params">anim</span>: <span class="type">CAAnimation</span>)</span><br><span class="line"><span class="keyword">func</span> <span class="title function_">animationDidStop</span>(<span class="params">anim</span>: <span class="type">CAAnimation</span>, <span class="params">finished</span> <span class="params">flag</span>: <span class="type">Bool</span>)</span><br></pre></td></tr></table></figure>

<h3 id="CAAnimation"><a href="#CAAnimation" class="headerlink" title="CAAnimation"></a>CAAnimation</h3><p><code>CAAnimation</code>和它的子类遵循KVO，也就意味着你可以把它们当成字典一样使用来添加新的接口在运行时。</p>
<p>例如你可以使用这种机制来给某个动画指定一个名字，以便你能够把它和其它动画区分开。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flyRight.setValue(<span class="string">&quot;somename&quot;</span>, forKey: <span class="string">&quot;name&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="CASpringAnimation"><a href="#CASpringAnimation" class="headerlink" title="CASpringAnimation"></a>CASpringAnimation</h3><table>
<thead>
<tr>
<th>Property</th>
<th>Default Value</th>
</tr>
</thead>
<tbody><tr>
<td>damping</td>
<td>10.0</td>
</tr>
<tr>
<td>mass</td>
<td>1.0</td>
</tr>
<tr>
<td>stiffness</td>
<td>100.0</td>
</tr>
<tr>
<td>initialVelocity</td>
<td>0.0</td>
</tr>
</tbody></table>
<p>参数说明：</p>
<ul>
<li><code>damping</code> - 应用给系统的阻尼</li>
<li><code>mass</code> - 在系统中重物的质量</li>
<li><code>stiffness</code> - 附加在重物上的弹簧的硬度</li>
<li><code>initialVelocity</code> - 附加在重物上的初始速度</li>
</ul>
<p>使用实例：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> jump <span class="operator">=</span> <span class="type">CASpringAnimation</span>(keyPath: <span class="string">&quot;position.y&quot;</span>)</span><br><span class="line">jump.initialVelocity <span class="operator">=</span> <span class="number">100.0</span></span><br><span class="line">jump.mass <span class="operator">=</span> <span class="number">10.0</span></span><br><span class="line">jump.stiffness <span class="operator">=</span> <span class="number">1500.0</span></span><br><span class="line">jump.damping <span class="operator">=</span> <span class="number">50.0</span></span><br><span class="line"></span><br><span class="line">jump.fromValue <span class="operator">=</span> textField.layer.position.y <span class="operator">+</span> <span class="number">1.0</span></span><br><span class="line">jump.toValue <span class="operator">=</span> textField.layer.position.y</span><br><span class="line">jump.duration <span class="operator">=</span> jump.settlingDuration</span><br><span class="line">textField.layer.addAnimation(jump, forKey: <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>

<p>备注：<br>此动画的<code>duration</code>参数可以通过前面几个参数自动计算得出</p>
<pre><code>jump.duration = jump.settlingDuration
</code></pre>
<h3 id="使用CAGradientLayer的locations实现滑动解锁"><a href="#使用CAGradientLayer的locations实现滑动解锁" class="headerlink" title="使用CAGradientLayer的locations实现滑动解锁"></a>使用CAGradientLayer的locations实现滑动解锁</h3><p>对<code>CAGradientLayer</code>的<code>locations</code>属性做动画轻松的实现iPhone自带的滑动解锁效果</p>
<p> a.创建一个渐变图层</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> gradientLayer: <span class="type">CAGradientLayer</span> <span class="operator">=</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> gradientLayer <span class="operator">=</span> <span class="type">CAGradientLayer</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Configure the gradient here</span></span><br><span class="line">    </span><br><span class="line">    gradientLayer.startPoint <span class="operator">=</span> <span class="type">CGPoint</span>(x: <span class="number">0.0</span>, y: <span class="number">0.5</span>)</span><br><span class="line">    gradientLayer.endPoint <span class="operator">=</span> <span class="type">CGPoint</span>(x: <span class="number">1.0</span>, y: <span class="number">0.5</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> colors <span class="operator">=</span> [</span><br><span class="line">        <span class="type">UIColor</span>.blackColor().<span class="type">CGColor</span>,</span><br><span class="line">        <span class="type">UIColor</span>.whiteColor().<span class="type">CGColor</span>,</span><br><span class="line">        <span class="type">UIColor</span>.blackColor().<span class="type">CGColor</span></span><br><span class="line">    ]</span><br><span class="line">    gradientLayer.colors <span class="operator">=</span> colors</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> locations <span class="operator">=</span> [</span><br><span class="line">        <span class="number">0.25</span>,</span><br><span class="line">        <span class="number">0.5</span>,</span><br><span class="line">        <span class="number">0.75</span></span><br><span class="line">    ]</span><br><span class="line">    gradientLayer.locations <span class="operator">=</span> locations</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> gradientLayer</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>


<p>b.创建一个文本样式字典</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> textAttributes : [<span class="type">String</span>: <span class="type">AnyObject</span>] <span class="operator">=</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> style <span class="operator">=</span> <span class="type">NSMutableParagraphStyle</span>()</span><br><span class="line">    style.alignment <span class="operator">=</span> .<span class="type">Center</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="type">NSFontAttributeName</span>:<span class="type">UIFont</span>(name: <span class="string">&quot;HelveticaNeue-Thin&quot;</span>, size: <span class="number">28.0</span>)<span class="operator">!</span>,</span><br><span class="line">        <span class="type">NSParagraphStyleAttributeName</span>:style</span><br><span class="line">    ]</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<p>c.当设置文本时绘制内容，添加<code>@IBInspectable</code>方便看实时效果</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@IBInspectable</span> <span class="keyword">var</span> text: <span class="type">String</span>! &#123;</span><br><span class="line"><span class="keyword">didSet</span> &#123;</span><br><span class="line">    setNeedsDisplay()</span><br><span class="line">    </span><br><span class="line">    <span class="type">UIGraphicsBeginImageContextWithOptions</span>(frame.size, <span class="literal">false</span>, <span class="number">0</span>)</span><br><span class="line">    text.drawInRect(bounds, withAttributes: textAttributes)</span><br><span class="line">    <span class="keyword">let</span> image <span class="operator">=</span> <span class="type">UIGraphicsGetImageFromCurrentImageContext</span>()</span><br><span class="line">    <span class="type">UIGraphicsEndImageContext</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> maskLayer <span class="operator">=</span> <span class="type">CALayer</span>()</span><br><span class="line">    maskLayer.backgroundColor <span class="operator">=</span> <span class="type">UIColor</span>.clearColor().<span class="type">CGColor</span></span><br><span class="line">    maskLayer.frame <span class="operator">=</span> <span class="type">CGRectOffset</span>(bounds, bounds.size.width, <span class="number">0</span>)</span><br><span class="line">    maskLayer.contents <span class="operator">=</span> image.<span class="type">CGImage</span></span><br><span class="line">    </span><br><span class="line">    gradientLayer.mask <span class="operator">=</span> maskLayer</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>d.重新布局<code>gradientLayer</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">layoutSubviews</span>() &#123;</span><br><span class="line">    gradientLayer.frame <span class="operator">=</span> <span class="type">CGRect</span>(</span><br><span class="line">        x: <span class="operator">-</span>bounds.size.width,</span><br><span class="line">        y: bounds.origin.y,</span><br><span class="line">        width: <span class="number">3</span> <span class="operator">*</span> bounds.size.width,</span><br><span class="line">        height: bounds.size.height)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e.添加到window时向渐变层添加动画</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">didMoveToWindow</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>.didMoveToWindow()</span><br><span class="line">    </span><br><span class="line">    layer.addSublayer(gradientLayer)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> gradientAnimation <span class="operator">=</span> <span class="type">CABasicAnimation</span>(keyPath: <span class="string">&quot;locations&quot;</span>)</span><br><span class="line">    gradientAnimation.fromValue <span class="operator">=</span> [<span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.25</span>]</span><br><span class="line">    gradientAnimation.toValue <span class="operator">=</span> [<span class="number">0.75</span>, <span class="number">1.0</span>, <span class="number">1.0</span>]</span><br><span class="line">    gradientAnimation.duration <span class="operator">=</span> <span class="number">3.0</span></span><br><span class="line">    gradientAnimation.repeatCount <span class="operator">=</span> <span class="type">Float</span>.infinity</span><br><span class="line">    </span><br><span class="line">    gradientLayer.addAnimation(gradientAnimation, forKey: <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2017/03/02/2017-03-02-vflshen-ru-qian-chu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/03/02/2017-03-02-vflshen-ru-qian-chu/" class="post-title-link" itemprop="url">VFL深入浅出</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-03-02 21:19:49" itemprop="dateCreated datePublished" datetime="2017-03-02T21:19:49+08:00">2017-03-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 11:36:52" itemprop="dateModified" datetime="2024-11-02T11:36:52+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>836</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p>给视图对象快速创建约束，可以使用比较冷门的VFL(Visual Format Language),本质是是基于自动布局(AutoLayout)。</p>
<h3 id="解决的问题"><a href="#解决的问题" class="headerlink" title="解决的问题"></a>解决的问题</h3><p>以一种直观的方式，为视图创建约束</p>
<h3 id="怎样解决"><a href="#怎样解决" class="headerlink" title="怎样解决"></a>怎样解决</h3><p>核心方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSArray</span>&lt;__kindof <span class="built_in">NSLayoutConstraint</span> *&gt; *)constraintsWithVisualFormat:(<span class="built_in">NSString</span> *)format</span><br><span class="line">                                                                options:(<span class="built_in">NSLayoutFormatOptions</span>)opts</span><br><span class="line">                                                                metrics:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="type">id</span>&gt; *)metrics</span><br><span class="line">                                                                  views:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="type">id</span>&gt; *)views;</span><br></pre></td></tr></table></figure>

<p>Example:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">NSLayoutConstraint</span> constraintsWithVisualFormat:<span class="string">@&quot;|-[button1]-[button2]-[textField(&gt;=20)]-|&quot;</span></span><br><span class="line">                                        options:<span class="number">0</span></span><br><span class="line">                                        metrics:metrics</span><br><span class="line">                                          views:views]</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<ul>
<li>format:指定约束的格式。更多信息，在<a href="file:///Users/wangruofeng/Library/Developer/Shared/Documentation/DocSets/com.apple.adc.documentation.iOS.docset/Contents/Resources/Documents/documentation/UserExperience/Conceptual/AutolayoutPG/index.html#//apple_ref/doc/uid/TP40010853">Auto Layout Guide</a>查看<a href="file:///Users/wangruofeng/Library/Developer/Shared/Documentation/DocSets/com.apple.adc.documentation.iOS.docset/Contents/Resources/Documents/documentation/UserExperience/Conceptual/AutolayoutPG/LayoutUsingStackViews.html#//apple_ref/doc/uid/TP40010853-CH3">Visual Format Language</a>。</li>
<li>opts:描述在视觉格式化字符串中的布局属性和方向</li>
<li>metrics:将出现在视觉格式化字符串的常量字典。字典的Keys必须是在出现在视觉格式化字符串的字符串类型，对应的values必须是NSNumber对象。</li>
<li>views:出现的视觉格式化字符串的字典view，所有的Keys必须是使用在视觉格式化字符串的字符串类型，对应的values必须是view对象。</li>
</ul>
<p>返回值：</p>
<p>一个约束组合的数组，像视觉格式化字符串描述的一样表述了在提供的视图和它们的父视图之间的关系。所有的约束以在视觉格式化字符串被指定的约束顺序一致。</p>
<h3 id="效率和可维护性"><a href="#效率和可维护性" class="headerlink" title="效率和可维护性"></a>效率和可维护性</h3><p>需要对VFL理解比较全面和深入，有一定的学习成本，维护起来比较困难，但是如果理解的比较深刻，对于简单的布局效率非常高，比直接创建约束要直观。</p>
<h3 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h3><ul>
<li>每条约束格式字符串分水平(<code>H</code>，可省略)和垂直方向(<code>V</code>)。</li>
<li><code>|</code> 代表父视图。</li>
<li><code>-</code> 代表标准间距，两个子视图直接的值是8，与父视图之间的值是16。</li>
<li><code>[view]</code> 每个视图必须用[]包裹起来，否则语法错误。</li>
<li><code>[view(&gt;=44)]</code> 可以为每个视图设置一些属性或者关系，写一个紧跟view后的括号集合，支持宽高，优先级，和其它视图之间的关系。</li>
<li><code>[view@20]</code> 可以设置视图的约束的优先级，以@开头，取值范围(0 1000]。</li>
<li><code>[view1]-20-[view2]</code> 可以指定view之间的水平或者垂直间距，写在一对 <code>-</code> 即可。</li>
<li><code>[view1][view2]</code> 如果 <code>-</code> 省略则他们之间的距离为0。</li>
<li><code>[flexibleButton(&gt;=70,&lt;=100)]</code> 多个条件之间用<code>,</code>连接并且之间不能有空格。</li>
</ul>
<h3 id="其它方案"><a href="#其它方案" class="headerlink" title="其它方案"></a>其它方案</h3><ol>
<li>使用<code>NSLayoutConstraint</code>的类方法创建(iOS96.0及以上可用)</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">instancetype</span>)constraintWithItem:(<span class="type">id</span>)view1</span><br><span class="line">                        attribute:(<span class="built_in">NSLayoutAttribute</span>)attr1</span><br><span class="line">                        relatedBy:(<span class="built_in">NSLayoutRelation</span>)relation</span><br><span class="line">                           toItem:(<span class="keyword">nullable</span> <span class="type">id</span>)view2</span><br><span class="line">                        attribute:(<span class="built_in">NSLayoutAttribute</span>)attr2</span><br><span class="line">                       multiplier:(<span class="built_in">CGFloat</span>)multiplier</span><br><span class="line">                         constant:(<span class="built_in">CGFloat</span>)c;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>使用<code>NSLayoutAnchor</code>的工厂方法创建(iOS9.0及以上可用)</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSLayoutConstraint</span> *)constraintEqualToAnchor:(<span class="built_in">NSLayoutAnchor</span>&lt;AnchorType&gt; *)anchor;</span><br><span class="line">- (<span class="built_in">NSLayoutConstraint</span> *)constraintGreaterThanOrEqualToAnchor:(<span class="built_in">NSLayoutAnchor</span>&lt;AnchorType&gt; *)anchor;</span><br><span class="line">- (<span class="built_in">NSLayoutConstraint</span> *)constraintLessThanOrEqualToAnchor:(<span class="built_in">NSLayoutAnchor</span>&lt;AnchorType&gt; *)anchor;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSLayoutConstraint</span> *)constraintEqualToAnchor:(<span class="built_in">NSLayoutAnchor</span>&lt;AnchorType&gt; *)anchor constant:(<span class="built_in">CGFloat</span>)c;</span><br><span class="line">- (<span class="built_in">NSLayoutConstraint</span> *)constraintGreaterThanOrEqualToAnchor:(<span class="built_in">NSLayoutAnchor</span>&lt;AnchorType&gt; *)anchor constant:(<span class="built_in">CGFloat</span>)c;</span><br><span class="line">- (<span class="built_in">NSLayoutConstraint</span> *)constraintLessThanOrEqualToAnchor:(<span class="built_in">NSLayoutAnchor</span>&lt;AnchorType&gt; *)anchor constant:(<span class="built_in">CGFloat</span>)c;</span><br></pre></td></tr></table></figure>

<h3 id="使用注意事项"><a href="#使用注意事项" class="headerlink" title="使用注意事项"></a>使用注意事项</h3><ul>
<li><p>使用时，必须把view的<code>translatesAutoresizingMaskIntoConstraints</code>属性设置为<code>NO</code>，否则约束可能更预期不一致。这是一个历史遗留的问题，由于在<code>AutoLayout</code>诞生以前一直使用<code>Autoresizing</code>来控制布局.</p>
</li>
<li><p>重写<code>updateConstraints()</code>方法，在里面计算约束，然后调用<code>setNeedsUpdateConstraints()</code>触发更新约束。</p>
</li>
<li><p>系统计算布局顺序: </p>
<ul>
<li>updateConstraints()</li>
<li>layoutSubviews()</li>
<li>drawRect(_:)</li>
</ul>
</li>
</ul>
<p>系统计算布局顺序参考</p>
<p><img src="https://koenig-media.raywenderlich.com/uploads/2016/05/LayoutCycle-1.png" alt="LayoutCycle"></p>
<p>具体使用示例，查看下面的Demo，样品工程</p>
<hr>
<p>Demo地址：<a target="_blank" rel="noopener" href="https://github.com/wangruofeng/VFLDemo">VFLDemo</a></p>
<p>参考链接</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.raywenderlich.com/125718/coding-auto-layout">coding-auto-layout</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/UserExperience/Conceptual/AutolayoutPG/VisualFormatLanguage.html#//apple_ref/doc/uid/TP40010853-CH27-SW1">Visual Format Language</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2017/02/23/2017-02-23-uiactivityviewcontroller-xiang-jie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/02/23/2017-02-23-uiactivityviewcontroller-xiang-jie/" class="post-title-link" itemprop="url">UIActivity​View​Controller 详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-02-23 23:23:12" itemprop="dateCreated datePublished" datetime="2017-02-23T23:23:12+08:00">2017-02-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 11:36:52" itemprop="dateModified" datetime="2024-11-02T11:36:52+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>翻译自NSHipster的<a target="_blank" rel="noopener" href="http://nshipster.com/uiactivityviewcontroller/">UIActivity​View​Controller</a></p>
</blockquote>
<p>一直非常好奇代码和数据之间的联系。</p>
<p>某些编程语言，例如<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Lisp_programming_language">Lisp</a>，<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Io_%28programming_language%29">Io</a>和<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Mathematica">Mathematica</a>他们是<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Homoiconicity">同型性</a>(代码即数据)，那就意味着它们的代码是原始数据的呈现形式，它们本身在代码中也能够被维护。然而大多数其它语言，包括Objective-C，然而，在这两者之间有严格的边界，避免eval()和其它有动态引导加载的潜在危险方法。</p>
<p>当数据出现太大和呈现一些东西过于笨重除了使用二进制流的问题时代码和数据之间的不安被推向到了一个全新的高度。自从第一个操作系统出现开始，怎样编码，解码，解释二进制代表的图片，文档，和媒体一直是一个问题。</p>
<p>在OS X上的核心服务框架和iOS上提供标识功能和通过文件拓展和<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Internet_media_type">MIMIE type</a>–根据<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Uniform_Type_Identifier">通用数据标示</a>，给数据类型的分类核心服务框架。UTIs提供了一种可拓展，阶梯分层系统，这给开发者在处理大量不同的文件类型提供了巨大的灵活性。例如，一个Ruby的源文件(.rb)被归类为：Ruby Source Code &gt; Source Code &gt; Text &gt; Content &gt; Data；一个QuickTime电影文件(.mov)被归类为 Video &gt; Movie &gt; Audiovisual Content &gt; Content &gt; Data。</p>
<p>UTIs表现得非常好在桌面的抽象文件系统中。然而，在一个移动范例中这就崩溃得很快，因为文件和目录是对用户隐藏的。还有，随着云服务和社交媒体扮演着越来越重要的角色在远程实体通过本地文件。因此，UTIs和URLs之间很紧张。</p>
<p>我们非常清楚我们需要一些别的东西。<code>UIActivityViewController</code>能否成为我们正在急切寻找的解决方案呢?</p>
<hr>
<p><code>UIActivityViewController</code>，在iOS6中被引入，提供了一套分享和在应用内执行数据操作的统一服务界面。</p>
<p>考虑到可操作的数据集合，一个<code>UIActivityViewController</code>实例通过如下方式创建：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *string = ...;</span><br><span class="line"><span class="built_in">NSURL</span> *URL = ...;</span><br><span class="line"></span><br><span class="line"><span class="built_in">UIActivityViewController</span> *activityViewController = [[<span class="built_in">UIActivityViewController</span> alloc] initWithActivityItems:@[string, URL]</span><br><span class="line">                                    applicationActivities:<span class="literal">nil</span>];</span><br><span class="line">[navigationController presentViewController:activityViewController</span><br><span class="line">                                   animated:<span class="literal">YES</span></span><br><span class="line">                                 completion:^&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>这将在屏幕底部呈现如下界面：</p>
<p><img src="http://nshipster.s3.amazonaws.com/uiactivityviewcontroller.png" alt="activity sharing img"></p>
<p>默认情况下，<code>UIActivityViewController</code>将会显示所有支持的可用服务类型，但是某些活动类型也可以排除：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">activityViewController.excludedActivityTypes = @[<span class="built_in">UIActivityTypePostToFacebook</span>];</span><br></pre></td></tr></table></figure>

<p>活动类型被划分“动作”(action)和“分享”(share)类型：</p>
<h3 id="UIActivityCategoryAction"><a href="#UIActivityCategoryAction" class="headerlink" title="UIActivityCategoryAction"></a>UIActivityCategoryAction</h3><ul>
<li>UIActivityTypePrint</li>
<li>UIActivityTypeCopyToPasteboard</li>
<li>UIActivityTypeAssignToContact</li>
<li>UIActivityTypeSaveToCameraRoll</li>
<li>UIActivityTypeAddToReadingList</li>
<li>UIActivityTypeAirDrop</li>
</ul>
<h3 id="UIActivityCategoryShare"><a href="#UIActivityCategoryShare" class="headerlink" title="UIActivityCategoryShare"></a>UIActivityCategoryShare</h3><ul>
<li>UIActivityTypeMessage</li>
<li>UIActivityTypeMail</li>
<li>UIActivityTypePostToFacebook</li>
<li>UIActivityTypePostToTwitter</li>
<li>UIActivityTypePostToFlickr</li>
<li>UIActivityTypePostToVimeo</li>
<li>UIActivityTypePostToTencentWeibo</li>
<li>UIActivityTypePostToWeibo</li>
</ul>
<p>每种活动类型，支持一系列不同的数据类型。例如，一个<code>Tweet</code>可能由一个<code>NSString</code>并附带一个<code>image</code>和或者<code>URL</code>。</p>
<p>不同活动类型支持的数据类型</p>
<table>
<thead>
<tr>
<th>Activity Type</th>
<th align="center">String</th>
<th>Attributed String</th>
<th>URL</th>
<th>Data</th>
<th>Image</th>
<th>Asset</th>
<th>Other</th>
</tr>
</thead>
<tbody><tr>
<td>Post To Facebook</td>
<td align="center">✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Post To Twitter</td>
<td align="center">✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Post To Weibo</td>
<td align="center">✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td>✓</td>
<td>✓</td>
<td></td>
</tr>
<tr>
<td>Message</td>
<td align="center">✓</td>
<td>✓</td>
<td>✓*</td>
<td>✓*</td>
<td></td>
<td>✓</td>
<td>sms:&#x2F;&#x2F; NSURL</td>
</tr>
<tr>
<td>Mail</td>
<td align="center">✓+</td>
<td>✓+</td>
<td>✓+</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Print</td>
<td align="center"></td>
<td></td>
<td></td>
<td>✓+</td>
<td>✓+</td>
<td></td>
<td>UIPrintPageRenderer, UIPrintFormatter, &amp; UIPrintInfo</td>
</tr>
<tr>
<td>Copy To Pasteboard</td>
<td align="center">✓</td>
<td></td>
<td>✓</td>
<td></td>
<td>✓</td>
<td></td>
<td>UIColor, NSDictionary</td>
</tr>
<tr>
<td>Assign To Contact</td>
<td align="center"></td>
<td></td>
<td></td>
<td></td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Save To Camera Roll</td>
<td align="center"></td>
<td></td>
<td>✓</td>
<td></td>
<td>✓</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Add To Reading List</td>
<td align="center"></td>
<td></td>
<td>✓</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Post To Flickr</td>
<td align="center"></td>
<td></td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
</tr>
<tr>
<td>Post To Vimeo</td>
<td align="center">✓</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td>✓</td>
<td></td>
</tr>
<tr>
<td>Post To Tencent Weibo</td>
<td align="center">✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td>✓</td>
<td>✓</td>
<td></td>
</tr>
<tr>
<td>AirDrop</td>
<td align="center">✓</td>
<td>✓</td>
<td>✓</td>
<td></td>
<td>✓</td>
<td>✓</td>
<td></td>
</tr>
</tbody></table>
<h3 id="UIActivityItemSource-UIActivityItemProvider"><a href="#UIActivityItemSource-UIActivityItemProvider" class="headerlink" title="UIActivityItemSource &amp; UIActivityItemProvider"></a>UIActivityItemSource &amp; UIActivityItemProvider</h3><p>当必要时和一个粘贴板项目能用来提供的数据类似，为了避免过度的内测开销或处理时间，活动类型可以是一种自定义类型。</p>
<p>任何遵循<code>&lt;UIActivityItemSource&gt;</code>协议的对象，包括内构<code>UIActivityItemProvider</code>类，可以用来动态提供不同类型的数据根据活动的类型。</p>
<h4 id="UIActivityItemSource"><a href="#UIActivityItemSource" class="headerlink" title="UIActivityItemSource"></a>UIActivityItemSource</h4><p>获取数据项目：</p>
<ul>
<li>activityViewControllerPlaceholderItem:</li>
<li>activityViewController:itemForActivityType:</li>
</ul>
<p>提供数据项目信息：</p>
<ul>
<li>activityViewController:subjectForActivityType:</li>
<li>activityViewController:dataTypeIdentifierForActivityType:</li>
<li>activityViewController:thumbnailImageForActivityType:suggestedSize:</li>
</ul>
<p>下面是一个例子，根据是否分享到FaceBook或者Twitter来展示自定义一条消息是怎样使用的:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">id</span>)activityViewController:(<span class="built_in">UIActivityViewController</span> *)activityViewController</span><br><span class="line">         itemForActivityType:(<span class="built_in">NSString</span> *)activityType</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ([activityType isEqualToString:<span class="built_in">UIActivityTypePostToFacebook</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">NSLocalizedString</span>(<span class="string">@&quot;Like this!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([activityType isEqualToString:<span class="built_in">UIActivityTypePostToTwitter</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">NSLocalizedString</span>(<span class="string">@&quot;Retweet this!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建一个自定义UIActivity"><a href="#创建一个自定义UIActivity" class="headerlink" title="创建一个自定义UIActivity"></a>创建一个自定义UIActivity</h3><p>除了上述的系统提供的活动，你也可以创建你自己的活动。</p>
<p>例如，让我们创建一个自定义活动类型，它能使一个URL中的图片添加上胡须通过使用<a target="_blank" rel="noopener" href="http://mustache.me/">mustache.me</a>。</p>
<p>Before:</p>
<p><img src="http://nshipster.s3.amazonaws.com/jony-ive-unstache.png" alt="Before"></p>
<p>After:</p>
<p><img src="http://nshipster.s3.amazonaws.com/jony-ive-mustache.png" alt="After"></p>
<p>首先，我们定义一个<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Reverse_domain_name_notation">反向域名解析的标识符</a>给活动类型：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> HIPMustachifyActivityType = <span class="string">@&quot;com.nshipster.activity.Mustachify&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>然后指定它的分类为<code>UIActivityCategoryAction</code>并且提供一个本地化标题和iOS版本相应的图片：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - UIActivity</span></span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">UIActivityCategory</span>)activityCategory &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">UIActivityCategoryAction</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)activityType &#123;</span><br><span class="line">    <span class="keyword">return</span> HIPMustachifyActivityType;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)activityTitle &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">NSLocalizedString</span>(<span class="string">@&quot;Mustachify&quot;</span>, <span class="literal">nil</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UIImage</span> *)activityImage &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NSFoundationVersionNumber</span> &gt; <span class="built_in">NSFoundationVersionNumber_iOS_6_1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">UIImage</span> imageNamed:<span class="string">@&quot;MustachifyUIActivity7&quot;</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">UIImage</span> imageNamed:<span class="string">@&quot;MustachifyUIActivity&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下一步，我们创建一个辅助函数，<code>HIPMatchingURLsInActivityItems</code>，通过它返回一个支持类型的图片URL的数组。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSArray</span> * HIPMatchingURLsInActivityItems(<span class="built_in">NSArray</span> *activityItems) &#123;</span><br><span class="line">    <span class="keyword">return</span> [activityItems filteredArrayUsingPredicate:[<span class="built_in">NSPredicate</span> predicateWithBlock:</span><br><span class="line">    ^<span class="type">BOOL</span>(<span class="type">id</span> item, __unused <span class="built_in">NSDictionary</span> *bindings) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([item isKindOfClass:[<span class="built_in">NSURL</span> <span class="keyword">class</span>]] &amp;&amp;</span><br><span class="line">            ![(<span class="built_in">NSURL</span> *)item isFileURL]) &#123;</span><br><span class="line">            <span class="keyword">return</span> [[(<span class="built_in">NSURL</span> *)item pathExtension] caseInsensitiveCompare:<span class="string">@&quot;jpg&quot;</span>] == <span class="built_in">NSOrderedSame</span> ||</span><br><span class="line">            [[(<span class="built_in">NSURL</span> *)item pathExtension] caseInsensitiveCompare:<span class="string">@&quot;png&quot;</span>] == <span class="built_in">NSOrderedSame</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数让后被用在<code>-canPerformWithActivityItems:</code>和<code>prepareWithActivityItems:</code>来获取小胡子的第一张PNG或JPEG图片的URL，假如有的话。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">BOOL</span>)canPerformWithActivityItems:(<span class="built_in">NSArray</span> *)activityItems &#123;</span><br><span class="line">    <span class="keyword">return</span> [HIPMatchingURLsInActivityItems(activityItems) count] &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)prepareWithActivityItems:(<span class="built_in">NSArray</span> *)activityItems &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> HIPMustachifyMeURLFormatString = <span class="string">@&quot;http://mustachify.me/%d?src=%@&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.imageURL = [<span class="built_in">NSURL</span> URLWithString:[<span class="built_in">NSString</span> stringWithFormat:HIPMustachifyMeURLFormatString, <span class="keyword">self</span>.mustacheType, [HIPMatchingURLsInActivityItems(activityItems) firstObject]]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们的网站服务提供了各种胡须选项，它被定义在一个枚举中：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, HIPMustacheType) &#123;</span><br><span class="line">    HIPMustacheTypeEnglish,</span><br><span class="line">    HIPMustacheTypeHorseshoe,</span><br><span class="line">    HIPMustacheTypeImperial,</span><br><span class="line">    HIPMustacheTypeChevron,</span><br><span class="line">    HIPMustacheTypeNatural,</span><br><span class="line">    HIPMustacheTypeHandlebar,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>最终，我们提供了一个<code>UIViewController</code>来显示图片。在这个例子中，一个简单的<code>UIWebView</code>控制器就够用了。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">HIPMustachifyWebViewController</span> : <span class="title">UIViewController</span> &lt;<span class="title">UIWebViewDelegate</span>&gt;</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIWebView</span> *webView;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UIViewController</span> *)activityViewController &#123;</span><br><span class="line">    HIPMustachifyWebViewController *webViewController = [[HIPMustachifyWebViewController alloc] init];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSURLRequest</span> *request = [<span class="built_in">NSURLRequest</span> requestWithURL:<span class="keyword">self</span>.imageURL];</span><br><span class="line">    [webViewController.webView loadRequest:request];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> webViewController;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了使用我们加了新胡须的活动，我们简单把它传递到<code>UIActivityViewController</code>构造器中：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HIPMustachifyActivity *mustacheActivity = [[HIPMustachifyActivity alloc] init];</span><br><span class="line"><span class="built_in">UIActivityViewController</span> *activityViewController =</span><br><span class="line">  [[<span class="built_in">UIActivityViewController</span> alloc] initWithActivityItems:@[imageURL]</span><br><span class="line">                                    applicationActivities:@[mustacheActivity]];</span><br></pre></td></tr></table></figure>

<h3 id="手动执行动作"><a href="#手动执行动作" class="headerlink" title="手动执行动作"></a>手动执行动作</h3><p>现在是一个提醒的好时机，当<code>UIActivityViewController</code>允许用户执行他们选择的动作，分享也能通过手动执行，当场景出现时。</p>
<p>所有为了完整性，下面是怎样手动执行这些动作示例：</p>
<h4 id="Open-URL"><a href="#Open-URL" class="headerlink" title="Open URL"></a>Open URL</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSURL</span> *URL = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@&quot;http://nshipster.com&quot;</span>];</span><br><span class="line">[[<span class="built_in">UIApplication</span> sharedApplication] openURL:URL];</span><br></pre></td></tr></table></figure>
<p>系统支持的URL协议包括：<code>mailto:</code>，<code> tel:</code>，<code>sms:</code>和<code>maps:</code>。</p>
<h4 id="添加到Safari阅读列表"><a href="#添加到Safari阅读列表" class="headerlink" title="添加到Safari阅读列表"></a>添加到Safari阅读列表</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@import</span> SafariServices;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSURL</span> *URL = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@&quot;http://nshipster.com/uiactivityviewcontroller&quot;</span>];</span><br><span class="line">[[SSReadingList defaultReadingList] addReadingListItemWithURL:URL</span><br><span class="line">                                                        title:<span class="string">@&quot;NSHipster&quot;</span></span><br><span class="line">                                                  previewText:<span class="string">@&quot;...&quot;</span></span><br><span class="line">                                                        error:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<h4 id="保存到相册"><a href="#保存到相册" class="headerlink" title="保存到相册"></a>保存到相册</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UIImage</span> *image = ...;</span><br><span class="line"><span class="type">id</span> completionTarget = <span class="keyword">self</span>;</span><br><span class="line">SEL completionSelector = <span class="keyword">@selector</span>(didWriteToSavedPhotosAlbum);</span><br><span class="line"><span class="type">void</span> *contextInfo = <span class="literal">NULL</span>;</span><br><span class="line"><span class="built_in">UIImageWriteToSavedPhotosAlbum</span>(image, completionTarget, completionSelector, contextInfo);</span><br></pre></td></tr></table></figure>

<h4 id="发送-SMS"><a href="#发送-SMS" class="headerlink" title="发送 SMS"></a>发送 SMS</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@import</span> MessageUI;</span><br><span class="line"></span><br><span class="line">MFMessageComposeViewController *messageComposeViewController = [[MFMessageComposeViewController alloc] init];</span><br><span class="line">messageComposeViewController.messageComposeDelegate = <span class="keyword">self</span>;</span><br><span class="line">messageComposeViewController.recipients = @[<span class="string">@&quot;mattt@nshipster•com&quot;</span>];</span><br><span class="line">messageComposeViewController.body = <span class="string">@&quot;Lorem ipsum dolor sit amet&quot;</span>;</span><br><span class="line">[navigationController presentViewController:messageComposeViewController animated:<span class="literal">YES</span> completion:^&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h4 id="发送-Email"><a href="#发送-Email" class="headerlink" title="发送 Email"></a>发送 Email</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@import</span> MessageUI;</span><br><span class="line"></span><br><span class="line">MFMailComposeViewController *mailComposeViewController = [[MFMailComposeViewController alloc] init];</span><br><span class="line">mailComposeViewController.mailComposeDelegate = <span class="keyword">self</span>;</span><br><span class="line">[mailComposeViewController setToRecipients:@[<span class="string">@&quot;mattt@nshipster•com&quot;</span>]];</span><br><span class="line">[mailComposeViewController setSubject:<span class="string">@&quot;Hello&quot;</span>];</span><br><span class="line">[mailComposeViewController setMessageBody:<span class="string">@&quot;Lorem ipsum dolor sit amet&quot;</span> isHTML:<span class="literal">NO</span>];</span><br><span class="line">[navigationController presentViewController:mailComposeViewController animated:<span class="literal">YES</span> completion:^&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h4 id="发送-Tweet"><a href="#发送-Tweet" class="headerlink" title="发送 Tweet"></a>发送 Tweet</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@import</span> Social;</span><br><span class="line"></span><br><span class="line">SLComposeViewController *tweetComposeViewController = [SLComposeViewController composeViewControllerForServiceType:SLServiceTypeTwitter];</span><br><span class="line">[tweetComposeViewController setInitialText:<span class="string">@&quot;Lorem ipsum dolor sit amet.&quot;</span>];</span><br><span class="line">[<span class="keyword">self</span>.navigationController presentViewController:tweetComposeViewController</span><br><span class="line">                                        animated:<span class="literal">YES</span></span><br><span class="line">                                      completion:^&#123;</span><br><span class="line">                                          <span class="comment">// ...</span></span><br><span class="line">                                      &#125;];</span><br></pre></td></tr></table></figure>


<h3 id="IntentKit"><a href="#IntentKit" class="headerlink" title="IntentKit"></a>IntentKit</h3><p>当所有的这些都是印象深刻和非常有用，它在iOS中的活动范例特别缺乏，当和在Android中的丰富的<a target="_blank" rel="noopener" href="http://developer.android.com/guide/components/intents-filters.html">Intents Model</a>相比。</p>
<p>在Android中，apps能够注册不同的intents，来指示它们能够用在Maps，或者充当一个浏览器，能够被涉及到相关活动的默认app选中，比如指引方向，或者一个书签的URL。</p>
<p>然而iOS缺乏来支持这些的可拓展的基础架构，有一个叫<a target="_blank" rel="noopener" href="https://github.com/intentkit/IntentKit">IntentKit</a>第三方库，作者<a target="_blank" rel="noopener" href="https://github.com/lazerwalker">@lazerwalker</a>(因<a target="_blank" rel="noopener" href="http://goshdarnblocksyntax.com/">f*ingblocksyntax.com</a>成名)，这是一个有趣的例子关于我们怎样缩小这方面的差距。</p>
<p><img src="https://raw.github.com/intentkit/IntentKit/master/example.gif" alt="IntentKit demo"></p>
<p>通常，一个开发者可能已经做了很多第一步的工作，来决定是否某个app是否安装，然后怎样构造一个URL来支持某个特殊的活动。</p>
<p>IntentKit加强了连结到大多数流行的Web，Maps,Mail,Twitter,Facebook,和Google+客户的的逻辑，以和<code>UIActivityViewController</code>相似的UI。</p>
<p>任何寻找提升他们的分享体验到下一个级别的人都应该仔细看看这个。</p>
<p>–</p>
<p>在iOS长期生存能力作为一个平台取决于像<code>UIActivityViewController</code>类型的分享机制存上在很大的争论。正如俗语所言：“资讯应该免费”。任何阻碍方式统一的东西，最终都会失去一些没有的东西。</p>
<p>将来的景象是公共的远程视图控制器APIs带给我希望，对于将来在iOS平台上的分享功能。然而现在我们做的和UIActivityViewController相比糟糕得多。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2017/01/09/2017-01-10-2016ge-ren-nian-du-zong-jie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/09/2017-01-10-2016ge-ren-nian-du-zong-jie/" class="post-title-link" itemprop="url">2016个人年度总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-01-09 23:48:07" itemprop="dateCreated datePublished" datetime="2017-01-09T23:48:07+08:00">2017-01-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 11:36:52" itemprop="dateModified" datetime="2024-11-02T11:36:52+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%94%9F%E6%B4%BB/" itemprop="url" rel="index"><span itemprop="name">生活</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>722</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>2016对于我来说的意义，就像10年前的今天，<code>iPhone</code>之余乔布斯，<code>iPhone</code>发布后10年后的今天，小程序之余张小龙。它跨越了一道深深的鸿沟，并向自己理想的方向坚定前行。</p>
<p>一直相信努力就会有回报，付出就会有收获，是金子总会发光。</p>
<ul>
<li>2016是我加入<a href="www.klook.com">客路</a>一周年的时间，认识了很多有趣的朋友和同事的一</li>
<li>2016是我迈出自我，走出中国探索未知的世界的一年。</li>
<li>2016是旅行，工作，生活，学习，社交一样都没落下的一年。</li>
</ul>
<p>曾经的铁哥们也即将回归东莞，这样我们的距离又进了一步，以后有更多的时间聊理想谈人生，想想突然好激动。</p>
<h3 id="业绩"><a href="#业绩" class="headerlink" title="业绩"></a>业绩</h3><p>2016-2017年间一共发布17个版本，多次被<code>Apple</code>推荐，崩溃率小于0.2%，这就是给自己和公司交出最满意的答卷。</p>
<p>下面是Klook App上Apple的推荐页截图：</p>
<img src="/images/2016_year_end_review/klook Apple App recommend.PNG" alt="klook Apple App recommend" width="50%" />

<p>下面是Klook iMessage App上Apple的推荐页截图：</p>
<img src="/images/2016_year_end_review/klook Apple iMessage App recommend.JPG" alt="klook Apple iMessage App recommend" width="50%" />

<p>有时发现互联网真的很奇妙，他能让很多人迅速积累大量的财富成名走上人生的巅峰，过上自己想要的生活，只要你一个好的idea和一个强大的执行力。</p>
<p>这一年来个人技术博客一共写了<strong>46</strong>遍文章，也算一点小积蓄，希望来年继续坚持，能够影响和帮助更多的人，因为技术这条道路上坑实在是太多。</p>
<p><code>Github</code>上<strong>405</strong>次commit还算中规中矩，希望来年分享更多的有价值的东西给有需要的小伙伴，也留给自己方便以后查阅。</p>
<p>![github 2016 commit record](&#x2F;images&#x2F;2016_year_end_review&#x2F;github 2016 commit record.png)</p>
<p>当然现在<code>Github</code>上的内容Fork和博客居多，原创开源项目还比较少，希望来年多输出一点东西。</p>
<h3 id="未来"><a href="#未来" class="headerlink" title="未来"></a>未来</h3><p>愿望这东西还真神奇，许一个试试吧，或许它真的实现了呢，就非常有趣了。<br>给自己定下的旅行清单，学习清单，阅读清单，电影清单基本都完成，这是一件非常棒的事情，为自己点个赞。单反已经从风光转人像，希望来年多出点片，新年即将来临，希望自己坚持一周2次的锻炼，保持精力充沛以便好投入到感情，生活中以及学习中，毕竟互联网是一门终生学习的职业，也是容易产生奇迹的职业，说不定一下个就是你呢。</p>
<p>来年希望和自己喜欢的人旅拍，多尝试一些没尝试过的事情，交更多有趣的朋友。干巴爹😁😁😁</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/12/08/2016-12-08-shi-pin-bo-fang-tips/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/08/2016-12-08-shi-pin-bo-fang-tips/" class="post-title-link" itemprop="url">视频播放Tips</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-12-08 23:44:02" itemprop="dateCreated datePublished" datetime="2016-12-08T23:44:02+08:00">2016-12-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 11:36:52" itemprop="dateModified" datetime="2024-11-02T11:36:52+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>409</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>主要涉及到Tips：</p>
<ol>
<li>获取设备音量</li>
<li>静音模式失效</li>
<li>监听音量改变</li>
<li>设置设备音量 </li>
<li>监听静音按钮</li>
<li>监听耳机拔插</li>
</ol>
<h2 id="获取设备音量"><a href="#获取设备音量" class="headerlink" title="获取设备音量"></a>获取设备音量</h2><p>播放音频可以通过：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">MPMusicPlayerController</span> *iPod = [<span class="built_in">MPMusicPlayerController</span> systemMusicPlayer];</span><br><span class="line"><span class="type">float</span> volumeLevel = iPod.volume;</span><br></pre></td></tr></table></figure>

<p>播放视频可以通过：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> outputVolume = [[<span class="built_in">AVAudioSession</span> sharedInstance] outputVolume];</span><br></pre></td></tr></table></figure>

<blockquote>
<p>推荐下面的方法，上面的在某些版本可能有问题，下面的方法兼容<strong>iOS6及以上</strong>。</p>
</blockquote>
<h2 id="静音模式失效"><a href="#静音模式失效" class="headerlink" title="静音模式失效"></a>静音模式失效</h2><p>通过设置音频会话的category实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSError</span> *setCategoryError = <span class="literal">nil</span>;</span><br><span class="line"><span class="type">BOOL</span> success = [[<span class="built_in">AVAudioSession</span> sharedInstance] setCategory: <span class="built_in">AVAudioSessionCategoryPlayback</span></span><br><span class="line">	                                                  error: &amp;setCategoryError];</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> (!success) &#123; <span class="comment">/* handle the error in setCategoryError */</span> &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这样App就不会随着手机静音键打开而静音，可在手机静音下播放声音😁</p>
</blockquote>
<h2 id="监听音量改变"><a href="#监听音量改变" class="headerlink" title="监听音量改变"></a>监听音量改变</h2><p>监听音频改变私有通知：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(volumeChanged:) name:<span class="string">@&quot;AVSystemController_SystemVolumeDidChangeNotification&quot;</span> object:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<p>实现通过回调：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)volumeChanged:(<span class="built_in">NSNotification</span> *)notification</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">float</span> volume = [[[notification userInfo] objectForKey:<span class="string">@&quot;AVSystemController_AudioVolumeNotificationParameter&quot;</span>]</span><br><span class="line">     floatValue];</span><br><span class="line">     </span><br><span class="line">     <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="设置设备音量"><a href="#设置设备音量" class="headerlink" title="设置设备音量"></a>设置设备音量</h2><p>使用<code>MPVolumeView</code>类，便利它的子views找到类为<code>MPVolumeSlider</code>的滑竿。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">MPVolumeView</span> *volumeView = [[<span class="built_in">MPVolumeView</span> alloc] init];</span><br><span class="line"><span class="built_in">UISlider</span> *volumeViewSlider = <span class="literal">nil</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">UIView</span> *view <span class="keyword">in</span> [volumeView subviews])&#123;</span><br><span class="line">	    <span class="keyword">if</span> ([view.class.description isEqualToString:<span class="string">@&quot;MPVolumeSlider&quot;</span>])	&#123;</span><br><span class="line">	        volumeViewSlider = (<span class="built_in">UISlider</span> *)view;</span><br><span class="line">	        <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>然后再通过设置<code>volumeViewSlider</code>的<code>value</code>即可。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_volumeViewSlider.value = someVolume;</span><br></pre></td></tr></table></figure>

<h2 id="监听静音按钮"><a href="#监听静音按钮" class="headerlink" title="监听静音按钮"></a>监听静音按钮</h2><p>参考<a target="_blank" rel="noopener" href="http://sharkfood.com/content/Developers/content/Sound%20Switch/">Sound Switch - Sharkfood</a>的实现。</p>
<p>使用很简单，判断是否为静音模式：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ([SharkfoodMuteSwitchDetector shared].isMute) &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>动态监听，通过block回调：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[SharkfoodMuteSwitchDetector shared].silentNotify = ^(<span class="type">BOOL</span> silent)&#123;</span><br><span class="line">      <span class="comment">// do something</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="监听耳机拔插"><a href="#监听耳机拔插" class="headerlink" title="监听耳机拔插"></a>监听耳机拔插</h2><p>监听<code>AVAudioSessionRouteChangeNotification</code>通知：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span></span><br><span class="line">									      selector:<span class="keyword">@selector</span>(audioRouteChangeListenerCallback:) 										      name:<span class="built_in">AVAudioSessionRouteChangeNotification</span> </span><br><span class="line">									        object:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<p>实现回调：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)audioRouteChangeListenerCallback:(<span class="built_in">NSNotification</span>*)notification</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSDictionary</span> *interuptionDict = notification.userInfo;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSInteger</span> routeChangeReason = [[interuptionDict valueForKey:<span class="built_in">AVAudioSessionRouteChangeReasonKey</span>] integerValue];</span><br><span class="line">    <span class="keyword">switch</span> (routeChangeReason) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">AVAudioSessionRouteChangeReasonNewDeviceAvailable</span>:</span><br><span class="line">            <span class="comment">// 耳机插入</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">AVAudioSessionRouteChangeReasonOldDeviceUnavailable</span>:</span><br><span class="line">            <span class="comment">// 耳机拔掉</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">AVAudioSessionRouteChangeReasonCategoryChange</span>:</span><br><span class="line">            <span class="comment">// called at start - also when other audio wants to play</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;AVAudioSessionRouteChangeReasonCategoryChange&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/11/26/2016-11-26-dong-hua-qie-huan-imagezui-jia-shi-jian/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/11/26/2016-11-26-dong-hua-qie-huan-imagezui-jia-shi-jian/" class="post-title-link" itemprop="url">动画切换Image最佳实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-11-26 20:42:40" itemprop="dateCreated datePublished" datetime="2016-11-26T20:42:40+08:00">2016-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 11:36:52" itemprop="dateModified" datetime="2024-11-02T11:36:52+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>844</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p><code>UIImageView</code>应该是iOS中使用最频换的控件，就如日常吃饭一样，天天都在重复，有时或许应该反思一下，怎么使用这个控件，达到低能耗，最佳用户体验。</p>
<p>针对单张图片来说，常见的处理是在图片准备显示时增加一个淡出动画，能使图片显示闲的很平滑。</p>
<p>多张图片也一样，在第一张图片的基础上淡出原来的图片，淡入新的图片。也可以说是溶解效果。</p>
<p>很多人喜欢对图片的<code>alpha</code>做淡出动画，使<code>alpha</code>从0到1动画改变。这种动画有一点不好的是，在动画结束后，图片会明显的出现一闪，这样使动画看起来有点突兀。比较好的做法时，在将要显示时给图片做一个转场动画。</p>
<h3 id="淡出动画实现"><a href="#淡出动画实现" class="headerlink" title="淡出动画实现"></a>淡出动画实现</h3><p>下面是其中一种简单的实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIImageView</span> (<span class="title">RFWebImage</span>)</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)animatedChangeToImage:(<span class="built_in">UIImage</span> *)img</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="built_in">UIView</span> transitionWithView:<span class="keyword">self</span></span><br><span class="line">                      duration:<span class="number">0.3</span>f</span><br><span class="line">                       options:<span class="built_in">UIViewAnimationOptionTransitionCrossDissolve</span></span><br><span class="line">                    animations:^&#123;</span><br><span class="line">                        <span class="keyword">self</span>.image = img;</span><br><span class="line">                    &#125; completion:<span class="literal">NULL</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>思路：在ImageView将要显示是使用转场动画函数来实现淡出动画效果，体验应该是是各种动画中最好的了，而且使用起来很简单。</p>
<p>在淡出显示的动画基础上，我们引出今天的主角，动画切换Image。</p>
<p>思路：单张图片淡出我们已经实现，现在做的就是在切换一张新的图片时同时再加入淡出或者说溶解效果即可。</p>
<h3 id="动画切换Image"><a href="#动画切换Image" class="headerlink" title="动画切换Image"></a>动画切换Image</h3><p>比较常见的有下面3种实现：</p>
<ul>
<li><code>CATransition</code>类实现</li>
<li><code>UIView</code>动画转场API实现</li>
<li><code>CABasicAnimation</code>类实现</li>
</ul>
<h4 id="CATransition实现"><a href="#CATransition实现" class="headerlink" title="CATransition实现"></a>CATransition实现</h4><p><code>CATransition</code>类是iOS中很好用的控制转场动画的类，通过简单的配置可以实现常见而炫酷的动画效果，变换类型通过<code>type</code>字段控制，<code>subtype</code>可以很细化控制动画的方向（比如动画开始的上下左右方向）。<code>CATransition</code>继承至<code>CAAnimation</code>可以对动画设置动画曲线（timingFunction），可以通过代理获取动画状态（是已经开始，还是已经停止，已经是否完成）。</p>
<p><code>type</code>支持四种类型：</p>
<ul>
<li>kCATransitionFade    &#x2F;&#x2F; 淡入淡出</li>
<li>kCATransitionMoveIn  &#x2F;&#x2F; 从某个方向向终点平移知道覆盖在上方</li>
<li>kCATransitionPush    &#x2F;&#x2F; 把原来的推出去，自己推出去</li>
<li>kCATransitionReveal  &#x2F;&#x2F; 把原来的从正上方解开，自己在下面</li>
</ul>
<p><em>下面是样板代码：</em></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)animatedSwichImageMethodOne &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UIImage</span> *toImage = [<span class="keyword">self</span> getRadomImage];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CATransition</span> *transition = [<span class="built_in">CATransition</span> animation];</span><br><span class="line">    transition.duration = <span class="number">0.3</span>f;</span><br><span class="line">    transition.timingFunction = [<span class="built_in">CAMediaTimingFunction</span> functionWithName:kCAMediaTimingFunctionEaseInEaseOut];</span><br><span class="line">    transition.type = kCATransitionFade;</span><br><span class="line">    transition.subtype = kCATransitionFromTop;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.imageViewOne.layer addAnimation:transition forKey:<span class="literal">nil</span>];</span><br><span class="line">    [<span class="keyword">self</span>.imageViewOne setImage:toImage];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="UIView动画转场"><a href="#UIView动画转场" class="headerlink" title="UIView动画转场"></a>UIView动画转场</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="type">void</span>)transitionWithView:(<span class="built_in">UIView</span> *)view duration:(<span class="built_in">NSTimeInterval</span>)duration options:(<span class="built_in">UIViewAnimationOptions</span>)options animations:(<span class="type">void</span> (^ __<span class="keyword">nullable</span>)(<span class="type">void</span>))animations completion:(<span class="type">void</span> (^ __<span class="keyword">nullable</span>)(<span class="type">BOOL</span> finished))completion <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">4</span>_0);</span><br></pre></td></tr></table></figure>

<p>通过上面的函数实现，其实是对第一种的高级封装。通过设置<code>options</code>为<code>UIViewAnimationOptionTransitionCrossDissolve</code>即可。</p>
<p><em>下面是样板代码：</em></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)animatedSwichImageMethodTwo &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIImage</span> *toImage = [<span class="keyword">self</span> getRadomImage];</span><br><span class="line">    </span><br><span class="line">    [<span class="built_in">UIView</span> transitionWithView:<span class="keyword">self</span>.imageViewTwo</span><br><span class="line">                      duration:<span class="number">0.3</span>f</span><br><span class="line">                       options:<span class="built_in">UIViewAnimationOptionTransitionCrossDissolve</span> | <span class="built_in">UIViewAnimationOptionCurveEaseInOut</span></span><br><span class="line">                    animations:^&#123;</span><br><span class="line">                        <span class="keyword">self</span>.imageViewTwo.image = toImage;</span><br><span class="line">                    &#125; completion:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="CABasicAnimation实现"><a href="#CABasicAnimation实现" class="headerlink" title="CABasicAnimation实现"></a>CABasicAnimation实现</h4><p><code>CABasicAnimation</code>是核心动画一个重要的类，继承至<code>CAPropertyAnimation</code>，可以对所有的可动画属性做动画，可以通过<code>fromValue</code>，<code>toValue</code>，<code>byValue</code>字段控制动画的进度。<br>在这里我们是对<code>CALayer</code>的<code>contents</code>属性做动画，在改变图片时，创建一个<code>CABasicAnimation</code>对象添加到ImageView的图层上即可。</p>
<p><em>下面是样板代码：</em></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)animatedSwichImageMethodThree &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">UIImage</span> *toImage = [<span class="keyword">self</span> getRadomImage];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">CABasicAnimation</span> *animation = [<span class="built_in">CABasicAnimation</span> animationWithKeyPath:<span class="string">@&quot;contents&quot;</span>];</span><br><span class="line">    animation.toValue = toImage;</span><br><span class="line">    animation.duration = <span class="number">0.3</span>f;</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span>.imageViewThree.layer addAnimation:animation forKey:<span class="string">@&quot;contentsAnimationKey&quot;</span>];</span><br><span class="line">    [<span class="keyword">self</span>.imageViewThree setImage:toImage];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>更多内容请下载<a target="_blank" rel="noopener" href="https://github.com/wangruofeng/AnimatedSwitchImageDemo">Demo</a>查看（<strong>🤔Bonus： Flip效果🤔</strong>）</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/11/17/2016-11-17-ioswu-feng-qiao-jie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/11/17/2016-11-17-ioswu-feng-qiao-jie/" class="post-title-link" itemprop="url">iOS无缝桥接【翻译Apple官方文档】</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-11-17 23:52:46" itemprop="dateCreated datePublished" datetime="2016-11-17T23:52:46+08:00">2016-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 11:36:52" itemprop="dateModified" datetime="2024-11-02T11:36:52+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Toll-Free-Bridged-Types"><a href="#Toll-Free-Bridged-Types" class="headerlink" title="Toll-Free Bridged Types"></a>Toll-Free Bridged Types</h3><p>在<code>Core Foundation</code>框架和<code>Foundation </code>框架中有很多数据类型可以交替转换。能够被交替转换的数据类型也被叫做<code>Toll-Free Bridged</code>数据类型。这意味着你能像参数一样使用相同的数据结构对一个<code>Core Foundation</code>的函数进行调用，或者像<code>Objective-C</code>的消息接受模式一样执行。例如，<code>NSLocale</code>（查看<a target="_blank" rel="noopener" href="https://developer.apple.com/reference/foundation/nslocale">NSLocale Class Reference</a>）可以与在<code>Core Foundation</code>中对应的<code>CFLocale </code>（查看<a target="_blank" rel="noopener" href="https://developer.apple.com/reference/corefoundation/1666963-cflocale">CFLocale Reference</a>）之间互相转换。</p>
<p>不是所有数据类型都是<code>Toll-Free Bridged</code>,即使它们的名字可能让你认为它们是。例如，<code>NSRunLoop</code>是没有对应的桥接类型<code>CFRunLoop</code>,<code>NSBundle</code>也没有对应的桥接类型<code>CFBundle</code>，<code>NSDateFormatter</code>同样没有对应的桥接类型<code>CFDateFormatter</code>。</p>
<p>文章末尾表1提供了一份支持无缝桥接的数据类型的列表。</p>
<blockquote>
<p><strong>注意</strong>：假如你使用一个自定义回调在一个<code>Core Foundation</code>框架的集合中，包含一个<code>NULL</code>回调，当使用<code>Objective-C</code>的方式接入它，它的内存管理方式是未定义的。</p>
</blockquote>
<h3 id="类型转换和对象语义周期声明"><a href="#类型转换和对象语义周期声明" class="headerlink" title="类型转换和对象语义周期声明"></a>类型转换和对象语义周期声明</h3><p>通过无缝桥接技术，在一个你以<code>NSLocale *</code>做为一个参数的方法的例子中，你能传递一个<code>CFLocaleRef</code>结构体，并且当你看到有一个<code>CFLocaleRef </code>参数的函数中，你能够传递一个<code>NSLocale</code>实例对象。当然你也必须提供给编译器相关的一些其它信息:第一，你必须转换一种类型成其它；第二，你可能必须指明对象的语义生命周期。</p>
<p>编译器理解<code>Objective-C</code>的方法并且返回<code>Core Foundation</code>数据类型，下面是<code>Cocoa</code>命名转换的历史（查看<a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/MemoryMgmt/Articles/MemoryMgmt.html#//apple_ref/doc/uid/10000011i">Advanced Memory Management Programming Guide</a>）。例如，编译器知道，在<code>iOS</code>中，通过<code>UIColor </code>的<code>CGColor</code>方法返回的<code>CGColor</code>并不应该被持有。你必须使用恰当的类型转换，像下面例子演示的那样：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMutableArray</span> *colors = [<span class="built_in">NSMutableArray</span> arrayWithObject:(<span class="type">id</span>)[[<span class="built_in">UIColor</span> darkGrayColor] <span class="built_in">CGColor</span>]];</span><br><span class="line">[colors addObject:(<span class="type">id</span>)[[<span class="built_in">UIColor</span> lightGrayColor] <span class="built_in">CGColor</span>]];</span><br></pre></td></tr></table></figure>

<p>编译器并不会自动管理<code>Core Foundation</code>对象的生命周期。你必须告诉编译器对象的语义所属关系通过使用一种转换（定义在<strong>objc&#x2F;runtime.h</strong>）或者<code>Core Foundation</code>风格的宏（定义在 <strong>NSObject.h</strong>）：</p>
<ul>
<li><code>__bridge</code>关键字表示转换指针在<code>Objective-C</code>和<code>Core Foundation</code>之间而不会转换所属关系。</li>
<li><code>__bridge_retained </code>关键字或者<code>CFBridgingRetain </code>表示转换指针在<code>Objective-C</code>和<code>Core Foundation</code>之间并且把所属权交给你。你负责调用<code>CFRelease</code>或者相关的函数来交出对象的所属权。</li>
<li><code>__bridge_transfer</code>关键字或者<code>CFBridgingRelease</code>表示转换一个非<code>Objective-C</code>的指针到<code>Objective-C</code>并且转换所属权给<strong>ARC</strong>。<strong>ARC</strong>负责交出对象的所属权。</li>
</ul>
<p>下面是一些例子：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSLocale</span> *gbNSLocale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@&quot;en_GB&quot;</span>];</span><br><span class="line"><span class="built_in">CFLocaleRef</span> gbCFLocale = (__bridge <span class="built_in">CFLocaleRef</span>)gbNSLocale;</span><br><span class="line"><span class="built_in">CFStringRef</span> cfIdentifier = <span class="built_in">CFLocaleGetIdentifier</span>(gbCFLocale);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;cfIdentifier: %@&quot;</span>, (__bridge <span class="built_in">NSString</span> *)cfIdentifier);</span><br><span class="line"><span class="comment">// Logs: &quot;cfIdentifier: en_GB&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">CFLocaleRef</span> myCFLocale = <span class="built_in">CFLocaleCopyCurrent</span>();</span><br><span class="line"><span class="built_in">NSLocale</span> *myNSLocale = (<span class="built_in">NSLocale</span> *)<span class="built_in">CFBridgingRelease</span>(myCFLocale);</span><br><span class="line"><span class="built_in">NSString</span> *nsIdentifier = [myNSLocale localeIdentifier];</span><br><span class="line"><span class="built_in">CFShow</span>((<span class="built_in">CFStringRef</span>)[<span class="string">@&quot;nsIdentifier: &quot;</span> stringByAppendingString:nsIdentifier]);</span><br><span class="line"><span class="comment">// Logs identifier for current locale</span></span><br></pre></td></tr></table></figure>

<p>下面的例子显示了使用口述的<code>Core Foundation</code>内存管理规则来管理<code>Core Foundation</code>内存：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)drawRect:(<span class="built_in">CGRect</span>)rect &#123;</span><br><span class="line">    <span class="built_in">CGContextRef</span> ctx = <span class="built_in">UIGraphicsGetCurrentContext</span>();</span><br><span class="line">    <span class="built_in">CGColorSpaceRef</span> colorSpace = <span class="built_in">CGColorSpaceCreateDeviceGray</span>();</span><br><span class="line">    <span class="built_in">CGFloat</span> locations[<span class="number">2</span>] = &#123;<span class="number">0.0</span>, <span class="number">1.0</span>&#125;;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *colors = [<span class="built_in">NSMutableArray</span> arrayWithObject:(<span class="type">id</span>)[[<span class="built_in">UIColor</span> darkGrayColor] <span class="built_in">CGColor</span>]];</span><br><span class="line">    [colors addObject:(<span class="type">id</span>)[[<span class="built_in">UIColor</span> lightGrayColor] <span class="built_in">CGColor</span>]];</span><br><span class="line">    <span class="built_in">CGGradientRef</span> gradient = <span class="built_in">CGGradientCreateWithColors</span>(colorSpace, (__bridge <span class="built_in">CFArrayRef</span>)colors, locations);</span><br><span class="line">    <span class="built_in">CGColorSpaceRelease</span>(colorSpace);  <span class="comment">// Release owned Core Foundation object.</span></span><br><span class="line"> </span><br><span class="line">    <span class="built_in">CGPoint</span> startPoint = <span class="built_in">CGPointMake</span>(<span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">    <span class="built_in">CGPoint</span> endPoint = <span class="built_in">CGPointMake</span>(<span class="built_in">CGRectGetMaxX</span>(<span class="keyword">self</span>.bounds), <span class="built_in">CGRectGetMaxY</span>(<span class="keyword">self</span>.bounds));</span><br><span class="line">    <span class="built_in">CGContextDrawLinearGradient</span>(ctx, gradient, startPoint, endPoint,</span><br><span class="line">                                kCGGradientDrawsBeforeStartLocation | kCGGradientDrawsAfterEndLocation);</span><br><span class="line">    <span class="built_in">CGGradientRelease</span>(gradient);  <span class="comment">// Release owned Core Foundation object.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="无缝桥接类型"><a href="#无缝桥接类型" class="headerlink" title="无缝桥接类型"></a>无缝桥接类型</h3><p>表1提供了一个在<code>Core Foundation</code>和<code>Foundation</code>中可以交替转换数据类型列表。对每一对桥接类型，表也列举出了这些无缝桥接类型在<code>OS X</code>中的可用版本。</p>
<table>
<thead>
<tr>
<th align="left">Core Foundation 类型</th>
<th align="left">Foundation 类型</th>
<th align="center">可用性</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CFArrayRef</td>
<td align="left">NSArray</td>
<td align="center">OS X v10.0</td>
</tr>
<tr>
<td align="left">CFAttributedStringRef</td>
<td align="left">NSAttributedString</td>
<td align="center">OS X v10.4</td>
</tr>
<tr>
<td align="left">CFCalendarRef</td>
<td align="left">NSCalendar</td>
<td align="center">OS X v10.0</td>
</tr>
<tr>
<td align="left">CFCharacterSetRef</td>
<td align="left">NSCharacterSet</td>
<td align="center">OS X v10.4</td>
</tr>
<tr>
<td align="left">CFDataRef</td>
<td align="left">NSData</td>
<td align="center">OS X v10.0</td>
</tr>
<tr>
<td align="left">CFDateRef</td>
<td align="left">NSDate</td>
<td align="center">OS X v10.4</td>
</tr>
<tr>
<td align="left">CFDictionaryRef</td>
<td align="left">NSDictionary</td>
<td align="center">OS X v10.0</td>
</tr>
<tr>
<td align="left">CFErrorRef</td>
<td align="left">NSError</td>
<td align="center">OS X v10.4</td>
</tr>
<tr>
<td align="left">CFLocaleRef</td>
<td align="left">NSLocale</td>
<td align="center">OS X v10.0</td>
</tr>
<tr>
<td align="left">CFMutableArrayRef</td>
<td align="left">NSMutableArray</td>
<td align="center">OS X v10.4</td>
</tr>
<tr>
<td align="left">CFMutableAttributedStringRef</td>
<td align="left">NSMutableAttributedString</td>
<td align="center">OS X v10.0</td>
</tr>
<tr>
<td align="left">CFMutableCharacterSetRef</td>
<td align="left">NSMutableCharacterSet</td>
<td align="center">OS X v10.4</td>
</tr>
<tr>
<td align="left">CFMutableDataRef</td>
<td align="left">NSMutableData</td>
<td align="center">OS X v10.0</td>
</tr>
<tr>
<td align="left">CFMutableDictionaryRef</td>
<td align="left">NSMutableDict</td>
<td align="center">OS X v10.4</td>
</tr>
<tr>
<td align="left">CFMutableSetRef</td>
<td align="left">NSMutableSet</td>
<td align="center">OS X v10.0</td>
</tr>
<tr>
<td align="left">CFMutableStringRef</td>
<td align="left">NSMutableString</td>
<td align="center">OS X v10.4</td>
</tr>
<tr>
<td align="left">CFNumberRef</td>
<td align="left">NSNumber</td>
<td align="center">OS X v10.0</td>
</tr>
<tr>
<td align="left">CFReadStreamRef</td>
<td align="left">NSInputStream</td>
<td align="center">OS X v10.4</td>
</tr>
<tr>
<td align="left">CFRunLoopTimerRef</td>
<td align="left">NSTimer</td>
<td align="center">OS X v10.0</td>
</tr>
<tr>
<td align="left">CFSetRef</td>
<td align="left">NSSet</td>
<td align="center">OS X v10.4</td>
</tr>
<tr>
<td align="left">CFStringRef</td>
<td align="left">NSString</td>
<td align="center">OS X v10.0</td>
</tr>
<tr>
<td align="left">CFTimeZoneRef</td>
<td align="left">NSTimeZone</td>
<td align="center">OS X v10.4</td>
</tr>
<tr>
<td align="left">CFURLRef</td>
<td align="left">NSURL</td>
<td align="center">OS X v10.0</td>
</tr>
<tr>
<td align="left">CFWriteStreamRef</td>
<td align="left">NSOutputStream</td>
<td align="center">OS X v10.4</td>
</tr>
</tbody></table>
<p>表1</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/CoreFoundation/Conceptual/CFDesignConcepts/Articles/tollFreeBridgedTypes.html">Toll-Free Bridged Types</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/11/17/2016-11-17-blockbei-wang-lu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/11/17/2016-11-17-blockbei-wang-lu/" class="post-title-link" itemprop="url">block备忘录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-11-17 23:10:08" itemprop="dateCreated datePublished" datetime="2016-11-17T23:10:08+08:00">2016-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 11:36:52" itemprop="dateModified" datetime="2024-11-02T11:36:52+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>825</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>随著<code>block</code>在<strong>iOS4.0</strong>和<strong>OS X 10.6</strong>的引入，给事件传递一种新的方式实现，在开发中用得最多的场景莫过于事件回调。使用<code>block</code>相对与<code>delegate</code>的优势在于，业务集中，可读性强，代码内联，不像代理需要实现很多函数，在适当的场景选择这种方式实现事件传递或者传参效果非常好，现在很多开源项目都实现了两种方法的事件回调。</p>
<p><code>block</code>用起来虽然很爽，但也有它的不足，存在循环引用，轻者内存泄露，甚至导致App崩溃，不易调试追溯，因此使用它使一定要小心。鉴于实践中的踩过各种坑，总结下来，方便自己和他人以后查阅，这就是<strong>block备忘录</strong>写作的初衷。</p>
<h3 id="block的本质"><a href="#block的本质" class="headerlink" title="block的本质"></a>block的本质</h3><p><code>block</code>实际上是指向结构体的指针，编译时，<code>block</code>的内部代码生产对应的函数。</p>
<p>具体结构如下：</p>
<p><img src="/images/block_structure.jpg" alt="block结构图"></p>
<h3 id="与C语言的函数指针的区别"><a href="#与C语言的函数指针的区别" class="headerlink" title="与C语言的函数指针的区别"></a>与C语言的函数指针的区别</h3><ul>
<li><code>block</code>的代码是内联的，效率高于函数调用</li>
<li><code>block</code>对于外部变量默认是只读属性</li>
<li><code>block</code>被<code>Objective-C</code>看成是对象处理</li>
</ul>
<h3 id="block声明"><a href="#block声明" class="headerlink" title="block声明"></a>block声明</h3><ul>
<li><p>作为<code>property</code></p>
<blockquote>
<p>@property (nonatomic, copy) returnType 	(^blockName)(parameterTypes);
  </p>
</blockquote>
</li>
<li><p>作为方法参数</p>
<blockquote>
<p>- (void)someMethodThatTakesABlock:(returnType (^)(parameterTypes))blockName;
  </p>
</blockquote>
</li>
<li><p>作为一个方法调用参数</p>
<blockquote>
<p>[someObject someMethodThatTakesABlock:^returnType 	(parameters) {…}];
  </p>
</blockquote>
</li>
<li><p>作为一个<code>typedef</code></p>
<blockquote>
<p>typedef returnType (^TypeName)(parameterTypes);</p>
</blockquote>
<blockquote>
<p>TypeName blockName &#x3D; ^returnType(parameters) {…};</p>
</blockquote>
</li>
<li><p>作为函数参数</p>
<blockquote>
<p>int (^sumOfNumbers)(int a, int b) &#x3D; ^(int a, int 	b) 	{<br>      return a + b;<br>  };</p>
</blockquote>
</li>
</ul>
<h3 id="SDWebImage中使用的block示例："><a href="#SDWebImage中使用的block示例：" class="headerlink" title="SDWebImage中使用的block示例："></a><code>SDWebImage</code>中使用的<code>block</code>示例：</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">void</span>(^SDWebImageCompletionBlock)(<span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="built_in">NSURL</span> *imageURL);</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">void</span>(^SDWebImageCompletionWithFinishedBlock)(<span class="built_in">UIImage</span> *image, <span class="built_in">NSError</span> *error, SDImageCacheType cacheType, <span class="type">BOOL</span> finished, <span class="built_in">NSURL</span> *imageURL);</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSString</span> *(^SDWebImageCacheKeyFilterBlock)(<span class="built_in">NSURL</span> *url);</span><br></pre></td></tr></table></figure>

<h3 id="block调用"><a href="#block调用" class="headerlink" title="block调用"></a>block调用</h3><p>跟C函数类似使用<code>（）</code>，括号里面还可以带一个或者多个参数</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// block声明</span></span><br><span class="line">（<span class="type">void</span>）(^loggerBlock)(<span class="type">void</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">// block定义</span></span><br><span class="line">loggerBlock = ^&#123; </span><br><span class="line">     <span class="built_in">NSLog</span>(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// block调用</span></span><br><span class="line">loggerBlock(); </span><br></pre></td></tr></table></figure>


<h3 id="block内存管理"><a href="#block内存管理" class="headerlink" title="block内存管理"></a>block内存管理</h3><p>默认情况下，<code>block</code>是在栈内存中，它不会对所引用的对象进行任何操作；如果对<code>block</code>进行一次<code>copy</code>操作，<code>block</code>就会在堆内存中，并且它会它所有的引用的对象做一次<code>retain</code>操作</p>
<ol>
<li>对于block外的变量引用，block 默认是将其复制到其数据结构中来实现访问的</li>
<li>对于用 <code>__block</code> 修饰的外部变量引用，block 是复制其引用地址来实现访问的</li>
<li>而block会捕获代码外的局部变量，并且仅限于只读操作</li>
<li>在block中希望修改的外界局部对象，必须加上<code>__block</code>关键词</li>
</ol>
<p>ARC</p>
<pre><code>如果对象使用`__unsafe_unretained`或`__weak`修饰，就不会对其做`retain`操作
</code></pre>
<p>MRC</p>
<pre><code>如果对象使用了`__block`修饰, 就不会对其做`retain`操作
</code></pre>
<p>为了防止<code>block</code>中的循环引用，可以用<code>__weak</code>关键词把相应的对象声明为弱引用,在<code>block</code>快内部需要多次访问，防止该对象被释放，可以用<code>__strong</code>关键词将声明为强引用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__<span class="keyword">weak</span> __typeof__(<span class="keyword">self</span>) weakSelf = <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line"></span><br><span class="line">    __<span class="keyword">strong</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>) strongSelf = weakSelf;</span><br><span class="line">    </span><br><span class="line">    [strongSelf doSomething];</span><br><span class="line">    [strongSelf doOtherThing];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a target="_blank" rel="noopener" href="http://blog.devtang.com/2013/07/28/a-look-inside-blocks/">谈Objective-C block的实现</a></li>
<li><a target="_blank" rel="noopener" href="http://www.galloway.me.uk/2012/10/a-look-inside-blocks-episode-1/">A look inside blocks: Episode 1</a></li>
<li><a target="_blank" rel="noopener" href="http://www.galloway.me.uk/2012/10/a-look-inside-blocks-episode-2/">A look inside blocks: Episode 2</a></li>
<li><a target="_blank" rel="noopener" href="http://www.galloway.me.uk/2013/05/a-look-inside-blocks-episode-3-block-copy/">A look inside blocks: Episode 3</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/biosli/archive/2013/05/29/iOS_Objective-C_Block.html">对 Objective-C 中 Block 的追探</a></li>
<li><a target="_blank" rel="noopener" href="https://llvm.org/svn/llvm-project/compiler-rt/trunk/BlocksRuntime/Block_private.h">LLVM 中 block 实现源码</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.parse.com/2013/02/05/objective-c-blocks-quiz/">objective-c-blocks-quiz</a></li>
<li><a target="_blank" rel="noopener" href="http://rypress.com/tutorials/objective-c/blocks.html">Blocks</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/29d70274374b">iOS开发-由浅至深学习block</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/10/23/2016-10-23-appchang-jian-beng-kui-wen-ti-fen-xi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/10/23/2016-10-23-appchang-jian-beng-kui-wen-ti-fen-xi/" class="post-title-link" itemprop="url">App常见崩溃问题分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-10-23 23:18:01" itemprop="dateCreated datePublished" datetime="2016-10-23T23:18:01+08:00">2016-10-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 11:36:52" itemprop="dateModified" datetime="2024-11-02T11:36:52+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>12 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>此文是基于这些年工作中项目里面常见崩溃的一些总结，整理出来方便查阅，希望对大家都有所帮助。</p>
<h3 id="App常见崩溃"><a href="#App常见崩溃" class="headerlink" title="App常见崩溃"></a>App常见崩溃</h3><ol>
<li>数组下标越界</li>
<li>字典构造与修改</li>
<li><code>NSAttributedString</code>相关</li>
<li>呈现一个空控制器</li>
<li>unrecognized selector</li>
<li>操作<code>tableView</code>数据</li>
<li>Push到同一个控制器多次</li>
</ol>
<h4 id="1-数组下标越界"><a href="#1-数组下标越界" class="headerlink" title="1.数组下标越界"></a>1.数组下标越界</h4><p><strong>示例代码</strong>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)testArrayOutOfBounds</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *testArray = @[@<span class="number">1</span>,@<span class="number">2</span>,@<span class="number">3</span>];</span><br><span class="line">    <span class="built_in">NSNumber</span> *num = testArray[<span class="number">3</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>异常现象</strong>：</p>
<p><em>Terminating app due to uncaught exception ‘NSRangeException’, reason: ‘*</em>* -[__NSArrayI objectAtIndex:]: index 3 beyond bounds [0 .. 2]’*</p>
<p><strong>预防方案</strong>：</p>
<p>在数组中取值时需要先进组下标索引边界检查，如果没有越界方可取值。</p>
<h4 id="2-字典构造造与修改"><a href="#2-字典构造造与修改" class="headerlink" title="2.字典构造造与修改"></a>2.字典构造造与修改</h4><p><strong>示例代码</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (void)testDicSetNilValueCrash</span><br><span class="line">&#123;</span><br><span class="line">    // 构造不可变字典时 key和value都不能为空</span><br><span class="line">    NSString *nilValue = nil;</span><br><span class="line">    NSString *nilKey = nil;</span><br><span class="line">    NSDictionary *dic1 = @&#123;@&quot;key&quot; : nilValue&#125;;</span><br><span class="line">    NSDictionary *dic2 = @&#123;nilKey : @&quot;value&quot;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>异常现象</strong>：</p>
<p><em>Terminating app due to uncaught exception ‘NSInvalidArgumentException’, reason: ‘*</em>* -[__NSPlaceholderDictionary initWithObjects:forKeys:count:]: attempt to insert nil object from objects[0]’*</p>
<p><strong>预防方案</strong>：</p>
<p>在我们使用字面量快速创建一个字典的时候需要特别小心，因为很可能字典的键和值不能保证同时不为空。有潜在崩溃的风险，这种崩溃非常容易出现，需要特别小心，但是当你留心的话也非常好避免，就是设置字典的键或者值的时候判断是否非空，可变字典设置某个键的值是可以为空，相当于删除字典中的某个键值。为了使App保持健壮推荐使用<code>KVO</code>或者字面量的方式来设置字典的值</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)testMutableDicSetNilValueCrash</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *value = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *mDic = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// via Dic set, leading crash</span></span><br><span class="line">    [mDic setObject:value forKey:<span class="string">@&quot;key&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// via KVO set, it&#x27;s safe</span></span><br><span class="line">    [mDic setValue:value forKey:<span class="string">@&quot;key&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// or via literal set, it&#x27;s safe</span></span><br><span class="line">    mDic[<span class="string">@&quot;key&quot;</span>] = value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="3-NSAttributedString相关"><a href="#3-NSAttributedString相关" class="headerlink" title="3.NSAttributedString相关"></a>3.NSAttributedString相关</h4><p><strong>示例代码</strong>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)testAttributedStringInitCrash</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *nilStr = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">NSMutableAttributedString</span> *attributedStr = [[<span class="built_in">NSMutableAttributedString</span> alloc] initWithString:nilStr];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)testAttributedStringAddAttributeCrash</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *nonnullStr = <span class="string">@&quot;str&quot;</span>;</span><br><span class="line">    <span class="built_in">NSMutableAttributedString</span> *attributedStr = [[<span class="built_in">NSMutableAttributedString</span> alloc] initWithString:nonnullStr];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSString</span> *nilValue = <span class="literal">nil</span>;</span><br><span class="line">    [attributedStr addAttribute:<span class="built_in">NSAttachmentAttributeName</span> value:nilValue range:<span class="built_in">NSMakeRange</span>(<span class="number">0</span>, <span class="number">1</span>)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>异常现象</strong>：</p>
<p><em>Terminating app due to uncaught exception ‘NSInvalidArgumentException’, reason: ‘NSConcreteMutableAttributedString initWithString:: nil value’</em></p>
<p><strong>预防方案</strong>：</p>
<p>在构造<code>NSMutableAttributedString</code>或者<code>NSAttributedString</code>需要留意，设置的属性的值是否有可能存在<code>nil</code>的情况。这个很容易被人忽视，值得注意。</p>
<h4 id="4-呈现一个空控制器"><a href="#4-呈现一个空控制器" class="headerlink" title="4.呈现一个空控制器"></a>4.呈现一个空控制器</h4><p><strong>示例代码</strong>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)testPresentNilControllerCrash</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UIViewController</span> *someVC = [<span class="built_in">UIViewController</span> new];</span><br><span class="line">    <span class="built_in">UIViewController</span> *presentVC = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    [someVC presentViewController:presentVC animated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>异常现象</strong>：</p>
<p>present一个空的控制器导致App crash</p>
<p><strong>预防方案</strong>：</p>
<p>present一个新控制器时，判断是否存在，存在才执行，否则直接返回</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)testPresentNilControllerCrashFixed</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">UIViewController</span> *someVC = [<span class="built_in">UIViewController</span> new];</span><br><span class="line">    <span class="built_in">UIViewController</span> *presentVC = [<span class="built_in">UIViewController</span> new];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (presentVC) &#123;</span><br><span class="line">        [someVC presentViewController:presentVC animated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-unrecognized-selector"><a href="#5-unrecognized-selector" class="headerlink" title="5.unrecognized selector"></a>5.unrecognized selector</h4><p><strong>示例代码</strong>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)testUnrecogernizedSelectorCash</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(testSel) withObject:<span class="literal">nil</span> afterDelay:<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>异常现象</strong>：</p>
<p><em>Terminating app due to uncaught exception ‘NSInvalidArgumentException’, reason: ‘-[ViewController testSel]: unrecognized selector sent to instance 0x7ffd41609d10’</em></p>
<p><strong>预防方案</strong>：</p>
<p>此类崩溃经常出现，特别是当服务器数据放回异常时，比如本来应该返回一个<code>NSString</code>类型字符串，结果返回<code>NULL</code>,当你调用字符串的<code>length</code>方式时，导致App崩溃。预防方法，重要的地方对类型进行判断再调用该类的相关方法，或者写一个分类统一处理此类逻辑。</p>
<h4 id="6-操作tableView数据"><a href="#6-操作tableView数据" class="headerlink" title="6.操作tableView数据"></a>6.操作tableView数据</h4><p><strong>示例代码</strong>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)testTableViewUpdateCrash</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSIndexPath</span> *insertIndexPath = [<span class="built_in">NSIndexPath</span> indexPathForRow:<span class="number">0</span> inSection:<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">NSIndexPath</span> *deleteIndexPath = [<span class="built_in">NSIndexPath</span> indexPathForRow:<span class="number">1</span> inSection:<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">NSIndexPath</span> *reloadIndexPath = [<span class="built_in">NSIndexPath</span> indexPathForRow:<span class="number">2</span> inSection:<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">NSIndexPath</span> *moved1IndexPath = [<span class="built_in">NSIndexPath</span> indexPathForRow:<span class="number">3</span> inSection:<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">NSIndexPath</span> *moved2IndexPath = [<span class="built_in">NSIndexPath</span> indexPathForRow:<span class="number">4</span> inSection:<span class="number">0</span>];</span><br><span class="line">    [<span class="keyword">self</span>.tableView beginUpdates];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span>.tableView insertRowsAtIndexPaths:@[insertIndexPath] withRowAnimation:<span class="built_in">UITableViewRowAnimationAutomatic</span>];</span><br><span class="line">    [<span class="keyword">self</span>.tableView deleteRowsAtIndexPaths:@[deleteIndexPath]withRowAnimation:<span class="built_in">UITableViewRowAnimationAutomatic</span>];</span><br><span class="line">    [<span class="keyword">self</span>.tableView reloadRowsAtIndexPaths:@[reloadIndexPath] withRowAnimation:<span class="built_in">UITableViewRowAnimationAutomatic</span>];</span><br><span class="line">    [<span class="keyword">self</span>.tableView moveRowAtIndexPath:moved1IndexPath toIndexPath:moved2IndexPath];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span>.tableView endUpdates];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>异常现象</strong>：</p>
<p><em>Fatal Exception: NSInternalInconsistencyException</em></p>
<p><em>Invalid update: invalid number of sections. The number of sections contained in the table view after the update (1) must be equal to the number of sections contained in the table view before the update (1), plus or minus the number of sections inserted or deleted (1 inserted, 0 deleted).</em></p>
<p><strong>预防方案</strong>：</p>
<p>当需要动态更新<code>tableView</code>的数据时，计算好模型的数据使模型的数据和更新<code>tableView</code>的后的数据保持同步。</p>
<h4 id="7-Push到同一个控制器多次"><a href="#7-Push到同一个控制器多次" class="headerlink" title="7.Push到同一个控制器多次"></a>7.Push到同一个控制器多次</h4><p><strong>异常现象</strong>：</p>
<p>Fatal Exception: NSInvalidArgumentException</p>
<p>Pushing the same view controller instance more than once is not supported (&lt;PPSelectPayMethodViewControllerIOS7: 0x10d7e7f10&gt;)</p>
<p><strong>参考链接</strong>：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/nixzhu/dev-blog/blob/master/2016-01-04-duplicate-push.md">防止点击 Cell 时 ViewController 被重复 Push</a></li>
</ul>
<p>以上就是工作中常见的异常崩溃以及处理方案，下面的异常分类内容来自<code>Apple</code>的官方文档，有兴趣的可以查阅。☕️</p>
<h3 id="Apple官方常见异常类型-Exception-types"><a href="#Apple官方常见异常类型-Exception-types" class="headerlink" title="Apple官方常见异常类型(Exception types)"></a>Apple官方常见异常类型(Exception types)</h3><ol>
<li>访问一块坏内存<code>[EXC_BAD_ACCESS] // SIGSEGV // SIGBUS]</code></li>
<li>异常退出<code>[EXC_CRASH // SIGABRT]</code></li>
<li>追踪受限<code>[EXC_BREAKPOINT // SIGTRAP]</code></li>
<li>非法指令<code>[EXC_BAD_INSTRUCTION // SIGILL]</code></li>
<li>被保护的资源遭到侵害<code>[EXC_GUARD]</code></li>
<li>资源限制<code>[EXC_RESOURCE]</code></li>
<li>其他异常类型</li>
</ol>
<h4 id="1-访问一块坏内存-Bad-Memory-Access"><a href="#1-访问一块坏内存-Bad-Memory-Access" class="headerlink" title="1.访问一块坏内存(Bad Memory Access)"></a>1.访问一块坏内存(Bad Memory Access)</h4><p>当程序试图接入无效内容或者尝试以不被允许的方式接入由于内存的保护等级(例如，尝试写入只读的内存)。<code>Exception Subtype</code>字段包含一个<strong>kern_return_t</strong>结构体用来描述错误和不正确接入的内存地址。</p>
<p>下面是一些调试坏内存接入导致崩溃的建议：</p>
<ul>
<li>假如<strong>objc_msgSend</strong>或者<strong>objc_release</strong>在崩溃线程回溯(<strong>Backtraces</strong>)的顶部附近,这个线程可能尝试给一个释放的对象发消息。你应该profile应用使用<strong>Zombies instrument</strong>来更好的理解这个崩溃发生的条件。</li>
<li>假如<strong>gpus_ReturnNotPermittedKillClient</strong>在崩溃线程回溯(<strong>Backtraces</strong>)的顶部附近，线程被终结因为它尝试用<strong>OpenGL ES</strong>或者<strong>Metal</strong>执行渲染当程序处于后台时。查看<a target="_blank" rel="noopener" href="https://developer.apple.com/library/ios/qa/qa1766/_index.html">QA1766: How to fix OpenGL ES application crashes when moving to the background</a></li>
<li>打开<code>Address Sanitizer</code>运行你的应用。Address Sanitizer添加了额外的说明在内容接入当你编译代码的时候。随着你应用的运行，Xcode将⚠️你假如内存以一种可能导致崩溃的方式接入。</li>
</ul>
<h4 id="2-异常退出（Abnormal-Exit）"><a href="#2-异常退出（Abnormal-Exit）" class="headerlink" title="2.异常退出（Abnormal Exit）"></a>2.异常退出（Abnormal Exit）</h4><p>程序异常退出，是最常见导致这类异常崩溃的原因是捕获到<code>Objective-C/C++</code>异常和调用了<code>abort()</code>函数。</p>
<p><strong>App Extensions</strong>将被终结发生这种类型的异常，假如他们初始化花费太多的时间(<em>watchdog</em>终结)。假如一个<strong>extension</strong>由于载入时间太长被终结，产生崩溃报告的<strong>Exception Subtype</strong>将是<em>LAUNCH_HANG</em>。因为<strong>extensions</strong>并没有一个<code>main</code>函数，任何花销在初始化的时间都发生在<strong>static constructors</strong>和呈现在你的<strong>extensions</strong>和依赖库的<code>+load</code>方法。你应该尽可能的延迟做这些工作。</p>
<h4 id="3-追踪受限（Trace-Trap）"><a href="#3-追踪受限（Trace-Trap）" class="headerlink" title="3.追踪受限（Trace Trap）"></a>3.追踪受限（Trace Trap）</h4><p>和异常退出类似，这种异常的目的是给一个追加的调试器，让它有机会来打断在一个当它执行时候指定的点的进程。你可以使用<code>__builtin_trap()</code>函数在你的代码中来触发这个异常。假如没有调试器追加的话，线程将被终结并且产生一个崩溃报告。</p>
<p>低等级的库（例如<strong>libdispatch</strong>）将受限这个进程一旦遇到一个重大的错误。关于错误的额外信息可以在<a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/technotes/tn2151/_index.html#//apple_ref/doc/uid/DTS40008184-CH1-APPINFO">Additional Diagnostic Information</a>章节中的崩溃报告找到，或者在设备的控制台。</p>
<p>假如在<code>runtime</code>遇到诸如下面的一个意外的条件，<code>Swift</code>代码将终结出现这种类型的异常：</p>
<ul>
<li>非可选类型带有一个<code>nil</code>值</li>
<li>错误的强制类型转换</li>
</ul>
<p>查看<a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/technotes/tn2151/_index.html#//apple_ref/doc/uid/DTS40008184-CH1-STACKTRACE">Backtraces</a>来决发生定异常条件的位置。额外的信息可能已经在设备的控制台打印出来了。你应该修改崩溃处的代码来优雅的处理<code>runtime</code>错误。例如，使用<a target="_blank" rel="noopener" href="https://developer.apple.com/library/ios/documentation/Swift/Conceptual/Swift_Programming_Language/TheBasics.html">Optional Binding</a>而不是强制解包一个可选变量。</p>
<h4 id="4-非法指令（Illegal-Instruction）"><a href="#4-非法指令（Illegal-Instruction）" class="headerlink" title="4.非法指令（Illegal Instruction）"></a>4.非法指令（Illegal Instruction）</h4><p>进程尝试执行一个非法或者未定义的指令。进程可能已经尝试跳进到一个无效的地址通过一个配置错误的函数指针。在<code>Intel</code>处理器中，<code>ud2</code>操作码导致一个<strong>EXC_BAD_INSTRUCTION</strong>异常，但是它通常被用来困住进程达到调试的目的。<code>Swift</code>代码在<code>Intel</code>处理器中将以这种异常终结，假如在<code>runtime</code>位置条件发生。更多详情查看<strong>Trace Trap</strong>。</p>
<h4 id="5-被保护的资源遭到侵害（Guarded-Resource-Violation）"><a href="#5-被保护的资源遭到侵害（Guarded-Resource-Violation）" class="headerlink" title="5.被保护的资源遭到侵害（Guarded Resource Violation）"></a>5.被保护的资源遭到侵害（Guarded Resource Violation）</h4><p>进程侵犯一个被保护的资源。系统库可能某个文件的描述器成<code>guarded</code>，在那以后，所有不正常的操作在这些描述器上都将触发一个<strong>EXC_GUARD</strong>异常（当它想操作在这些文件描述器上，系统可以使用特殊的<code>guarded</code>标记的私有APIs）。这可以帮你向下快速追踪问题，例如关闭一个已经被系库打开的文件描述器。例如，假如一个app关闭文件秒杀器通过使用截图<code>SQLite</code>文件到一个<code>Core Data</code>存储，<code>Core Data</code>将会在随后诡异的崩溃。<strong>guard exception</strong>将让这些问题尽早引起你的注意，这样也让他们变得更容易调试。</p>
<p>崩溃报告来自新版的<code>iOS</code>包含了人类可读的详细信息关于引起<code>EXC_GUARD</code>异常的操作在<code>Exception Subtype</code>和<code>Exception Message</code>字段中。在来自<code>macOS</code>或者老版本的<code>iOS</code>的崩溃报告中，这些信息被编码到第一个<code> Exception Code</code>就像一个分解成如下的位段：</p>
<ul>
<li><strong>[63:61] - Guard Type</strong>：被保护的资源类型。<code>0x2</code>代表一个文件描述器资源。</li>
<li><strong>[60:32] - Flavor</strong>：侵害被处罚时的条件<ul>
<li>假如第一个<code>(1 &lt;&lt; 0)</code>位被设置，进程尝试执行<code>close()</code>函数在一个受保护的文件描述器。</li>
<li>假如第二个<code>(1 &lt;&lt; 1)</code>位被设置，进程尝试执行<code>dup()</code>，<code>dup2()</code>，或者<code>fcntl()</code>带<code>F_DUPFD</code>或者<code>F_DUPFD_CLOEXEC</code>命令在一个受保护的文件描述器。</li>
<li>假如第三个<code>(1 &lt;&lt; 2)</code>位被设置，进程尝试通过一个<code>socket</code>发送给一个受保护的文件描述器。</li>
<li>假如第三个<code>(1 &lt;&lt; 3)</code>位被设置，进程尝试写入到一个受保护的文件描述器。</li>
</ul>
</li>
<li><strong>[31:0] - File Descriptor</strong>：进程尝试修改的受保护的文件描述器。</li>
</ul>
<h4 id="6-资源限制（Resource-Limit）"><a href="#6-资源限制（Resource-Limit）" class="headerlink" title="6.资源限制（Resource Limit）"></a>6.资源限制（Resource Limit）</h4><p>进程超出了一个资源消耗的限制。这是一个来自操作系统通知，告诉进程正在使用的资源过多。精确的资源列在<code>Exception Subtype</code>字段中。假如<code>Exception Note</code>字段包含<code>NON-FATAL CONDITION</code>，进程不会被终结即使产生了一个崩溃报告。</p>
<ul>
<li><p>异常子类型<code>MEMORY</code>表明进程已经越过系统应用的内存限制。这可能是一个终结的先兆由于超额的使用内存。</p>
</li>
<li><p>异常子类型<code>WAKEUPS</code>表明在进程中的线程每秒被唤醒太多次，这强制<code>CPU</code>非常频繁的唤醒消耗电池寿命。</p>
<p>  典型的，这个通过由线程与线程的通信产生（通常是使用<code>peformSelector:onThread:</code>或<code>dispatch_async</code>）,那样无意的发生了远远超出它正常应该的切换频率。因为通信的协调发生得非常频繁而出发此类的异常，这个通常和多个后台线程有着相似<code>Backtraces</code> – 表明那些地方发生过通信。</p>
</li>
</ul>
<h4 id="7-其他异常类型（Other-Exception-Types）"><a href="#7-其他异常类型（Other-Exception-Types）" class="headerlink" title="7.其他异常类型（Other Exception Types）"></a>7.其他异常类型（Other Exception Types）</h4><p>一些崩溃报告可能含有一个未命名的<code>Exception Type</code>，将以一个16进制的值（例如，00000020）的形式打印。假如你的设备收到了一个这样的崩溃报告，直接查看<code>Exception Codes</code>字段寻找更多的信息。</p>
<ul>
<li><p>异常代码<code>0xbaaaaaad</code>表明记录是整个系统的<code>stackshot</code>，不是一个崩溃报告。为了获得一个<code>stackshot</code>，按<code>Home</code>键和任意音量键。这些记录经常被用户偶然创建，并不表明是一个错误。</p>
</li>
<li><p>异常代码<code>0xbad22222</code>表明一个<code>VoIP</code>应用已经被<code>iOS</code>终结，因为它启动得太频繁。</p>
</li>
<li><p>异常代码<code>0x8badf00d</code>表明应用已经被<code>iOS</code>终结因为发生<code>watchdog</code>超时。应用花费太长时间启动，终结，或者响应系统事件。通常导致这歌问题是做了<a target="_blank" rel="noopener" href="http://developer.apple.com/library/ios/qa/qa1693/">在主线程执行了同步的网络请求</a>。无论什么操作在<code>Thread 0</code>都需要移动到后台线程，或者异步处理，以免它阻塞主线程。</p>
</li>
<li><p>异常代码<code>0xc00010ff</code>表明引用被操作系统终结为了响应一个发热事件。这个可能由于一个发生崩溃的特定的设备的问题或者环境被操作导致。为了使你的应用更高效运行的建议，查看<strong>WWDC session</strong><a target="_blank" rel="noopener" href="https://developer.apple.com/videos/wwdc/2011/?id=312"> iOS Performance and Power Optimization with Instruments</a>。</p>
</li>
<li><p>异常代码<code>0xdead10cc</code>表明应用被<code>iOS</code>终结，由于当在后台运行时它持有了一个系统的资源（像通信录数据库）。</p>
</li>
<li><p>异常代码<code>0xdeadfa11</code>表明应用被用户强制退出。强制退出发生在当用户第一次按下开关机按钮直到”滑动来关机”出现，然后在按下Home键。这是合理的假如用户这样做了，因为应用已经变得不可响应，但是这并不能保证 - 强制退出任何正在运行的任务。</p>
<blockquote>
<p>注意：终结一个挂起的app通过从多任务关系面板中移除并不会产生一个崩溃报告。一旦一个app被挂起，<strong>iOS</strong>它有资格在任何时候终结它，所有没有崩溃报告产生。</p>
</blockquote>
</li>
</ul>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/technotes/tn2151/_index.html">Understanding and Analyzing Application Crash Reports</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/content/documentation/IDEs/Conceptual/AppDistributionGuide/AnalyzingCrashReports/AnalyzingCrashReports.html">Analyzing Crash Reports</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/09/10/2016-09-10-kuai-su-feng-zhuang-airbnbfeng-ge-loadingview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/09/10/2016-09-10-kuai-su-feng-zhuang-airbnbfeng-ge-loadingview/" class="post-title-link" itemprop="url">快速封装Airbnb风格Loadingview</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-09-10 13:54:15" itemprop="dateCreated datePublished" datetime="2016-09-10T13:54:15+08:00">2016-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 11:36:52" itemprop="dateModified" datetime="2024-11-02T11:36:52+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>942</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>一直在观察各种App的<code>LoadingView</code>，比较有代表性的是<code>MBProgressVHUD</code>，<code>SVProgressHUD</code>，这两个使用得非常广泛，大到QQ，支付宝，小到各种不知道名的App，长时间的迭代让它们的逻辑非常完善，同时也导致了有些累赘，如果把它们当一个产品来分析，可以看出，它们在不断地增加需求和使用场景，有没有一个非常简洁的HUD没有我们不需要的那些多余的逻辑只是负责显示指示和隐藏呢？</p>
<p>好像没有，所有今天动手准备自己封装一个<code>LoadingView</code>，灵感来自Airbnb，用过Airbnb的同学都知道，它的<code>LoadingView</code>很有风格,Airbnb是几张图片循环翻转切换，当然我不准备复制他们的idea，我准备做一个循环左右上下切换的<code>LoadingView</code>。</p>
<img src="/images/loading_img/loading_img_01.jpg" width="375" height="667">

<p>废话不多说，先来看一下，最终效果的原型图</p>
<p><img src="/images/loading_img/loading_img_02.jpg" alt="RFLoadingView"></p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>分析一下思路：</p>
<ul>
<li>四条虚线交叉形成的区域就是我们能够看到的图片</li>
<li>首先准备两张图片，位置 中+上</li>
<li>开始第一段动画，向下切换，位置 变成 中+下</li>
<li>第一段动画结束，将下面的图片移动到右边，准备开始第二段动画</li>
<li>第二动画跟第一段类似，只是方向是从右向左，动画结束后 位置变成 中+左</li>
<li>将左边的图片移动到上方位置，完成一个循环</li>
</ul>
<p> 为了使动画更流畅不至于生硬，我们使用iOS7推出的带弹簧效果的API</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">+ (<span class="type">void</span>)animateWithDuration:(<span class="built_in">NSTimeInterval</span>)duration delay:(<span class="built_in">NSTimeInterval</span>)delay usingSpringWithDamping:(<span class="built_in">CGFloat</span>)dampingRatio initialSpringVelocity:(<span class="built_in">CGFloat</span>)velocity options:(<span class="built_in">UIViewAnimationOptions</span>)options animations:(<span class="type">void</span> (^)(<span class="type">void</span>))animations completion:(<span class="type">void</span> (^ __<span class="keyword">nullable</span>)(<span class="type">BOOL</span> finished))completion <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">7</span>_0);</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<h3 id="API接口"><a href="#API接口" class="headerlink" title="API接口"></a>API接口</h3><p>在API接口设计上，我希望尽量简单实用，封装了两个方法，一个用来显示，一个用来隐藏，可以指定显示到某个view，以及指定显示和隐藏时是否使用动画。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">+ (<span class="type">void</span>)showViewAddedTo:(<span class="built_in">UIView</span> *)view animated:(<span class="type">BOOL</span>)animated;</span><br><span class="line">+ (<span class="type">void</span>)hideViewForView:(<span class="built_in">UIView</span> *)view animated:(<span class="type">BOOL</span>)animated;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="API实现"><a href="#API实现" class="headerlink" title="API实现"></a>API实现</h3><p>根据刚才的分析，核心的动画实现已经有了思路，现在就是怎么设计内部代码实现，为了方便显示蒙版阻止加载的时候用户交互，我把view的背景颜色设置了一个淡灰色，view的中间有三个子view，一个是位于中间的容器<code>centralView</code>,负责显示我们所看到的区域，方便实现圆角和动画效果，里面加入两个子view，<code>firstView</code>和<code>secondView</code>用于显示动画切换的图片。</p>
<p>内部接口大概这样</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIView</span>      *centralView;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIImageView</span> *firstView;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIImageView</span> *secondView;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>为了防止多次添加<code>LoadingView</code>，在每次添加前，我们会查找该view是否存在，如果不存在，创建一个新的对象，如果存在直接跳过添加操作。反向遍历，快速查找。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">+ (RFLoadingView *)loadingViewForView:(<span class="built_in">UIView</span> *)view</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSEnumerator</span> *subviewsEnum = [view.subviews reverseObjectEnumerator];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">UIView</span> *subview <span class="keyword">in</span> subviewsEnum) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([subview isKindOfClass:<span class="keyword">self</span>]) &#123;</span><br><span class="line">            <span class="keyword">return</span> (RFLoadingView *)subview;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>动画核心实现,两端动画，封装成两个方法</p>
<ul>
<li><code>- (void)animatedImageFromTopToBottom</code></li>
<li><code>- (void)animatedImageFromTopToBottom</code></li>
</ul>
<p>具体实现如下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="type">void</span>)animatedImageFromTopToBottom</span><br><span class="line">&#123;</span><br><span class="line">    [<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.3</span> delay:<span class="number">0.5</span> usingSpringWithDamping:<span class="number">0.7</span> initialSpringVelocity:<span class="number">0</span> options:<span class="built_in">UIViewAnimationOptionCurveEaseInOut</span> animations:^&#123;</span><br><span class="line">        _firstView.centerY  += kCenterViewSize;</span><br><span class="line">        _secondView.centerY += kCenterViewSize;</span><br><span class="line">    &#125; completion:^(<span class="type">BOOL</span> finished) &#123;</span><br><span class="line">        _firstView.centerX += kCenterViewSize;</span><br><span class="line">        _firstView.centerY -= kCenterViewSize;</span><br><span class="line">        </span><br><span class="line">        [<span class="keyword">self</span> changeFirstImage];</span><br><span class="line">        [<span class="keyword">self</span> animatedImageFromRightToLeft];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)animatedImageFromRightToLeft</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    [<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.3</span> delay:<span class="number">0.5</span> usingSpringWithDamping:<span class="number">0.7</span> initialSpringVelocity:<span class="number">0</span> options:<span class="built_in">UIViewAnimationOptionCurveEaseInOut</span> animations:^&#123;</span><br><span class="line">        _firstView.centerX  -= kCenterViewSize;</span><br><span class="line">        _secondView.centerX -= kCenterViewSize;</span><br><span class="line">    &#125; completion:^(<span class="type">BOOL</span> finished) &#123;</span><br><span class="line">        _secondView.centerX += kCenterViewSize;</span><br><span class="line">        _secondView.centerY -= kCenterViewSize;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.alpha &amp;&amp; <span class="keyword">self</span>) &#123;</span><br><span class="line">            [<span class="keyword">self</span> changeSecondImage];</span><br><span class="line">            [<span class="keyword">self</span> animatedImageFromTopToBottom];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要非常注意的是，一定要写上终止动画的条件，不然会无限循环，影响性能</p>
</blockquote>
<h3 id="show和hide"><a href="#show和hide" class="headerlink" title="show和hide"></a>show和hide</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (void)showAnimated:(BOOL)animated</span><br><span class="line">&#123;</span><br><span class="line">    RFMainThreadAssert();</span><br><span class="line">    </span><br><span class="line">    self.alpha = 1;</span><br><span class="line">    </span><br><span class="line">    [UIView animateWithDuration:animated ? 0.3 : 0 animations:^&#123;</span><br><span class="line">        _centralView.alpha = 1;</span><br><span class="line">    &#125; completion:^(BOOL finished) &#123;</span><br><span class="line">        [self animatedImageFromTopToBottom];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)hideAnimated:(BOOL)animated</span><br><span class="line">&#123;</span><br><span class="line">    RFMainThreadAssert();</span><br><span class="line">    </span><br><span class="line">    [UIView animateWithDuration:animated ? 0.3 : 0 animations:^&#123;</span><br><span class="line">        self.alpha = 0;</span><br><span class="line">    &#125; completion:^(BOOL finished) &#123;</span><br><span class="line">        [self removeFromSuperview];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h3><img src="/images/loading_img/loading_img_03.jpg" width="375" height="667">

<ul>
<li>Github Demo地址:<br><a target="_blank" rel="noopener" href="https://github.com/wangruofeng/RFLoadingView">RFLoadingViewDemo</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



                        </div>
                        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

                    </div>
                        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">王若风</p>
  <div class="site-description" itemprop="description">王若风的技术博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">70</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/wangruofeng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wangruofeng" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wangruofeng007@gmail.com" title="E-Mail → mailto:wangruofeng007@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/oneruofeng" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;oneruofeng" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://instagram.com/ace_freeman007" title="Instagram → https:&#x2F;&#x2F;instagram.com&#x2F;ace_freeman007" rel="noopener" target="_blank"><i class="fab fa-instagram fa-fw"></i>Instagram</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


                </div>
            </main>

            <footer class="footer">
                <div class="footer-inner">
                    

                    

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">王若风</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">99k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">6:01</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

                    








                </div>
            </footer>
        </div>

        
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




        




  
<script src="/js/local-search.js"></script>














        
            <script
                type="text/javascript"
                src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
        
            

            

    </body>
</html>