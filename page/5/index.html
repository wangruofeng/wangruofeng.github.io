<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.wangruofeng007.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":"default","style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

        <meta name="description" content="王若风的技术博客">
<meta property="og:type" content="website">
<meta property="og:title" content="王若风的技术博客">
<meta property="og:url" content="https://blog.wangruofeng007.com/page/5/index.html">
<meta property="og:site_name" content="王若风的技术博客">
<meta property="og:description" content="王若风的技术博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="王若风">
<meta property="article:tag" content="技术博客, Flutter, iOS">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.wangruofeng007.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

        <title>
            王若风的技术博客
        </title>
        






        <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

    <link rel="alternate" href="/atom.xml" title="王若风的技术博客" type="application/atom+xml">
</head>

    <body itemscope="itemscope" itemtype="http://schema.org/WebPage">
        <div class="container use-motion">
            <div class="headband"></div>

            <header
                class="header"
                itemscope="itemscope"
                itemtype="http://schema.org/WPHeader">
                <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">王若风的技术博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">世界尽头の冷酷仙境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
            </header>

            
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


            <main class="main">
                <div class="main-inner">
                    <div class="content-wrap">
                        

                        <div class="content index posts-expand">
                            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/03/03/2016-03-03-shi-yong-mantlegao-xiao-gou-jian-model/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/03/03/2016-03-03-shi-yong-mantlegao-xiao-gou-jian-model/" class="post-title-link" itemprop="url">使用 Mantle 高效构建 Model</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-03-03 01:05:21" itemprop="dateCreated datePublished" datetime="2016-03-03T01:05:21+08:00">2016-03-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 16:29:50" itemprop="dateModified" datetime="2024-11-02T16:29:50+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>在iOS开发中，从服务器获取数据，然后解析成本地的模型是经常的要做事，而且重复次数特别多，每次增加一个网络请求或者增加一个模型都需要完成<code>JSON</code>到<code>Model</code>层的转换，手写通过字典<code>valueForKey:</code>直接解析已经更不上时代的步伐，学会利用工具提高自己的工作效率，今天就分享一下<code>Mantle</code>这个框架解析的心得。</p>
<p><code>Mantle</code>解决的痛点：</p>
<ul>
<li>服务器经常更新（添加或者删除）字段，客服端需要在<code>Model</code>层初始化的时候修改取值字段，易出错，而且繁琐。</li>
<li>实现自定义的<code>Model</code>的序列化，以便将数据保存到本地，也就是说实现<code>NSCoding</code>协议，在模型复制的情况下添加或者修改字段非常麻烦。</li>
<li>自定义的<code>Model</code>的<code>Copy</code>,你必须手动实现<code>NSCopying</code>协议,而且没有办法反序列化成<code>JSON</code>。</li>
</ul>
<p><code>Mantle</code>很好的解决的以上痛点：</p>
<ul>
<li>实现了<code>NSCopying</code>协议。</li>
<li>实现了<code>NSCoding</code>协议，可以通过<code>NSKeyedArchiver</code>将数据归档到本地。</li>
<li>提供了<code>isEqual:</code>和<code>hash</code>的默认实现。</li>
<li>可以在<code>Model</code>和<code>JSON</code>之间互相转换。</li>
</ul>
<p>以一个<code>CATProfile</code>模型类为例，演示这个框架怎样以一种非常简单的方式将一个<code>NSDictionary</code>对象映射成一个<code>Objective-C</code>,反之亦然。</p>
<p>下面的<code>CATProfile</code>模型</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Objective Cat&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;birthday&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2013-09-12 13:29:36 +0100&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;website&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://objc.at&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;lat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;48.2083&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;lon&quot;</span><span class="punctuation">:</span> <span class="string">&quot;16.3731&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;relationship_status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;single&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;awesome&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>下面我们创建一个<code>MTLModel</code>子类代表以上的<code>Json</code>对象。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// CATProfile.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, <span class="built_in">CATRelationshipStatus</span>) &#123;</span><br><span class="line">    <span class="built_in">CATRelationshipStatusSingle</span> = <span class="number">0</span>,</span><br><span class="line">    <span class="built_in">CATRelationshipStatusInRelationship</span>,</span><br><span class="line">    <span class="built_in">CATRelationshipStatusComplicated</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">CATProfile</span> : <span class="title">MTLModel</span>&lt;<span class="title">MTLJSONSerializing</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSNumber</span> *profileId;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSDate</span> *birthday;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSURL</span> *website;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">CLLocationCoordinate2D</span> locationCoordinate;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>) <span class="built_in">CATRelationshipStatus</span> relationshipStatus;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">getter</span>=isAwesome) <span class="type">BOOL</span> awesome;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>CATProfile</code>类继承自<code>MTLModel</code>并且实现了<code>MTLJSONSerializing</code>，协议要求实现<code>+JSONKeyPathsByPropertyKey</code>方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// CATProfile.m</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSDictionary</span> *)JSONKeyPathsByPropertyKey &#123;</span><br><span class="line">    <span class="comment">// properties defined in header &lt; : &gt; key in JSON Dictionary</span></span><br><span class="line">    <span class="keyword">return</span> @&#123;</span><br><span class="line">             <span class="string">@&quot;profileId&quot;</span>:          <span class="string">@&quot;id&quot;</span>,</span><br><span class="line">             <span class="string">@&quot;websiteURL&quot;</span>:         <span class="string">@&quot;website&quot;</span>,</span><br><span class="line">             <span class="string">@&quot;locationCoordinate&quot;</span>: <span class="string">@&quot;location&quot;</span>,</span><br><span class="line">             <span class="string">@&quot;relationshipStatus&quot;</span>: <span class="string">@&quot;relationship_status&quot;</span>,</span><br><span class="line">            &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>+JSONKeyPathsByPropertyKey</code>方法返回一个在JSON数据中需要模型的属性匹配的值的字典，这能确保<code>Mantle</code>知道那个JSON键键使用来构成一个指定的模型接口。</p>
<p>很明显除了这个列表中的<code>name</code>,<code>birthday</code>和<code>awesome</code>属性。假如一个属性在字典中被忽略，<code>Mantle</code>将自动在JSON中查找带有相同名称的接口。</p>
<p><strong>NSValueTransformer</strong></p>
<p><code>Mantle</code>还能够处理任意类型的转换，例如<code>NSString</code>he<code>NSNumber</code>默认支持。然而，它也需要一些帮助对于处理非任意的类型例如<code>NSURL</code>和<code>枚举</code>还有自定义的结构体像<code>CLLocationCoordinate2D</code>。</p>
<p><code>Mantle</code>依赖<strong>Foundation</strong>框架下<code>NSValueTransformer</code>对象来实现在模型代表的JSON层和OC对象的实际接口之间的值的映射。</p>
<p>创建一个自定义<strong>transformer</strong>给某个属性，我们需要实现一个叫做<code>+&lt;propertyName&gt;JSONTransformer</code>的类方法并且返回一个想要的<code>NSValueTransformer</code>对象。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mapping birthday to NSDate and vice-versa</span></span><br><span class="line">+ (<span class="built_in">NSValueTransformer</span> *)birthdayJSONTransformer &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">MTLValueTransformer</span> reversibleTransformerWithForwardBlock:^(<span class="built_in">NSString</span> *dateString) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span>.dateFormatter dateFromString:dateString];</span><br><span class="line">    &#125; reverseBlock:^(<span class="built_in">NSDate</span> *date) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">self</span>.dateFormatter stringFromDate:date];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSDateFormatter</span> *)dateFormatter &#123;</span><br><span class="line">    <span class="built_in">NSDateFormatter</span> *dateFormatter = [[<span class="built_in">NSDateFormatter</span> alloc] init];</span><br><span class="line">    dateFormatter.locale = [[<span class="built_in">NSLocale</span> alloc] initWithLocaleIdentifier:<span class="string">@&quot;en_US_POSIX&quot;</span>];</span><br><span class="line">    dateFormatter.dateFormat = <span class="string">@&quot;yyyy-MM-dd&#x27;T&#x27;HH:mm:ss.SSS&#x27;Z&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dateFormatter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Mantle</code>在<code>runtime</code>调用这个方法来决定怎样变换**birthday **属性，正向转换block从一个字符串对象到一个<code>NSDate</code>对象，反向转换block将<code>NSDate</code>对象转换回一个字符串对象，非常棒！</p>
<p>下面列举了一些变换方法，对于所有的我们需要注意的非任意属性以供参考。</p>
<h3 id="NSURL-↔︎-JSON-string"><a href="#NSURL-↔︎-JSON-string" class="headerlink" title="NSURL ↔︎ JSON string"></a>NSURL ↔︎ JSON string</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSValueTransformer</span> *)websiteURLJSONTransformer &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSValueTransformer</span> valueTransformerForName:<span class="built_in">MTLURLValueTransformerName</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="CLLocationCoordinate2D-↔︎-JSON-object"><a href="#CLLocationCoordinate2D-↔︎-JSON-object" class="headerlink" title="CLLocationCoordinate2D ↔︎ JSON object"></a>CLLocationCoordinate2D ↔︎ JSON object</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSValueTransformer</span> *)locationCoordinateJSONTransformer &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">MTLValueTransformer</span> reversibleTransformerWithForwardBlock:^(<span class="built_in">NSDictionary</span> *coordinateDict) &#123;</span><br><span class="line">        <span class="built_in">CLLocationDegrees</span> latitude = [coordinateDict[<span class="string">@&quot;lat&quot;</span>] doubleValue];</span><br><span class="line">        <span class="built_in">CLLocationDegrees</span> longitude = [coordinateDict[<span class="string">@&quot;lon&quot;</span>] doubleValue];</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">NSValue</span> valueWithMKCoordinate:<span class="built_in">CLLocationCoordinate2DMake</span>(latitude, longitude)];</span><br><span class="line">    &#125; reverseBlock:^(<span class="built_in">NSValue</span> *coordinateValue) &#123;</span><br><span class="line">        <span class="built_in">CLLocationCoordinate2D</span> coordinate = [coordinateValue <span class="built_in">MKCoordinateValue</span>];</span><br><span class="line">        <span class="keyword">return</span> @&#123;<span class="string">@&quot;lat&quot;</span>: @(coordinate.latitude), <span class="string">@&quot;lon&quot;</span>: @(coordinate.longitude)&#125;;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="enum-↔︎-JSON-string"><a href="#enum-↔︎-JSON-string" class="headerlink" title="enum ↔︎ JSON string"></a>enum ↔︎ JSON string</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSValueTransformer</span> *)relationshipStatusJSONTransformer &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSValueTransformer</span> mtl_valueMappingTransformerWithDictionary:@&#123;</span><br><span class="line">        <span class="string">@&quot;single&quot;</span>: @(<span class="built_in">CATRelationshipStatusSingle</span>),</span><br><span class="line">        <span class="string">@&quot;relationship&quot;</span>: @(<span class="built_in">CATRelationshipStatusInRelationship</span>),</span><br><span class="line">        <span class="string">@&quot;complicated&quot;</span>: @(<span class="built_in">CATRelationshipStatusComplicated</span>)</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="BOOL-↔︎-JSON-boolean"><a href="#BOOL-↔︎-JSON-boolean" class="headerlink" title="BOOL ↔︎ JSON boolean"></a>BOOL ↔︎ JSON boolean</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSValueTransformer</span> *)awesomeJSONTransformer &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSValueTransformer</span> valueTransformerForName:<span class="built_in">MTLBooleanValueTransformerName</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="从JSON创建模型对象"><a href="#从JSON创建模型对象" class="headerlink" title="从JSON创建模型对象"></a>从JSON创建模型对象</h3><p>一旦模型配置完成，就该获得JSON对象从API中，并且把它转换成我们模型的一个实例。首先，我们需要把JSON呈现转换成一个<code>NSDictionary</code>,它能够用来通过<code>Mantle</code>来创建我们的模型，很幸运的是iOS提供了一个非常棒的方法来处理它，就是通过<code>NSJSONSerialization</code>。</p>
<p>那样以后，<code>MTLJSONAdapter</code>类就能利用<code>Mantle</code>做繁重的工作来创建我们的模型。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create NSDictionary from JSON data</span></span><br><span class="line"><span class="built_in">NSData</span> JSONData = ... <span class="comment">// the JSON response from the API</span></span><br><span class="line"><span class="built_in">NSDictionary</span> *JSONDict = [<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:JSONData options:<span class="number">0</span> error:<span class="literal">NULL</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// create model object from NSDictionary using MTLJSONSerialisation</span></span><br><span class="line"><span class="built_in">CATProfile</span> *profile = [<span class="built_in">MTLJSONAdapter</span> modelOfClass:<span class="built_in">CATProfile</span>.class fromJSONDictionary:JSONDict error:<span class="literal">NULL</span>];</span><br></pre></td></tr></table></figure>

<h3 id="从模型对象创建JSON"><a href="#从模型对象创建JSON" class="headerlink" title="从模型对象创建JSON"></a>从模型对象创建JSON</h3><p><code>MTLJSONAdapter</code>也有能力创建一个字典从我们的的模型类中，以便能直接编码回一个JSON字符串。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create NSDictionary from model class using MTLJSONSerialisation</span></span><br><span class="line"><span class="built_in">CATProfile</span> *profile = ...</span><br><span class="line"><span class="built_in">NSDictionary</span> *profileDict = [<span class="built_in">MTLJSONAdapter</span> JSONDictionaryFromModel:profile];</span><br><span class="line"></span><br><span class="line"><span class="comment">// convert NSDictionary to JSON data</span></span><br><span class="line"><span class="built_in">NSData</span> *JSONData = [<span class="built_in">NSJSONSerialization</span> dataWithJSONObject:profileDict options:<span class="number">0</span> error:<span class="literal">NULL</span>];</span><br></pre></td></tr></table></figure>

<blockquote>
<p>假如当创建一个JSON呈现你的模型是在你的模型中有一个属性不应该包括，你应该返回<code>NSNull.null</code>,例如。在<code>+JSONKeyPathsByPropertyKey</code>的@{“name” : “NSNull.null”}。<code>Mantle</code>将安全的忽略这个属性。</p>
</blockquote>
<h3 id="映射数组和字典"><a href="#映射数组和字典" class="headerlink" title="映射数组和字典"></a>映射数组和字典</h3><p>大多数情况，模型和其他模型有关系，这些关系普遍通过JSON数组或者对象来呈现。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Objective Cat&quot;</span><span class="punctuation">,</span></span><br><span class="line">  ...<span class="punctuation">,</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;owner&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">99</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Alexander Schuch&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;friends&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Owly&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bird&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Hedgy&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;mammal&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>Mantle</code>支持映射这些关系到新的模型，为了让<code>Mantle</code>知道怎样变换关系，我们可以使用下面提供的分类方法中的一个来返回<code>NSValueTransformer</code>。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSValueTransformer</span> *)mtl_JSONDictionaryTransformerWithModelClass:(Class)modelClass;</span><br><span class="line">+ (<span class="built_in">NSValueTransformer</span> *)mtl_JSONArrayTransformerWithModelClass:(Class)modelClass;</span><br></pre></td></tr></table></figure>

<p>当然<code>Mantle</code>需要知道这些官和他们的将要转换的<code>MTLModel</code>子类，就像和创建一个新的<code>MTLModel</code>子类并且实现将要映射到这些对象的<code>MTLJSONSerializing</code>协议一样简单。然后我们可以添加一些新的属性到我们<code>CATProfile</code>类中并且实现两个新的转换器。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CATProfile.h</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">CATOwner</span> *owner;   <span class="comment">// CATOwner is a MTLModel subclass</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSArray</span> *friends;  <span class="comment">// Array of CATFriend objects</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// CATProfile.m</span></span><br><span class="line">+ (<span class="built_in">NSValueTransformer</span> *)ownerJSONTransformer &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSValueTransformer</span> mtl_JSONDictionaryTransformerWithModelClass:<span class="built_in">CATOwner</span>.class];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSValueTransformer</span> *)friendsJSONTransformer &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSValueTransformer</span> mtl_JSONArrayTransformerWithModelClass:<span class="built_in">CATFriend</span>.class];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="一些有用的补充"><a href="#一些有用的补充" class="headerlink" title="一些有用的补充"></a>一些有用的补充</h3><p>我们简单的聊了一下<code>NSValueTransformer</code>在前面,<code>NSValueTransformer</code>有一个非常棒的特征让通过名字全局注册一个变换器成为可能。假如你正在使用相同的变换器在你整个app中，确保子类化<code>NSValueTransformer</code>，注册你的自定义变换器一次并且在你随后的<code>MTLModels</code>中使用它。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In CATProfile.m</span></span><br><span class="line"><span class="built_in">NSString</span> * <span class="keyword">const</span> kCATCustomValueTransformerName = <span class="string">@&quot;CATCustomValueTransformer&quot;</span>;</span><br><span class="line"></span><br><span class="line">+ (<span class="type">void</span>)initialize</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// Register NSValueTransformer</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">self</span> == <span class="built_in">CATProfile</span>.class) &#123;</span><br><span class="line">    <span class="built_in">CATCustomValueTransformer</span> *transformer = [<span class="built_in">CATCustomValueTransformer</span> new];</span><br><span class="line">    [<span class="built_in">NSValueTransformer</span> setValueTransformer:transformer forName:kCATCustomValueTransformerName];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Then use the custom transformer to translate properties using Mantle</span></span><br><span class="line">+ (<span class="built_in">NSValueTransformer</span> *)whateverPropertyJSONTransformer &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSValueTransformer</span> valueTransformerForName:kCATCustomValueTransformerName];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p><code>Mantle</code>是一个非常棒的补充处理<code>JSON</code>APIs，然而，你也必须意识到假如你不得不处理非常复杂的数据或者不稳定的APIs它也是不合适的。</p>
<p>参考资料</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://www.objc.at/mantle">Mantle-Cat</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/MantleFramework/Mantle">Mantle Framework on Github</a></li>
<li><a target="_blank" rel="noopener" href="http://nshipster.com/nsvaluetransformer/">NSValueTransformer at NSHipster</a></li>
<li><a target="_blank" rel="noopener" href="http://www.dominikgruber.com/articles/2013/08/mantle-as-a-model-layer-for-ios-and-os-x-apps">Mantle as a Model Layer for iOS and OS X Apps</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.ibireme.com/2015/10/23/ios_model_framework_benchmark/">iOS JSON 模型转换库评测</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/31/2016-01-31-3chong-fang-shi-shi-xian-iosmo-hu-xiao-guo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/31/2016-01-31-3chong-fang-shi-shi-xian-iosmo-hu-xiao-guo/" class="post-title-link" itemprop="url">4 种方式实现 iOS 模糊效果</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-31 23:12:52" itemprop="dateCreated datePublished" datetime="2016-01-31T23:12:52+08:00">2016-01-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 16:29:42" itemprop="dateModified" datetime="2024-11-02T16:29:42+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>704</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>介绍iOS中以下四种方式实现：</p>
<ul>
<li><code>CoreImage</code>中的模糊滤镜</li>
<li><code>UIImage + ImageEffects</code>的category模糊效果</li>
<li>iOS8中<code>UIVisualEffectView</code>模糊效果</li>
<li>iOS7以后通过<code>UIToolBar</code>实现模糊效果</li>
</ul>
<h3 id="CoreImage中的模糊滤镜实现"><a href="#CoreImage中的模糊滤镜实现" class="headerlink" title="CoreImage中的模糊滤镜实现"></a><code>CoreImage</code>中的模糊滤镜实现</h3><p><code>CoreImage</code>主要通过<code>CIFilter</code>这个类来实现。</p>
<p>这个类支持的滤镜多达14类，每个类又细分多款滤镜：</p>
<ol>
<li>CICategoryBlur<ul>
<li>CIBoxBlur</li>
<li>CIDiscBlur</li>
<li><strong>CIGaussianBlur</strong></li>
<li>CIMaskedVariableBlur</li>
<li>CIMedianFilter</li>
<li>CIMotionBlur</li>
<li>CINoiseReduction</li>
<li>CIZoomBlur</li>
</ul>
</li>
</ol>
<ul>
<li>CICategoryColorAdjustment<ul>
<li>CIColorClamp</li>
<li>CIColorControls</li>
<li>CIColorMatrix</li>
<li>CIColorPolynomial</li>
<li>CIExposureAdjust</li>
<li>CIGammaAdjust</li>
<li>CIHueAdjust</li>
<li>CILinearToSRGBToneCurve</li>
<li>CISRGBToneCurveToLinear</li>
<li>CITemperatureAndTint</li>
<li>CIToneCurve</li>
<li>CIVibrance</li>
<li>CIWhitePointAdjust</li>
</ul>
</li>
<li>CICategoryColorEffect</li>
<li>CICategoryCompositeOperation</li>
<li>CICategoryDistortionEffect</li>
<li>CICategoryGenerator</li>
<li>CICategoryGeometryAdjustment</li>
<li>CICategoryGradient</li>
<li>CICategoryHalftoneEffect</li>
<li>CICategoryReduction</li>
<li>CICategorySharpen</li>
<li>CICategoryStylize</li>
<li>CICategoryTileEffect</li>
<li>CICategoryTransition</li>
</ul>
<p>我们这里使用的是高斯模糊，也就是<code>CIGaussianBlur</code>。</p>
<p><strong>Sample Code：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">UIImage *avatar = [UIImage imageNamed:@&quot;avatar&quot;];</span><br><span class="line"></span><br><span class="line">/********** CoreImage ************/</span><br><span class="line"></span><br><span class="line">// CIImage</span><br><span class="line">CIImage *ciImage = [[CIImage alloc] initWithImage:avatar];</span><br><span class="line"></span><br><span class="line">// CIFilter</span><br><span class="line">CIFilter *blurFilter = [CIFilter filterWithName:@&quot;CIGaussianBlur&quot;];</span><br><span class="line"></span><br><span class="line">// 设置模糊滤镜半径</span><br><span class="line">[blurFilter setValue:@(20) forKey:@&quot;inputRadius&quot;];</span><br><span class="line"></span><br><span class="line">// 将图片输入到滤镜</span><br><span class="line">[blurFilter setValue:ciImage forKey:kCIInputImageKey];</span><br><span class="line"></span><br><span class="line">// 将处理好的图片输出</span><br><span class="line">CIImage *outCiImage = [blurFilter valueForKey:kCIOutputImageKey];</span><br><span class="line"></span><br><span class="line">// 查询可以设置的参数和一些信息</span><br><span class="line">NSLog(@&quot;%@&quot;,[blurFilter attributes]);</span><br><span class="line"></span><br><span class="line">// CIContext</span><br><span class="line">CIContext *contex = [CIContext contextWithOptions:nil];</span><br><span class="line"></span><br><span class="line">// 获取CGImage句柄</span><br><span class="line">CGImageRef outCGImage = [contex createCGImage:outCiImage fromRect:[outCiImage extent]];</span><br><span class="line"></span><br><span class="line">// 最终获取到图片</span><br><span class="line">UIImage *blurImage = [UIImage imageWithCGImage:outCGImage];</span><br><span class="line"></span><br><span class="line">// 释放CGImage句柄</span><br><span class="line">CGImageRelease(outCGImage);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时<code>blurImage</code>图片就是经过滤镜处理后的图片，在放在<code>ImageView</code>上加载即可看到效果。</p>
<p><img src="/images/img_blur.jpg" alt="avatar"></p>
<h3 id="UIImage-ImageEffects的category模糊效果"><a href="#UIImage-ImageEffects的category模糊效果" class="headerlink" title="UIImage + ImageEffects的category模糊效果"></a><code>UIImage + ImageEffects</code>的category模糊效果</h3><p>使用Apple开源的一个图片处理分类来实现，这个使用起来只需一行代码，简洁明了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">UIImage *blurImage = [sourceImage blurImage];</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里封装了一个区域模糊效果的方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (UIImage *)blurImageAtFrame:(CGRect)frame;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="iOS8中UIVisualEffectView模糊效果"><a href="#iOS8中UIVisualEffectView模糊效果" class="headerlink" title="iOS8中UIVisualEffectView模糊效果"></a>iOS8中<code>UIVisualEffectView</code>模糊效果</h3><p>这个效果只支持iOS8.0以上的版本，通过<code>UIVisualEffectView</code>来实现。</p>
<p><strong>Sample Code：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// 1.创建模糊view</span><br><span class="line">   UIVisualEffectView *effectView = [[UIVisualEffectView alloc] initWithEffect:[UIBlurEffect effectWithStyle:UIBlurEffectStyleLight]];</span><br><span class="line">   </span><br><span class="line">   // 2.设置尺寸</span><br><span class="line">   effectView.frame = CGRectMake(0, 100, [UIScreen mainScreen].bounds.size.width, 200);</span><br><span class="line">   </span><br><span class="line">   // 3.添加到view当中</span><br><span class="line">   [self.view addSubview:effectView];</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<p><strong>😊Bonus:</strong><br>实现iOS高版本通知中心炫酷的Label模糊效果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// 添加一个文本标签</span><br><span class="line">   UILabel *label = [[UILabel alloc] initWithFrame:effectView.bounds];</span><br><span class="line">   label.text = @&quot;www.blog.wangruofeng007&quot;;</span><br><span class="line">   label.textAlignment = NSTextAlignmentCenter;</span><br><span class="line">   label.font = [UIFont systemFontOfSize:30];</span><br><span class="line">   [effectView.contentView addSubview:label];</span><br><span class="line">   </span><br><span class="line">   /***************** 添加模糊效果 *****************/</span><br><span class="line">   </span><br><span class="line">   // 1.创建子模糊view</span><br><span class="line">   UIVisualEffectView *subEffectView = [[UIVisualEffectView alloc] initWithEffect:[UIVibrancyEffect effectForBlurEffect:(UIBlurEffect *)effectView.effect]];</span><br><span class="line">   </span><br><span class="line">   // 2.设定尺寸</span><br><span class="line">   subEffectView.frame = effectView.bounds;</span><br><span class="line">   </span><br><span class="line">   // 3.将子模糊view添加到effectView的contenView才能生效</span><br><span class="line">   [effectView.contentView addSubview:subEffectView];</span><br><span class="line">   </span><br><span class="line">   // 4.添加要显示的view来达到特殊的效果</span><br><span class="line">   [subEffectView.contentView addSubview:label];</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<p>效果图：</p>
<img src="https://github.com/wangruofeng/BlurEffectDemo/raw/master/sample.png" style="witdh:50%; height:50%">
</img>

<p>Demo地址：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/wangruofeng/BlurEffectDemo">BlurEffectDemo 
</a> – 本文效果Demo</li>
<li><a target="_blank" rel="noopener" href="https://github.com/wangruofeng/UIVisualEffects_Objective-c">UIVisualEffects_Objective-c</a> – 详细介绍<code>UIVisualEffects</code>的使用</li>
</ul>
<h3 id="iOS7以后通过UIToolBar实现模糊效果"><a href="#iOS7以后通过UIToolBar实现模糊效果" class="headerlink" title="iOS7以后通过UIToolBar实现模糊效果"></a>iOS7以后通过<code>UIToolBar</code>实现模糊效果</h3><p>在iOS7以后，<code>UINavigationBar</code>和<code>UIToolBar</code>自带毛玻璃模糊效果，可以通过手动创建<code>UIToolBar</code>对象，然后添加到view中实现，UIToolBar区域就可以实现动态毛玻璃模糊效果。</p>
<p>例如在一个状态栏后方添加一个模糊view,可以在控制器中这样实现，假设没有导航栏</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UIToolbar *statusBar = [[UIToolbar alloc] initWithFrame:CGRectMake(0, 0, self.view.frame.size.width, 20)];</span><br><span class="line">[self.view addSubview:statusBar];</span><br></pre></td></tr></table></figure>

<p>这个方法非常简单实用😊，快去试试吧。</p>
<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/ios/documentation/GraphicsImaging/Conceptual/CoreImaging/ci_tasks/ci_tasks.html">Core Image Programming Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/prerelease/ios/documentation/GraphicsImaging/Reference/CoreImageFilterReference/index.html">Core Image Filter Reference</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/wangruofeng/UIImageBlur">UIImageBlur</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/29/2016-01-29-watch-app-kai-fa-zhi-interface-elements-xiang-jie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/29/2016-01-29-watch-app-kai-fa-zhi-interface-elements-xiang-jie/" class="post-title-link" itemprop="url">Watch App 开发之 Interface Elements 详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-29 17:36:26" itemprop="dateCreated datePublished" datetime="2016-01-29T17:36:26+08:00">2016-01-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 16:29:36" itemprop="dateModified" datetime="2024-11-02T16:29:36+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Watch-OS2/" itemprop="url" rel="index"><span itemprop="name">Watch OS2</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><code>iWatch</code>原生态支持的控件主要有以下类型,下面对每个类型一一解刨。</p>
<ul>
<li>Labels</li>
<li>Images</li>
<li>Groups</li>
<li>Pickers</li>
<li>Tables</li>
<li>Buttons</li>
<li>Switches</li>
<li>Sliders</li>
<li>Maps</li>
<li>Movies</li>
<li>Date and Timer Labels</li>
<li>Menus</li>
</ul>
<h3 id="Labels-–-WKInterfaceLabel"><a href="#Labels-–-WKInterfaceLabel" class="headerlink" title="Labels – WKInterfaceLabel"></a>Labels – WKInterfaceLabel</h3><p><code>Labels</code>使用静态的文本来传达简短的消息，是你App中最常见的一个元素之一。它能支持多行显示也可通过代码动态更新内容。</p>
<p><code>iWatch</code>,设计一个标签事，首先应该把精力集中在<code>易读性</code>,使用更亮的颜色和使用动态类型（<code> Dynamic Type</code>）来保证文本尺寸的正确，内置已经提供了最佳的易读性和自动的动态的类型支持。假如需要使用自定义的字体，应该避免使用过度格式化的。</p>
<p>更多信息查看：<a target="_blank" rel="noopener" href="https://developer.apple.com/watch/human-interface-guidelines/typography/">Typography</a><br><img src="/images/iwatch/img_iwatch_00.jpg" style='width:50%;height:50%'></img></p>
<h3 id="Images-–-WKInterfaceImage"><a href="#Images-–-WKInterfaceImage" class="headerlink" title="Images – WKInterfaceImage"></a>Images – WKInterfaceImage</h3><h3 id=""><a href="#" class="headerlink" title=""></a><img src="/images/iwatch/img_iwatch_01.jpg" style='width:50%;height:50%'></img></h3><p>一个<code>Image</code>元素用来显示单张图片或者一系列动画图片。Images支持在<code>iOS</code>上的的任何格式，但是跟偏向于PNG格式。动画系列图片可以通过代码控制启停。</p>
<p><code>38mm</code>和<code>42mm</code>共用一套图片资源，只要内容能够表达清晰。</p>
<p>Apple Watch支持高清屏显示，所有没有必要创建一个标准的分辨率图片，在图片名应该包括<code>@2x</code>。</p>
<p><strong>当图片正在加载时，应该使用占位图片来占据它的空间</strong>。</p>
<p>优化图片查看：<a href="/images/iwatch/img_iwatch_02.jpg">Image Optimizations</a></p>
<h3 id="Groups-–-WKInterfaceGroup"><a href="#Groups-–-WKInterfaceGroup" class="headerlink" title="Groups – WKInterfaceGroup"></a>Groups – WKInterfaceGroup</h3><p><code>Group</code>这个概念是专为有限空间的<code>iWatch</code>打造的，可以帮你对其他元素进行布局。它有<code>postion</code>,<code>size</code>,<code>marigns</code>以及其他布局相关的接口，一个<code>Group</code>对象本身也是一个可见的元素，它也有背景图片，颜色，圆角半径等属性。</p>
<p><strong>支持水平<code>horizontally</code>和垂直<code>vertically</code>布局</strong>，可以让放在里面的项目实现相应的布局，可以使用<code>spacing</code>属性来设置内部项目之间的间距，使用<code>margins</code>来控制<code>Group</code>和它周边的元素的距离。</p>
<p><code>Group</code>支持镶嵌操作，你可以通过镶嵌来指定你想要的布局样式。</p>
<p>你应该优化你的<code>Group</code>的背景图片来获得更好的体验，因为太大可能使你的App变得卡顿。优化请参考：<a target="_blank" rel="noopener" href="https://developer.apple.com/watch/human-interface-guidelines/icons-and-images/#image-optimizations">Image Optimizations</a></p>
<p>外观大概这样:<br><img src="/images/iwatch/img_iwatch_02.jpg" style='width:50%;height:50%'></img></p>
<h3 id="Pickers-–-WKInterfacePicker"><a href="#Pickers-–-WKInterfacePicker" class="headerlink" title="Pickers – WKInterfacePicker"></a>Pickers – WKInterfacePicker</h3><p><code>Pickers</code>能够显示一个可以使用数字表冠导航的列表。这意味着你可以使用一种更精确和迷人的方式选择。<code>Pickers</code>可以通过下面三种方式的一种来展示它们的项目：<br><img src="/images/iwatch/img_iwatch_03.jpg" style='width:50%;height:50%'></img></p>
<ul>
<li><code>List style</code>,可以显示文本或者图片在一个滚动列表里面</li>
<li><code>Stack style</code>,栈风格以一个卡片风格的界面显示图片，当用户滚动，被选择的图片动画进入最上方，这种风格适合浏览照片。</li>
<li><code>Sequence style</code>,序列显示，可以显示一系列的图片。当用户转动表冠时，<code>Picker</code>显示先前或下一张图片在这个序列中没有动画，这种风格适合于构建自定义的界面使用你自己的图片。</li>
</ul>
<p><code>Pickers</code>还能被配置成显示一个<code>轮廓</code>，<code>标题</code>，<code>滚动指示器</code>。这些元素可以让你分辨出屏幕上的<code>Pickers</code>并且可以帮助用户导航它的内容。</p>
<p><strong>使用标题来指明你选择项目的意义或者picker本身的作用</strong></p>
<p>你可以给项目指定一个独特的标题当那些项目的意思表达不清晰的时候，可选，你也可以设置所有的项目相同的标题来标明<code>Picker</code>它本身的作用。<br><img src="/images/iwatch/img_iwatch_04.jpg" style='width:50%;height:50%'></img></p>
<p><strong>显示一个滚动指示器当所有的内容不是全部可见时</strong><br><img src="/images/iwatch/img_iwatch_05.jpg" style='width:50%;height:50%'></img></p>
<h3 id="Tabels-–-WKInterfaceTable"><a href="#Tabels-–-WKInterfaceTable" class="headerlink" title="Tabels – WKInterfaceTable"></a>Tabels – WKInterfaceTable</h3><p><code>Tabels</code>在一列中展示多行的内容。一个表的一行是动态配置的，它的内容可以在随时改变。<code>Tabels</code>天生可滚动，支持各种交互，能够设置背景颜色或者图片。<br><img src="/images/iwatch/img_iwatch_06.jpg" style='width:50%;height:50%'></img></p>
<p>使用注意事项：</p>
<ul>
<li><p><strong>统一使用行的风格类型</strong>，即使一个表可以包含多行，它应该呈现一个全局统一的外观，每一行使用你的主要内容开始，然后随你的需要添加更多支持的其他类型的内容，例如<code>headers</code>或者<code>footers</code>,总是用原来设计的目的来使用行类型。例如，你不应该用一行来显示<code>headers</code>或<code>footers</code>的内容。</p>
</li>
<li><p><strong>限制行数最大20</strong>，显示最重要的行在顶部，让用户能够浏览尽可能的多。行数越少越容易快速浏览。</p>
</li>
<li><p><strong>不要在<code>groups</code>里面镶嵌<code>tables</code></strong>,<code>Tabels</code>会动态改变它的尺寸基于它所包含的行的数目。它会忽略<code>groups</code>对高度的限制。</p>
</li>
<li><p><strong>不要在table行内包含<code>∧</code>或者<code>∨</code>符号</strong>，行后台实现可以自然点击，你不需要包含一个<code>∧</code>或者<code>∨</code>符号或者文字来表明行是可点击的。</p>
</li>
</ul>
<h3 id="Buttons-–-WKInterfaceButton"><a href="#Buttons-–-WKInterfaceButton" class="headerlink" title="Buttons – WKInterfaceButton"></a>Buttons – WKInterfaceButton</h3><p>一个<code>button</code>可以执行一个app指定的动作，<code>button</code>可以自定背景和圆角半径。它还可以充当容器使用，包含一个标签<code>labe;</code>，图片<code>image</code>，或者一个组<code>group</code>对象。<br><img src="/images/iwatch/img_iwatch_07.jpg" style='width:50%;height:50%'></img></p>
<p>使用事项：</p>
<ul>
<li><p><strong>创建横跨屏幕的Buttons</strong> ，全宽的buttons看起来更容易点击，假如有两个buttons，必须有相同的水平间距，两者使用相同的高度使用相同的图或者简短的文本标签。</p>
</li>
<li><p><strong>使用相同的高度对于<code>vertical stacks</code>风格布局一行和两行文本按钮</strong>，原则是，尽可能的，使用一致到高度让他们在视觉上统一。</p>
</li>
<li><p><strong>使用标准的圆角半径</strong>，标准的圆角半径的是<code>6点</code>，使用标准的圆角半径可以提升整个app的视觉的一致性并且可以增强button的内容。</p>
</li>
<li><p><strong>让butotns足够大以便容易点击</strong>，创建让用户很容易点击的button，buttons应该遵循下面最小的值。</p>
</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>38mm (minimum)</th>
<th>42mm (minimum)</th>
</tr>
</thead>
<tbody><tr>
<td>Circular buttons</td>
<td>75 pixels</td>
<td>80 pixels</td>
</tr>
<tr>
<td>Round rectangular buttons</td>
<td>50 pixels high</td>
<td>52 pixels high</td>
</tr>
</tbody></table>
<h3 id="Switches-–-WKInterfaceSwitch"><a href="#Switches-–-WKInterfaceSwitch" class="headerlink" title="Switches – WKInterfaceSwitch"></a>Switches – WKInterfaceSwitch</h3><p>开关控件更<code>iOS</code>类似，让用户在量个互斥的选择或者状态中选择，例如开或者关，一个靠近<code>switch</code>的标签应该指定响应的效果当，开关切换时。</p>
<p>效果像这样：<br><img src="/images/iwatch/img_iwatch_08.jpg" style='width:50%;height:50%'></img></p>
<h3 id="Sliders-–-WKInterfaceSlider"><a href="#Sliders-–-WKInterfaceSlider" class="headerlink" title="Sliders – WKInterfaceSlider"></a>Sliders – WKInterfaceSlider</h3><p>一个滑动条让用户来调整到某一个值。一个<code>slider</code>用来显示它设置的一系列的值或者是一个持续的<code>bar</code>, 它可以在一个有限的范围内根据预定的数量自增或者自减。</p>
<p><img src="/images/iwatch/img_iwatch_09.jpg" style='width:50%;height:50%'> </img></p>
<p>Note：你可以像使用<code>slider</code>那样使用自定图片,系统默认显示<code>+</code>和<code>-</code>符号。</p>
<h3 id="Maps-–-WKInterfaceMap"><a href="#Maps-–-WKInterfaceMap" class="headerlink" title="Maps – WKInterfaceMap"></a>Maps – WKInterfaceMap</h3><p><code>Maps</code>是地理位置的静态快照。你可以放一张地图在你的界面里面在预计的时间，但是你<code>WatchKit extension</code>必须配置显示的区域在运行时。显示区域是不可交互的，但是点击一个地图将会打开你<code>Apple Watch</code>上的<code>Maps</code>app。</p>
<p>你可以在地图上用一个高亮的点对你感兴趣或者其他相关信息进行标注。地图能显示标准的<code>红</code>，<code>黄</code>，<code>绿</code>大头针，它也可以显示自定义的图片，系统允许你最多添加<code>5个</code>在一张地图上。</p>
<p>使用注意实现：</p>
<ul>
<li><strong>让你地图的元素根据屏幕自动适应</strong>。用户应该能够看到整个地图元素在Apple Watch上而不用滚动屏幕。</li>
<li><strong>配置显示的地图区域到包含兴趣点的最小范围</strong>，地图元素内容本身不能滚动，所有所有内容必须附着在一个指定的地图区域</li>
</ul>
<h3 id="Movies-–-WKInterfaceMovie"><a href="#Movies-–-WKInterfaceMovie" class="headerlink" title="Movies – WKInterfaceMovie"></a>Movies – WKInterfaceMovie</h3><p>一个<code>movie</code>对象会显示一张海报图片，当点击时，模态呈现一份视频或者音频对象，使用这个元素来放置简短的媒体剪切和你内容内联。媒文件的重放由系统来管理。</p>
<p>使用注意事项：</p>
<ul>
<li><strong>使用一种海报图片来呈现剪切的内容</strong>，海报图片能让用户提前做决定是否观看与这个剪切关联的媒体，不要使用没有意义的剪切图片。</li>
<li><strong>不要创建海报图片像系统控件</strong>，<code>Movies</code>会让视频和音频内容看起来像你节目的一部分，所以不要通过让他们看起来像其他东西的方式把他们隐藏起来。你应该使用一个<code>Button</code>（而不是一个<code>movie</code>）来呈现媒体回放界面假如你喜欢的话。</li>
<li><strong>保证视频或者音频剪辑得足够短</strong>，剪辑不应该超过30秒，首选更短的。长的剪辑会占用更多的磁盘空间并且要求用户保持他们的手腕抬起更长时间，这样可能导致疲劳。</li>
<li><strong>适当的设置剪辑视频的尺寸</strong>，无论时候都应该使用推荐的尺寸来剪切，缩放视频剪辑将影响性能导致不理想的外观。更多信息关于推荐的尺寸和编码的值，参考<a target="_blank" rel="noopener" href="https://developer.apple.com/watch/human-interface-guidelines/watch-technologies/#audio-and-video">Audio &amp; Video</a></li>
</ul>
<div style="text-align:center">
<video src='https://developer.apple.com/watch/human-interface-guidelines/ui-elements/images/iwatch/ui-elements-movies.mp4' style='width:50%;height:50%;'>
</video>
</div>

<h3 id="Date-Timer-Labels-–-WKInterfaceDate-WKInterfaceTimer"><a href="#Date-Timer-Labels-–-WKInterfaceDate-WKInterfaceTimer" class="headerlink" title="Date &amp; Timer Labels – WKInterfaceDate,WKInterfaceTimer"></a>Date &amp; Timer Labels – WKInterfaceDate,WKInterfaceTimer</h3><p>Date 和 Timer 标签用来显示真实的时间在<code>Apple Watch</code>上。</p>
<p><img src="/images/iwatch/img_iwatch_10.jpg" style='width:50%;height:50%'></img></p>
<p>一个<code>date label</code>显示了现在的日期，现在的时间或者两者的组合。它可以使用各种样式，日历和时区来配置，在你配置好后，日期标签直接跟新它的值而不需要通过你app的进一步输入。</p>
<p><img src="/images/iwatch/img_iwatch_11.jpg" style='width:50%;height:50%'></img></p>
<p>一个<code>timer label</code>用来显示一个精准的倒计时和和计数定时器。它能够配置它显示的计数的值以各种形式，在你配置完成后，一个<code>timer label</code>能够计数或者倒计时不用从你的app的进一步输入。</p>
<h3 id="Menus-–-WKMenuItemIcon"><a href="#Menus-–-WKMenuItemIcon" class="headerlink" title="Menus – WKMenuItemIcon"></a>Menus – WKMenuItemIcon</h3><p>强力触摸<code>Apple Watch</code>将调出当前屏幕的<code>menu</code>（假如有点话）。一个菜单能够显示多达4个有关的动作对于当前屏幕，而不用从你的界面离开。</p>
<p><img src="/images/iwatch/img_iwatch_12.jpg" style='width:50%;height:50%'></img></p>
<p>使用注意事项：</p>
<ul>
<li><strong>包含一个Menu当现在屏幕有相关的操作的时候</strong>，菜单是可选的。假如没有菜单呈现，系统将播放一段动画来响应用户的强力触摸操作。</li>
<li><strong>使用一个label和一个icon来传达每个菜单动作的意图</strong>，label和icon都需要，label限制2行，所以文本应该尽量的短。</li>
<li><strong>使用菜单来响应它们预期的目的</strong>，<code>Menus</code>是一种能够修改当前界面控制器内容的方式，不要使用它们来作为主要的导航形式在你的app中。</li>
<li><strong>避免复制你的其他app中菜单的视觉风格</strong>，假如你必须使用一个相似的布局，加上颜色给你的界面或者排列的项目，用一种不同于其他菜单的方式。</li>
</ul>
<p><img src="/images/iwatch/img_iwatch_13.jpg" style='width:50%;height:50%'></img></p>
<p><img src="/images/iwatch/img_iwatch_14.jpg" style='width:50%;height:50%'></img></p>
<p><img src="/images/iwatch/img_iwatch_15.jpg" style='width:50%;height:50%'></img></p>
<p>更多menu icons 设计的信息，参考<a target="_blank" rel="noopener" href="https://developer.apple.com/watch/human-interface-guidelines/icons-and-images/#menu-icons"> Menu Icons</a>。</p>
<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/watch/human-interface-guidelines/">human-interface-guidelines</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/watch/human-interface-guidelines/visual-design/">human-interface-guidelines Visual Design</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ipader/SwiftGuide/tree/master/Apple%20Watch">Apple Watch指南</a></li>
<li><a target="_blank" rel="noopener" href="http://www.wareable.com/apple-watch/best-apple-watch-apps-832">Best-apple-watch-apps</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/20/2016-01-20-mvvmzi-liao-zheng-li/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/20/2016-01-20-mvvmzi-liao-zheng-li/" class="post-title-link" itemprop="url">MVVM 资料整理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-20 22:59:16" itemprop="dateCreated datePublished" datetime="2016-01-20T22:59:16+08:00">2016-01-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 16:29:30" itemprop="dateModified" datetime="2024-11-02T16:29:30+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%B5%84%E6%96%99%E6%94%B6%E9%9B%86/" itemprop="url" rel="index"><span itemprop="name">资料收集</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>273</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>MVVM，作为一种新的架构设计，有别于MVC，MVP，它有很多自己的特性和优势，例如易于调试，业务逻辑集中方便管理，统一各种通信机制，将业务和控制器解耦。这框架现在很多公司都在尝试使用，像美团等，以后可能是一种趋势，鉴于它学习成本比较高，此文意在记录和收集相关的资料，以便以后查阅。</p>
</blockquote>
<p><strong>Github地址</strong>：<a target="_blank" rel="noopener" href="https://github.com/ReactiveCocoa/ReactiveCocoa">ReactiveCocoa</a></p>
<p>比较不错的学习资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://blog.devtang.com/blog/2016/01/03/reactive-cocoa-discussion/">ReactiveCocoa 讨论会</a> – 唐巧</li>
<li><a target="_blank" rel="noopener" href="http://limboy.me/ios/2015/09/27/ios-mvvm-without-reactivecocoa.html">MVVM without ReactiveCocoa</a> – limboy</li>
<li><a target="_blank" rel="noopener" href="http://tech.meituan.com/tag/ReactiveCocoa">ReactiveCocoa</a> – 美团</li>
<li><a target="_blank" rel="noopener" href="http://blog.leichunfeng.com/blog/2015/12/25/reactivecocoa-v2-dot-5-yuan-ma-jie-xi-zhi-jia-gou-zong-lan/">ReactiveCocoa v2.5 源码解析之架构总览</a> – 雷纯峰 </li>
<li><a target="_blank" rel="noopener" href="http://blog.leichunfeng.com/blog/2015/11/08/functor-applicative-and-monad/">Functor、Applicative 和 Monad</a> – 雷纯峰 </li>
<li><a target="_blank" rel="noopener" href="https://www.coursera.org/course/reactive">Principles of Reactive Programming</a> – 这里有一些视频课程，很不错</li>
<li><a target="_blank" rel="noopener" href="http://www.raywenderlich.com/62699/reactivecocoa-tutorial-pt1">ReactiveCocoa Tutorial – The Definitive Introduction: Part 1&#x2F;2</a></li>
<li><a target="_blank" rel="noopener" href="http://www.raywenderlich.com/62796/reactivecocoa-tutorial-pt2">ReactiveCocoa Tutorial – The Definitive Introduction: Part 2&#x2F;2</a></li>
<li><a target="_blank" rel="noopener" href="http://www.raywenderlich.com/74106/mvvm-tutorial-with-reactivecocoa-part-1">MVVM Tutorial with ReactiveCocoa: Part 1&#x2F;2</a></li>
<li><a target="_blank" rel="noopener" href="http://www.raywenderlich.com/74131/mvvm-tutorial-with-reactivecocoa-part-2">MVVM Tutorial with ReactiveCocoa: Part 2&#x2F;2</a></li>
<li><a target="_blank" rel="noopener" href="http://pan.baidu.com/share/link?uk=3726868924&shareid=2347251856&third=0&adapt=pc&fr=ftw">Functional Reactive Programming on iOS</a> – 这本书介绍函数式编程配有例子，可以快速理解这种思想，入门级推荐</li>
<li><a target="_blank" rel="noopener" href="http://nshipster.cn/reactivecocoa/">Reactive​Cocoa</a> – NSHipster</li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/1fc8c809e2c0">ReactiveCocoa 入坑 ing</a> – 简书</li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/335f236b8a5b">ReactiveCocoa学习资源收集</a> – 简书</li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/p/b56402adfc93">ReactiveCocoa学习资料汇总</a> – 简书</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/18/2016-01-18-tableviewxing-neng-you-hua/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/18/2016-01-18-tableviewxing-neng-you-hua/" class="post-title-link" itemprop="url">TableView 性能优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-18 22:00:04" itemprop="dateCreated datePublished" datetime="2016-01-18T22:00:04+08:00">2016-01-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 16:29:26" itemprop="dateModified" datetime="2024-11-02T16:29:26+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>645</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>此文整理一下TableView优化相关的方案和思路。</p>
</blockquote>
<h4 id="TableView为什么会卡？"><a href="#TableView为什么会卡？" class="headerlink" title="TableView为什么会卡？"></a>TableView为什么会卡？</h4><p>主要由以下原因：</p>
<ul>
<li><code>cellForRowAtIndexPath:</code>方法中处理了过多业务</li>
<li>tableviewCell的subview层级太复杂，做了大量透明处理</li>
<li>cell的height动态变化时计算方式不对</li>
</ul>
<h4 id="优化核心思想：UITableViewCell重用机制"><a href="#优化核心思想：UITableViewCell重用机制" class="headerlink" title="优化核心思想：UITableViewCell重用机制"></a>优化核心思想：<code>UITableViewCell</code>重用机制</h4><p>简单的理解就是：UITableView只会创建一屏幕（或一屏幕多一点）的UITableViewCell，其他都是从中取出来重用的。每当Cell滑出屏幕时，就会放入到一个集合（或数组）中（这里就相当于一个重用池），当要显示某一位置的Cell时，会先去集合（或数组）中取，如果有，就直接拿来显示；如果没有，才会创建。这样做的好处可想而知，极大的减少了内存的开销。</p>
<h4 id="Tips："><a href="#Tips：" class="headerlink" title="Tips："></a>Tips：</h4><ol>
<li>提前计算并缓存好高度（布局），因为<code>heightForRowAtIndexPath:</code>是调用最频繁的方法；</li>
<li>异步绘制,遇到复杂界面,参考<code>Facebook</code>的<code>AsyncDisplayKit</code>和<a target="_blank" rel="noopener" href="https://github.com/ibireme/YYAsyncLayer">YYAsyncLayer</a>异步绘制框架；</li>
<li>缓存图片（<code>SDWebImage</code>），提前处理好<code>UIImageView</code>图片的尺寸按需加载而不是加载原图；</li>
<li>计算等耗时操作异步处理，处理完再回主线程更新UI；</li>
<li>图文混排不定高度采用<code>CoreText</code>排版，缓存Cell高度参考<a target="_blank" rel="noopener" href="https://github.com/ibireme/YYKit">YYKit</a>；</li>
<li>实现Cell的<code>drawRect:</code>方法直接绘制，减少<code>UIView</code>，<code>UIImageView</code>，<code>UILabel</code>等容器的使用。</li>
</ol>
<h4 id="Bonus："><a href="#Bonus：" class="headerlink" title="Bonus："></a>Bonus：</h4><ol>
<li>正确使用reuseIdentifier来重用Cell；</li>
<li>尽量少用或不用透明图层或View；</li>
<li>如果Cell内现实的内容来自web，使用异步加载，缓存请求结果；</li>
<li>减少subviews的数量在<code>heightForRowAtIndexPath:</code>中尽量不使用<code>cellForRowAtIndexPath:</code>，如果你需要用到它，只用一次然后缓存结果；</li>
<li>尽量少用addView给Cell动态添加View，可以初始化时就添加，然后通过hide来控制是否显示；</li>
<li>固定高度不要实现<code>heightForRowAtIndexPath:</code>方法。</li>
</ol>
<p>可以通过实现以下方法，可以减少高度计算次数</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> rowHeight;             <span class="comment">// will return the default value if unset</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> sectionHeaderHeight;   <span class="comment">// will return the default value if unset</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> sectionFooterHeight;   <span class="comment">// will return the default value if unset</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> estimatedRowHeight <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">7</span>_0); <span class="comment">// default is 0, which means there is no estimate</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> estimatedSectionHeaderHeight <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">7</span>_0); <span class="comment">// default is 0, which means there is no estimate</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">CGFloat</span> estimatedSectionFooterHeight <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">7</span>_0); <span class="comment">// default is 0, which means there is no estimate</span></span><br></pre></td></tr></table></figure>


<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://ealui.com/index.php/blog/view/code-uitableviewcell-optimizations">code-uitableviewcell-optimizations-part-1</a></li>
<li><a target="_blank" rel="noopener" href="http://ealui.com/blog/view/code-uitableviewcell-optimization-part-2">code-uitableviewcell-optimization-part-2</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/ios-os-x-development/perfect-smooth-scrolling-in-uitableviews-fd609d5275a5#.b176bxlm3">Perfect smooth scrolling in UITableViews</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.sunnyxx.com/2015/05/17/cell-height-calculation/">优化UITableViewCell高度计算的那些事</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cocoachina.com/ios/20150602/11968.html">详细整理：UITableView优化技巧</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cnblogs.com/wengzilin/p/4288027.html">UITableview性能优化总结</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/nixzhu/dev-blog/blob/master/2014-11-22-asyncdisplaykit-tutorial-achieving-60-fps-scrolling.md">AsyncDisplayKit 教程：达到 60 FPS 的滚动帧率</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/facebook/AsyncDisplayKit">AsyncDisplayKit</a> </li>
<li><a target="_blank" rel="noopener" href="https://github.com/ibireme/YYAsyncLayer">YYAsyncLayer</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/16/2016-01-16-ios-animation-swift-ban/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/16/2016-01-16-ios-animation-swift-ban/" class="post-title-link" itemprop="url">iOS Animation Swift 版</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-16 19:34:06" itemprop="dateCreated datePublished" datetime="2016-01-16T19:34:06+08:00">2016-01-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 11:36:52" itemprop="dateModified" datetime="2024-11-02T11:36:52+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="http://ww2.sinaimg.cn/large/64124373gw1f01qjo2k00j21g00ejjvd.jpg" alt="coreAnimation"></p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>此文主要记录我学习iOS的动画相关内容用<code>Swift</code>语言，记录下来以供参考，不定时更新。</p>
<h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><ul>
<li>Section I: View 动画<ul>
<li>View animation</li>
<li>弹簧动画 - Springs</li>
<li>转场动画 - Transitions</li>
<li>关键帧动画 - Keyframe</li>
</ul>
</li>
<li>Section II: Auto Layout 动画</li>
<li>Section III: Layer 动画</li>
<li>Section IV: 3D 动画</li>
<li>Section V: 未来类型的动画</li>
<li>Section VI: View Controller 动画</li>
<li>Section VII：第三方动画库</li>
<li>Section VIII: Apple Watch 动画</li>
</ul>
<h4 id="Section-I-View-动画"><a href="#Section-I-View-动画" class="headerlink" title="Section I: View 动画"></a>Section I: View 动画</h4><h5 id="1-View-animation"><a href="#1-View-animation" class="headerlink" title="1.View animation"></a>1.View animation</h5><p>简介：view 的动画主要是通过UIView的类方法创建，动画内容一般<br>放在block里面，可以镶嵌使用，构成链式动画，主要有3个方法,三个访法只需会参数最多的那个就行，函数名<code>animateWithDuration(_:delay:options:animations:completion:)</code>，其他的使用起来都类似。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">func</span> animateWithDuration(<span class="keyword">_</span> duration: <span class="type">NSTimeInterval</span>, animations animations: () -&gt; <span class="type">Void</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">func</span> animateWithDuration(<span class="keyword">_</span> duration: <span class="type">NSTimeInterval</span>, animations animations: () -&gt; <span class="type">Void</span>, completion completion: ((<span class="type">Bool</span>) -&gt; <span class="type">Void</span>)<span class="operator">?</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">func</span> animateWithDuration(<span class="keyword">_</span> duration: <span class="type">NSTimeInterval</span>, delay delay: <span class="type">NSTimeInterval</span>, options options: <span class="type">UIViewAnimationOptions</span>, animations animations: () -&gt; <span class="type">Void</span>, completion completion: ((<span class="type">Bool</span>) -&gt; <span class="type">Void</span>)<span class="operator">?</span>)</span><br></pre></td></tr></table></figure>

<p>使用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UIView</span>.animateWithDuration(<span class="number">0.5</span>, delay: <span class="number">0</span>, options: [], animations: &#123;</span><br><span class="line">    <span class="comment">//do something</span></span><br><span class="line">  &#125;, completion: &#123;<span class="keyword">_</span> <span class="keyword">in</span></span><br><span class="line">    <span class="comment">//do something</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：<code>options</code>，动画选项，这个运行你设置一个动画选项集合，传<code>[]</code>表示不需要选项，单个时可以省略放括号例如<code>.Repeat</code>,多个用逗号连接<code>[.Repeat, .CurveEaseInOut]</code></p>
</blockquote>
<blockquote>
<p><code>completion</code>闭包需要一个参数，不需要使用参数可以用<code>_</code>表示，不需要实现可以直接传<code>nil</code></p>
</blockquote>
<p>或者像下面这样写</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UIView</span>.animateWithDuration(<span class="number">0.5</span>, delay: <span class="number">0</span>, options: [], animations: &#123; () -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">  <span class="comment">//do something</span></span><br><span class="line">  &#125;) &#123; (<span class="keyword">_</span>) -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">  <span class="comment">//do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-弹簧动画-Springs"><a href="#2-弹簧动画-Springs" class="headerlink" title="2.弹簧动画 - Springs"></a>2.弹簧动画 - Springs</h5><p>简介：弹簧动画是iOS 7.0新增的API，函数名<code>animateWithDuration(_:delay:usingSpringWithDamping:initialSpringVelocity:opti ons:animations:completion:)</code>，</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">func</span> animateWithDuration(<span class="keyword">_</span> duration: <span class="type">NSTimeInterval</span>, delay delay: <span class="type">NSTimeInterval</span>, usingSpringWithDamping dampingRatio: <span class="type">CGFloat</span>, initialSpringVelocity velocity: <span class="type">CGFloat</span>, options options: <span class="type">UIViewAnimationOptions</span>, animations animations: () -&gt; <span class="type">Void</span>, completion completion: ((<span class="type">Bool</span>) -&gt; <span class="type">Void</span>)<span class="operator">?</span>)</span><br></pre></td></tr></table></figure>

<p>使用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UIView</span>.animateWithDuration(<span class="number">0.5</span>, delay: <span class="number">0.5</span>, usingSpringWithDamping: <span class="number">0.5</span>, initialSpringVelocity: <span class="number">0.0</span>, options: [], animations: &#123;</span><br><span class="line"><span class="comment">// do something</span></span><br><span class="line">&#125;, completion: <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：<code>usingSpringWithDamping</code>:设置弹簧的阻尼，范围（0.0-1.0），越接近0.0弹簧越有弹性，越接近1.0，效果越僵硬，你可以把当成弹簧的刚度来理解，<br><code>initialSpringVelocity</code>:设置弹簧初始化的速度，设置1.0表示用1秒在动画跨度上完成整个动画距离，值越大或者越小会导致动画有相应的大的或者较小的速度，可以当成弹簧的初始动量来理解。</p>
</blockquote>
<h5 id="3-转场动画-Transitions"><a href="#3-转场动画-Transitions" class="headerlink" title="3.转场动画 - Transitions"></a>3.转场动画 - Transitions</h5><p>简介：前两种创建的动画是基于可动画的接口例如，position，alpha，frame等等，Transitions是专门处理添加或者移除一个view的动画,系统有2个标准函数，一个是对单个view的处理，一个是处理2个view替换。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">func</span> transitionWithView(<span class="keyword">_</span> view: <span class="type">UIView</span>, duration duration: <span class="type">NSTimeInterval</span>, options options: <span class="type">UIViewAnimationOptions</span>, animations animations: (() -&gt; <span class="type">Void</span>)<span class="operator">?</span>, completion completion: ((<span class="type">Bool</span>) -&gt; <span class="type">Void</span>)<span class="operator">?</span>)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">func</span> transitionFromView(<span class="keyword">_</span> fromView: <span class="type">UIView</span>, toView toView: <span class="type">UIView</span>, duration duration: <span class="type">NSTimeInterval</span>, options options: <span class="type">UIViewAnimationOptions</span>, completion completion: ((<span class="type">Bool</span>) -&gt; <span class="type">Void</span>)<span class="operator">?</span>)</span><br></pre></td></tr></table></figure>

<p>使用：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//add the new view via transition</span></span><br><span class="line"><span class="type">UIView</span>.transitionWithView(animationContainerView<span class="operator">!</span>, duration: <span class="number">0.33</span>,</span><br><span class="line">options: [.<span class="type">CurveEaseOut</span>, .<span class="type">TransitionFlipFromBottom</span>], animations: &#123;</span><br><span class="line"><span class="keyword">self</span>.animationContainerView<span class="operator">!</span>.addSubview(newView) &#125;, completion: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//remove the view via transition</span></span><br><span class="line"><span class="type">UIView</span>.transitionWithView(animationContainerView<span class="operator">!</span>, duration: <span class="number">0.33</span>,</span><br><span class="line">options: [.<span class="type">CurveEaseOut</span>, .<span class="type">TransitionFlipFromBottom</span>], animations: &#123;</span><br><span class="line"><span class="keyword">self</span>.newView.removeFromSuperview() &#125;, completion: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//hide the view via transition</span></span><br><span class="line"><span class="type">UIView</span>.transitionWithView(<span class="keyword">self</span>.newView, duration: <span class="number">0.33</span>, options: [.<span class="type">CurveEaseOut</span>, .<span class="type">TransitionFlipFromBottom</span>], animations: &#123;</span><br><span class="line"><span class="keyword">self</span>.newView.hidden <span class="operator">=</span> <span class="literal">true</span> &#125;, completion: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//replace via transition</span></span><br><span class="line"><span class="type">UIView</span>.transitionFromView(<span class="keyword">self</span>.oldView<span class="operator">!</span>, toView: <span class="keyword">self</span>.newView<span class="operator">!</span>, duration: <span class="number">0.33</span>, options: [.<span class="type">TransitionFlipFromTop</span>],</span><br><span class="line">completion: <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure>

<h5 id="4-关键帧动画-Keyframe"><a href="#4-关键帧动画-Keyframe" class="headerlink" title="4.关键帧动画 - Keyframe"></a>4.关键帧动画 - Keyframe</h5><p>简介：关键帧顾名思义就是设定关键的一些帧然后系统会根据一套算法计算中间的其他帧，这样改变的可动画属性时看看起来更加流畅自然，主要有两个函数,一个创建关键帧动画，一个设置具体每帧内容</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">func</span> animateKeyframesWithDuration(<span class="keyword">_</span> duration: <span class="type">NSTimeInterval</span>, delay delay: <span class="type">NSTimeInterval</span>, options options: <span class="type">UIViewKeyframeAnimationOptions</span>, animations animations: () -&gt; <span class="type">Void</span>, completion completion: ((<span class="type">Bool</span>) -&gt; <span class="type">Void</span>)<span class="operator">?</span>)</span><br><span class="line"><span class="operator">+</span> (void)addKeyframeWithRelativeStartTime:(double)frameStartTime relativeDuration:(double)frameDuration animations:(void (<span class="operator">^</span>)(void))animations</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">planeDepart</span>() &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">UIView</span>.animateKeyframesWithDuration(<span class="number">1.5</span>, delay: <span class="number">0.0</span>, options: [], animations: &#123;</span><br><span class="line">    <span class="comment">//add keyframes</span></span><br><span class="line"></span><br><span class="line">    <span class="type">UIView</span>.addKeyframeWithRelativeStartTime(<span class="number">0.0</span>, relativeDuration: <span class="number">0.25</span>, animations: &#123;</span><br><span class="line">      <span class="keyword">self</span>.planeImage.center.x <span class="operator">+=</span> <span class="number">100.0</span></span><br><span class="line">      <span class="keyword">self</span>.planeImage.center.y <span class="operator">-=</span> <span class="number">10.0</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="type">UIView</span>.addKeyframeWithRelativeStartTime(<span class="number">0.1</span>, relativeDuration: <span class="number">0.4</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.planeImage.transform <span class="operator">=</span> <span class="type">CGAffineTransformMakeRotation</span>(<span class="type">CGFloat</span>(<span class="operator">-</span><span class="type">M_PI_4</span><span class="operator">/</span><span class="number">2</span>))</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">UIView</span>.addKeyframeWithRelativeStartTime(<span class="number">0.25</span>, relativeDuration: <span class="number">0.25</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.planeImage.center.x <span class="operator">+=</span> <span class="number">100.0</span></span><br><span class="line">        <span class="keyword">self</span>.planeImage.center.y <span class="operator">-=</span> <span class="number">60.0</span></span><br><span class="line">        <span class="keyword">self</span>.planeImage.alpha <span class="operator">=</span> <span class="number">0.0</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">UIView</span>.addKeyframeWithRelativeStartTime(<span class="number">0.51</span>, relativeDuration: <span class="number">0.01</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.planeImage.transform <span class="operator">=</span> <span class="type">CGAffineTransformIdentity</span></span><br><span class="line">        <span class="keyword">self</span>.planeImage.center <span class="operator">=</span> <span class="type">CGPoint</span>(x: <span class="number">0.0</span>, y: originalCenter.y)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">UIView</span>.addKeyframeWithRelativeStartTime(<span class="number">0.55</span>, relativeDuration: <span class="number">0.45</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.planeImage.alpha <span class="operator">=</span> <span class="number">1.0</span></span><br><span class="line">        <span class="keyword">self</span>.planeImage.center <span class="operator">=</span> originalCenter</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      &#125;, completion: <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：这是设计一个飞机沿一条路径起飞然后再归位的一段动画，<code>addKeyframeWithRelativeStartTime(_:relativeDuration:animations:)</code>,第一个参数相对开始时间，是相对于动画持续时间的百分比，例如0.1就是10%，0.25就是25%，如果整个动画持续2秒，0.1就是在2*0.1&#x3D;0.2秒的时候开始，后面的一个参数是相对持续时间，范围更第一参数类似也(0.0-1.0),只从相对开始时间起，往后推移的相对时间。</p>
</blockquote>
<h4 id="Section-II-Auto-Layout-动画"><a href="#Section-II-Auto-Layout-动画" class="headerlink" title="Section II: Auto Layout 动画"></a>Section II: Auto Layout 动画</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// change Constraint</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// init layout</span></span><br><span class="line">view.layoutIfNeeded()</span><br><span class="line"></span><br><span class="line"><span class="type">UIView</span>.animateWithDuration(<span class="number">0.8</span>, delay: <span class="number">0.0</span>,</span><br><span class="line">      usingSpringWithDamping: <span class="number">0.4</span>, initialSpringVelocity: <span class="number">0.0</span>,</span><br><span class="line">      options: [], animations: &#123;</span><br><span class="line">      </span><br><span class="line">        <span class="comment">// do something change constraint</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// layout</span></span><br><span class="line">        <span class="keyword">self</span>.view.layoutIfNeeded()</span><br><span class="line">      &#125;, completion: <span class="literal">nil</span>)</span><br><span class="line">      </span><br></pre></td></tr></table></figure>

<p>原理就是，修改约束,让添加一个动画，在动画<code>block</code>里面执行布局更新，<code>block</code>里面也可以添加修改约束代码，修改约束的本质是修改相关<code>View</code>的<code>frame</code>和<code>bounds</code>，由于修改<code>View</code>的这个属性是支持动画的，所以修改约束其实是间接修改<code>View</code>的这些属性，所有也是支持动画的，这个动画的强大的之处在于，可以实现一系列<code>View</code>相互协作的动画。</p>
<h4 id="Section-VIII-Apple-Watch-动画"><a href="#Section-VIII-Apple-Watch-动画" class="headerlink" title="Section VIII: Apple Watch 动画"></a>Section VIII: Apple Watch 动画</h4><p>概述：在Apple Watch 中有两种技术来创建动画，一个是一次性创建一系列静态可动画的图片序列或者循环动画，另一种是对标签和其他项目通过改变尺寸，对齐，颜色，透明度进行布局和外观动画。</p>
<p><strong>Animated Image Sequences</strong></p>
<p><code>Animated Image Sequences</code>是由两个或者更多的独立图片组成的序列来随时间按序列显示。每张图片组成了动画的一个单独的帧，整个动画运行在一个循环中除了你在运行的时候修改了播放的行为。主要把它安装在你界面中的<code>image</code>，<code>group</code>,<code>button</code>等元素中。通过<code>WKImageAnimatable</code>协议来实现动画，也就是说凡是遵循这个协议的对象都支持动画，<code>WatchKit</code>中遵循这个协议的对象有：<code>WKInterfaceGroup</code>，<code>WKInterfaceImage</code></p>
<p>你可以控制<code>image</code>和<code>group</code>元素<code>Animated Image Sequences</code>的播放的速度，方向，帧率,否则界面元素将会无限循环显示一个完整的动画。</p>
<blockquote>
<p>Notes:</p>
</blockquote>
<ol>
<li><code>Animated Image Sequences</code>可以正向播放动画也可以反向执行动画在运行的时候，你不应该提供一套一样的图片以反向的方式，你应该使用这个技术来降低App的尺寸。</li>
<li>如果你是从<code>storyboard</code>创建序列图片对象，可以通过<code>func startAnimating()</code>方法开始执行动画，通过<code>func stopAnimating()</code>来停止动画的执行。</li>
</ol>
<p>实例：</p>
<p>实现<code>WKInterfaceGroup</code>加载进度动画</p>
<p>1.在<code>Watch</code>里面的<code>Interface.storyboard</code>里面拖拽一个<code>WKInterfaceGroup</code>命名为<code>backgroundGroup</code><br>2.创建一个<code>WKInterfaceButton</code>按钮来触发这个动画事件,在控制器里面实现下面的代码</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@IBAction</span> <span class="keyword">func</span> <span class="title function_">checkInButtonTapped</span>() &#123;</span><br><span class="line">    <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">let</span> duration <span class="operator">=</span> <span class="number">0.35</span></span><br><span class="line">    <span class="keyword">let</span> delay <span class="operator">=</span> dispatch_time(<span class="type">DISPATCH_TIME_NOW</span>, <span class="type">Int64</span>((duration <span class="operator">+</span> <span class="number">0.15</span>) <span class="operator">*</span> <span class="type">Double</span>(<span class="type">NSEC_PER_SEC</span>)))</span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">    backgroundGroup.setBackgroundImageNamed(<span class="string">&quot;Progress&quot;</span>)</span><br><span class="line">    <span class="comment">// 3</span></span><br><span class="line">    backgroundGroup.startAnimatingWithImagesInRange(<span class="type">NSRange</span>(location: <span class="number">0</span>, length: <span class="number">10</span>), duration: duration, repeatCount: <span class="number">1</span>)</span><br><span class="line">    <span class="comment">// 4</span></span><br><span class="line">    dispatch_after(delay, dispatch_get_main_queue()) &#123; () -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">      <span class="comment">// 5</span></span><br><span class="line">      dosomething</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>参数说明：<code>imageRange</code>,将要执行动画的图片范围，<code>0</code>表示第一张图片，<code>1</code>表示第二张图片，以此类推；<code>duration</code>,单位秒，表示动画执行单个循环的时间，<code>正值</code>表示从第一帧到最后一帧执行，<code>负值</code>表示以相反的顺序执行动画，以第一帧结束；<code>repeatCount</code>,动画的重复次数，设置<code>0</code>表示无限循环。</p>
</blockquote>
<p>3.将素材文件拖入<code>Watch</code>的<code>Asset.xcassets</code>的文件里面，以<code>Progress</code>开始命名后面接一串连续的数字，效果应该像下面这样。</p>
<p><img src="http://ww2.sinaimg.cn/mw690/64124373gw1f0g7yyn3ipj20co0c60tw.jpg" alt="iWatchProgress"></p>
<p>4.然后在模拟器上运行就OK了。</p>
<p><strong>Layout and Appearance Animations</strong></p>
<p>你可以动画改变所有界面元素的布局和外观。动画改变布局让你修改元素的尺寸或者动态的改变布局的方向。你可以移动在屏幕上的元素或者让它们的内容重新对齐。你也可以动画改变元素的外观，包括改变他们的<code>backgroud color</code>或者<code>opactiy</code>。这些类型的动画让你创建动态的界面用来响应用户的交互并且提供一个更好的反馈。</p>
<p>所有的<code>layout- and appearance-based animations</code>在动画开始和结束都以<code>easing</code>的曲线方式自动构建 。你不能关闭或者自定义缓动曲线。相当于<code>UIView</code>的动画选项里面的<code>easeInOut</code>。</p>
<p>可动画属性：</p>
<ul>
<li>Opacity</li>
<li>Height</li>
<li>Width</li>
<li>Group Insets</li>
<li>Alignment</li>
<li>Background Color</li>
<li>Tint Color</li>
</ul>
<p>核心代码：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">func</span> animateWithDuration(<span class="keyword">_</span> duration: <span class="type">NSTimeInterval</span>, animations animations: () -&gt; <span class="type">Void</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>说明:这个方法在<code>WKInterfaceController</code>中，目前发现只有这一个动画API，你可以在这个闭包里面执行相应的动画操作，实现跟<code>UIView</code>的block动画类似。</p>
<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1f0g87cuk9cj20zi034dh2.jpg" alt="iWatchAnimation"></p>
<p>实例：</p>
<blockquote>
<p>在界面已经出现的时候对<code>planeImage</code>进行着色动画,改变<code>separator</code>的颜色</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> planeImage: <span class="type">WKInterfaceImage</span>!</span><br><span class="line"><span class="keyword">var</span> separator: <span class="type">WKInterfaceSeparator</span>!</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">didAppear</span>() &#123;</span><br><span class="line">    <span class="keyword">super</span>.didAppear()</span><br><span class="line">    <span class="comment">// 1</span></span><br><span class="line">      animateWithDuration(<span class="number">0.35</span>, animations: &#123; () -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">        <span class="comment">// 2</span></span><br><span class="line">        <span class="keyword">let</span> color <span class="operator">=</span> <span class="type">UIColor</span>(red: <span class="number">90</span><span class="regexp">/255, green: 200/</span><span class="number">255</span>, blue: <span class="number">250</span><span class="operator">/</span><span class="number">255</span>, alpha: <span class="number">1</span>)</span><br><span class="line">        planeImage.setTintColor(color)</span><br><span class="line">        separator.setColor(color)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/watch/human-interface-guidelines/">Apple Human-interface-guidelines</a> – Apple</li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/prerelease/ios/documentation/General/Conceptual/WatchKitProgrammingGuide/index.html#//apple_ref/doc/uid/TP40014969-CH8-SW1">Apple WatchKit Programming Guide</a> – Apple</li>
<li><a target="_blank" rel="noopener" href="https://github.com/ipader/SwiftGuide/blob/master/Apple%20Watch/README.md">Apple Watch</a> – SwiftGuide</li>
<li><a target="_blank" rel="noopener" href="https://github.com/ipader/SwiftGuide">Swift Guide</a> – SwiftGuide</li>
</ul>
<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com/">http://blog.wangruofeng007.com</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/15/2016-01-15-nsurlsession/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/15/2016-01-15-nsurlsession/" class="post-title-link" itemprop="url">NSURLSession 教程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-15 18:15:01" itemprop="dateCreated datePublished" datetime="2016-01-15T18:15:01+08:00">2016-01-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 16:29:21" itemprop="dateModified" datetime="2024-11-02T16:29:21+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>37 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文翻译自 <a target="_blank" rel="noopener" href="http://www.raywenderlich.com/51127/nsurlsession-tutorial">http://www.raywenderlich.com/51127/nsurlsession-tutorial</a></p>
<p>原作者： Charlie Fulton</p>
<p>译者：<a target="_blank" rel="noopener" href="https://twitter.com/oneruofeng">@oneruofeng</a></p>
<p>注意：这是一篇来自我们作为即将发布<a target="_blank" rel="noopener" href="http://www.raywenderlich.com/?p=49762"> iOS 7 Feast</a>的一部分<a target="_blank" rel="noopener" href="http://www.raywenderlich.com/?page_id=48020">iOS 7 by Tutorials</a>的简短版本的章节。我们希望你们喜欢。</p>
<p>每一个新的iOS版本发布都会包含一些极好的新的网络APIs，iOS7也不例外，在iOS7中，Apple引入了<code>NSURLSession</code>,这是为了取代<code>NSURLConnection</code>作为偏好的网络请求的一系列类。</p>
<p>在这个<code>NSURLSession</code>的教程中，你将了解到这个新类究竟是什么，为什么你要使用它以及你怎样使用它，它和以前的类库比较而言怎样，最后最重要的是：获得一个整合到一个真正的App的实践。</p>
<p>请注意：这个课程是假设你熟悉基本的网络概念。假如网络对你来说完全是新的，你仍然可以跟我一起一步一步的学习，但是可能有些你不熟悉的概念需要需要自己查询在这个过程中。</p>
<h4 id="为什么使用NSURLSession"><a href="#为什么使用NSURLSession" class="headerlink" title="为什么使用NSURLSession"></a>为什么使用<code>NSURLSession</code></h4><p>为什么你要使用<code>NSURLSession</code>? 饿，因为它可以带给你一些好处和优势相比以前的：</p>
<ul>
<li><strong>后台上传和下载</strong> ： 当你创建<code>NSURLSession</code>的时候你只需配置一个选项即可，你便可以进行所有的后台网络任务。这将有对你的电池寿命有利，它支持<code>UIKit</code>多任务并且当切换线程的时候使用相同的代理模型。</li>
<li><strong>使你的网络操作可以暂停和恢复</strong> ：你稍后将会看到，任何使用<code>NSURLSession</code>API的网络任务都可以被暂停，停止，重新开始。而没有使用<code>NSOperation</code>子类的必要。</li>
<li><strong>可配置的容器</strong>：对于放进里面的请求而言每一个<code>NSURLSession</code>都是可配置的。例如，假如你需要设置一个HTTP header选项，你只需要设置一次然后每个在session中的请求就都会有相同的配置了。</li>
<li><strong>可子类化和私密存储</strong>： <code>NSURLSession</code>是可子类化的并且你可以配置一个session用来作为私密存储在某个会话中。这允许你拥有私密存储对象在全局状态下。</li>
<li><strong>优化的授权处理机制</strong>：授权被完成基于某个特定的连接。当使用<code>NSURLConnection</code>的时候假如发生了一处授权改变，这个改变将返回一个随意的请求，你不能确定你具体得到的那个。使用<code>NSURLSession</code>的话，代理回来处理授权。</li>
<li><strong>丰富的代理模型</strong>：<code>NSURLConnection</code>有些基于block的同步方法，然而代理就不能使用它们了。当一个请求建立了无论它是成功还是失败，哪怕需要授权。使用<code>NSURLSession</code>就就可以混合接入，使用基于block的异步方法同时也可以设置代理来处理授权。</li>
<li><strong>通过文件系统上传和下载</strong>：苹果鼓励把（文件内容）数据跟(URL和一些设置)元数据分开。</li>
</ul>
<h4 id="NSURLSession-vs-NSURLConnection"><a href="#NSURLSession-vs-NSURLConnection" class="headerlink" title="NSURLSession vs NSURLConnection"></a><code>NSURLSession</code> vs <code>NSURLConnection</code></h4><p>“哇哦，<code>NSURLSession</code>听起来很复杂呀！”,你可能这么想。”我可能还是继续使用我的老朋友<code>NSURLConnection</code>。”</p>
<p>别担心–使用<code>NSURLSession</code>使用起来其实和它的前辈<code>NSURLConnection</code>一样简单对于简单的任务来说。例如，让我来看一个在获取伦敦最新的天气的一个简单网络请求，通过它来获取JSON数据的例子。</p>
<p>假设你用这个<code>NSString</code>来构造这个<code>NSURL</code>:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *londonWeatherUrl = <span class="string">@&quot;http://api.openweathermap.org/data/2.5/weather?q=London,uk&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>这里是第一步你使用<code>NSURLConnection</code>来调用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSURLRequest</span> *request = [<span class="built_in">NSURLRequest</span> requestWithURL:</span><br><span class="line">[<span class="built_in">NSURL</span> URLWithString:londonWeatherUrl]];</span><br><span class="line"></span><br><span class="line">[<span class="built_in">NSURLConnection</span> sendAsynchronousRequest:request</span><br><span class="line">   queue:[<span class="built_in">NSOperationQueue</span> mainQueue]</span><br><span class="line">   completionHandler:^(<span class="built_in">NSURLResponse</span> *response,</span><br><span class="line">                       <span class="built_in">NSData</span> *data,</span><br><span class="line">                       <span class="built_in">NSError</span> *connectionError) &#123;</span><br><span class="line">      <span class="comment">// handle response</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>现在让我们来使用<code>NSURLSession</code>。注意这是使用<code>NSURLSession</code>的最简单的方式来快速构造一个请求。在后面的课程你将看到怎样配置session和设置其他特征比如像代理。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSURLSession</span> *session = [<span class="built_in">NSURLSession</span> sharedSession];</span><br><span class="line">[[session dataTaskWithURL:[<span class="built_in">NSURL</span> URLWithString:londonWeatherUrl]</span><br><span class="line">          completionHandler:^(<span class="built_in">NSData</span> *data,</span><br><span class="line">                              <span class="built_in">NSURLResponse</span> *response,</span><br><span class="line">                              <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">            <span class="comment">// handle response</span></span><br><span class="line"></span><br><span class="line">  &#125;] resume];</span><br></pre></td></tr></table></figure>

<p>注意你并不需要指定它运行在那个队列中。除了你特别指定，这个调用将会在后台线程。你可能很难注意到这两者之间有什么不同，它就是故意这样的。Apple提到打算使用<code>dataTaskWithURL</code>来取代在<code>NSURLConnection</code>中的<code>sendAsynchronousRequest</code>。</p>
<p>所有从根本上来讲–对于简单的任务使用<code>NSURLSession</code>就和使用<code>NSURLConnection</code>一样简单，并且它还有一些列额外的定制功能当你需要它的时候。</p>
<h4 id="NSURLSession-vs-AFNetworking"><a href="#NSURLSession-vs-AFNetworking" class="headerlink" title="NSURLSession vs AFNetworking"></a><code>NSURLSession</code> vs <code>AFNetworking</code></h4><p>不提到<code>AFNetworking</code>框架就谈不上谈论网络编程。这个事在<code>iOS/OS X</code>上最流行的框架，有杰出的<code>Mattt Thompson</code>创建。</p>
<blockquote>
<p>注意：想了解更多关于<code>AFNetworking</code>,请检出在<a target="_blank" rel="noopener" href="https://github.com/AFNetworking/AFNetworking">https://github.com/AFNetworking/AFNetworking</a>的github页面。我们也有一个关于它的课程：<a target="_blank" rel="noopener" href="http://www.raywenderlich.com/30445/afnetworking-crash-course">http://www.raywenderlich.com/30445/afnetworking-crash-course</a></p>
</blockquote>
<p>下面是的使用<code>AFNetworking</code> 1.x版本处理相同的数据任务的代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSURLRequest</span> *request = [<span class="built_in">NSURLRequest</span> requestWithURL:</span><br><span class="line">                         [<span class="built_in">NSURL</span> URLWithString:londonWeatherUrl]];</span><br><span class="line"></span><br><span class="line">AFJSONRequestOperation *operation =</span><br><span class="line">[AFJSONRequestOperation JSONRequestOperationWithRequest:request</span><br><span class="line">    success:^(<span class="built_in">NSURLRequest</span>  *request,</span><br><span class="line">              <span class="built_in">NSHTTPURLResponse</span>  *response,</span><br><span class="line">              <span class="type">id</span> JSON) &#123;</span><br><span class="line">    <span class="comment">// handle response</span></span><br><span class="line">&#125; failure:<span class="literal">nil</span>];</span><br><span class="line">[operation start];</span><br></pre></td></tr></table></figure>

<p>使用<code>AFNetworking</code>的一个好处是处理响应的数据的数据根据类型被归类。使用<code>AFJSONRequestOperation</code>(或者诸如<code>XML</code>和plist相似的类),成功block已经被解析根据响应并且为你返回你想要的数据。使用<code>NSURLSession</code>你将收到一个<code>NSData</code>对象在<code>completion handler</code>,所有你只需要把<code>NSData</code>转换成<code>JOSN</code>或者其他形式。</p>
<blockquote>
<p>注意：你能够很方便的把数据从<code>NSData</code>转换成<code>JSON</code>使用在iOS 5引入的<code>NSJSONSerialization</code>这个类。如果你想了解更多，请查看23章的iOS 5 教程，“Working with JSON”。</p>
</blockquote>
<p>你或许想知道你是应该使用<code>AFNetworking</code>还是仅仅是继续使用<code>NSURLSession</code>。</p>
<p>就个人而言，我认为对于简单的需求最好还是继续使用<code>NSURLSession</code>–这样可以避免不必要的引入一个第三方库在你的工程中。另外，使用新的代理，配置，和基于很多添加到<code>AFNetworking</code>中的的“遗失特征”现在都被包括了的API的任务。</p>
<p>然而，假如你想使用一些在<code>AFNetworking</code>中2.0版本的新特性，诸如序列化和将来对<br><code>UIKit</code>的整合（添加到<code>UIIImageView</code>分类中），然后这样很难争辩不使用它！</p>
<blockquote>
<p>注意：在<code>AFNetworking</code>2.0分支中，它们已经转换到使用<code>NSURLSession</code>。更多信息看这篇帖子：<a target="_blank" rel="noopener" href="https://github.com/AFNetworking/AFNetworking/wiki/AFNetworking-2.0-Migration-Guide">https://github.com/AFNetworking/AFNetworking/wiki/AFNetworking-2.0-Migration-Guide</a></p>
</blockquote>
<h4 id="介绍-Byte-Club"><a href="#介绍-Byte-Club" class="headerlink" title="介绍 Byte Club"></a>介绍 Byte Club</h4><p>在这篇<code>NSURLSession</code>教程中，你将探索这个新的API通过构建一篇日记好图片分享app基于<code> Dropbox Core API</code>,因为是顶级机密组织因此姑且命名它<code>Byte Club</code>。</p>
<p>考虑到这个课程是你接受到<code>Byte Club</code>的官方邀请！什么是你可能会问到的关于<code>Byte Club</code>的第一条规则？没人谈论<code>Byte Club</code>–除了那些足够炫酷的人将会阅读这个教程。并且那些Android用户完全不知道；他们被他们俩的生活劫持了。 ：]</p>
<p>开始构建app迎战下一个章节，将充当被<code>Byte Club</code>组织邀请。</p>
<p>主要到这个教程是假设你对基本的网络有基本的了解在先前的版本iOS。它非常有用假如你已经使用过诸如<code>NSURLConnection</code>或者<code>NSURLSession</code>在过去。假如在iOS方面你是网络方面的新手，在继续这个课程之前你应该查询我们的iOS学徒系列作为最初的开发者。</p>
<h4 id="现在开始吧"><a href="#现在开始吧" class="headerlink" title="现在开始吧"></a>现在开始吧</h4><p><code>Byte Club</code>是iOS 开发者专有的组织，一起来加入挑战你的编程吧。由于每个成员都是远程工作，在这个挑战中有一个是跨越世界，成员通过分享他们“战场”的全景照片也能找到它的乐趣。</p>
<p>例如，下面是Ray的办公场所的全景照片：<br><img src="http://ww4.sinaimg.cn/mw690/64124373gw1ezzf1ygxi8j20go03njs2.jpg" alt="Ray&#39;s office setup"></p>
<blockquote>
<p>注意：你可能想创建你自己办公室的全景照片–它很有趣，在这个课程的后续中我们将会处理。</p>
</blockquote>
<blockquote>
<p>在 iOS 7中，你可以通过打开相机选择一个叫<code>Pano</code>（全景）的标签照一张全景照片。</p>
</blockquote>
<blockquote>
<p>加入你喜欢那张，把它设置成你锁屏界面的墙纸通过打开<code>设置</code>让后选择<code>墙纸</code>  \选择墙纸 \我的全景照片。</p>
</blockquote>
<p>当然-<code>Byte Club </code>有它自己的app，我们来见证奇迹。你可以和其他成员使用app来完成编程挑战或者分享全景照片。在幕后，这是通过网络实现-明确的说，就是通过<code>Dropbox API</code>来分享文件。</p>
<h4 id="开始的工程概述"><a href="#开始的工程概述" class="headerlink" title="开始的工程概述"></a>开始的工程概述</h4><p>首先，下载<a target="_blank" rel="noopener" href="http://cdn1.raywenderlich.com/downloads/ByteClub_Starter.zip">教程开始的工程</a>。</p>
<p>开始的工程包含了为你预先准备好的UI，所以你只需把精力集中在这个教程中app的网络部分。开始的工程也包含一些处理<code>Dropbox</code>授权的代码,在后面你将学到更多。</p>
<p>在Xcode中打开工程让后在你设备或者模拟器上运行，你应该看到像下面这样：</p>
<p><img src="http://ww1.sinaimg.cn/mw690/64124373gw1ezzf1vk3t1j205b09edg2.jpg" alt="networking2"></p>
<p>然而你还并不能登录它-你不得不先配置app，你将做一点。</p>
<p>下一步打开<code>Main.storyboard</code>纵览一下整个app的设计：</p>
<p><img src="http://ww2.sinaimg.cn/mw690/64124373gw1ezzf1x56zfj20go0a9q3e.jpg" alt="networking2"></p>
<p>这是一个最基本的使用2个标签的的TabBarController app：一个是为了挑战编程，另<br>一个是为了放全景照片。这里也有预先让用户登录到app中的一步。你将要配置登录在你创建完<code>Dropbox</code>平台下的App后。</p>
<p>感到很轻松浏览一下App剩余的部分并且找到到目前为止相似的地方。你将会注意到除了授权组件，这里没有检索挑战编程或者全景照片的网络代码-那就是你的工作！</p>
<h4 id="创建一个新的Dropbox平台App"><a href="#创建一个新的Dropbox平台App" class="headerlink" title="创建一个新的Dropbox平台App"></a>创建一个新的<code>Dropbox</code>平台App</h4><p>为了开始你的新的<code>Dropbox</code> App,打开 Dropbox App 位于<a target="_blank" rel="noopener" href="https://www.dropbox.com/developers/apps">https://www.dropbox.com/developers/apps</a>的控制台</p>
<p>用你的<code>Dropbox</code>账号登录，假如没有，没问题：马上创建一个免费的Dropbox账号。假如这是你第一次使用Dropbox的API，你需要通知Dropbox的条款和条件。</p>
<p>经过这个法定的材料以后就是上路了，选择创建App选项。将呈现给你一系列问题-提供下面的答案</p>
<ul>
<li>What type of app do you want to create?<ul>
<li>Choose: <strong>Dropbox API app</strong></li>
</ul>
</li>
<li>What type of data does your app need to store on Dropbox?<ul>
<li>Choose: <strong>Files and Datastore</strong></li>
</ul>
</li>
<li>Can your app be limited to its own, private folder?<ul>
<li>Choose: <strong>No – My App needs access to files already on Dropbox</strong></li>
</ul>
</li>
<li>What type of files does your app need access to?<ul>
<li>Choose: <strong>All File Types</strong></li>
</ul>
</li>
</ul>
<p>最终，为你的App准备一个名字，选择什么并没有关系只有它是唯一的。假如你选择了一个别人已经在使用的名字<code>Dropbox </code>将会告诉你。你的屏幕应该看起来像下面这样：</p>
<p><img src="http://ww2.sinaimg.cn/mw690/64124373gw1ezzf38fs1nj20go0epdhp.jpg" alt="networking3">    </p>
<p>点击<code>Create App</code>，你将开始上路了！</p>
<p>下一个屏幕你将看到显示到屏幕中的包含 <strong>App key</strong> 和 <strong>App secret</strong> :</p>
<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1ezzfuk4ucmj208z08rglt.jpg" alt="networking5"></p>
<p>先不要关闭这个屏幕，你将需要需要下一步的<code>App Key</code>和<code>App Secret</code>。</p>
<p>打开<code>Dropbox.m</code>文件找到下面这些行：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">warning</span> INSERT YOUR OWN API KEY and SECRET HERE</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *apiKey = <span class="string">@&quot;YOUR_KEY&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *appSecret = <span class="string">@&quot;YOUR_SECRET&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>填写你的app key 和 secret，让后删除 #warning line，现在你可以关闭<code>Dropbox</code> Web App 页面。</p>
<p>下面，创建一个文件夹在你Dropbox主文件下的根目录给它命一个你想要的名字。假如你把这个文件夹个和其他的Dropbox用户分享，发送他们在构建 Byte Club App的时候，他们将能够创建笔记并且能够上传所有人都能看得见的照片。</p>
<p>在Dropbox.m中找打下面这些行：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">warning</span> THIS FOLDER MUST BE CREATED AT THE TOP LEVEL OF YOUR DROPBOX FOLDER, you can then share this folder with others</span></span><br><span class="line"><span class="built_in">NSString</span> * <span class="keyword">const</span> appFolder = <span class="string">@&quot;byteclub&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>改变字符串的值，设置成你创建的Dropbox文件夹的名字，让后删除 #warning pragma.</p>
<p>为了把这个app分发给其他用户，给他们接入<code>access tokens</code>,你将需要为你的Dropbox 平台 App打开<code>Enable additional users</code>设置。</p>
<p>去在<a target="_blank" rel="noopener" href="https://www.dropbox.com/developers/apps">https://www.dropbox.com/developers/apps</a>Dropbox app的控制台。点击你app 名称。然后点击<code>Enable Additional Users</code>按钮。将出现一个状态对话框表明你已经增加了你的用户限制。点击Okay关闭对话框。你的App 页面将像下面这样显示：</p>
<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1ezzg9htvs2j20go056jrj.jpg" alt="networking5"></p>
<blockquote>
<p>注意：你可能注意到当你正在开发你的app的时候，你可以接入多达100个用户。当你准备发布app销售的时候，你必须申请生产状态，你可以通过点击<code>Apply for production</code>按钮来发送给<code>Dropbox</code>一些额外的信息。</p>
</blockquote>
<blockquote>
<p>Dropbox 将随后审核你的App 来确保它遵守指南，假如所有的一切进行得顺利的话，你将打开你的app的 API接入无线的用户。</p>
</blockquote>
<h4 id="Dropbox-授权-概览"><a href="#Dropbox-授权-概览" class="headerlink" title="Dropbox 授权: 概览"></a>Dropbox 授权: 概览</h4><p>假如你曾经使用过第三方<code>twitter</code>客服端app，像<code>TweetBot</code>,你将会熟悉<code>OAuth</code>授权处理步骤从一个用户的角度。<code>OAuth</code>授权接入过程对你app来说是完全一样的。</p>
<p>构建运行你的app，按照步骤登录。你将看到一个有2个标签的空白屏幕，一个是Notes，一个是PanoPhotos，如下图显示：</p>
<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1ezzglpqm1aj209f0fa0t7.jpg" alt="networking7"></p>
<p><code>OAuth</code>授权发生在3和高级的步骤：</p>
<ol>
<li>获取用来处理剩下的授权一个OAuth请求 token。这是请求token。</li>
<li>一个web 页面被呈现到用户面前通过他们的web浏览器。没有这一步的用户授权，对你的应用想获取一个第三步中的接入token几乎不可能。</li>
<li>在第二步完成后，应用调用web服务来交换临时请求token（从第一步中的）为了一个将存储在app里面的持久接入token。</li>
</ol>
<blockquote>
<p>注意：为了保证这个教程的简洁，我们不打算进行更详细的讲解关于这里Dropbox授权工作。然而，假如你想了解更多点击整个教程的完全版本，它是<a target="_blank" rel="noopener" href="http://www.raywenderlich.com/?page_id=48020">iOS 7 by Tutorials.</a>的一部分。</p>
</blockquote>
<h4 id="NSURLSession-的一系列类"><a href="#NSURLSession-的一系列类" class="headerlink" title="NSURLSession 的一系列类"></a>NSURLSession 的一系列类</h4><p>Apple已经把<code>NSURLSession</code>描述成一个新类和一系列旧类的组合。这些新的工具是为了处理 上传，下载，处理授权已经处理在HTTP协议里面的任何事情。</p>
<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1ezzgzutn43j20go0dwgn3.jpg" alt="networking12"></p>
<p>一个<code>NSURLSession</code>用一个带可选代理的<code>NSURLSessionConfiguration</code>构造。在你创建会话以后，你应该能够满足你的网络需要通过创建<code>NSURLSessionTask</code>的任务。</p>
<h4 id="NSURLSessionConfiguration"><a href="#NSURLSessionConfiguration" class="headerlink" title="NSURLSessionConfiguration"></a>NSURLSessionConfiguration</h4><p>这里有三种方式创建<code>NSURLSessionConfiguration</code>:</p>
<ul>
<li><strong>defaultSessionConfiguration</strong> - 创建一个使用全局缓存，cookie的配置对象和凭证存储的对象。这个配置会使你的会话最像<code>NSURLConnection</code>。</li>
<li><strong>ephemeralSessionConfiguration</strong> - 这个配置是用来作为‘私有的’会话并且不会持久化存储缓存，cookie，或者信用存储对象。</li>
<li><strong>backgroundSessionConfiguration</strong> - 当你想要从远程推送或者当app被暂时挂起时进行网络业务使用这个这个配置。参考17章和18章在<a target="_blank" rel="noopener" href="http://www.raywenderlich.com/?page_id=48020"> iOS 7 by Tutorials</a>,<code>Beginning and Intermediate Multitasking</code>,有更详细的讲解。</li>
</ul>
<p>一旦你创建一个<code>NSURLSessionConfiguration</code>对象，你就可以在它上面设置各种接口像这样：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSURLSessionConfiguration</span> *sessionConfig =</span><br><span class="line">[<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line">sessionConfig.allowsCellularAccess = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line">[sessionConfig setHTTPAdditionalHeaders:</span><br><span class="line">          @&#123;<span class="string">@&quot;Accept&quot;</span>: <span class="string">@&quot;application/json&quot;</span>&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line">sessionConfig.timeoutIntervalForRequest = <span class="number">30.0</span>;</span><br><span class="line">sessionConfig.timeoutIntervalForResource = <span class="number">60.0</span>;</span><br><span class="line">sessionConfig.HTTPMaximumConnectionsPerHost = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<ol>
<li>你限制了网络操作只有wifi才能进行。</li>
<li>这将设置所有的请求只接受 JSON类型的响应。</li>
<li>这些接口将配置资源或者请求超时时间。你也可以限制你的app对你的主机只能有一个网络连接。</li>
</ol>
<p>这些仅仅是你能配置的一些东西，确保检查所有列表的文档。</p>
<h4 id="NSURLSession"><a href="#NSURLSession" class="headerlink" title="NSURLSession"></a>NSURLSession</h4><p><code>NSURLSession</code>被设计成替代<code>NSURLConnection</code>的API。Sessions做了他们的工作通过他们的部下，也就是非常出名的<code>NSURLSessionTask</code>对象。使用<code>NSURLSession</code>你能够创建任务使用基于block的便利方法，设置一个代理，或者同时两者。例如，假如你想要下载一张<br>图片（ *challenge hint *）,你就需要创建一个<code>NSURLSessionDownloadTask</code>。</p>
<p>第一步，你需要创建(会话)session。 这里有一个例子：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="built_in">NSString</span> *imageUrl =</span><br><span class="line"><span class="string">@&quot;http://www.raywenderlich.com/images/store/iOS7_PDFonly_280@2x_authorTBA.png&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="built_in">NSURLSessionConfiguration</span> *sessionConfig =</span><br><span class="line">  [<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="built_in">NSURLSession</span> *session =</span><br><span class="line">  [<span class="built_in">NSURLSession</span> sessionWithConfiguration:sessionConfig</span><br><span class="line">                                delegate:<span class="keyword">self</span></span><br><span class="line">                           delegateQueue:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<p>Ok,这个仅仅是你目前所看到的一点点不同。让我们一步步重温。</p>
<ol>
<li>用这个代码片段我们将一样进行下载在两个任务中。</li>
<li>你总是以创建<code>NSURLConfiguration</code>开始。</li>
<li>这里创建一个会话使用现在的类作为代理。</li>
</ol>
<p>在你创建会话后，你可以通过创建一个带一个<code>completion handler</code>的任务下载这张图片，想下面这样:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="built_in">NSURLSessionDownloadTask</span> *getImageTask =</span><br><span class="line">[session downloadTaskWithURL:[<span class="built_in">NSURL</span> URLWithString:imageUrl]</span><br><span class="line"></span><br><span class="line">    completionHandler:^(<span class="built_in">NSURL</span> *location,</span><br><span class="line">                        <span class="built_in">NSURLResponse</span> *response,</span><br><span class="line">                        <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">        <span class="comment">// 2</span></span><br><span class="line">        <span class="built_in">UIImage</span>  *downloadedImage =</span><br><span class="line">          [<span class="built_in">UIImage</span> imageWithData:</span><br><span class="line">              [<span class="built_in">NSData</span> dataWithContentsOfURL:location]];</span><br><span class="line">      <span class="comment">//3</span></span><br><span class="line">      <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="comment">// do stuff with image</span></span><br><span class="line">         _imageWithBlock.image = downloadedImage;</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line">[getImageTask resume];</span><br></pre></td></tr></table></figure>

<p>Ah ha!现在这个看起来有点像网络代码！</p>
<ol>
<li><p>任务总是被sessions创建。任务一旦被基于block的方法创建。记住你仍然可以使用<code>NSURLSessionDownloadDelegate</code>来跟踪下载进度。所以你将获得最好的两个单词！（ *hint for challenge *）</p>
<p> -URLSession:downloadTask<br> :didWriteData:totalBytesWritten<br> :totalBytesExpectedToWrite:</p>
</li>
<li><p>这里你使用在 <code>completion handler</code>提供的本地变量来获取一个指向图片的指针。</p>
</li>
<li><p>最终你能够，例如，更新 <code>UIIImageView</code>的图片来显示新的文件。(hint hint ☺)</p>
</li>
<li><p>你总得自己启动任务！</p>
</li>
<li><p>记住我在前面所说的，一个会话也可以创建将要发送消息给代理方法来通知你完成等的任务。</p>
</li>
</ol>
<p>应该长成这样，使用相同的会话从上面：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="built_in">NSURLSessionDownloadTask</span> *getImageTask =</span><br><span class="line">  [session downloadTaskWithURL:[<span class="built_in">NSURL</span> URLWithString:imageUrl]];</span><br><span class="line"></span><br><span class="line">[getImageTask resume];</span><br></pre></td></tr></table></figure>

<ol>
<li>这当然是确定使用更少的代码☺ 然而，假如你只这样做，你将什么都看不到。<br>你需要让你的代理实现一些<code>NSURLSessionDownloadDelegate</code>协议的方法。</li>
</ol>
<p>首先我们需要获得通知当下载完成时：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">     downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</span><br><span class="line">didFinishDownloadingToURL:(<span class="built_in">NSURL</span> *)location</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// use code above from completion handler</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再有你需要提供将要下载的文件存放的位置，然后你就可以使用这个来处理图片。</p>
<p>最后，假如你需要跟踪下载进度，对于任务创建方法，你需要像下面这样用：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">     downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</span><br><span class="line">     didWriteData:(int64_t)bytesWritten</span><br><span class="line">totalBytesWritten:(int64_t)totalBytesWritten</span><br><span class="line">totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;%f / %f&quot;</span>, (<span class="type">double</span>)totalBytesWritten,</span><br><span class="line">    (<span class="type">double</span>)totalBytesExpectedToWrite);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正如你所见，<code>NSURLSessionTask</code>是一匹通过网络来干活的真实的驮马。</p>
<h4 id="NSURLSessionTask"><a href="#NSURLSessionTask" class="headerlink" title="NSURLSessionTask"></a>NSURLSessionTask</h4><p>目前为止你已经知道<code>NSURLSessionDataTask</code>和<code>NSURLSessionDownloadTask</code>怎样使用了。这两个的任务是来自他们共同的基类<code>NSURLSessionTask</code>，你可以在这类看到：</p>
<p><img src="http://ww1.sinaimg.cn/mw690/64124373gw1ezzij54674j20go0d53zc.jpg" alt="networking13"></p>
<p><code>NSURLSessionTask</code>在你的会话中是任务的基类；他们只能通过一个会话创建并且它们是下面子类中的一个。</p>
<h4 id="NSURLSessionDataTask"><a href="#NSURLSessionDataTask" class="headerlink" title="NSURLSessionDataTask"></a>NSURLSessionDataTask</h4><p>这个任务发起HTTP GET请求来从服服务器拉取数据。数据被返回以NSData的形式返回。你应该在随后将其把这个数据转换成正确的数据类型比如<code>XML</code>,<code>JSON</code>,UIImage，plist等等。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSURLSessionDataTask</span> *jsonData = [session dataTaskWithURL:yourNSURL</span><br><span class="line">      completionHandler:^(<span class="built_in">NSData</span>  *data,</span><br><span class="line">                          <span class="built_in">NSURLResponse</span>  *response,</span><br><span class="line">                          <span class="built_in">NSError</span>  *error) &#123;</span><br><span class="line">        <span class="comment">// handle NSData</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h4 id="NSURLSessionUploadTask"><a href="#NSURLSessionUploadTask" class="headerlink" title="NSURLSessionUploadTask"></a>NSURLSessionUploadTask</h4><p>使用这个类当你需要上传一些东西到web服务器时，使用HTTP <code>POST</code> 或者 <code>PUT</code> 命令。任务带来也允许你监视网络状况当它正在传输的时候。</p>
<p>上传一张图片：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSData</span> *imageData = <span class="built_in">UIImageJPEGRepresentation</span>(image, <span class="number">0.6</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSURLSessionUploadTask</span> *uploadTask =</span><br><span class="line">  [upLoadSession uploadTaskWithRequest:request</span><br><span class="line">                              fromData:imageData];</span><br></pre></td></tr></table></figure>

<p>在这类任务被创建从一个会话中并且图片以NSData的形式上传。这里也可以通使用一个文件或者流的方法来进行上传。</p>
<h4 id="NSURLSessionDownloadTask"><a href="#NSURLSessionDownloadTask" class="headerlink" title="NSURLSessionDownloadTask"></a>NSURLSessionDownloadTask</h4><p><code>NSURLSessionDownloadTask</code>让通过远程服务下载文件变得超级简单，并且可以暂停和恢复下载只要你想。这个子类有别于其他两个。</p>
<ul>
<li>这个类型的任务直接写入一个临时文件。</li>
<li>在下载会话中将调用<code>URLSession:downloadTask:didWriteData:totalBytesWritten:totalBytesExpectedToWrite:</code>来更新状态信息。</li>
<li>当任务完成时，<code>URLSession:downloadTask:didFinishDownloadingToURL: </code>被调用。这就是你该保存文件从临时位置到一个永久位置的时候。</li>
<li>当下载失败或者取消时，你可以让数据重新开始下载。</li>
</ul>
<p>这个特性将极其有用当你在下载一个<code>Byte Club</code>定位 全景照片给你的设备的相机胶卷。你看到的一个下载任务例子在上面下载图片片段中。</p>
<h5 id="上述全部"><a href="#上述全部" class="headerlink" title="上述全部"></a>上述全部</h5><p>所有的上述任务被创建在一个暂停的状态；在创建一个任务时你需要调用它的继续方法像下面演示的那样：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[uploadTask resume];</span><br></pre></td></tr></table></figure>

<p>当你一次不只管理一个任务时，<code>taskIdentifier</code>接口允许你唯一标示一个在会话中的任务</p>
<p>这就是！既然你已经知道了<code>NSURLSession</code>系列的主要类，让我们尝试一下。</p>
<h4 id="Sharing-notes-with-NSURLSession"><a href="#Sharing-notes-with-NSURLSession" class="headerlink" title="Sharing notes with NSURLSession"></a>Sharing notes with NSURLSession</h4><p>OK，这不是死亡诗社，这是<code>Byte Club</code>!是时候开始看看一下这个的网络代码在起作用了。</p>
<p>你需要一个方法来给<code>Byte Club</code>的其他成员发送消息。既然你已经设置了接入token，下一步就是实例化<code>NSURLSesssion</code>对象，让后调用你的第一个Dropbox API。</p>
<h5 id="Creating-an-NSURLSession"><a href="#Creating-an-NSURLSession" class="headerlink" title="Creating an NSURLSession"></a>Creating an NSURLSession</h5><p>添加下面的接口到 <strong>NotesViewController.m</strong> 文件，就在 NSArray  *notes 行的后面：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSURLSession</span> *session;</span><br></pre></td></tr></table></figure>

<p>你将创造所有你的下属从上面的session中。</p>
<p>添加下面的方法到<code>NotesViewController.m</code>就在<code>initWithStyle</code>方法的上面：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">id</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)aDecoder</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="variable language_">super</span> initWithCoder:aDecoder];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="comment">// 1</span></span><br><span class="line">        <span class="built_in">NSURLSessionConfiguration</span>  *config = [<span class="built_in">NSURLSessionConfiguration</span> ephemeralSessionConfiguration];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2</span></span><br><span class="line">        [config setHTTPAdditionalHeaders:@&#123;<span class="string">@&quot;Authorization&quot;</span>: [Dropbox apiAuthorizationHeader]&#125;];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3</span></span><br><span class="line">         _session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:config];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是上面代码注释的注释的解释：</p>
<ol>
<li>你的app调用 <code>initWithCoder</code>当你实例化一个控制器从一个故事版中;因此这是一个完美的时刻初始化和创建<code>NSURLSession</code>。你并不想积极缓存或者持久化这里，所有你使用<code>ephemeralSessionConfiguration</code>便利方法，它返回一个没有持久化缓存，cookies，或者认证存储的会话。这是一个”私有浏览”配置。</li>
<li>下一步，你添加授权HTTP头道配置对象中。apiAuthorizationHeader是一个我写的辅助方法，返回一个字符串，以授权制定的格式。这个字符串包含access token，token secret和你的 Dropbox App API 秘钥。记住这是必要的因为每个对 Dropbox API 的调用都需要被授权。</li>
<li>最后，你使用上面的配置创建了<code>NSURLSession</code>。</li>
</ol>
<p>会话现在准备好创建在你app中你所需要的任何网络任务。</p>
<h5 id="GET-Notes-through-the-Dropbox-API"><a href="#GET-Notes-through-the-Dropbox-API" class="headerlink" title="GET Notes through the Dropbox API"></a>GET Notes through the Dropbox API</h5><p>为了模拟一条笔记被另一个用户添加，添加任何你在设置在你的Dropbox根目录下的文件夹中选择的文本文件。例如位于Dropbox文件夹下 <strong>byteclub</strong> 下面显示的 <strong>test.txt</strong>：</p>
<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1ezzkkwyf6ej20go03tglw.jpg" alt="networking14"></p>
<p>等待直到<code>Dropbox</code>确认它已经同步完你的文件，让后继续下面代码。</p>
<p>添加下面的代码到空的<code>notesOnDropBox</code>方法中在<code>NotesViewController.m</code>:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">UIApplication</span> sharedApplication].networkActivityIndicatorVisible = <span class="literal">YES</span>;</span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="built_in">NSURL</span> *url = [Dropbox appRootURL];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="built_in">NSURLSessionDataTask</span> *dataTask =</span><br><span class="line">[<span class="keyword">self</span>.session dataTaskWithURL:url</span><br><span class="line">            completionHandler:^(<span class="built_in">NSData</span>  *data,</span><br><span class="line">                                <span class="built_in">NSURLResponse</span>  *response,</span><br><span class="line">                                <span class="built_in">NSError</span>  *error) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!error) &#123;            </span><br><span class="line">        <span class="comment">// TODO 1: More coming here!</span></span><br><span class="line">    &#125;                </span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3  </span></span><br><span class="line">[dataTask resume];</span><br></pre></td></tr></table></figure>

<p>这个方法的目标是检索在app的Dropbox文件下的文件列表。让我们来重温一下这是怎样工作的一步步。</p>
<ol>
<li>在Dropbox中，你能看到一个文件夹的内容通过进行一个已经授权的<code>GET</code>请求到某个特别的URL - 像<a target="_blank" rel="noopener" href="https://api.dropbox.com/1/metadata/dropbox/byteclub">https://api.dropbox.com/1/metadata/dropbox/byteclub</a>. 我已经创建了一个便利的方法在Dropbox类中来为你产生这个URL。</li>
<li><code>NSURLSession</code>用便利构造方法来简单的创建各种类型的任务。这是你创建的一个数据任务为了执行一个GET请求到那个URL。当请求完成时，你的<code>completionHandler</code> block被调用。一会儿你将添加一下代码到这里。</li>
<li>记住一个任务默认是一个<code>暂停</code>的状态,因此你需要调用恢复方法来启动运行。</li>
</ol>
<p>那就是所有你需要做的来开始一个<code>GET</code>请求-现在让我们添加代码到解析的结果中。添加下面的这些行到”TUDO 1”注释的后面:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="built_in">NSHTTPURLResponse</span> *httpResp = (<span class="built_in">NSHTTPURLResponse</span> *) response;</span><br><span class="line"><span class="keyword">if</span> (httpResp.statusCode == <span class="number">200</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSError</span>  *jsonError;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">    <span class="built_in">NSDictionary</span>  *notesJSON =</span><br><span class="line">      [<span class="built_in">NSJSONSerialization</span> JSONObjectWithData:data                                                                        </span><br><span class="line">        options:<span class="built_in">NSJSONReadingAllowFragments</span>                                                                             </span><br><span class="line">        error:&amp;jsonError];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableArray</span>  *notesFound = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!jsonError) &#123;                    </span><br><span class="line">        <span class="comment">// TODO 2: More coming here!</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是两个主要的部分:</p>
<ol>
<li><p>你知道你已经发送一个HTTP请求，所以响应将是一个HTTPP响应。因此这里你可以抛出<code>NSURLResponse</code>到一个<code>NSHTTPURLRequest</code>响应以便你能够接入到接口的状态码。<br>假如你收到了一个HTTP状态码200，然后一切正常。</p>
<p> HTTP 错误码举例：</p>
<ul>
<li>400 - 输入参数错误。错误消息将表明那个和为什么错误。</li>
<li>401 - token错误或者失效。这个可能发生假如用户或者<code>Dropbox</code>被撤销或者接入token过期。你可以通过重新授权修复这个用户。</li>
<li>403 - 错误的授权请求（错误的用户键，坏的随机数，时间戳过期…）。不信的是，重新授权用户在这里并没有用。</li>
<li>404 - 指定路径下的文件或者文件夹没找到。</li>
<li>405 - 未知的请求方法（通常应该是 GET 或者 POST）。</li>
<li>429 - 你的app发送太多请求超出了限制的速率，429能够触发在每个app或者每个用户根部。</li>
<li>503 - 假如响应包括重发后的头，这就意味做你的<code>OAuth</code> 1.0 app 正在被限速。否则，这个表明了一个短暂的服务器错误，并且你的app应该重新发送这这个请求。</li>
<li>507 - 用户超出 Dropbox 储存配额。</li>
<li>5xx - 服务器错误。</li>
</ul>
</li>
<li><p>Dropbox API返回JSON类型的数据。所有你收到一个200的响应，然后应该把数据转发成JSON使用iOS的构建JSON序列化的方法。了解更多关于JSON和NSJSONSerialization，查看第23章在 <code>iOS 5 by Tutorials</code>,”Working with JSON.”</p>
</li>
</ol>
<p>JSON 数据返回从Dropbox将看起来像下面这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;hash&quot;: &quot;6a29b68d106bda4473ffdaf2e94c4b61&quot;,</span><br><span class="line">    &quot;revision&quot;: 73052,</span><br><span class="line">    &quot;rev&quot;: &quot;11d5c00e1cf6c&quot;,</span><br><span class="line">    &quot;thumb_exists&quot;: false,</span><br><span class="line">    &quot;bytes&quot;: 0,</span><br><span class="line">    &quot;modified&quot;: &quot;Sat, 10 Aug 2013 21:56:50 +0000&quot;,</span><br><span class="line">    &quot;path&quot;: &quot;/byteclub&quot;,</span><br><span class="line">    &quot;is_dir&quot;: true,</span><br><span class="line">    &quot;icon&quot;: &quot;folder&quot;,</span><br><span class="line">    &quot;root&quot;: &quot;dropbox&quot;,</span><br><span class="line">    &quot;contents&quot;: [&#123;</span><br><span class="line">        &quot;revision&quot;: 73054,</span><br><span class="line">        &quot;rev&quot;: &quot;11d5e00e1cf6c&quot;,</span><br><span class="line">        &quot;thumb_exists&quot;: false,</span><br><span class="line">        &quot;bytes&quot;: 16,</span><br><span class="line">        &quot;modified&quot;: &quot;Sat, 10 Aug 2013 23:21:03 +0000&quot;,</span><br><span class="line">        &quot;client_mtime&quot;: &quot;Sat, 10 Aug 2013 23:21:02 +0000&quot;,</span><br><span class="line">        &quot;path&quot;: &quot;/byteclub/test.txt&quot;,</span><br><span class="line">        &quot;is_dir&quot;: false,</span><br><span class="line">        &quot;icon&quot;: &quot;page_white_text&quot;,</span><br><span class="line">        &quot;root&quot;: &quot;dropbox&quot;,</span><br><span class="line">        &quot;mime_type&quot;: &quot;text/plain&quot;,</span><br><span class="line">        &quot;size&quot;: &quot;16 bytes&quot;</span><br><span class="line">    &#125;],</span><br><span class="line">    &quot;size&quot;: &quot;0 bytes&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所有最后一段添加的代码是拉取的部分你感兴趣的从JSON中。特别的，你想循环遍历“contents”数组来把“is_dir”设置成<code>false</code>。</p>
<p>这样做，添加下面的代码到“TODO 2”注释后面：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="built_in">NSArray</span> *contentsOfRootDirectory = notesJSON[<span class="string">@&quot;contents&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSDictionary</span> *data <span class="keyword">in</span> contentsOfRootDirectory) &#123;</span><br><span class="line">    <span class="keyword">if</span> (![data[<span class="string">@&quot;is_dir&quot;</span>] boolValue]) &#123;</span><br><span class="line">        DBFile  *note = [[DBFile alloc] initWithJSONData:data];</span><br><span class="line">        [notesFound addObject:note];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[notesFound sortUsingComparator:</span><br><span class="line">  ^<span class="built_in">NSComparisonResult</span>(<span class="type">id</span> obj1, <span class="type">id</span> obj2) &#123;</span><br><span class="line">    <span class="keyword">return</span> [obj1 compare:obj2];                    </span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.notes = notesFound;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 6</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    [<span class="built_in">UIApplication</span> sharedApplication].networkActivityIndicatorVisible = <span class="literal">NO</span>;</span><br><span class="line">    [<span class="keyword">self</span>.tableView reloadData];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这里有两部分：</p>
<ol>
<li><p>你拉取数组对象从“contents”键中，让后循环便利数组。每个数组入口是一个文件，所以你创建一个相应的<code>DBFile</code>文件模型为每一个文件。</p>
<p> <code>DBFile</code>是一个我为你创建的辅助类，为了拉取信息从一个JSON字典到一个文件中 - 轻轻一瞥就能看到它是怎样工作的。</p>
<p> 当你完成时，你添加所有的笔记到<code>self.notes</code>接口中。表视图被设置来显示数组中的任何记录。</p>
</li>
</ol>
<p>既然你的表视图数据源已经更新了，你需要重载表的数据。无论何时你正在处理异步网络请求时，你必须保证更新UIKit在主线程。</p>
<p>机敏的读者将会注意到在上述代码中没有错误处理；假如你感觉你像一个哭丧女（大多数Byte Club 都是！）添加一些代码在这里（在随后的代码块中你将添加），代码在错误和警告用户的时候将重试。</p>
<p>构建运行你的app；你应该看你添加到你的<code>Dropbox</code>文件夹的文件是否显示在列表中，就像下面例子一样显示：</p>
<p><img src="http://ww2.sinaimg.cn/mw690/64124373gw1ezzmc48hezj20aa0gojs1.jpg" alt="networking16"></p>
<p>事情本来是小事，当时这证明了你正确的调用了Dropbox API。</p>
<p>下一步是发布比较然后向其他俱乐部成员发起挑战，再一次使用Dropbox API 就当你是传送机构。</p>
<h5 id="POST-Notes-through-the-Dropbox-API"><a href="#POST-Notes-through-the-Dropbox-API" class="headerlink" title="POST Notes through the Dropbox API"></a>POST Notes through the Dropbox API</h5><p>轻点右上角的 + 号，你将看到笔记add&#x2F;edit屏幕出现，就像下面演示的一样：</p>
<p><img src="http://ww4.sinaimg.cn/mw690/64124373gw1ezzmc5whzij20a90gojru.jpg" alt="networking17"></p>
<p>开始的app已经安装了DBFile 模型对象到NoteDetailsViewController在<code>prepareForSegue:sender:</code>方法中：</p>
<p>加入你瞥一眼这个方法，你将看到<code>NoteViewController</code>被设置成<code>NoteDetailsViewController</code>的代理。这种方法，<code>NoteDetailsViewController</code>能够通知<code>NoteViewController</code>当用户完成编辑一篇笔记或者取消编辑一篇笔记时。</p>
<p>打开<code>NotesViewController.m </code>,添加下面这行到<code>prepareForSegue:sender:</code>中，就在<code>showNote.delegate = self</code>行的后面；</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showNote.session = _session;</span><br></pre></td></tr></table></figure>

<p><code>NoteDetailsViewController</code>已经有一个<code>NSURLSession</code>的接口名字叫做<code>session</code>,因此你能够设置它在<code>prepareForSegue:sender: </code>载入之前。</p>
<p>现在detail view controller将获得相同的<code>NSURLSession</code>,所有detail view controller能够使用它来进行DropBox 的API调用。</p>
<p><code>Cancel</code>和<code>Done</code>按钮已经呈现在你的app中；你只需要添加一些在他们背后保存或者取消在尚未完工的笔记逻辑。</p>
<p>在<code>NoteDetailsViewController.m</code>,找到下面这一行在<code>(IBAction)done:(id)sender:</code>方法中：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// - UPLOAD FILE TO DROPBOX - //</span></span><br><span class="line">    [<span class="keyword">self</span>.delegate noteDetailsViewControllerDoneWithDetails:<span class="keyword">self</span>];</span><br></pre></td></tr></table></figure>

<p>…用下面的替换它：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="built_in">NSURL</span>  *url = [Dropbox uploadURLForPath: _note.path];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="built_in">NSMutableURLRequest</span> *request =</span><br><span class="line">  [[<span class="built_in">NSMutableURLRequest</span> alloc] initWithURL:url];</span><br><span class="line">[request setHTTPMethod:<span class="string">@&quot;PUT&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line"><span class="built_in">NSData</span> *noteContents = [_note.contents dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line"><span class="built_in">NSURLSessionUploadTask</span> *uploadTask = [_session      </span><br><span class="line">  uploadTaskWithRequest:request                                                                  </span><br><span class="line">  fromData:noteContents                                                        </span><br><span class="line">  completionHandler:^(<span class="built_in">NSData</span> *data,                                                                             </span><br><span class="line">  <span class="built_in">NSURLResponse</span> *response,                                                                               </span><br><span class="line">  <span class="built_in">NSError</span> *error)</span><br><span class="line">&#123;   </span><br><span class="line">   <span class="built_in">NSHTTPURLResponse</span> *httpResp = (<span class="built_in">NSHTTPURLResponse</span>*) response;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!error &amp;&amp; httpResp.statusCode == <span class="number">200</span>) &#123;</span><br><span class="line"></span><br><span class="line">       [<span class="keyword">self</span>.delegate noteDetailsViewControllerDoneWithDetails:<span class="keyword">self</span>];</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="comment">// alert for error saving / updating note</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5</span></span><br><span class="line">[uploadTask resume];</span><br></pre></td></tr></table></figure>

<p>这个实现了你需要保存和分享你的笔记的所有事情。假如仔细观察每一块的注释，你将发现做了下面的事：</p>
<ol>
<li>为了上传一个文件到Dropbox，你需要再次使用某个API URL。就像先前你需要一个URL来列出在一个文件夹中的文件，我已经构造了一个辅助方法来为你产生URL。你可以在这里调用。</li>
<li>下一步是你的老朋友<code>NSMutableURLRequest</code>,新的APIs能够同时使用普通的URL是和<code>NSURLRequest</code>对象，但是这里你需要可变的形式来使Dropbox API让它的请求变成PUT请求。设置HTTP方法作为PUT发信号给Dropbox来让它为你创建一个新的文件。</li>
<li>下一步是将文本从你的<code>UITextView</code>编码成NSData对象。</li>
<li>既然你已经创建好了请求和NSData数据，你下一步就是创建一个<code>NSURLSessionUploadTask</code>然后设置<code>completion handler</code> block.一旦成功，你就调用代理方法<code> noteDetailsViewControllerDoneWithDetails:</code>来关闭呈现的内容。在生产级别的应用中你可以回传一个新的BDFile给代理然后同步你需要持久化的数据。为了这个应用，你只需要刷新<code>NotesViewController </code>用一个网络调用。</li>
<li>再次提到，所有的任务以暂停的状态被创建，所以你必须调用恢复来启动他们。</li>
</ol>
<p>构建然后运行你的App，点击笔记标签上的+号。在<code>challenge name</code>字段上输入你的名字，输入一些文本在<code>note</code>字段想Ray发布一份挑战书，和下面的例子相似：</p>
<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1f008ujjji0j20aa0godgy.jpg" alt="networking17"></p>
<p>当你清点<code>Done</code>时，<code>NoteViewController</code>将返回并且给你列出新的笔记像下面显示的那样：</p>
<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1f008ukjg7bj20aa0go3z4.jpg" alt="networking18"><br>)</p>
<p>你已经正式的给Ray下发挑战书；然而，他有朋友在非常高的位置所有你最好尽力完成这场比赛。</p>
<p>但是这里有一条非常重要的消息遗漏了。你能告诉我是什么么？</p>
<p>轻点笔记包含的挑战；<code>NoteDetailsViewController</code>自己呈现，当时笔记的内容确实空白的。</p>
<p>Ray并不会找到你的发的非常有威胁的挑战假如他没有读的话！</p>
<p>现在，app只是调用<code>Dropbox</code>元数据API来检索文件列表。你也需要添加一些代码来抓取笔记的内容。</p>
<p>打开<code>NoteDetailsViewController.m</code>,用下面的实现替换空白的<code>retreiveNoteText</code>的实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="type">void</span>)retreiveNoteText</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">NSString</span>  *fileApi =</span><br><span class="line">      <span class="string">@&quot;https://api-content.dropbox.com/1/files/dropbox&quot;</span>;</span><br><span class="line">    <span class="built_in">NSString</span>  *escapedPath = [ _note.path</span><br><span class="line">      stringByAddingPercentEscapesUsingEncoding:</span><br><span class="line">      <span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSString</span>  *urlStr = [<span class="built_in">NSString</span> stringWithFormat: <span class="string">@&quot;%@/%@&quot;</span>,</span><br><span class="line">      fileApi,escapedPath];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSURL</span>  *url = [<span class="built_in">NSURL</span> URLWithString: urlStr];</span><br><span class="line"></span><br><span class="line">    [<span class="built_in">UIApplication</span> sharedApplication].networkActivityIndicatorVisible = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">    [[ _session dataTaskWithURL:url completionHandler:^(<span class="built_in">NSData</span>  *data, <span class="built_in">NSURLResponse</span>  *response, <span class="built_in">NSError</span>  *error) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">            <span class="built_in">NSHTTPURLResponse</span>  *httpResp = (<span class="built_in">NSHTTPURLResponse</span>*) response;</span><br><span class="line">            <span class="keyword">if</span> (httpResp.statusCode == <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="comment">// 3</span></span><br><span class="line">                <span class="built_in">NSString</span>  *text =</span><br><span class="line">                 [[<span class="built_in">NSString</span> alloc]initWithData:data</span><br><span class="line">                   encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">                <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                    [<span class="built_in">UIApplication</span> sharedApplication].networkActivityIndicatorVisible = <span class="literal">NO</span>;</span><br><span class="line">                    <span class="keyword">self</span>.textView.text = text;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// HANDLE BAD RESPONSE //</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ALWAYS HANDLE ERRORS :-] //</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4</span></span><br><span class="line">    &#125;] resume];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面在笔记中的代码（没有错误检查）下面来解释：</p>
<ol>
<li>设置请求的路径和你期望检索的文件的URL地址；&#x2F;文件的端点在Dropbox API中将会返回给你一个指定文件的内容。</li>
<li>用指向感兴趣的文件的URL创建数据任务。这个调用应该开始，只要你纵览整个app你会相当熟悉。</li>
<li>假如你响应的代码表明所有的都是好的，在主线程用你在先前的步骤中检索到的文件内容设置textView。记住，UI更新必须切换到主线程。</li>
<li>一旦这个任务被初始化，调用恢复。这里有写不一样的方法和以前的相比，当恢复被直接调用时在任务还没有指派时。</li>
</ol>
<p>构建运行你的App，在列表中对你的挑战轻点，内容将直接正确的显示在view中，像下面这样：</p>
<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1f008ulhco4j20a90got9d.jpg" alt="networking19"></p>
<p>你可以扮演Ray然后通过向笔记中输入文本响应这个挑战；文件将很快更新当你轻点<code>Done</code>。</p>
<h4 id="使用NSURLSessionTask代理发送照片"><a href="#使用NSURLSessionTask代理发送照片" class="headerlink" title="使用NSURLSessionTask代理发送照片"></a>使用<code>NSURLSessionTask</code>代理发送照片</h4><p>你已经看到怎样使用<code>NSURLSession</code>异步便利构造方法。但是假如你想把注意力集中在文件传输上，例如上传一个大文件并且显示一个进度条怎么样？</p>
<p>对于这种异步的，耗时任务类型你需要实现<code>NSURLSessionTaskDelegate</code>协议方。通过实现这个方法，你能够检索回调当一个任务接收到数据和完成接收数据时。</p>
<p>你可能已经注意到<code>PanoPhotos</code>标签是空的当你启动App的时候。然而，<code>Byte Club</code>组织的创办成员已经慷慨的提供了一些他们自己的全景照片，你可以用它来填充你的app。</p>
<p>下载这些 我们为你放在一起的<a target="_blank" rel="noopener" href="http://cdn4.raywenderlich.com/downloads/ByteClub_photos.zip">全景照片</a>。解压文件，拷贝到你的app在Dropbox目录下的照片目录。你文件夹的内容应该和下面一样：</p>
<p><img src="http://ww3.sinaimg.cn/mw690/64124373gw1f00a5m7rhhj20go06ddhi.jpg" alt="networking20"></p>
<p>Dropbox和核心API可以提供照片的缩略图；使用一个 UITableView cell这听起来想一件非常完美的事。</p>
<p>打开<code> PhotosViewController.m</code>然后在<code>“GO GET THUMBNAILS</code>注释后面添加下面的代码到<code>tableView:cellForRowAtIndexPath: </code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">UIApplication</span> sharedApplication].networkActivityIndicatorVisible = <span class="literal">YES</span>;</span><br><span class="line"><span class="built_in">NSURLSessionDataTask</span> *dataTask = [_session dataTaskWithURL:url</span><br><span class="line">  completionHandler:^(<span class="built_in">NSData</span>  *data, <span class="built_in">NSURLResponse</span>  *response,</span><br><span class="line">  <span class="built_in">NSError</span>  *error) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">      <span class="built_in">UIImage</span>  *image = [[<span class="built_in">UIImage</span> alloc] initWithData:data];</span><br><span class="line">      photo.thumbNail = image;</span><br><span class="line">      <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        [<span class="built_in">UIApplication</span> sharedApplication].networkActivityIndicatorVisible = <span class="literal">NO</span>;</span><br><span class="line">        cell.thumbnailImage.image = photo.thumbNail;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// HANDLE ERROR //</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br><span class="line">[dataTask resume];</span><br></pre></td></tr></table></figure>

<p>上面的代码显示了照片的缩略图图在表视图的cell中。。。或者至少它会是，假如<code>_photoThumbnails</code>现在不是空的话。</p>
<p>找到<code>refreshPhotos</code>用下面的实现替换：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)refreshPhotos</span><br><span class="line">&#123;</span><br><span class="line">    [[<span class="built_in">UIApplication</span> sharedApplication] setNetworkActivityIndicatorVisible:<span class="literal">YES</span>];</span><br><span class="line">    <span class="built_in">NSString</span>  *photoDir = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;https://api.dropbox.com/1/search/dropbox/%@/photos?query=.jpg&quot;</span>,appFolder];</span><br><span class="line">    <span class="built_in">NSURL</span>  *url = [<span class="built_in">NSURL</span> URLWithString:photoDir];</span><br><span class="line"></span><br><span class="line">    [[ _session dataTaskWithURL:url completionHandler:^(<span class="built_in">NSData</span></span><br><span class="line">       *data, <span class="built_in">NSURLResponse</span>  *response, <span class="built_in">NSError</span>  *error) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">            <span class="built_in">NSHTTPURLResponse</span>  *httpResp =</span><br><span class="line">             (<span class="built_in">NSHTTPURLResponse</span>*) response;</span><br><span class="line">            <span class="keyword">if</span> (httpResp.statusCode == <span class="number">200</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">NSError</span>  *jsonError;</span><br><span class="line">                <span class="built_in">NSArray</span>  *filesJSON = [<span class="built_in">NSJSONSerialization</span>  </span><br><span class="line">                  JSONObjectWithData:data                                                                     </span><br><span class="line">                  options:<span class="built_in">NSJSONReadingAllowFragments</span>                                                                           </span><br><span class="line">                  error:&amp;jsonError];</span><br><span class="line">                <span class="built_in">NSMutableArray</span>  *dbFiles =</span><br><span class="line">                  [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!jsonError) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">NSDictionary</span>  *fileMetadata <span class="keyword">in</span></span><br><span class="line">                      filesJSON) &#123;</span><br><span class="line">                        DBFile  *file = [[DBFile alloc]</span><br><span class="line">                          initWithJSONData:fileMetadata];</span><br><span class="line">                        [dbFiles addObject:file];</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    [dbFiles sortUsingComparator:^<span class="built_in">NSComparisonResult</span>(<span class="type">id</span> obj1, <span class="type">id</span> obj2) &#123;</span><br><span class="line">                        <span class="keyword">return</span> [obj1 compare:obj2];</span><br><span class="line">                    &#125;];</span><br><span class="line"></span><br><span class="line">                     _photoThumbnails = dbFiles;</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                        [[<span class="built_in">UIApplication</span> sharedApplication] setNetworkActivityIndicatorVisible:<span class="literal">NO</span>];</span><br><span class="line">                        [<span class="keyword">self</span>.tableView reloadData];</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// HANDLE BAD RESPONSE //</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ALWAYS HANDLE ERRORS :-] //</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;] resume];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个和你早期载入挑战笔记时写的代码很像。这次，API调用来查找在<code>photos</code>目录的内容，并且只会以.jpg拓展的文件。</p>
<p>既然<code>_photoThumbnails</code>数组已经填充好了，缩略图将出现在表视图中并且异步更新。</p>
<p>构建运行你的app，然后切换到<code>PanoPhotos</code>标签；缩略图将载入并且像下面这样出现：</p>
<p>！<a target="_blank" rel="noopener" href="http://ww2.sinaimg.cn/mw690/64124373gw1f00ahhaw20j20a90go0uz.jpg">networking21</a></p>
<p>照片看起来非常的棒–只是请当心Matthijs家撕裂代码的猫🐱！</p>
<h4 id="上传一张全景照片"><a href="#上传一张全景照片" class="headerlink" title="上传一张全景照片"></a>上传一张全景照片</h4><p>你的app能够下载相片，如果它也能上传照片并且显示上传进度的话就非常棒了。</p>
<p>为了跟踪上传的进度，<code>PhotosViewController</code>必须成为<code>NSURLSessionDelegate</code>和<code>NSURLSessionTaskDelegate</code>协议的代理，以便你能收到进度回调。</p>
<p>修改在<code>PhotosViewController.m</code>中<code>PhotosViewController</code>的接口声明，添加<code>NSURLSessionTaskDelegate</code>,像下面这样：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@ interface PhotosViewController ()<span class="built_in">UITableViewDelegate</span>, <span class="built_in">UITableViewDataSource</span>, <span class="built_in">UIImagePickerControllerDelegate</span>, <span class="built_in">UINavigationControllerDelegate</span>, <span class="built_in">NSURLSessionTaskDelegate</span>&gt;</span><br></pre></td></tr></table></figure>

<p>下一步，添加下面的私有接口：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>)</span><br><span class="line">  <span class="built_in">NSURLSessionUploadTask</span> *uploadTask;</span><br></pre></td></tr></table></figure>

<p>上面的指针引用了任务对象；通过哪种方式，你就可以接入到对象的成员中来跟踪上传任务的进度了。</p>
<p>当用户选择一张图片上传时，<code>didFinishPickingMediaWithInfo</code>调用<code>uploadImage:</code>方法来执行文件上传。<br>现在，那个方法空了-这是你的工作让它丰满起来。</p>
<p>替换<code>uploadImage: </code>用下面的代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)uploadImage:(<span class="built_in">UIImage</span>*)image</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSData</span>  *imageData = <span class="built_in">UIImageJPEGRepresentation</span>(image, <span class="number">0.6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">NSURLSessionConfiguration</span>  *config = [<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration];</span><br><span class="line">    config.HTTPMaximumConnectionsPerHost = <span class="number">1</span>;</span><br><span class="line">    [config setHTTPAdditionalHeaders:@&#123;<span class="string">@&quot;Authorization&quot;</span>: [Dropbox apiAuthorizationHeader]&#125;];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">    <span class="built_in">NSURLSession</span>  *upLoadSession = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:config delegate:<span class="keyword">self</span> delegateQueue:<span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// for now just create a random file name, dropbox will handle it if we overwrite a file and create a new name..</span></span><br><span class="line">    <span class="built_in">NSURL</span>  *url = [Dropbox createPhotoUploadURL];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span>  *request = [[<span class="built_in">NSMutableURLRequest</span> alloc] initWithURL:url];</span><br><span class="line">    [request setHTTPMethod:<span class="string">@&quot;PUT&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3</span></span><br><span class="line">    <span class="keyword">self</span>.uploadTask = [upLoadSession uploadTaskWithRequest:request fromData:imageData];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4</span></span><br><span class="line">    <span class="keyword">self</span>.uploadView.hidden = <span class="literal">NO</span>;</span><br><span class="line">    [[<span class="built_in">UIApplication</span> sharedApplication] setNetworkActivityIndicatorVisible:<span class="literal">YES</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5</span></span><br><span class="line">    [ _uploadTask resume];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是上面的代码做的事：</p>
<ol>
<li>起先，你使用设置在<code>initWithCoder</code>的会话和相关的便利方法来创建异步任务。这个时候，你使用一个<code>NSURLSessionConfiguration </code>,它只允许一个连接连接到远程主机，因为你上传进度处理一次就是一个文件。</li>
<li>上传和下载任务报告信息通过它们的代理返回；你将简短的实现。</li>
<li>这里你设置了<code>uploadTask</code>接口使用从<code>UIImagePicker</code>获得的JPEG图片。</li>
<li>下一步，你显示<code>UIProgressView</code>让它隐藏在<code>PhotosViewController</code>内部。</li>
<li>开始任务–额，抱歉，是恢复任务。</li>
</ol>
<p>既然代理已经设置了，你就可以实现<code>NSURLSessionTaskDelegate</code>方法来更新进度视图。</p>
<p>添加下面的代码到<code> PhotosViewController.m</code>文件末尾：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> mark - NSURLSessionTaskDelegate methods</span></span><br><span class="line"></span><br><span class="line">- (<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">  task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">  didSendBodyData:(int64_t)bytesSent</span><br><span class="line">  totalBytesSent:(int64_t)totalBytesSent</span><br><span class="line">  totalBytesExpectedToSend:(int64_t)totalBytesExpectedToSend</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        [ _progress setProgress:</span><br><span class="line">          (<span class="type">double</span>)totalBytesSent /</span><br><span class="line">          (<span class="type">double</span>)totalBytesExpectedToSend animated:<span class="literal">YES</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代理方法将定期报告信息给调用者关于上传任务的信息。它同时会更新<code>UIProgressView</code>（ _progress）的进度以便显示 totalBytesSent&#x2F;totalBytesExpectedToSend,这比显示一个完成的百分比跟有意义（也更极客）。</p>
<p>剩下唯一的事就是当上传任务结束时指示一下。添加下面的代码到<code> PhotosViewController.m</code>文件末尾：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session task:(<span class="built_in">NSURLSessionTask</span> *)task didCompleteWithError:(<span class="built_in">NSError</span> *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1</span></span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        [[<span class="built_in">UIApplication</span> sharedApplication] setNetworkActivityIndicatorVisible:<span class="literal">NO</span>];</span><br><span class="line">         _uploadView.hidden = <span class="literal">YES</span>;</span><br><span class="line">        [ _progress setProgress:<span class="number">0.5</span>];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!error) &#123;</span><br><span class="line">        <span class="comment">// 2</span></span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [<span class="keyword">self</span> refreshPhotos];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Alert for error</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里没有很多代码，但是它执行了两项非常重要的任务：</p>
<ol>
<li>打开网络指示器，然后隐藏<code>_uploadView</code>作为上传完成的一点点清理工作。</li>
<li>刷新<code>PhotosViewController</code>以便包含你刚刚上传的照片，由于demo app是不能进行任何本地储存的上传<br>。在一个真正的app中，你应该把图片在本地进行储存和缓存。</li>
</ol>
<p>构建运行你的app，导航到<code>PanoPhotos</code>标签，点击照相图标选择一张照片。</p>
<p><img src="http://ww4.sinaimg.cn/mw690/64124373gw1f00bn13wq4j20di09ojs2.jpg" alt="networking22"></p>
<blockquote>
<p>注意：假如你说使用模拟器测试app，很显然你不能用你的Mac拍照，所有仅仅是拷贝一张全景照片<br>给模拟器然后上传。这样做，可以确保没有其他的Xcode工程现在连接到这个模拟器，在Xcode中选择 <strong>Xcode   Open Developer Tool   iOS Simulator</strong>。</p>
</blockquote>
<blockquote>
<p>从Finder中拖拽一张全景照片带模拟器中，在模拟器中图片将会在Safari中打开。长按图片然后保存图片到图库中。</p>
</blockquote>
<p>在选择一张图片后上传，uploadView显示在屏幕的中央，并且带有上传进度，乡下面这一样显示：</p>
<p>！<a target="_blank" rel="noopener" href="http://ww1.sinaimg.cn/mw690/64124373gw1f00bn4hmqwj209e0gomzu.jpg">networking23</a></p>
<p>你可能注意到一张图片上传需要花一些时间由于上传任务设置了<code>better quality</code>缩放因子。对于那些A类性格的人，你应该提供一个取消函数假如上传花费太长的时间。</p>
<p>取消按钮在<code>uploadView</code>已经被封装起来在故事板中，所有你只需实现清楚逻辑来杀死下载操作就行。</p>
<p>用下面的代码替换<code> PhotosViewController.m</code>的<code>cancelUpload: </code>：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">IBAction</span>)cancelUpload:(<span class="type">id</span>)sender &#123;    </span><br><span class="line">    <span class="keyword">if</span> ( _uploadTask.state == <span class="built_in">NSURLSessionTaskStateRunning</span>) &#123;</span><br><span class="line">        [ _uploadTask cancel];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这类你会看到，取消一个任务相当简单就是调用一个取消方法。</p>
<p>现在构建运行你的app，选择一张照片上传然后点击<code>Cancel</code>。图片上传将会停止并且<code>uploadView</code>将会被隐藏。</p>
<p>就这样–<code>Byte Club</code>完成了！</p>
<h4 id="何去何从？"><a href="#何去何从？" class="headerlink" title="何去何从？"></a>何去何从？</h4><p>这里是<a target="_blank" rel="noopener" href="http://cdn5.raywenderlich.com/downloads/ByteClub_Completed.zip">完成的工程</a>在这个<code>NSURLSession</code>教程中。</p>
<p>假如你做到这一步，恭喜你可以享受到<code>Byte Club</code>的时光！不要告诉任何<code>Android</code>的小伙伴们！ :]<br>你现在能够处理在你app需要的任何网络任务了。</p>
<p>假如你喜欢这个课程，你可能想要查阅我们的新书<a target="_blank" rel="noopener" href="http://www.raywenderlich.com/?page_id=48020"> iOS 7 by Tutorials</a>,这是这本书的一个简略版本，这本书几乎涵盖了在iOS 7中最新和最多的APIs，这些你应该清楚的知道作为一个开发者。</p>
<p>我几乎忘记了。。。</p>
<pre><code>/slap &lt;you the reader&gt; have been slapped around a bit with a large trout.
</code></pre>
<p>（不要问我为什么 hehe！😄）</p>
<p>假如你有任何问题或者评论关于这个教程或者<code>NSURLSession</code>,请加入到下面的论坛讨论！</p>
<p>参考资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://objccn.io/issue-5-4/">从 NSURLConnection 到 NSURLSession</a></li>
<li><a target="_blank" rel="noopener" href="http://www.raywenderlich.com/51127/nsurlsession-tutorial">NSURLSession Tutorial</a></li>
</ul>
<p>译者注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com/">http://blog.wangruofeng007.com</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/14/2016-01-14-iosxian-cheng-an-quan-suo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/14/2016-01-14-iosxian-cheng-an-quan-suo/" class="post-title-link" itemprop="url">iOS 线程安全-锁</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-14 02:08:36" itemprop="dateCreated datePublished" datetime="2016-01-14T02:08:36+08:00">2016-01-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 16:29:10" itemprop="dateModified" datetime="2024-11-02T16:29:10+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>777</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Objective－C"><a href="#Objective－C" class="headerlink" title="Objective－C"></a>Objective－C</h2><h3 id="使用-synchronized-类实现锁"><a href="#使用-synchronized-类实现锁" class="headerlink" title="使用 @synchronized 类实现锁"></a><strong>使用 @synchronized 类实现锁</strong></h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实例类person</span></span><br><span class="line">Person *person = [[Person alloc] init];</span><br><span class="line"><span class="comment">// 线程A</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">    <span class="keyword">@synchronized</span>(person) &#123;</span><br><span class="line">        [person personA];</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">        <span class="comment">// 线程休眠3秒</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 线程B</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">    <span class="keyword">@synchronized</span>(person) &#123;</span><br><span class="line">        [person personB];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用-NSRecursiveLock-类实现锁"><a href="#使用-NSRecursiveLock-类实现锁" class="headerlink" title="使用 NSRecursiveLock 类实现锁"></a><strong>使用 NSRecursiveLock 类实现锁</strong></h3><blockquote>
<p>递归锁，递归或循环方法时使用此方法实现锁，可避免死锁等问题</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实例类person</span></span><br><span class="line">Person *person = [[Person alloc] init];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建锁对象</span></span><br><span class="line"><span class="built_in">NSRecursiveLock</span> *theLock = [[<span class="built_in">NSRecursiveLock</span> alloc] init];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建递归方法</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">void</span> (^testCode)(<span class="type">int</span>);</span><br><span class="line">testCode = ^(<span class="type">int</span> value) &#123;</span><br><span class="line">    [theLock tryLock];</span><br><span class="line">    <span class="keyword">if</span> (value &gt; <span class="number">0</span>)  &#123;</span><br><span class="line">        [person personA];</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">1</span>];</span><br><span class="line">        testCode(value - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    [theLock unlock];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程A</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">    testCode(<span class="number">5</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//线程B</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">    [theLock lock];</span><br><span class="line">    [person personB];</span><br><span class="line">    [theLock unlock];</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用-NSConditionLock（条件锁）类实现锁"><a href="#使用-NSConditionLock（条件锁）类实现锁" class="headerlink" title="使用 NSConditionLock（条件锁）类实现锁"></a><strong>使用 NSConditionLock（条件锁）类实现锁</strong></h3><blockquote>
<p>使用此方法可以指定，只有满足条件的时候才可以解锁</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实例类person</span></span><br><span class="line">Person *person = [[Person alloc] init];</span><br><span class="line"><span class="comment">// 创建条件锁</span></span><br><span class="line"><span class="built_in">NSConditionLock</span> *conditionLock = [[<span class="built_in">NSConditionLock</span> alloc] init];</span><br><span class="line"><span class="comment">// 线程A</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">    [conditionLock lock];</span><br><span class="line">    [person personA];</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">    [conditionLock unlockWithCondition:<span class="number">10</span>];</span><br><span class="line"> &#125;);</span><br><span class="line"><span class="comment">// 线程B</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">    [conditionLock lockWhenCondition:<span class="number">10</span>];</span><br><span class="line">    [person personB];</span><br><span class="line">    [conditionLock unlock];</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="NSDistributedLock（分布式锁）"><a href="#NSDistributedLock（分布式锁）" class="headerlink" title="NSDistributedLock（分布式锁）"></a><strong>NSDistributedLock（分布式锁）</strong></h3><blockquote>
<p>在iOS中不需要用到，也没有这个方法，因此本文不作介绍，这里写出来只是想让大家知道有这个锁存在。<br>如果想要学习NSDistributedLock的话，你可以创建MAC OS的项目自己演练，方法请自行Google，谢谢</p>
</blockquote>
<h2 id="C语言"><a href="#C语言" class="headerlink" title="C语言"></a>C语言</h2><h3 id="使用-pthread-mutex-t-实现锁"><a href="#使用-pthread-mutex-t-实现锁" class="headerlink" title="使用 pthread_mutex_t 实现锁"></a><strong>使用 pthread_mutex_t 实现锁</strong></h3><blockquote>
<p>注意：必须在头文件导入：#import &lt;pthread.h&gt;</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实例类person</span></span><br><span class="line">Person *person = [[Person alloc] init];</span><br><span class="line"><span class="comment">// 创建锁对象</span></span><br><span class="line">__block pthread_mutex_t mutex;</span><br><span class="line">pthread_mutex_init(&amp;mutex, <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">// 线程A</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">    pthread_mutex_lock(&amp;mutex);</span><br><span class="line">    [person personA];</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">    pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 线程B</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">    pthread_mutex_lock(&amp;mutex);</span><br><span class="line">    [person personB];</span><br><span class="line">    pthread_mutex_unlock(&amp;mutex);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="使用-GCD-实现“锁”-信号量）"><a href="#使用-GCD-实现“锁”-信号量）" class="headerlink" title="使用 GCD 实现“锁”(信号量）"></a><strong>使用 GCD 实现“锁”(信号量）</strong></h3><blockquote>
<p>GCD提供一种信号的机制，使用它我们可以创建“锁”</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实例类person</span></span><br><span class="line">Person *person = [[Person alloc] init];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建并设置信量</span></span><br><span class="line">dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程A</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">    [person personA];</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">    dispatch_semaphore_signal(semaphore);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 线程B</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">    [person personB];</span><br><span class="line">    dispatch_semaphore_signal(semaphore);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我在这里解释一下代码。<code>dispatch_semaphore_wait</code>方法是把信号量加1，<code>dispatch_semaphore_signal</code><br>是把信号量减1。</p>
<p>我们把信号量当作是一个计数器，当计数器是一个非负整数时，所有通过它的线程都应该把这个整数减1。</p>
<p>如果计数器大于0，那么则允许访问，并把计数器减1。如果为0，则访问被禁止，所有通过它的线程都处于<br>等待的状态。</p>
<h3 id="使用POSIX（条件锁）创建锁）"><a href="#使用POSIX（条件锁）创建锁）" class="headerlink" title="使用POSIX（条件锁）创建锁）"></a><strong>使用POSIX（条件锁）创建锁）</strong></h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实例类person</span></span><br><span class="line">Person *person = [[Person alloc] init];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建互斥锁</span></span><br><span class="line"> __block pthread_mutex_t mutex;</span><br><span class="line"> pthread_mutex_init(&amp;mutex, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 创建条件锁</span></span><br><span class="line"> __block pthread_cond_t cond;</span><br><span class="line"> pthread_cond_init(&amp;cond, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 线程A</span></span><br><span class="line"> <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">     pthread_mutex_lock(&amp;mutex);</span><br><span class="line">     pthread_cond_wait(&amp;cond, &amp;mutex);</span><br><span class="line">     [person personA];</span><br><span class="line">     pthread_mutex_unlock(&amp;mutex);</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 线程B</span></span><br><span class="line"> <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">     pthread_mutex_lock(&amp;mutex);</span><br><span class="line">     [person personB];</span><br><span class="line">     [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">     pthread_cond_signal(&amp;cond);</span><br><span class="line">     pthread_mutex_unlock(&amp;mutex);</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>效果：程序会首先调用线程B，在5秒后再调用线程A。因为在线程A中创建了等待条件锁，线程B有激活锁，只有当线程B执行完后会激活线程A。</p>
<p><code>pthread_cond_wait</code>方法为等待条件锁。</p>
<p><code>pthread_cond_signal</code>方法为激活一个相同条件的条件锁。</p>
<blockquote>
<p>注意:自旋锁<code>OSSpinLock</code>已经不再线程安全</p>
</blockquote>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.liuhaihua.cn/archives/25316.html">http://www.liuhaihua.cn/archives/25316.html</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.ibireme.com/2016/01/16/spinlock_is_unsafe_in_ios/">不再安全的 OSSpinLock</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/14/2016-01-14-sqlite-jiao-cheng-qi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/14/2016-01-14-sqlite-jiao-cheng-qi/" class="post-title-link" itemprop="url">SQLite 教程(七)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-14 01:46:57" itemprop="dateCreated datePublished" datetime="2016-01-14T01:46:57+08:00">2016-01-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 16:29:15" itemprop="dateModified" datetime="2024-11-02T16:29:15+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Database/" itemprop="url" rel="index"><span itemprop="name">Database</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.4k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="SQLite-Order-By"><a href="#SQLite-Order-By" class="headerlink" title="SQLite Order By"></a>SQLite Order By</h4><p>SQLite 的 <strong>ORDER BY</strong> 子句是用来基于一个或多个列按升序或降序顺序排列数据。</p>
<hr>
<p><strong>语法</strong></p>
<p>ORDER BY 子句的基本语法如下：</p>
<pre><code>SELECT column-list
FROM table_name
[WHERE condition]
[ORDER BY column1, column2, .. columnN] [ASC | DESC];
</code></pre>
<p>您可以在 ORDER BY 子句中使用多个列。确保您使用的排序列在列清单中。</p>
<p><strong>实例</strong></p>
<p>假设 COMPANY 表有以下记录：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>
<p>下面是一个实例，它会将结果按 SALARY 升序排序：</p>
<pre><code>sqlite&gt; SELECT * FROM COMPANY ORDER BY SALARY ASC;
</code></pre>
<p>这将产生以下结果：</p>
<pre><code>    ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
7           James       24          Houston     10000.0
2           Allen       25          Texas       15000.0
1           Paul        32          California  20000.0
3           Teddy       23          Norway      20000.0
6           Kim         22          South-Hall  45000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
</code></pre>
<p>下面是一个实例，它会将结果按 NAME 和 SALARY 升序排序：</p>
<pre><code>sqlite&gt; SELECT * FROM COMPANY ORDER BY NAME, SALARY ASC;
</code></pre>
<p>这将产生以下结果：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
2           Allen       25          Texas       15000.0
5           David       27          Texas       85000.0
7           James       24          Houston     10000.0
6           Kim         22          South-Hall  45000.0
4           Mark        25          Rich-Mond   65000.0
1           Paul        32          California  20000.0
3           Teddy       23          Norway      20000.0
</code></pre>
<p>下面是一个实例，它会将结果按 NAME 降序排序：</p>
<pre><code>sqlite&gt; SELECT * FROM COMPANY ORDER BY NAME DESC;
</code></pre>
<p>这将产生以下结果：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
3           Teddy       23          Norway      20000.0
1           Paul        32          California  20000.0
4           Mark        25          Rich-Mond   65000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
5           David       27          Texas       85000.0
2           Allen       25          Texas       15000.0
</code></pre>
<h4 id="SQLite-Group-By"><a href="#SQLite-Group-By" class="headerlink" title="SQLite Group By"></a>SQLite Group By</h4><p>SQLite 的 <strong>GROUP BY</strong> 子句用于与 SELECT 语句一起使用，来对相同的数据进行分组。<br>在 SELECT 语句中，GROUP BY 子句放在 WHERE 子句之后，放在 ORDER BY 子句之前。</p>
<hr>
<p><strong>语法</strong></p>
<p>下面给出了 GROUP BY 子句的基本语法。GROUP BY 子句必须放在 WHERE 子句中的条件之后，必须放在 ORDER BY 子句之前。</p>
<pre><code>SELECT column-list
FROM table_name
WHERE [ conditions ]
GROUP BY column1, column2....columnN
ORDER BY column1, column2....columnN
</code></pre>
<p>您可以在 GROUP BY 子句中使用多个列。确保您使用的分组列在列清单中。</p>
<p><strong>实例</strong></p>
<p>假设 COMPANY 表有以下记录：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>
<p>如果您想了解每个客户的工资总额，则可使用 GROUP BY 查询，如下所示：</p>
<pre><code>sqlite&gt; SELECT NAME, SUM(SALARY) FROM COMPANY GROUP BY NAME;
</code></pre>
<p>这将产生以下结果：</p>
<pre><code>NAME        SUM(SALARY)
----------  -----------
Allen       15000
David       85000
James       20000
Kim         45000
Mark        65000
Paul        40000
Teddy       20000
</code></pre>
<p>让我们把 ORDER BY 子句与 GROUP BY 子句一起使用，如下所示：</p>
<pre><code>sqlite&gt;  SELECT NAME, SUM(SALARY)
         FROM COMPANY GROUP BY NAME ORDER BY NAME DESC;
</code></pre>
<p>这将产生以下结果：</p>
<pre><code>NAME        SUM(SALARY)
----------  -----------
Teddy       20000
Paul        40000
Mark        65000
Kim         45000
James       20000
David       85000
Allen       15000
</code></pre>
<h4 id="SQLite-Having-子句"><a href="#SQLite-Having-子句" class="headerlink" title="SQLite Having 子句"></a>SQLite Having 子句</h4><p>HAVING 子句允许指定条件来过滤将出现在最终结果中的分组结果。</p>
<p>WHERE 子句在所选列上设置条件，而 HAVING 子句则在由 GROUP BY 子句创建的分组上设置条件。</p>
<hr>
<p><strong>语法</strong></p>
<p>下面是 HAVING 子句在 SELECT 查询中的位置：</p>
<pre><code>SELECT
FROM
WHERE
GROUP BY
HAVING
ORDER BY
</code></pre>
<p>在一个查询中，HAVING 子句必须放在 GROUP BY 子句之后，必须放在 ORDER BY 子句之前。下面是包含 HAVING 子句的 SELECT 语句的语法：</p>
<pre><code>SELECT column1, column2
FROM table1, table2
WHERE [ conditions ]
GROUP BY column1, column2
HAVING [ conditions ]
ORDER BY column1, column2
</code></pre>
<p><strong>实例</strong></p>
<p>假设 COMPANY 表有以下记录：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
8           Paul        24          Houston     20000.0
9           James       44          Norway      5000.0
10          James       45          Texas       5000.0
</code></pre>
<p>下面是一个实例，它将显示名称计数小于 2 的所有记录：</p>
<pre><code>sqlite &gt; SELECT * FROM COMPANY GROUP BY name HAVING count(name) &lt; 2;
</code></pre>
<p>这将产生以下结果：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
2           Allen       25          Texas       15000
5           David       27          Texas       85000
6           Kim         22          South-Hall  45000
4           Mark        25          Rich-Mond   65000
3           Teddy       23          Norway      20000
</code></pre>
<p>下面是一个实例，它将显示名称计数大于 2 的所有记录,注意其实这里只返回最后一条记录：</p>
<pre><code>sqlite &gt; SELECT * FROM COMPANY GROUP BY name HAVING count(name) &gt; 2;
</code></pre>
<p>这将产生以下结果：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
10          James       45          Texas       5000
</code></pre>
<h4 id="SQLite-Distinct-关键字"><a href="#SQLite-Distinct-关键字" class="headerlink" title="SQLite Distinct 关键字"></a>SQLite Distinct 关键字</h4><p>SQLite 的 <strong>DISTINCT</strong> 关键字与 SELECT 语句一起使用，来消除所有重复的记录，并只获取唯一一次记录。<br>有可能出现一种情况，在一个表中有多个重复的记录。当提取这样的记录时，DISTINCT 关键字就显得特别有意义，它只获取唯一一次记录，而不是获取重复记录。</p>
<hr>
<p><strong>语法</strong></p>
<p>用于消除重复记录的 DISTINCT 关键字的基本语法如下：</p>
<pre><code>SELECT DISTINCT column1, column2,.....columnN
FROM table_name
WHERE [condition]
</code></pre>
<p><strong>实例</strong></p>
<p>假设 COMPANY 表有以下记录：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
8           Paul        24          Houston     20000.0
9           James       44          Norway      5000.0
10          James       45          Texas       5000.0
</code></pre>
<p>首先，让我们来看看下面的 SELECT 查询，它将返回重复的工资记录：</p>
<pre><code>sqlite&gt; SELECT name FROM COMPANY;
</code></pre>
<p>这将产生以下结果：</p>
<pre><code>NAME
----------
Paul
Allen
Teddy
Mark
David
Kim
James
Paul
James
James
</code></pre>
<p>现在，让我们在上述的 SELECT 查询中使用 DISTINCT 关键字：</p>
<pre><code>sqlite&gt; SELECT DISTINCT name FROM COMPANY;
</code></pre>
<p>这将产生以下结果，没有任何重复的条目：</p>
<pre><code>NAME
----------
Paul
Allen
Teddy
Mark
David
Kim
James
</code></pre>
<p>资料整理于：<a target="_blank" rel="noopener" href="http://www.runoob.com/sqlite/sqlite-tutorial.html">RUNOOB.COM-SQLite教程</a><br>转载请注明出处。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/14/2016-01-14-sqlite-jiao-cheng-liu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/14/2016-01-14-sqlite-jiao-cheng-liu/" class="post-title-link" itemprop="url">SQLite 教程(六)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-14 01:41:01" itemprop="dateCreated datePublished" datetime="2016-01-14T01:41:01+08:00">2016-01-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 16:29:13" itemprop="dateModified" datetime="2024-11-02T16:29:13+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Database/" itemprop="url" rel="index"><span itemprop="name">Database</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.8k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>6 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="SQLite-Delete-语句"><a href="#SQLite-Delete-语句" class="headerlink" title="SQLite Delete 语句"></a>SQLite Delete 语句</h4><p>SQLite 的 <strong>DELETE</strong> 查询用于删除表中已有的记录。可以使用带有 WHERE 子句的 DELETE 查询来删除选定行，否则所有的记录都会被删除。</p>
<hr>
<p><strong>语法</strong></p>
<p>带有 WHERE 子句的 DELETE 查询的基本语法如下：</p>
<pre><code>DELETE FROM table_name
WHERE [condition];
</code></pre>
<p>您可以使用 AND 或 OR 运算符来结合 N 个数量的条件。</p>
<p><strong>实例</strong></p>
<p>假设 COMPANY 表有以下记录：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>
<p>现在，COMPANY 表有以下记录：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
</code></pre>
<p>如果您想要从 COMPANY 表中删除所有记录，则不需要使用 WHERE 子句，DELETE 查询如下：</p>
<pre><code>sqlite&gt; DELETE FROM COMPANY;
</code></pre>
<p>现在，COMPANY 表中没有任何的记录，因为所有的记录已经通过 DELETE 语句删除。</p>
<h4 id="SQLite-Like-子句"><a href="#SQLite-Like-子句" class="headerlink" title="SQLite Like 子句"></a>SQLite Like 子句</h4><p>SQLite 的 <strong>LIKE</strong> 运算符是用来匹配通配符指定模式的文本值。如果搜索表达式与模式表达式匹配，LIKE 运算符将返回真（true），也就是 1。这里有两个通配符与 LIKE 运算符一起使用：</p>
<ul>
<li>百分号 （%）</li>
<li>下划线 （_）</li>
</ul>
<p>百分号（%）代表零个、一个或多个数字或字符。下划线（_）代表一个单一的数字或字符。这些符号可以被组合使用。</p>
<hr>
<p><strong>语法</strong></p>
<p>% 和 _ 的基本语法如下：</p>
<pre><code>SELECT FROM table_name
WHERE column LIKE &#39;XXXX%&#39;

or

SELECT FROM table_name
WHERE column LIKE &#39;%XXXX%&#39;

or

SELECT FROM table_name
WHERE column LIKE &#39;XXXX_&#39;

or

SELECT FROM table_name
WHERE column LIKE &#39;_XXXX&#39;

or

SELECT FROM table_name
WHERE column LIKE &#39;_XXXX_&#39;
</code></pre>
<p>您可以使用 AND 或 OR 运算符来结合 N 个数量的条件。在这里，XXXX 可以是任何数字或字符串值。</p>
<p><strong>实例</strong></p>
<p>下面一些实例演示了 带有 ‘%’ 和 ‘_’ 运算符的 LIKE 子句不同的地方：</p>
<table>
<thead>
<tr>
<th>语句</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>WHERE SALARY LIKE ‘200%’</td>
<td>查找以 200 开头的任意值</td>
</tr>
<tr>
<td>WHERE SALARY LIKE ‘%200%’</td>
<td>查找任意位置包含 200 的任意值</td>
</tr>
<tr>
<td>WHERE SALARY LIKE ‘_00%‘</td>
<td>查找第二位和第三位为 00 的任意值</td>
</tr>
<tr>
<td>WHERE SALARY LIKE ‘2_%_%’</td>
<td>查找以 2 开头，且长度至少为 3 个字符的任意值</td>
</tr>
<tr>
<td>WHERE SALARY LIKE ‘%2’</td>
<td>查找以 2 结尾的任意值</td>
</tr>
<tr>
<td>WHERE SALARY LIKE ‘_2%3’</td>
<td>查找第二位为 2，且以 3 结尾的任意值</td>
</tr>
<tr>
<td>WHERE SALARY LIKE ‘2___3’</td>
<td>查找长度为 5 位数，且以 2 开头以 3 结尾的任意值</td>
</tr>
</tbody></table>
<p>让我们举一个实际的例子，假设 COMPANY 表有以下记录：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>
<p>下面是一个实例，它显示 COMPANY 表中 AGE 以 2 开头的所有记录：</p>
<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE AGE  LIKE &#39;2%&#39;;
</code></pre>
<p>这将产生以下结果：</p>
<pre><code>    ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>
<p>下面是一个实例，它显示 COMPANY 表中 ADDRESS 文本里包含一个连字符（-）的所有记录：</p>
<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE ADDRESS  LIKE &#39;%-%&#39;;
</code></pre>
<p>这将产生以下结果：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
4           Mark        25          Rich-Mond   65000.0
6           Kim         22          South-Hall  45000.0
</code></pre>
<h4 id="SQLite-Glob-子句"><a href="#SQLite-Glob-子句" class="headerlink" title="SQLite Glob 子句"></a>SQLite Glob 子句</h4><p>SQLite 的 <strong>GLOB</strong> 运算符是用来匹配通配符指定模式的文本值。如果搜索表达式与模式表达式匹配，GLOB 运算符将返回真（true），也就是 1。与 LIKE 运算符不同的是，GLOB 是大小写敏感的，对于下面的通配符，它遵循 UNIX 的语法。</p>
<ul>
<li>星号 （*）</li>
<li>问号 （?）</li>
</ul>
<p>星号（*）代表零个、一个或多个数字或字符。问号（?）代表一个单一的数字或字符。这些符号可以被组合使用。</p>
<hr>
<p><strong>语法</strong></p>
<p>* 和 ? 的基本语法如下：</p>
<pre><code>SELECT FROM table_name
WHERE column GLOB &#39;XXXX*&#39;

or

SELECT FROM table_name
WHERE column GLOB &#39;*XXXX*&#39;

or

SELECT FROM table_name
WHERE column GLOB &#39;XXXX?&#39;

or

SELECT FROM table_name
WHERE column GLOB &#39;?XXXX&#39;

or

SELECT FROM table_name
WHERE column GLOB &#39;?XXXX?&#39;

or

SELECT FROM table_name
WHERE column GLOB &#39;????&#39;
</code></pre>
<p>您可以使用 AND 或 OR 运算符来结合 N 个数量的条件。在这里，XXXX 可以是任何数字或字符串值。</p>
<hr>
<p><strong>实例</strong></p>
<p>下面一些实例演示了 带有 ‘*’ 和 ‘?’ 运算符的 GLOB 子句不同的地方：</p>
<table>
<thead>
<tr>
<th>语句</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>WHERE SALARY GLOB ‘200*‘</td>
<td>查找以 200 开头的任意值</td>
</tr>
<tr>
<td>WHERE SALARY GLOB ‘*200*‘</td>
<td>查找任意位置包含 200 的任意值</td>
</tr>
<tr>
<td>WHERE SALARY GLOB ‘?00*‘</td>
<td>查找第二位和第三位为 00 的任意值</td>
</tr>
<tr>
<td>WHERE SALARY GLOB ‘2??’</td>
<td>查找以 2 开头，且长度至少为 3 个字符的任意值</td>
</tr>
<tr>
<td>WHERE SALARY GLOB ‘*2’</td>
<td>查找以 2 结尾的任意值</td>
</tr>
<tr>
<td>WHERE SALARY GLOB ‘?2*3’</td>
<td>查找第二位为 2，且以 3 结尾的任意值</td>
</tr>
<tr>
<td>WHERE SALARY GLOB ‘2???3’</td>
<td>查找长度为 5 位数，且以 2 开头以 3 结尾的任意值</td>
</tr>
</tbody></table>
<p>让我们举一个实际的例子，假设 COMPANY 表有以下记录：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>
<p>下面是一个实例，它显示 COMPANY 表中 AGE 以 2 开头的所有记录：</p>
<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE AGE  GLOB &#39;2*&#39;;
</code></pre>
<p>这将产生以下结果：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>
<p>下面是一个实例，它显示 COMPANY 表中 ADDRESS 文本里包含一个连字符（-）的所有记录：</p>
<pre><code>sqlite&gt; SELECT * FROM COMPANY WHERE ADDRESS  GLOB &#39;*-*&#39;;
</code></pre>
<p>这将产生以下结果：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
4           Mark        25          Rich-Mond   65000.0
6           Kim         22          South-Hall  45000.0
</code></pre>
<h4 id="SQLite-Limit-子句"><a href="#SQLite-Limit-子句" class="headerlink" title="SQLite Limit 子句"></a>SQLite Limit 子句</h4><p>SQLite 的 <strong>LIMIT</strong> 子句用于限制由 SELECT 语句返回的数据数量。</p>
<hr>
<p><strong>语法</strong></p>
<p>带有 LIMIT 子句的 SELECT 语句的基本语法如下：</p>
<pre><code>SELECT column1, column2, columnN
FROM table_name
LIMIT [no of rows]
</code></pre>
<p>下面是 <code>LIMIT</code> 子句与 <code>OFFSET</code> 子句一起使用时的语法：</p>
<pre><code>SELECT column1, column2, columnN
FROM table_name
LIMIT [no of rows] OFFSET [row num]
</code></pre>
<p>SQLite 引擎将返回从下一行开始直到给定的 <code>OFFSET</code> 为止的所有行，如下面的最后一个实例所示。</p>
<p><strong>实例</strong></p>
<p>假设 COMPANY 表有以下记录：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
7           James       24          Houston     10000.0
</code></pre>
<p>下面是一个实例，它限制了您想要从表中提取的行数：</p>
<pre><code>sqlite&gt; SELECT * FROM COMPANY LIMIT 6;
</code></pre>
<p>这将产生以下结果：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
1           Paul        32          California  20000.0
2           Allen       25          Texas       15000.0
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
6           Kim         22          South-Hall  45000.0
</code></pre>
<p>但是，在某些情况下，可能需要从一个特定的偏移开始提取记录(<code>OFFSET下标从0开始</code>)。下面是一个实例，从第三位开始提取 3 个记录：</p>
<pre><code>sqlite&gt; SELECT * FROM COMPANY LIMIT 3 OFFSET 2;
</code></pre>
<p>这将产生以下结果：</p>
<pre><code>ID          NAME        AGE         ADDRESS     SALARY
----------  ----------  ----------  ----------  ----------
3           Teddy       23          Norway      20000.0
4           Mark        25          Rich-Mond   65000.0
5           David       27          Texas       85000.0
</code></pre>
<p>资料整理于：<a target="_blank" rel="noopener" href="http://www.runoob.com/sqlite/sqlite-tutorial.html">RUNOOB.COM-SQLite教程</a><br>转载请注明出处。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



                        </div>
                        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

                    </div>
                        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">王若风</p>
  <div class="site-description" itemprop="description">王若风的技术博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">72</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/wangruofeng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wangruofeng" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wangruofeng007@gmail.com" title="E-Mail → mailto:wangruofeng007@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/oneruofeng" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;oneruofeng" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://instagram.com/ace_freeman007" title="Instagram → https:&#x2F;&#x2F;instagram.com&#x2F;ace_freeman007" rel="noopener" target="_blank"><i class="fab fa-instagram fa-fw"></i>Instagram</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


                </div>
            </main>

            <footer class="footer">
                <div class="footer-inner">
                    

                    

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">王若风</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">108k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">6:32</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

                    








                </div>
            </footer>
        </div>

        
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




        




  
<script src="/js/local-search.js"></script>














        
            <script
                type="text/javascript"
                src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
        
            

            

    </body>
</html>