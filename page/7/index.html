<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"blog.wangruofeng007.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":"default","style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

        <meta name="description" content="王若风的技术博客">
<meta property="og:type" content="website">
<meta property="og:title" content="王若风的技术博客">
<meta property="og:url" content="https://blog.wangruofeng007.com/page/7/index.html">
<meta property="og:site_name" content="王若风的技术博客">
<meta property="og:description" content="王若风的技术博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="王若风">
<meta property="article:tag" content="技术博客, Flutter, iOS">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://blog.wangruofeng007.com/page/7/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

        <title>
            王若风的技术博客
        </title>
        
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7M5CYEY807"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-7M5CYEY807');
      }
    </script>






        <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

    <link rel="alternate" href="/atom.xml" title="王若风的技术博客" type="application/atom+xml">
</head>

    <body itemscope="itemscope" itemtype="http://schema.org/WebPage">
        <div class="container use-motion">
            <div class="headband"></div>

            <header
                class="header"
                itemscope="itemscope"
                itemtype="http://schema.org/WPHeader">
                <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">王若风的技术博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">世界尽头の冷酷仙境</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
            </header>

            
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


            <main class="main">
                <div class="main-inner">
                    <div class="content-wrap">
                        

                        <div class="content index posts-expand">
                            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/13/2016-01-13-gong-han-mo-shi-xiang-jie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/13/2016-01-13-gong-han-mo-shi-xiang-jie/" class="post-title-link" itemprop="url">工厂模式详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-13 05:39:21" itemprop="dateCreated datePublished" datetime="2016-01-13T05:39:21+08:00">2016-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-03 13:32:35" itemprop="dateModified" datetime="2024-11-03T13:32:35+08:00">2024-11-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
  
    <a title="disqus" href="/2016/01/13/2016-01-13-gong-han-mo-shi-xiang-jie/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/13/2016-01-13-gong-han-mo-shi-xiang-jie/" itemprop="commentCount"></span>
    </a>
  </span>
  
 <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>11 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="3-种工厂模式"><a href="#3-种工厂模式" class="headerlink" title="3 种工厂模式"></a>3 种工厂模式</h2><p>概述：工厂模式是个系列，分为简单工厂模式， 工厂方法模式， 抽象工厂模式，这三种模式也非常常用。这些模式最最经典的就例子就是设计计算器。</p>
<ul>
<li>Factory Method (工厂方法模式)</li>
<li>Abstract Factory (抽象工厂模式）</li>
<li>Simple Factory（简单工厂模式）</li>
</ul>
<p> <code>参考 GoF《Design Patterns》一书</code> GOF 是这样描述工厂模式的：</p>
<blockquote>
<p>“Define an interface for creating an object, but let subclasses decide which class to instantiate. Factory Method lets a class defer instantiation to subclasses.”</p>
</blockquote>
<blockquote>
<p>在基类中定义创建对象的一个接口，让子类决定实例化哪个类。工厂方法让一个类的实例化延迟到子类中进行。</p>
</blockquote>
<h3 id="简单工厂模式"><a href="#简单工厂模式" class="headerlink" title="简单工厂模式"></a>简单工厂模式</h3><p> 严格的说，简单工厂模式并不是 23 种常用的设计模式之一，它只算工厂模式的一个特殊实现。简单工厂模式在实际中的应用相对于其他 2 个工厂模式用的还是相对少得多，因为它只适应很多简单的情况，最最重要的是它违背了我们在概述中说的开放-封闭原则。因为每次你要新添加一个功能，都需要在生 switch-case 语句（或者 if-else 语句）中去修改代码，添加分支条件</p>
<p> 简单工厂模式角色分配：</p>
<ol>
<li><p>Creator（产品创建者）<br>简单工厂模式的核心，它负责实现创建所有实例的内部逻辑。工厂类可以被外界直接调用，创建所需的产品对象。</p>
</li>
<li><p>Product （ 产品抽象类）<br>简单工厂模式所创建的所有对象的父类，它负责描述所有实例所共有的公共接口。</p>
</li>
<li><p>Concrete Product （具体产品）<br>是简单工厂模式的创建目标，所有创建的对象都是充当这个角色的某个具体类的实例。</p>
</li>
</ol>
<p>简单的工厂模式 UML 图<br><img src="/images/factory_pattern/uml_1.jpg" alt="简单工厂模式"></p>
<p>考虑下面一个事例： 加入你是一个商人，你做的的是手机生意。现在你生产 android 手机和 iphone 等，考虑到以后你可能还会生产其他手机例如 ubuntu 手机。假定你选择了简单工厂模式来实现。那么显然，我们需要所有产品的抽象基类（Product） 即是 Phone 类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Phone</span>   </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    virtual ~Phone()&#123;&#125;;<span class="comment">//在删除的时候防止内存泄露  </span></span><br><span class="line">    virtual <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(string number)</span> = <span class="number">0</span>;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>然后我们需要具体的产品类 Concrete Product： AndroidPhone 和 iOSPhone</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AndroidPhone</span> : <span class="keyword">public</span> Phone   </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(string number)</span>&#123; cout&lt;&lt;<span class="string">&quot;AndroidPhone is calling...&quot;</span>&lt;&lt;endl;&#125;  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IosPhone</span> : <span class="keyword">public</span> Phone  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(string number)</span> &#123; cout&lt;&lt;<span class="string">&quot;IosPhone is calling...&quot;</span>&lt;&lt;endl;&#125;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>最后我们需要 Creator</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PhoneFactory</span>  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    Phone* createPhone(string phoneName)  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="keyword">if</span>(phoneName == <span class="string">&quot;AndroidPhone&quot;</span>)  </span><br><span class="line">        &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AndroidPhone</span>();  </span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(phoneName == <span class="string">&quot;IosPhone&quot;</span>)  </span><br><span class="line">        &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IosPhone</span>();  </span><br><span class="line">        &#125;  </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NULL;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>客户端这样实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">main</span><span class="params">()</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    PhoneFactor factory;  </span><br><span class="line">    Phone* myAndroid = factory.createPhone(<span class="string">&quot;AndroidPhone&quot;</span>);  </span><br><span class="line">    Phone* myIPhone = factory.createPhone(<span class="string">&quot;iOSPhone&quot;</span>);  </span><br><span class="line">    <span class="keyword">if</span>(myAndroid)  </span><br><span class="line">    &#123;  </span><br><span class="line">        myAndroid-&gt;call(<span class="string">&quot;123&quot;</span>);  </span><br><span class="line">        delete myAndroid;  </span><br><span class="line">        myAndroid = NULL;  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(myIPhone)  </span><br><span class="line">    &#123;  </span><br><span class="line">        myIPhone-&gt;call(<span class="string">&quot;123&quot;</span>);  </span><br><span class="line">        delete  myIPhone;  </span><br><span class="line">        myIPhone = NULL;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就是简单工厂方法，把所有的创建交给 creator,creator 通过 switch-case(或者 if-else)语句来选择具体创建的对象。简单明了。但是就如上面所说，它最致命的问题的违背了开放-封闭原则。每次你要新添加一个功能，都要修改 factor 里面的 createPhone 代码。 但是工厂方法模式可以解决这个问题。</p>
<h3 id="工厂方法模式"><a href="#工厂方法模式" class="headerlink" title="工厂方法模式"></a>工厂方法模式</h3><p>个人觉得工厂方法模式在工厂模式家族中是用的最多模式。上面说过了，如果简单工厂模式，要添加一个新功能，比如我现在要增加 WinPhone 的生产，那么我要修改 PhoneFactory 中的 createPhone 中的分支判断条件。这违背了开放-封闭原则，那为什么不能将创建方法放到子类中呢？<br>工厂方法的定义就是：定义一个用于创建对象的接口，让子类决定实例化哪一个类，工厂方法使一个类的实例化延迟到其子类。</p>
<p> 工厂方法模式角色：</p>
<ol>
<li>抽象工厂(Creator)角色：是工厂方法模式的核心，与应用程序无关。任何在模式中创建的对象的工厂类必须实现这个接口。</li>
<li>具体工厂(Concrete Creator)角色：这是实现抽象工厂接口的具体工厂类，包含与应用程序密切相关的逻辑，并且受到应用程序调用以创建产品对象。</li>
<li>抽象产品(Product)角色：工厂方法模式所创建的对象的超类型，也就是产品对象的共同父类或共同拥有的接口。</li>
<li>具体产品(Concrete Product)角色：这个角色实现了抽象产品角色所定义的接口。某具体产品有专门的具体工厂创建，它们之间往往一一对应</li>
</ol>
<p>工厂方法模式 UML 图：<br><img src="/images/factory_pattern/uml_2.jpg" alt="工厂方法模式"></p>
<p>看定义看的晕乎乎的？那么我们来看代码：产品接口，以及其相应的子类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Phone</span>   </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    virtual ~Phone()&#123;&#125;;<span class="comment">//在删除的时候防止内存泄露  </span></span><br><span class="line">    virtual <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(string number)</span> = <span class="number">0</span>;  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AndroidPhone</span> : <span class="keyword">public</span> Phone   </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(string number)</span>&#123; cout&lt;&lt;<span class="string">&quot;AndroidPhone is calling...&quot;</span>&lt;&lt;endl;&#125;  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">iOSPhone</span> : <span class="keyword">public</span> Phone  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(string number)</span> &#123; cout&lt;&lt;<span class="string">&quot;iOSPhone is calling...&quot;</span>&lt;&lt;endl;&#125;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>上面这个和简单工厂方法还是一样的。接下来不一样的来了…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PhoneFactory</span>  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    virtual ~PhoneFactory()&#123;&#125;;  </span><br><span class="line">    virtual Phone* createPhone() = <span class="number">0</span>;  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AndroidPhoneFactory</span> : <span class="keyword">public</span> PhoneFactory  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    virtual Phone* createPhone()  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AndroidPhone</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IosPhoneFactory</span> : <span class="keyword">public</span> PhoneFactory  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    virtual Phone* createPhone()  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IosPhone</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>工厂方法将 PhoneFactory 抽象成了基类，PhoneFactory 的 createPhone 不在像以前那样将所有的判断塞到里面。而是改由其子类来实现创建功能，这感觉就是权力下放。<br>客户端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">main</span><span class="params">()</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    PhoneFactory*  androidCreator = <span class="keyword">new</span> <span class="title class_">AndroidPhoneFactory</span>();  </span><br><span class="line">    PhoneFactory*  iosCreator = <span class="keyword">new</span> <span class="title class_">IosPhoneFactory</span>();  </span><br><span class="line">    Phone*  myAndroid = androidCreator-&gt;createPhone();  </span><br><span class="line">    Phone* myIPhone = iosCreator-&gt;createPhone();  </span><br><span class="line">    <span class="keyword">if</span>(myAndroid)  </span><br><span class="line">    &#123;  </span><br><span class="line">        myAndroid-&gt;call(<span class="string">&quot;123&quot;</span>);  </span><br><span class="line">        delete myAndroid;  </span><br><span class="line">        myAndroid = NULL;  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(myIPhone)  </span><br><span class="line">    &#123;  </span><br><span class="line">        myIPhone-&gt;call(<span class="string">&quot;123&quot;</span>);  </span><br><span class="line">        delete  myIPhone;  </span><br><span class="line">        myIPhone = NULL;  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    delete androidCreator;  </span><br><span class="line">    delete iosCreator;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在工厂方法模式中，核心工厂类不在负责产品的创建，而是将具体的创建工作交给子类去完成。也就是后所这个核心工厂仅仅只是提供创建的接口，具体实现方法交给继承它的子类去完成。当我们的系统需要增加其他新功能时，只需要继承 PhoneFactory 这个类，并且实现 createPhone 接口。 不需要对原工厂 PhoneFactory 进行任何修改，这样很好地符合了“开放-封闭“原则。</p>
<p>虽然工厂方法模式满足了”开放-封闭”原则，但是这个模式也仍然有缺点：每次增加一个产品时，都需要增加一个具体类和对象实现工厂，是的系统中类的个数成倍增加，在一定程度上增加了系统的复杂度，同时也增加了系统具体类的依赖。这并不是什么好事。</p>
<h3 id="抽象工厂模式"><a href="#抽象工厂模式" class="headerlink" title="抽象工厂模式"></a>抽象工厂模式</h3><p>在工厂方法模式中，其实我们有一个潜在意识的意识。那就是我们生产的都是同一类产品，例如我们生产的都是手机！那么现在假如现在我们又要生产平板了了呢？那么就要用到抽象工厂模式。我抽象工厂模式也用的比较多在工厂模式家族中，仅次于工厂方法模式。在了解抽象工厂模式之前，还是老生常谈的理清下产品等级结构和产品簇的概念。下面的图还是老图。但是我讲讲我的理解：</p>
<p><img src="/images/factory_pattern/uml_3.jpg" alt="抽象工厂模式"></p>
<p>产品等级结构：产品的等级结构也就是产品的继承结构。我理解就是同一类产品，比如手机是一个系列，有 android 手机，ios 手机，win 手机，那么这个抽象类手机和他的子类就构成了一个产品等级结构。那其他的平板显然不是和手机一个系列的，一个平板，一个是手机，所以他们是不同的产品等级结构。</p>
<p>产品族: 在抽象工厂模式中，产品族是指由同一个工厂生产的，位于不同产品等级结构中的一组产品。比如分为 android 产品，和 ios 产品。其中一个 ios 产品包含 ios 手机和 ios 平板。显然 ios 手机和 ios 平板不是同一个产品等级结构的，因为一个是手机，一个是平板。但他们是同一个产品簇—都是 ios 产品。<br>希望大家通过上面的例子大家明白了这两个概念。</p>
<p> 抽象工厂模式的 UML 图：<br> <img src="/images/factory_pattern/uml_4.jpg" alt="抽象工厂模式"></p>
<p>接着上面的话题，现在假如我要增加对平板的支持，那么我们肯定先添加两个产品等级结构，一个是手机，一个是平板：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//产品等级结构--手机  </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Phone</span>   </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    virtual ~Phone()&#123;&#125;;<span class="comment">//在删除的时候防止内存泄露  </span></span><br><span class="line">    virtual <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(string number)</span> = <span class="number">0</span>;  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AndroidPhone</span> : <span class="keyword">public</span> Phone   </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(string number)</span>&#123; cout&lt;&lt;<span class="string">&quot;AndroidPhone is calling...&quot;</span>&lt;&lt;endl; &#125;  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IosPhone</span> : <span class="keyword">public</span> Phone  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">call</span><span class="params">(string number)</span> &#123; cout&lt;&lt;<span class="string">&quot;IosPhone is calling...&quot;</span>&lt;&lt;endl; &#125;  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="comment">//产品等级结构--平板  </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pad</span>  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    virtual ~Pad()&#123;&#125;;  </span><br><span class="line">    virtual <span class="keyword">void</span> <span class="title function_">playMovie</span><span class="params">()</span> = <span class="number">0</span>;  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AndroidPad</span> : <span class="keyword">public</span> Pad  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    virtual <span class="keyword">void</span> <span class="title function_">playMovie</span><span class="params">()</span>&#123; cout&lt;&lt;<span class="string">&quot;AndriodPad is playing movie...&quot;</span>&lt;&lt;endl; &#125;  </span><br><span class="line">&#125;;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IosPad</span> : <span class="keyword">public</span> Pad  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    virtual <span class="keyword">void</span> <span class="title function_">playMovie</span><span class="params">()</span>&#123; cout&lt;&lt;<span class="string">&quot;IosPad is playing movie...&quot;</span>&lt;&lt;endl; &#125;  </span><br><span class="line">&#125;;   </span><br></pre></td></tr></table></figure>
<p>然后具体的工厂我们整个工厂是生产移动设备的所以我们取名为 MobileFactory,然后工厂可以生产平板和手机，故有了 createPhone 和 createPad 两个接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MobileFactory</span>  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    virtual ~MobileFactory()&#123;&#125;;  </span><br><span class="line">    virtual Phone* createPhone() = <span class="number">0</span>;  </span><br><span class="line">    virtual Pad* createPad() = <span class="number">0</span>;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>接着是 android 产品簇 的工厂类，负责生产 android 的手机和平板：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AndroidFactory</span> : <span class="keyword">public</span> MobileFactory  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    Phone* createPhone()  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AndroidPhone</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">    Pad* createPad()  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AndroidPad</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接着是 ios 的产品簇的工厂类，负责生产 ios 的手机和平板：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IosFactory</span> : <span class="keyword">public</span> MobileFactory  </span><br><span class="line">&#123;  </span><br><span class="line"><span class="keyword">public</span>:  </span><br><span class="line">    Phone* createPhone()  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IosPhone</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    Pad* createPad()  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">IosPad</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>最后客户端这样实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">main</span><span class="params">()</span>  </span><br><span class="line">&#123;  </span><br><span class="line">    MobileFactory*  androidCreator = <span class="keyword">new</span> <span class="title class_">AndroidFactory</span>();  </span><br><span class="line">    MobileFactory*  iosCreator = <span class="keyword">new</span> <span class="title class_">IosFactory</span>();  </span><br><span class="line">    Phone*  myAndroidPhone = androidCreator-&gt;createPhone();  </span><br><span class="line">    Pad* myAndroidPad = androidCreator-&gt;createPad();  </span><br><span class="line">    Phone* myIosPhone = iosCreator-&gt;createPhone();  </span><br><span class="line">    Pad* myIosPad = iosCreator-&gt;createPad();  </span><br><span class="line"></span><br><span class="line">    myAndroidPhone-&gt;call(<span class="string">&quot;123&quot;</span>);  </span><br><span class="line">    myAndroidPad-&gt;playMovie();  </span><br><span class="line"></span><br><span class="line">    myIosPhone-&gt;call(<span class="string">&quot;123&quot;</span>);  </span><br><span class="line">    myIosPad-&gt;playMovie();  </span><br><span class="line">    <span class="comment">//这里没有做释放和判断，请自己判断和释放  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结：<br>抽象工厂模式适用于那些有多种产品的产品簇，并且每次使用其中的某一产品簇的产品。<br>缺点 ： 抽象工厂模式的添加新功能也非常麻烦，比工厂方法模式都还要复杂的多。<br>优点： 当一个产品族中的多个对象被设计成一起工作时，它能够保证客户端始终只使用同一个产品族中的对象</p>
<h2 id="主要用途"><a href="#主要用途" class="headerlink" title="主要用途"></a>主要用途</h2><p>工厂方法要解决的问题是对象的创建时机，它提供了一种扩展的策略，很好地符合了开放封闭原则。工厂方法也叫做虚构造器（Virtual Constructor）。</p>
<p><img src="http://cdn.cocimg.com/cms/uploads/allimg/130516/4196_130516112054_1.png" alt="工厂方法的类结构图"></p>
<h2 id="什么时候使用工厂方法"><a href="#什么时候使用工厂方法" class="headerlink" title="什么时候使用工厂方法"></a>什么时候使用工厂方法</h2><p>当是如下情况是，可以使用工厂方法：一个类不知道它所必须创建的对象的类时，一个类希望有它的子类决定所创建的对象时。</p>
<p>更多关于工厂方法的介绍，可以参考本文最后给出的参考内容。下面我们就来看看在 iOS 中工厂方法的一种实现方法。</p>
<h2 id="iOS-中工厂方法的实现实例"><a href="#iOS-中工厂方法的实现实例" class="headerlink" title="iOS 中工厂方法的实现实例"></a>iOS 中工厂方法的实现实例</h2><p>如下有一个类图，该图描述了下面即将实现的工厂方法（利用工厂方法，创建出不同的形状）。其中 BVShapeFactory 为工厂方法的基类，BVShape 为形状的基类，BVClient 通过 BVShapeFactory，利用 BVShapeFactory 的子类（BVCircleShapeFactory 和 BVSquareShapeFactory）分别创建出 BVCircleShape 和 BVSquareShape。<br><img src="http://cdn.cocimg.com/cms/uploads/allimg/130516/4196_130516112123_1.png" alt="工厂方法"></p>
<p>github 下载地址:<a target="_blank" rel="noopener" href="https://github.com/BeyondVincent/ios_patterns/tree/master/FactoryMethodPattern">https://github.com/BeyondVincent/ios_patterns/tree/master/FactoryMethodPattern</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="http://doc.okbase.net/luozhonglan/archive/103843.html">iOS 设计模式——工厂方法（简单工厂模式，工厂方法模式， 抽象工厂模式）</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cocoachina.com/ios/20130516/6219.html">iOS 设计模式(03):工厂方法</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cocoachina.com/ios/20141124/10296.html">Objective-C 类族和工厂模式</a></li>
<li><a target="_blank" rel="noopener" href="http://crosbymichael.com/objective-c-design-patterns-factory.html">Objective C Design Patterns - Factory</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/ios/documentation/General/Conceptual/CocoaEncyclopedia/ClassFactoryMethods/ClassFactoryMethods.html">Class Factory Methods</a>–Apple</li>
<li><a target="_blank" rel="noopener" href="http://www.raywenderlich.com/46988/ios-design-patterns">iOS Design Patterns</a>–raywenderlich</li>
<li><a target="_blank" rel="noopener" href="http://www.knowstack.com/abstract-factory-design-pattern-objective-c/">Abstract Factory Design Pattern Objective C</a></li>
<li><a target="_blank" rel="noopener" href="https://www.binpress.com/tutorial/the-factory-design-pattern-explained-by-example/142">The factory design pattern explained by example</a>-php</li>
<li><a target="_blank" rel="noopener" href="https://www.safaribooksonline.com/blog/2014/12/10/design-patterns-series-day-3-factory-singleton-patterns/">Design Patterns Series, Day 3: Factory and Singleton Patterns</a>–safaribooksonline</li>
<li><a target="_blank" rel="noopener" href="http://www.bobmccune.com/2011/04/08/automagic-factories-in-objective-c/">Automagic Factories in Objective-C</a>–bobmccune</li>
</ul>
<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com/">http://blog.wangruofeng007.com</a></p>
<!-- processed 2 -->

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/13/2016-01-13-duo-xian-cheng-zhi-nsthread/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/13/2016-01-13-duo-xian-cheng-zhi-nsthread/" class="post-title-link" itemprop="url">多线程之 NSThread</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-13 05:36:48" itemprop="dateCreated datePublished" datetime="2016-01-13T05:36:48+08:00">2016-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-03 13:40:58" itemprop="dateModified" datetime="2024-11-03T13:40:58+08:00">2024-11-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">多线程</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
  
    <a title="disqus" href="/2016/01/13/2016-01-13-duo-xian-cheng-zhi-nsthread/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/13/2016-01-13-duo-xian-cheng-zhi-nsthread/" itemprop="commentCount"></span>
    </a>
  </span>
  
 <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>919</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>每个 iOS 应用程序都有个专门用来更新显示 UI 界面、处理用户触摸事件的主线程，因此不能将其他太耗时的操作放在主线程中执行，不然会造成主线程堵塞(出现卡机现象)，带来极坏的用户体验。一般的解决方案就是将那些耗时的操作放到另外一个线程中去执行，多线程编程是防止主线程堵塞，增加运行效率的最佳方法。</p>
<p>iOS 中有 3 种常见的多线程编程方法</p>
<ol>
<li><p><code>NSThread</code> 这种方法需要管理线程的生命周期、同步、加锁问题，会导致一定的性能开销</p>
</li>
<li><p><code>NSOperation</code> 和 <code>NSOperationQueue</code> 是基于 OC 实现的。NSOperation 以面向对象的方式封装了需要执行的操作，然后可以将这个操作放到一个 NSOperationQueue 中去异步执行。不必关心线程管理、同步等问题。</p>
</li>
<li><p><code>Grand Centeral Dispatch</code> 简称 GCD，iOS4 才开始支持，是纯 C 语言的 API。自 iPad2 开始，苹果设备开始有了双核 CPU，为了充分利用这 2 个核，GCD 提供了一些新特性来支持多核并行编程</p>
</li>
</ol>
<p>这篇文章简单介绍 <code>NSThread 这</code> 个类，一个 <code>NSThread</code> 实例就代表着一条线程</p>
<h2 id="获取当前线程"><a href="#获取当前线程" class="headerlink" title="获取当前线程"></a>获取当前线程</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSThread</span> *current = [<span class="built_in">NSThread</span> currentThread];</span><br></pre></td></tr></table></figure>

<h2 id="获取主线程"><a href="#获取主线程" class="headerlink" title="获取主线程"></a>获取主线程</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSThread</span> *main = [<span class="built_in">NSThread</span> mainThread];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;主线程:%@&quot;</span>, main);    </span><br></pre></td></tr></table></figure>

<p>打印结果是：</p>
<p> 2013-04-18 21:36:38.599 thread[7499:c07] 主线程:&lt;NSThread: 0x71434e0&gt;{name &#x3D; (null), num &#x3D; 1}</p>
<p>num 相当于线程的 id，主线程的 num 是为 1 的</p>
<h2 id="NSThread-的创建"><a href="#NSThread-的创建" class="headerlink" title="NSThread 的创建"></a>NSThread 的创建</h2><h3 id="a-动态方法"><a href="#a-动态方法" class="headerlink" title="a.动态方法"></a>a.动态方法</h3><ul>
<li>(id)initWithTarget:(id)target selector:(SEL)selector object:(id)argument;</li>
</ul>
<p>在第 2 行创建了一条新线程，然后在第 4 行调用 <code>start</code> 方法启动线程，线程启动后会调用 self 的 <code>run:</code> 方法，并且将@”mj”作为方法参数</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化线程</span></span><br><span class="line"><span class="built_in">NSThread</span> *thread = [[[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(run:) object:<span class="string">@&quot;mj&quot;</span>] autorelease];</span><br><span class="line"><span class="comment">// 开启线程</span></span><br><span class="line">[thread start];</span><br></pre></td></tr></table></figure>

<p>假如 run:方法是这样的：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)run:(<span class="built_in">NSString</span> *)string &#123;</span><br><span class="line">     <span class="built_in">NSThread</span> *current = [<span class="built_in">NSThread</span> currentThread];</span><br><span class="line">     <span class="built_in">NSLog</span>(<span class="string">@&quot;执行了 run:方法-参数：%@，当前线程：%@&quot;</span>, string, current);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印结果为：</p>
<p> 2013-04-18 21:40:33.102 thread[7542:3e13] 执行了 run:方法-参数：mj，当前线程：&lt;NSThread: 0x889e8d0&gt;{name &#x3D; (null), num &#x3D; 3}</p>
<p>可以发现，这条线程的 num 值为 3，说明不是主线程，主线程的 num 为 1</p>
<h3 id="b-静态方法"><a href="#b-静态方法" class="headerlink" title="b.静态方法"></a>b.静态方法</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="type">void</span>)detachNewThreadSelector:(SEL)selector toTarget:(<span class="type">id</span>)target withObject:(<span class="type">id</span>)argument;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">NSThread</span> detachNewThreadSelector:<span class="keyword">@selector</span>(run:) toTarget:<span class="keyword">self</span> withObject:<span class="string">@&quot;mj&quot;</span>];</span><br></pre></td></tr></table></figure>

<h3 id="c-隐式创建线程"><a href="#c-隐式创建线程" class="headerlink" title="c.隐式创建线程"></a>c.隐式创建线程</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span> performSelectorInBackground:<span class="keyword">@selector</span>(run:) withObject:<span class="string">@&quot;mj&quot;</span>];</span><br></pre></td></tr></table></figure>
<p>会隐式地创建一条新线程，并且在这条线程上调用 self 的 run:方法，以@”mj”为方法参数</p>
<h2 id="暂停当前线程"><a href="#暂停当前线程" class="headerlink" title="暂停当前线程"></a>暂停当前线程</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSDate</span> *date = [<span class="built_in">NSDate</span> dateWithTimeInterval:<span class="number">2</span> sinceDate:[<span class="built_in">NSDate</span> date]];  </span><br><span class="line">[<span class="built_in">NSThread</span> sleepUntilDate:date];</span><br></pre></td></tr></table></figure>

<p>上面两种做法都是暂停当前线程 2 秒</p>
<h2 id="线程的其他操作"><a href="#线程的其他操作" class="headerlink" title="线程的其他操作"></a>线程的其他操作</h2><h3 id="a-在指定线程上执行操作"><a href="#a-在指定线程上执行操作" class="headerlink" title="a.在指定线程上执行操作"></a>a.在指定线程上执行操作</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(run) onThread:thread withObject:<span class="literal">nil</span> waitUntilDone:<span class="literal">YES</span>];</span><br></pre></td></tr></table></figure>

<ul>
<li>上面代码的意思是在 thread 这条线程上调用 self 的 run 方法</li>
<li>最后的 YES 代表：上面的代码会阻塞，等 run 方法在 thread 线程执行完毕后，上面的代码才会通过</li>
</ul>
<h3 id="b-在主线程上执行操作"><a href="#b-在主线程上执行操作" class="headerlink" title="b.在主线程上执行操作"></a>b.在主线程上执行操作</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span> performSelectorOnMainThread:<span class="keyword">@selector</span>(run) withObject:<span class="literal">nil</span> waitUntilDone:<span class="literal">YES</span>];  </span><br></pre></td></tr></table></figure>

<p>在主线程调用 self 的 run 方法</p>
<h3 id="c-在当前线程执行操作"><a href="#c-在当前线程执行操作" class="headerlink" title="c.在当前线程执行操作"></a>c.在当前线程执行操作</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(run) withObject:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>
<p>在当前线程调用 self 的 run 方法</p>
<h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><ol>
<li>优点： <code>NSThread</code> 比其他多线程方案较轻量级，更直观地控制线程对象</li>
<li>缺点：需要自己管理线程的生命周期，线程同步。线程同步对数据的加锁会有一定的系统开销</li>
</ol>
<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com/">http://blog.wangruofeng007.com</a></p>
<!-- processed 2 -->

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/13/2016-01-13-nsoperation-and-nsoperationqueue-tutorial-in-swift/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/13/2016-01-13-nsoperation-and-nsoperationqueue-tutorial-in-swift/" class="post-title-link" itemprop="url">NSOperation and NSOperationQueue Tutorial in Swift</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-13 05:18:36" itemprop="dateCreated datePublished" datetime="2016-01-13T05:18:36+08:00">2016-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-03 14:26:13" itemprop="dateModified" datetime="2024-11-03T14:26:13+08:00">2024-11-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">多线程</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
  
    <a title="disqus" href="/2016/01/13/2016-01-13-nsoperation-and-nsoperationqueue-tutorial-in-swift/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/13/2016-01-13-nsoperation-and-nsoperationqueue-tutorial-in-swift/" itemprop="commentCount"></span>
    </a>
  </span>
  
 <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>6.5k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>24 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>译自 Written by <a target="_blank" rel="noopener" href="http://www.raywenderlich.com/u/jrturton"> Richard Turton</a> — on October 7, 2014</li>
<li>原文链接：<a target="_blank" rel="noopener" href="http://www.raywenderlich.com/76341/use-nsoperation-nsoperationqueue-swift">http://www.raywenderlich.com/76341/use-nsoperation-nsoperationqueue-swift</a></li>
<li>译者<a target="_blank" rel="noopener" href="https://twitter.com/oneruofeng">@oneruofeng</a></li>
</ul>
<blockquote>
<p><strong>Post info</strong>: Updated for Xcode 7.1 and Swift 2.1 – 1 January 2016<br><strong>Update note</strong>: This tutorial was updated to iOS 8, Xcode 6.1 and Swift by Richard Turton.<br><a target="_blank" rel="noopener" href="http://www.raywenderlich.com/76341/use-nsoperation-nsoperationqueue-swift">Original post</a> by Tutorial Team member <a target="_blank" rel="noopener" href="http://www.raywenderlich.com/u/Canopus">Soheil Azarpour</a>.</p>
</blockquote>
<p>每个人都有点击一个按钮或者进入一些文本在 iOS 或者 Mac App 上的令人沮丧的经历，就是突然-WHAM，用户交互停止了响应。</p>
<p>在 Mac 上，你的用户开始盯着一个沙漏或者一个七彩的轮子开始旋转直到它们再次恢复 UI 交互为止。在一个 iOS app 中，用户期望 App 立即响应它们的触摸事件，无响应的 app 给人的感觉是笨重和缓慢，这样通常会导致收到差评。</p>
<p>保持你的 app 的可交互的状态说起来容易做起来难，一旦你的 app 需要执行不仅仅是少量的任务，事情很快就变得很复杂，我们并没有多少事件在主事件循环执行繁重的工作并且同时提供一个可以响应的 UI。</p>
<p>低级的开发者是怎样做的呢？解决方案就是把工作从主线程中移除通过并发。并发意味着你应用所有的操作同时执行在多个流（或者线程）中–这样的话用户界面就能保持响应的要执行的工作。</p>
<p>一种实现并发操作在 iOS 是通过 <code>NSOperation</code> 和 <code>NSOperationQueue</code> 这两个类。在这个教程中，你将学会怎样使用它们！你将从一个没有使用并发的 App 开始，所以它将出现的非常迟钝和无响应。然后你将重做你的应用给它们添加并发操作并且–希望–呈现一个更加响应良好的可交互界面给用户！</p>
<h3 id="我们开始吧"><a href="#我们开始吧" class="headerlink" title="我们开始吧"></a>我们开始吧</h3><p>这份样品工程的总的目标的就是展示一个滤镜处理过的图片的表视图。图片将从网络上下载，经过一个滤镜处理后，然后在表视图中显示。</p>
<p>下面是这个 app 模型的示意图</p>
<p><img src="/images/operation_queue/operation_queue_01.jpg" alt="app 模型的示意图"></p>
<h3 id="第一个版本尝试"><a href="#第一个版本尝试" class="headerlink" title="第一个版本尝试"></a>第一个版本尝试</h3><p>下载你将在这个教程中使用的<a target="_blank" rel="noopener" href="http://cdn5.raywenderlich.com/wp-content/uploads/2014/10/ClassicPhotos-Starter63.zip">第一个版本的项目</a></p>
<blockquote>
<p>注意：所以的图片来自<a target="_blank" rel="noopener" href="http://sxc.hu/"> stock.xchng.</a>。一下图片在数据源故意错误命名，以便这里有些例子是图片下载失败好处理失败的情况。</p>
</blockquote>
<p>构建并且运行这个工程，最终你将看到这个 app 运行起来显示一列照片。尝试滚动这个列表，很痛苦，不是吗？<br><img src="/images/operation_queue/operation_queue_02.jpg" alt="list of photoes"></p>
<p><em>传统的相册，运行缓慢</em></p>
<p>所有的操作都发生在 <code>ListViewController.swift</code> 里，并且最主要的是发生在 <code>tableView(_:cellForRowAtIndexPath:)</code> 方法里。看一下那个方法和注释这里有两件相当集中的事情需要思考：</p>
<ol>
<li><code>从网络载入图片数据</code> 。即使网络状况良好，app 将仍然必须等待直到下载完成了才能继续。</li>
<li>使用<em>Core Image</em>给图片加滤镜。这个方法给图片应用一个深褐色的滤镜，假如你想了解更多关于 <code>Core Image</code> 滤镜的知识，请点击<a target="_blank" rel="noopener" href="http://www.raywenderlich.com/76285/beginning-core-image-swift">Beginning Core Image in Swift</a></li>
</ol>
<p>还有，你将载入一系列图片请求从网络当它第一次被请求时:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lazy</span> <span class="keyword">var</span> photos <span class="operator">=</span> <span class="type">NSDictionary</span>(contentsOfURL:dataSourceURL)</span><br></pre></td></tr></table></figure>

<p>所有的工作发生在应用的主线程。由于主线程也负责用户交互，让它一直忙于从网络下载东西和给图片加滤镜消磨掉了响应中的 app。你可以通过使用 Xcode 的仪表测量视图获得这样一个快速的概述。你可以通过显示 <code>调试导航</code> (Commnad+6)接入这个仪表视图,让后选择 <code>CPU</code> 当 app 正在运行的时候。</p>
<p><img src="/images/operation_queue/operation_queue_03.jpg" alt="gauges"></p>
<p><em>Xcode 的仪表视图表明，主线程的任务非常重</em></p>
<p>你会看到那些所有的长钉在 <code>Thread 1</code> ，那就是 app 的主线程。更多详细的信息你可以运行 app 的 <code>Instruments</code> ,但是那个在<a target="_blank" rel="noopener" href="http://www.raywenderlich.com/?p=23037"> whole other tutorial :].</a>中</p>
<p>是时候考虑怎样改善一下你的用户体验了！</p>
<h3 id="任务，线程和进程"><a href="#任务，线程和进程" class="headerlink" title="任务，线程和进程"></a>任务，线程和进程</h3><p>在你专研这篇教程之前，这里有一下技术上的慨念需要理一下，我将定义一些专用术语：</p>
<ul>
<li><strong>任务</strong> ：一个简单单个的需要完成的工作</li>
<li><strong>线程</strong> ：操作系统提供的机制允许多个用户操作同时进行在一个应用中</li>
<li><strong>进程</strong> ：一个可执行的代码块，它可以由多个线程构成</li>
</ul>
<blockquote>
<p>注意：在 iOS 和 OS X 中，线程的功能由 POSIX 线程 API（或者 pthreads）实现，并且它使操作系统的一部分。而这个又是相当底层的东西，你将发现它很容易犯错误；或许关于线程最糟糕的事情是那些很难被发现的错误！</p>
</blockquote>
<blockquote>
<p><code>Foundation</code> 框架包含了一个叫做 <code>NSThread</code> 的类，这让我们处理事情更容易，但是用 <code>NSThread</code> 管理多个线程仍是一件令人头疼的事情。 <code>NSOperation</code> 和 <code>NSOperationQueue</code> 是为了最大化简化处理多线程的更高级的类。</p>
</blockquote>
<p>在这个图解中，你会看到进程，线程和任务之间的关系：</p>
<p><img src="/images/operation_queue/operation_queue_04.jpg" alt="the relationship between a process, threads, and tasks"></p>
<p><em>进程，线程和任务</em></p>
<p>正如你所见，一个进程可以包涵多个执行的线程，每个线程能够同时执行多个任务。</p>
<p>在这个图集中, <code>thread 2</code> 执行文件的读的工作，同时 <code>thread 1</code> 执行 UI 相关的代码。这和你应该怎样在 iOS 中构建你的代码（主线程执行任何和 UI 相关的工作，第二线程应当执行慢的或者长时间运行的耗时操作例如读取文件，接入网络等等）有点相似。</p>
<h3 id="NSOperation-vs-Grand-Central-Dispatch-GCD"><a href="#NSOperation-vs-Grand-Central-Dispatch-GCD" class="headerlink" title="NSOperation vs. Grand Central Dispatch (GCD)"></a>NSOperation vs. Grand Central Dispatch (GCD)</h3><p>你应该听说过<a target="_blank" rel="noopener" href="http://developer.apple.com/library/ios/#documentation/Performance/Reference/GCD_libdispatch_Ref/Reference/reference.html">Grand Central Dispatch (GCD).</a>。简单的来说， <code>GCD</code> 由语言的特征，运行时库和系统增强组成来提供一个在 <code>iOS</code> 和 <code>OS X</code> 多核硬件中支持并发系统并且综合的改良。假如你想了解更多关于 GCD 相关的知识，有可以阅读我们的<a target="_blank" rel="noopener" href="http://www.raywenderlich.com/?p=4295">Multithreading and Grand Central Dispatch on iOS for Beginners Tutorial</a>。</p>
<p> <code>NSOperation</code> 和 <code>NSOperationQueue</code> 构建在GCD之上。普遍来说，苹果推荐使用最高级别抽象，当需要显示他们一些需要的测量工作时回到最底层。</p>
<p>下面是关于这两者的一些简单比较，将帮助你决定何时何地选择使用 <code>GCD</code> 或者 <code>NSOperation</code> ：</p>
<ul>
<li><p><strong>GCD</strong> 是一个轻量级的方式来描述将要被并发执行的工作单元。你不必定制这个工作单元的时刻表；系统为你定制时刻表。在 blocks 中增加依赖是一件头疼的事情。取消或者暂停一个 block 来进行额外的工作为作为开发者的你！ :]</p>
</li>
<li><p><strong>NSOperation</strong> 和 GCD 相比增加了一些额外开支，但是你能够在各种操作之间增加依赖并且恢复，取消，暂停他们。</p>
</li>
</ul>
<p>这个教程将使用 <code>NSOperation</code> ,因为你将处理一个列表为了好的表现并且由于它大量的消耗的资源你需要能够取消一个操作针对某个图片，假如用户已经将那张图片滚出屏幕。即使这些操作在后台线程，假如这里有一打事情在队列里等着它们去处理，这将表现得跟糟糕。</p>
<h3 id="重构-App-Model"><a href="#重构-App-Model" class="headerlink" title="重构 App Model"></a>重构 App Model</h3><p>是时候重构开始的非多线程的模型了！假如你仔细观察先前的模型，你会发现这里有三个可以被改进的线程受困区域。通过切割这三个区域让后把他们放在单独的线程里，主线程的压力将得到缓解并且能够保持和用户交互。</p>
<p><img src="/images/operation_queue/operation_queue_05.jpg" alt="NSOperation_model_improved"></p>
<p><em>改进后的 model</em></p>
<p>为了摆脱你应用的瓶颈，你需要一个指定一个线程来响应你的用户时间，一个线程专注于下载资源和图片，一个线程执行图片滤镜操作。在新的模型中，app 从主线程启动让后载入一个空的表视图。同时，app 启动第二个线程开始下载数据资源。</p>
<p>一旦数据资源下载完成，你将通知表视图重新载入。这些事情必须在主线程完成，因为它涉及到用户界面相关的操作。从这一点来说，表视图知道有多少行，并且它知道他将显示图片的 URL 地址，但是她不知道它是否真的有图片！假如你立即开始下载所有的图片在这个点上，这可能导致效率极其低下，因为你不需要一次性把所有图片下载完！</p>
<p>为了让这个变得更好我们能够做什么？</p>
<p>一个更好的模型就是可交互的行在屏幕范围内可见时才开始下载图片。所以你的代码开始将询问表视图有多少行可见。因此，代码应该直到这里有一个未加滤镜的图片等待处理时才开始处理图片加滤镜操作。</p>
<p>为了使 app 更加快速响应，代码将要让图片一旦下载完毕立即显示。让后才开始进行图片加滤镜操作，让后更新 UI 界面来显示已经经过滤镜处理后的图片。下面的图标显示了这个过程的控制流：</p>
<p><img src="/images/operation_queue/operation_queue_06.jpg" alt="Control Flow"></p>
<p><em>Cotroll Flow</em></p>
<p>为了获得这些对象，你需要跟踪这张图片现在是否正在被下载，一旦完成下载，假如图片的滤镜被应用上。你需要跟跟踪每个操作的状态，它是否正在下载中或者执行滤镜操作，以便你能够取消，暂停或者恢复每个操作当用户滚动的时候。</p>
<p>Okey！ 现在你准备好开始码代码了！ :]</p>
<p>打开你下载的工程，添加一个新的<strong>Swift File</strong>到你的工程中命名为** PhotoOperations.swift**。添加下面代码：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PendingOperations</span> &#123;</span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">var</span> downloadsInProgress <span class="operator">=</span> [<span class="type">NSIndexPath</span>:<span class="type">NSOperation</span>]()</span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">var</span> downloadQueue:<span class="type">NSOperationQueue</span> <span class="operator">=</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> queue <span class="operator">=</span> <span class="type">NSOperationQueue</span>()</span><br><span class="line">    queue.name <span class="operator">=</span> <span class="string">&quot;Download queue&quot;</span></span><br><span class="line">    queue.maxConcurrentOperationCount <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> queue</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">var</span> filtrationsInProgress <span class="operator">=</span> [<span class="type">NSIndexPath</span>:<span class="type">NSOperation</span>]()</span><br><span class="line">  <span class="keyword">lazy</span> <span class="keyword">var</span> filtrationQueue:<span class="type">NSOperationQueue</span> <span class="operator">=</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> queue <span class="operator">=</span> <span class="type">NSOperationQueue</span>()</span><br><span class="line">    queue.name <span class="operator">=</span> <span class="string">&quot;Image Filtration queue&quot;</span></span><br><span class="line">    queue.maxConcurrentOperationCount <span class="operator">=</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> queue</span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这回类包含了 2 个字典为了跟踪激活和正在进行中的下载和滤镜操作对表中的每一行，并且两个操作队列都有各自的操作类型。</p>
<p>所有的值被懒加载的方式创建，意味着他们不会被初始化知道他们第一次被接入。这样改善了你 app 的表现性能。</p>
<p>创建一个 <code>NSOperationQueue</code> 是非常简单的，正如你所见，给你的队列命名是非常有用的，因为名字会在仪器或者调速器中显示。 <code>maxConcurrentOperationCount</code> 在这里由于这个教程的缘故被设置成 1，是为了让你看到操作一个接一个完成。你可以离开这一部分允许队列决定他一次处理多少个操作–这样会进一步改善性能。</p>
<p>队列是怎样决定一次运行多少个操作的呢？这是一个非常好的问题！ :] 这取决于硬件。默认， <code>NSOperationQueue</code> 将要处理一写计算在屏幕背后，决定什么是最好的需要看代码是运行在某个具体的平台，和将载入的最大数量的线程数。</p>
<p>考虑到下面的例子，假设系统此时是空闲的，这里有很多资源可用，所以这个队列能够载入可能 8 条并发的线程。下一个时刻你运行程序，系统可能忙于其他不相关的正在抢夺资源的操作，这时队列就仅仅载入 2 个并发的线程。因为你已经设置了一个最大并发操作数，在这个 app 中一次只会进行一个操作。</p>
<blockquote>
<p>注意：你可能想知道为什么你必须跟踪所有的激活的和正在进行中操作。队列有一个 <code>operations</code> 的方法，它将返回一个操作的数组，所有为什么不用它呢？在这个工程中这样做效果不是很好。你需要跟踪更表视图行数关联的操作，它可能会重复执行数组每次你需要一个的时候。把它们储存在一个字典中用 index path 来作为他的 key 方便快速和高效的查找。</p>
</blockquote>
<p>是时候考虑下载和过滤操作了。添加下列代码到 <code>PhotoOperations.swift:</code> 文件的末尾：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ImageDownloader</span>: <span class="title class_ inherited__">NSOperation</span> &#123;</span><br><span class="line">  <span class="comment">//1</span></span><br><span class="line">  <span class="keyword">let</span> photoRecord: <span class="type">PhotoRecord</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//2</span></span><br><span class="line">  <span class="keyword">init</span>(<span class="params">photoRecord</span>: <span class="type">PhotoRecord</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.photoRecord <span class="operator">=</span> photoRecord</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//3</span></span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="comment">//4</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.cancelled &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//5</span></span><br><span class="line">    <span class="keyword">let</span> imageData <span class="operator">=</span> <span class="type">NSData</span>(contentsOfURL:<span class="keyword">self</span>.photoRecord.url)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.cancelled &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//7</span></span><br><span class="line">    <span class="keyword">if</span> imageData<span class="operator">?</span>.length <span class="operator">&gt;</span> <span class="number">0</span> &#123;</span><br><span class="line">      <span class="keyword">self</span>.photoRecord.image <span class="operator">=</span> <span class="type">UIImage</span>(data:imageData<span class="operator">!</span>)</span><br><span class="line">      <span class="keyword">self</span>.photoRecord.state <span class="operator">=</span> .<span class="type">Downloaded</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">self</span>.photoRecord.state <span class="operator">=</span> .<span class="type">Failed</span></span><br><span class="line">      <span class="keyword">self</span>.photoRecord.image <span class="operator">=</span> <span class="type">UIImage</span>(named: <span class="string">&quot;Failed&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <code>NSOperation</code> 是一个抽象类，为它的子类而设计。每个子类代表了一个特别的 <code>任务</code> 正如呈现在列表早期那样。</p>
<p>下面是上面代码每行注释到底发生了什么的说明：</p>
<ol>
<li>添加一个常量引用到和操作相关的 <code>PhotoRecord</code> 对象</li>
<li>创建一个设计初始化方法允许 <code>photo record</code> 参数可以被传进来</li>
<li><code>main</code> 是你在 <code>NSOperation</code> 子类中需要重写的方法，用来执行相关工作</li>
<li>在启动开始前检查是否被取消，操作应该定期检查是否已经被取消在尝试长时间或密集的工作之前</li>
<li>下载图片数据</li>
<li>再次检查是否被取消</li>
<li>假如这里有数据，创建一个图片对象然后把它添加到记录中，同时改变它的状态，假如这里没有数据，把这条记录标记成失败然后设置适当的图片</li>
</ol>
<p>下一步，你将创建另一个操作来处理图片加滤镜的操作！添加下面的代码到 <code>PhotoOperations.swift</code> 文件末尾：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ImageFiltration</span>: <span class="title class_ inherited__">NSOperation</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> photoRecord: <span class="type">PhotoRecord</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">init</span>(<span class="params">photoRecord</span>: <span class="type">PhotoRecord</span>) &#123;</span><br><span class="line">    <span class="keyword">self</span>.photoRecord <span class="operator">=</span> photoRecord</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">main</span> () &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.cancelled &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.photoRecord.state <span class="operator">!=</span> .<span class="type">Downloaded</span> &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> filteredImage <span class="operator">=</span> <span class="keyword">self</span>.applySepiaFilter(<span class="keyword">self</span>.photoRecord.image<span class="operator">!</span>) &#123;</span><br><span class="line">      <span class="keyword">self</span>.photoRecord.image <span class="operator">=</span> filteredImage</span><br><span class="line">      <span class="keyword">self</span>.photoRecord.state <span class="operator">=</span> .<span class="type">Filtered</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了你对图片应用滤镜（使用一个未实现的方法，因此编译 1 错误）而不是下载它之外，这个看起来和下载操作非常相像。</p>
<p>添加遗失的图片滤镜处理方法到 <code>ImageFiltration</code> 类中:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(image:<span class="type">UIImage</span>) -&gt; <span class="type">UIImage</span>? &#123;</span><br><span class="line">  <span class="keyword">let</span> inputImage <span class="operator">=</span> <span class="type">CIImage</span>(data:<span class="type">UIImagePNGRepresentation</span>(image))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">self</span>.cancelled &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> context <span class="operator">=</span> <span class="type">CIContext</span>(options:<span class="literal">nil</span>)</span><br><span class="line">  <span class="keyword">let</span> filter <span class="operator">=</span> <span class="type">CIFilter</span>(name:<span class="string">&quot;CISepiaTone&quot;</span>)</span><br><span class="line">  filter.setValue(inputImage, forKey: kCIInputImageKey)</span><br><span class="line">  filter.setValue(<span class="number">0.8</span>, forKey: <span class="string">&quot;inputIntensity&quot;</span>)</span><br><span class="line">  <span class="keyword">let</span> outputImage <span class="operator">=</span> filter.outputImage</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">self</span>.cancelled &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> outImage <span class="operator">=</span> context.createCGImage(outputImage, fromRect: outputImage.extent())</span><br><span class="line">  <span class="keyword">let</span> returnImage <span class="operator">=</span> <span class="type">UIImage</span>(CGImage: outImage)</span><br><span class="line">  <span class="keyword">return</span> returnImage</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>图片添加滤镜操作使用先前 <code>ListViewController</code> 中相同的实现。已经把它移动到这里来了以至于它它能在后台的一个单独的操作中完成。再次强调，你应该非常频繁的检查取消操作；最佳实践是在进行任何耗时操作调用之前和之后。一旦加滤镜操作完成，你应该立即设置 photo record 实例的值。</p>
<p>很棒！现在你已经有了所有的工具和基础为了处理后台任务进程的操作。是时候回到控制器修改它以便能利用所有这些新的福利。</p>
<p>切换到 <code>ListViewController.swift</code> 文件，然后删除 <code>lazy var photos</code> 接口声明。添加下面声明：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> photos <span class="operator">=</span> [<span class="type">PhotoRecord</span>]()</span><br><span class="line"><span class="keyword">let</span> pendingOperations <span class="operator">=</span> <span class="type">PendingOperations</span>()</span><br></pre></td></tr></table></figure>

<p>这些将持有一个数组的你在开始创建的 <code>PhotoDetails</code> 对象， <code>PendingOperations</code> 对象来管理操作。</p>
<p>添加一个下载 <code>photos property</code> 列表新的方法到类中：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">fetchPhotoDetails</span>() &#123;</span><br><span class="line">  <span class="keyword">let</span> request <span class="operator">=</span> <span class="type">NSURLRequest</span>(URL:dataSourceURL<span class="operator">!</span>)</span><br><span class="line">  <span class="type">UIApplication</span>.sharedApplication().networkActivityIndicatorVisible <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="type">NSURLConnection</span>.sendAsynchronousRequest(request, queue: <span class="type">NSOperationQueue</span>.mainQueue()) &#123;response,data,error <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> data <span class="operator">!=</span> <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> datasourceDictionary <span class="operator">=</span> <span class="type">NSPropertyListSerialization</span>.propertyListWithData(data, options: <span class="type">Int</span>(<span class="type">NSPropertyListMutabilityOptions</span>.<span class="type">Immutable</span>.rawValue), format: <span class="literal">nil</span>, error: <span class="literal">nil</span>) <span class="keyword">as!</span> <span class="type">NSDictionary</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span>(key : <span class="type">AnyObject</span>,value : <span class="type">AnyObject</span>) <span class="keyword">in</span> datasourceDictionary &#123;</span><br><span class="line">        <span class="keyword">let</span> name <span class="operator">=</span> key <span class="keyword">as?</span> <span class="type">String</span></span><br><span class="line">        <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">NSURL</span>(string:value <span class="keyword">as?</span> <span class="type">String</span> <span class="operator">??</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> name <span class="operator">!=</span> <span class="literal">nil</span> <span class="operator">&amp;&amp;</span> url <span class="operator">!=</span> <span class="literal">nil</span> &#123;</span><br><span class="line">          <span class="keyword">let</span> photoRecord <span class="operator">=</span> <span class="type">PhotoRecord</span>(name:name<span class="operator">!</span>, url:url<span class="operator">!</span>)</span><br><span class="line">          <span class="keyword">self</span>.photos.append(photoRecord)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">self</span>.tableView.reloadData()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> error <span class="operator">!=</span> <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> alert <span class="operator">=</span> <span class="type">UIAlertView</span>(title:<span class="string">&quot;Oops!&quot;</span>,message:error.localizedDescription, delegate:<span class="literal">nil</span>, cancelButtonTitle:<span class="string">&quot;OK&quot;</span>)</span><br><span class="line">      alert.show()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">UIApplication</span>.sharedApplication().networkActivityIndicatorVisible <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法创建一个异步的网络请求，当完成的时候，将执行 <code>completion block</code> 在主线程。当下载完成 property list 的数据被萃取成一个 <code>NSDictionary</code> ,然后再次处理一个数组的 <code>PhotoRecord</code> 的对象。你不能直接使用这里的 <code>NSOperation</code> ,你应该在主线程中接入它使用 <code>NSOperationQueue.mainQueue()</code> 。</p>
<p>在 <code>viewDidLoad</code> 调用新方法</p>
<blockquote>
<p>fetchPhotoDetails()</p>
</blockquote>
<p>下一步找到 <code>tableView(_:cellForRowAtIndexPath:)</code> 然后替换它用下面的实现：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">tableView</span>(<span class="params">tableView</span>: <span class="type">UITableView</span>, <span class="params">cellForRowAtIndexPath</span> <span class="params">indexPath</span>: <span class="type">NSIndexPath</span>) -&gt; <span class="type">UITableViewCell</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> cell <span class="operator">=</span> tableView.dequeueReusableCellWithIdentifier(<span class="string">&quot;CellIdentifier&quot;</span>, forIndexPath: indexPath) <span class="keyword">as!</span> <span class="type">UITableViewCell</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//1</span></span><br><span class="line">  <span class="keyword">if</span> cell.accessoryView <span class="operator">==</span> <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> indicator <span class="operator">=</span> <span class="type">UIActivityIndicatorView</span>(activityIndicatorStyle: .<span class="type">Gray</span>)</span><br><span class="line">    cell.accessoryView <span class="operator">=</span> indicator</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> indicator <span class="operator">=</span> cell.accessoryView <span class="keyword">as!</span> <span class="type">UIActivityIndicatorView</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//2</span></span><br><span class="line">  <span class="keyword">let</span> photoDetails <span class="operator">=</span> photos[indexPath.row]</span><br><span class="line"></span><br><span class="line">  <span class="comment">//3</span></span><br><span class="line">  cell.textLabel<span class="operator">?</span>.text <span class="operator">=</span> photoDetails.name</span><br><span class="line">  cell.imageView<span class="operator">?</span>.image <span class="operator">=</span> photoDetails.image</span><br><span class="line"></span><br><span class="line">  <span class="comment">//4</span></span><br><span class="line">  <span class="keyword">switch</span> (photoDetails.state)&#123;</span><br><span class="line">  <span class="keyword">case</span> .<span class="type">Filtered</span>:</span><br><span class="line">    indicator.stopAnimating()</span><br><span class="line">  <span class="keyword">case</span> .<span class="type">Failed</span>:</span><br><span class="line">    indicator.stopAnimating()</span><br><span class="line">    cell.textLabel<span class="operator">?</span>.text <span class="operator">=</span> <span class="string">&quot;Failed to load&quot;</span></span><br><span class="line">  <span class="keyword">case</span> .<span class="type">New</span>, .<span class="type">Downloaded</span>:</span><br><span class="line">    indicator.startAnimating()</span><br><span class="line">    <span class="keyword">self</span>.startOperationsForPhotoRecord(photoDetails,indexPath:indexPath)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> cell</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>花点时间来通读注释区域下面的解释：</p>
<ol>
<li>为了给用户提供反馈，创建 <code>UIActivityIndicatorView</code> 让后把它设成 cell 的 accessory view。</li>
<li>数据源包含 <code>PhotoRecord</code> 实例。抓取正确的数据基于当前行的 <code>indexPath</code> 。</li>
<li>cell 的文本标签总是一样的，图片被正确的设置在 <code>PhotoRecord</code> 中当它被处理的时候，以便你能够设置他们两者，而不管记录的状态。</li>
<li>检查记录，正确的设置 activity indicator 和文本，然后开始操作（暂时还没实现）</li>
</ol>
<p>你可以移除 <code>applySepiaFilter</code> 的实现，因为那个将不再被调用了，添加下面的方法到类中来开始操作：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">startOperationsForPhotoRecord</span>(<span class="params">photoDetails</span>: <span class="type">PhotoRecord</span>, <span class="params">indexPath</span>: <span class="type">NSIndexPath</span>)&#123;</span><br><span class="line">  <span class="keyword">switch</span> (photoDetails.state) &#123;</span><br><span class="line">  <span class="keyword">case</span> .<span class="type">New</span>:</span><br><span class="line">    startDownloadForRecord(photoDetails, indexPath: indexPath)</span><br><span class="line">  <span class="keyword">case</span> .<span class="type">Downloaded</span>:</span><br><span class="line">    startFiltrationForRecord(photoDetails, indexPath: indexPath)</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="type">NSLog</span>(<span class="string">&quot;do nothing&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里，你将传递一个 <code>PhotoRecord</code> 类型的实例带有它的 <code>index path</code> 。<br>依据 <code>photo record</code> 的状态，你选开始进行下载还是加滤镜的步骤。</p>
<blockquote>
<p>注意：下载图片和给图片加滤镜的方法分开实现，因为这里有可能出现当一个图片正在被下载，用户可能把它滚开了，这样你就不必对它应用滤镜操作。当下一次用户又来到相同的哪行时，你不必重新下载图片；你只需对它应用<br>图片滤镜即可！ Efficiency rocks! :]</p>
</blockquote>
<p>现在你需要实现你在上面调用的方法。记住你创建的自定义的类， <code>PendingOperations</code> ,保持跟踪操作；现在实际上你可以使用它了！添加下面的方法到类中：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">startDownloadForRecord</span>(<span class="params">photoDetails</span>: <span class="type">PhotoRecord</span>, <span class="params">indexPath</span>: <span class="type">NSIndexPath</span>)&#123;</span><br><span class="line">  <span class="comment">//1</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> downloadOperation <span class="operator">=</span> pendingOperations.downloadsInProgress[indexPath] &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//2</span></span><br><span class="line">  <span class="keyword">let</span> downloader <span class="operator">=</span> <span class="type">ImageDownloader</span>(photoRecord: photoDetails)</span><br><span class="line">  <span class="comment">//3</span></span><br><span class="line">  downloader.completionBlock <span class="operator">=</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> downloader.cancelled &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_async(dispatch_get_main_queue(), &#123;</span><br><span class="line">      <span class="keyword">self</span>.pendingOperations.downloadsInProgress.removeValueForKey(indexPath)</span><br><span class="line">      <span class="keyword">self</span>.tableView.reloadRowsAtIndexPaths([indexPath], withRowAnimation: .<span class="type">Fade</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//4</span></span><br><span class="line">  pendingOperations.downloadsInProgress[indexPath] <span class="operator">=</span> downloader</span><br><span class="line">  <span class="comment">//5</span></span><br><span class="line">  pendingOperations.downloadQueue.addOperation(downloader)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">startFiltrationForRecord</span>(<span class="params">photoDetails</span>: <span class="type">PhotoRecord</span>, <span class="params">indexPath</span>: <span class="type">NSIndexPath</span>)&#123;</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> filterOperation <span class="operator">=</span> pendingOperations.filtrationsInProgress[indexPath]&#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> filterer <span class="operator">=</span> <span class="type">ImageFiltration</span>(photoRecord: photoDetails)</span><br><span class="line">  filterer.completionBlock <span class="operator">=</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> filterer.cancelled &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    dispatch_async(dispatch_get_main_queue(), &#123;</span><br><span class="line">      <span class="keyword">self</span>.pendingOperations.filtrationsInProgress.removeValueForKey(indexPath)</span><br><span class="line">      <span class="keyword">self</span>.tableView.reloadRowsAtIndexPaths([indexPath], withRowAnimation: .<span class="type">Fade</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  pendingOperations.filtrationsInProgress[indexPath] <span class="operator">=</span> filterer</span><br><span class="line">  pendingOperations.filtrationQueue.addOperation(filterer)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Okey!下面是一个快速列表来帮助你立即上面的代码到底做了什么：</p>
<ol>
<li>首先，检查特定的 <code>indexPath</code> 来看这里是否已经有一个操作在 <code>downloadsInProgress</code> 中。假如有，忽略它。</li>
<li>假如没有，通过 <code>designated initializer</code> 创建一个 <code>ImageDownloader</code> 实例</li>
<li>添加一个当操作完成时执行的完成 block。这是最好的地方让你其余的应用知道一个操作已经完成。注意完成 block 必须被执行即使这个操作被取消，这相当的重要，所以你需要使用 GCD 来触发重新载入表视图在主线程。</li>
<li>添加操作到 <code>downloadsInProgress</code> 中来保持跟踪一些事情。</li>
<li>添加操作到下载队列中。这是你实际获取这些操作开始运行的方法–队列需要注意的是一旦你添加了操作它就会执行。</li>
</ol>
<p>过滤图片的方法遵循下面相同的类型，除了它使用 <code>ImageFiltration</code> 和 <code>filtrationsInProgress</code> 来跟踪操作。作为经验，你应该尝试不要重复这个区域的代码 :]</p>
<p>你做到了！你的工程完成了。构建让后运行看有什么改进在操作上！当你滚动表视图的时候，app 并没有停止，还是像它们变得可见一样继续下载图片和给图片加滤镜操作。</p>
<p><img src="/images/operation_queue/operation_queue_07.jpg" alt="classicphotos-stalled-screenshot"></p>
<p><em>原来的图片，现在可以滚动了</em></p>
<p>是不是很酷？你能看到随做你的进步让你的应用更易于响应能做出的努力 –对用户来说更有趣！</p>
<h3 id="细微的调整"><a href="#细微的调整" class="headerlink" title="细微的调整"></a>细微的调整</h3><p>你已经随着这个教程走过漫长的路！你的小项目现在反应灵敏表明了在原来的版本基础上有很多改进。然而，这里任然有一些遗留的细节我们需要考虑。你是想成为一名伟大的程序员，而不仅仅是一名优秀的程序员！</p>
<p>你可能已经注意到了当你滚动表视图时，那些离屏的 cell 仍然在处理下载和给图片加滤镜的操作。假如你快速滚动，app 将忙于下载和给图片处理滤镜的操作，在列表中从最前面甚至到不可见的地方。理想的情况下 app 应该对离开屏幕的 cells 就是现在不可见的取消滤镜操作。</p>
<p>难道你没有把取消的规定放进你的代码里？ 是的，你做了–现在你应该充分利用它们！:]</p>
<p>回到 Xcode，让后打开 <code>ListViewController.swift</code> 文件。去到 <code>tableView(_:cellForRowAtIndexPath:)</code> 方法的实现，封装 <code>startOperationsForPhotoRecord</code> 调用在一个 if 条件向下面的：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="operator">!</span>tableView.dragging <span class="operator">&amp;&amp;</span> <span class="operator">!</span>tableView.decelerating) &#123;</span><br><span class="line">  <span class="keyword">self</span>.startOperationsForPhotoRecord(photoDetails, indexPath: indexPath)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你需要告诉表视图开始操作仅仅当表视图没有滚动的时候。这实际上是 <code>UIScrollView</code> 的接口，由于 <code>UITableView</code> 是 <code>UIScrollView</code> 的子类，你自动继承了这些接口。</p>
<p>下一步，添加到下面 <code>UIScrollView</code> 代理方法的实现到类中：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">scrollViewWillBeginDragging</span>(<span class="params">scrollView</span>: <span class="type">UIScrollView</span>) &#123;</span><br><span class="line">  <span class="comment">//1</span></span><br><span class="line">  suspendAllOperations()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">scrollViewDidEndDragging</span>(<span class="params">scrollView</span>: <span class="type">UIScrollView</span>, <span class="params">willDecelerate</span> <span class="params">decelerate</span>: <span class="type">Bool</span>) &#123;</span><br><span class="line">  <span class="comment">// 2</span></span><br><span class="line">  <span class="keyword">if</span> <span class="operator">!</span>decelerate &#123;</span><br><span class="line">    loadImagesForOnscreenCells()</span><br><span class="line">    resumeAllOperations()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="keyword">func</span> <span class="title function_">scrollViewDidEndDecelerating</span>(<span class="params">scrollView</span>: <span class="type">UIScrollView</span>) &#123;</span><br><span class="line">  <span class="comment">// 3</span></span><br><span class="line">  loadImagesForOnscreenCells()</span><br><span class="line">  resumeAllOperations()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>快速走查上面的代码显示在下面：</p>
<ol>
<li>当用户开始滚动，你想暂停所有的操作让后看看用户想看到什么。你将要实现 <code>suspendAllOperations</code> 在一会儿工夫。</li>
<li>假如 <code>decelerate</code> 的值是 <code>false</code> ,那就意味着停止拖拽表视图，因此你想恢复暂停的，因为 cell 离开屏幕取消的操作，启动在屏幕内 cells 的操作。你将要一起实现 <code>loadImagesForOnscreenCells</code> 和 <code>resumeAllOperations</code> 。</li>
<li>代理方法告诉你表视图已经停止滚动，所以你将做和#2 条相同的处理。</li>
</ol>
<p>现在，添加下面这些遗失的方法的实现到 <code>ListViewController.swift</code> :</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">suspendAllOperations</span> () &#123;</span><br><span class="line">  pendingOperations.downloadQueue.suspended <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">  pendingOperations.filtrationQueue.suspended <span class="operator">=</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">resumeAllOperations</span> () &#123;</span><br><span class="line">  pendingOperations.downloadQueue.suspended <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">  pendingOperations.filtrationQueue.suspended <span class="operator">=</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> <span class="title function_">loadImagesForOnscreenCells</span> () &#123;</span><br><span class="line">  <span class="comment">//1</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> pathsArray <span class="operator">=</span> tableView.indexPathsForVisibleRows() &#123;</span><br><span class="line">    <span class="comment">//2</span></span><br><span class="line">    <span class="keyword">var</span> allPendingOperations <span class="operator">=</span> <span class="type">Set</span>(pendingOperations.downloadsInProgress.keys.array)</span><br><span class="line">    allPendingOperations.unionInPlace(pendingOperations.filtrationsInProgress.keys.array)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3</span></span><br><span class="line">    <span class="keyword">var</span> toBeCancelled <span class="operator">=</span> allPendingOperations</span><br><span class="line">    <span class="keyword">let</span> visiblePaths <span class="operator">=</span> <span class="type">Set</span>(pathsArray <span class="keyword">as!</span> [<span class="type">NSIndexPath</span>])</span><br><span class="line">    toBeCancelled.subtractInPlace(visiblePaths)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4</span></span><br><span class="line">    <span class="keyword">var</span> toBeStarted <span class="operator">=</span> visiblePaths</span><br><span class="line">    toBeStarted.subtractInPlace(allPendingOperations)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5</span></span><br><span class="line">    <span class="keyword">for</span> indexPath <span class="keyword">in</span> toBeCancelled &#123;</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> pendingDownload <span class="operator">=</span> pendingOperations.downloadsInProgress[indexPath] &#123;</span><br><span class="line">        pendingDownload.cancel()</span><br><span class="line">      &#125;</span><br><span class="line">      pendingOperations.downloadsInProgress.removeValueForKey(indexPath)</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> pendingFiltration <span class="operator">=</span> pendingOperations.filtrationsInProgress[indexPath] &#123;</span><br><span class="line">        pendingFiltration.cancel()</span><br><span class="line">      &#125;</span><br><span class="line">      pendingOperations.filtrationsInProgress.removeValueForKey(indexPath)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6</span></span><br><span class="line">    <span class="keyword">for</span> indexPath <span class="keyword">in</span> toBeStarted &#123;</span><br><span class="line">      <span class="keyword">let</span> indexPath <span class="operator">=</span> indexPath <span class="keyword">as</span> <span class="type">NSIndexPath</span></span><br><span class="line">      <span class="keyword">let</span> recordToProcess <span class="operator">=</span> <span class="keyword">self</span>.photos[indexPath.row]</span><br><span class="line">      startOperationsForPhotoRecord(recordToProcess, indexPath: indexPath)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <code>suspendAllOperations</code> 和 <code>resumeAllOperations</code> 有一个简单的实现。 <code>NSOperationQueues</code> 能够被暂停，通过设置 <code>suspended</code> 接口为 <code>true</code> 。这将暂停队列里面的所有操作–你不能单独暂停一个操作。</p>
<p> <code>loadImagesForOnscreenCells</code> 有一点小复杂。这里发生了什么事？</p>
<ol>
<li>以一个包含了现在表视图可见的 <code>index paths</code> 的数组开始开始</li>
<li>构造一个所有进行中的操作的集合通过结合所有在下载的进度+所有在处理滤镜的进度。</li>
<li>构造一个 <code>index paths</code> 集合用来取消操作。开始所有的操作，然后移除可见行的 <code>index paths</code> ，这样讲留下一个离开屏幕的行正在执行的操作集合</li>
<li>构造一个 <code>index paths</code> 集合，需要操作启动，用所有可见行的 <code>index paths</code> 启动，让后移除它们中在进行的操作。</li>
<li>遍历那些被取消的操作，取消它们，然后移除它们的引用从 <code>PendingOperations</code> 。</li>
<li>遍历那些将要开始的操作，然后对他们每个调用 <code>startOperationsForPhotoRecord</code> 。</li>
</ol>
<p>构建运行然后你发现一个更流畅，资源管理德更好的应用！给你自己一轮掌声！</p>
<p><img src="/images/operation_queue/operation_queue_09.jpg" alt="improved app"></p>
<p><em>原来的相册，载入东西一次一个</em></p>
<p>注意到当你完成滚动表视图，在可见区域行的 cell 的图片立即开始处理。</p>
<h3 id="何去何从？"><a href="#何去何从？" class="headerlink" title="何去何从？"></a>何去何从？</h3><p>这里是<a target="_blank" rel="noopener" href="http://cdn2.raywenderlich.com/wp-content/uploads/2014/10/ClassicPhotos-Final63.zip">completed version of the project</a>。</p>
<blockquote>
<p>注意：此教程写于 <code>Update 17 April 2015: Updated for Xcode 6.3 and Swift 1.2</code> ,现在 Swift 最新版本 2.1 使用 Xcode7+以上编辑会报错，这里打包一个新语法修改版<a target="_blank" rel="noopener" href="https://github.com/wangruofeng/ClassicPhotos-Starter-fixed/archive/master.zip">completed fixed version of the project</a>。</p>
</blockquote>
<p>假如你完成这个工程应该花时间来真正理解它，恭喜你！你可以认为你自己是一位更有价值 iOS 开发者了比起在教程刚开始的时候！大多数开发的公司是非常幸运的有一个或者两个人正在知道这个东西。</p>
<p>当时请当心 – 像多层嵌套的 blocks,不必要的使用多线程可能让一个工程变得难以理解对维护你代码的人来说。线程可能引入一些难以捉摸的 bugs，将永远不出现知道你网络非常慢，或者代码运行在一个更快（或更慢）的设备上，或一个不同数量的核的芯片上时。小心测试，尽量使用 <code>Instruments</code> （或者你自己的观察）来确定引入多线程真的有很大改进。</p>
<p>一个有用的特征使用操作时在这里没涉及到就是依赖（ <code>dependency</code> ）。你可以给一个操作添加一个或者更多的操作的依赖。这个操作不会开始直到它所有依赖的操作完成时。例如：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyDownloadOperation is a subclass of NSOperation</span></span><br><span class="line"><span class="keyword">let</span> downloadOperation <span class="operator">=</span> <span class="type">MyDownloadOperation</span>()</span><br><span class="line"><span class="comment">// MyFilterOperation  is a subclass of NSOperation</span></span><br><span class="line"><span class="keyword">let</span> filterOperation <span class="operator">=</span> <span class="type">MyFilterOperation</span>()</span><br><span class="line"></span><br><span class="line">filterOperation.addDependency(downloadOperation)</span><br></pre></td></tr></table></figure>

<p>移除依赖：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filterOperation.removeDependency(downloadOperation)</span><br></pre></td></tr></table></figure>

<p>这个工程是否能使用依赖简化呢？把你学到的新技能用起来试一试 ：]<br>有件非常重要的事需要注意的就是一个依赖操作将仍然启动假如它依赖的操作被取消，还有它将自然完成。你需要牢记在心。</p>
<p>假如你有任何评论或者问题关于这个教程或者 <code>NSOperations</code> ,请加<a target="_blank" rel="noopener" href="https://github.com/wangruofeng/Github_Blog/pulls">Pull request</a>。</p>
<p>译者注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com/">http://blog.wangruofeng007.com</a></p>
<!-- processed 2 -->

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/13/2016-01-13-duo-xian-cheng-zhi-nsoperation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/13/2016-01-13-duo-xian-cheng-zhi-nsoperation/" class="post-title-link" itemprop="url">多线程之 NSOperation</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-13 05:14:59" itemprop="dateCreated datePublished" datetime="2016-01-13T05:14:59+08:00">2016-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-02 21:17:02" itemprop="dateModified" datetime="2024-11-02T21:17:02+08:00">2024-11-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">多线程</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
  
    <a title="disqus" href="/2016/01/13/2016-01-13-duo-xian-cheng-zhi-nsoperation/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/13/2016-01-13-duo-xian-cheng-zhi-nsoperation/" itemprop="commentCount"></span>
    </a>
  </span>
  
 <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>7 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>本文目录</strong></p>
<ul>
<li>前言</li>
<li>NSInvocationOperation</li>
<li>NSBlokcOperation</li>
<li>NSOperation的其他用法</li>
<li>自定义NSOperation</li>
<li>参考资料</li>
</ul>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>1.虽然<code>NSThread</code>也可以实现多线程编程，但是需要我们去管理线程的生命周期，还要考虑线程同步、加锁问题，造成一些性能上的开销。我们也可以配合使用<code>NSOperation</code>和<code>NSOperationQueue</code>实现多线程编程，实现步骤大致是这样的</p>
<ul>
<li>先将需要执行的操作封装到一个NSOperation对象中</li>
<li>然后将NSOperation对象添加到NSOperationQueue中</li>
<li>系统会自动将<code>NSOperation</code>中封装的操作放到一条新线程中执行在此过程中，我们根本不用考虑线程的生命周期、同步、加锁等问题下面列举一个应用场景，比如微博的粉丝列表：</li>
</ul>
<p><img src="/images/common/weibo_fancy.png" alt="微博的粉丝列表"></p>
<p>每一行的头像肯定要从新浪服务器下载图片后才能显示的，而且是需要异步下载。这时候你就可以把每一行的图片下载操作封装到一个<code>NSOperation</code>对象中，上面有6行，所以要创建6个<code>NSOperation</code>对象，然后添加到<code>NSOperationQueue</code>中，分别下载不同的图片，下载完毕后，回到对应的行将图片显示出来。</p>
<p>2 .默认情况下，<code>NSOperation</code>并不具备封装操作的能力，必须使用它的子类，使用NSOperation子类的方式有3种：</p>
<ul>
<li>NSInvocationOperation</li>
<li>NSBlockOperation</li>
<li>自定义子类继承NSOperation，实现内部相应的方法</li>
</ul>
<p>这讲先介绍如何用<code>NSOperation</code>封装一个操作，后面再结合<code>NSOperationQueue</code>来使用。</p>
<h2 id="NSInvocationOperation"><a href="#NSInvocationOperation" class="headerlink" title="NSInvocationOperation"></a>NSInvocationOperation</h2><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSInvocationOperation</span> *operation = [[<span class="built_in">NSInvocationOperation</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(run:) object:<span class="string">@&quot;mj&quot;</span>];</span><br><span class="line">[operation start];</span><br></pre></td></tr></table></figure>

<ul>
<li>第1行初始化了一个<code>NSInvocationOperation</code>对象，它是基于一个对象和selector来创建操作</li>
<li>第2行调用了start方法，紧接着会马上执行封装好的操作，也就是会调用self的run:方法，并且将@”mj”作为方法参数</li>
<li>这里要注意：默认情况下，调用了start方法后并不会开一条新线程去执行操作，而是在当前线程同步执行操作。只有将operation放到一个NSOperationQueue中，才会异步执行操作。</li>
</ul>
<h2 id="NSBlockOperation"><a href="#NSBlockOperation" class="headerlink" title="NSBlockOperation"></a>NSBlockOperation</h2><h3 id="a-同步执行一个操作"><a href="#a-同步执行一个操作" class="headerlink" title="a.同步执行一个操作"></a>a.同步执行一个操作</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSBlockOperation</span> *operation = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^()&#123;</span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@&quot;执行了一个新的操作&quot;</span>);</span><br><span class="line"> &#125;];</span><br><span class="line">  <span class="comment">// 开始执行任务</span></span><br><span class="line">[operation start];</span><br></pre></td></tr></table></figure>

<ul>
<li>第1行初始化了一个NSBlockOperation对象，它是用一个Block来封装需要执行的操作</li>
<li>第2行调用了start方法，紧接着会马上执行Block中的内容</li>
<li>这里还是在当前线程同步执行操作，并没有异步执行</li>
</ul>
<h3 id="b-并发执行多个操作"><a href="#b-并发执行多个操作" class="headerlink" title="b.并发执行多个操作"></a>b.并发执行多个操作</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSBlockOperation</span> *operation = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^()&#123;</span><br><span class="line">　　<span class="built_in">NSLog</span>(<span class="string">@&quot;执行第1次操作，线程：%@&quot;</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">[operation addExecutionBlock:^() &#123;</span><br><span class="line">　　<span class="built_in">NSLog</span>(<span class="string">@&quot;又执行了1个新的操作，线程：%@&quot;</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">[operation addExecutionBlock:^() &#123;</span><br><span class="line">　　<span class="built_in">NSLog</span>(<span class="string">@&quot;又执行了1个新的操作，线程：%@&quot;</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">[operation addExecutionBlock:^() &#123;</span><br><span class="line">　　<span class="built_in">NSLog</span>(<span class="string">@&quot;又执行了1个新的操作，线程：%@&quot;</span>, [<span class="built_in">NSThread</span> currentThread]);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 开始执行任务</span></span><br><span class="line">[operation start];</span><br></pre></td></tr></table></figure>

<ul>
<li><p>第1行初始化了一个NSBlockOperation对象</p>
</li>
<li><p>分别在第5、9、13行通过addExecutionBlock:方法添加了新的操作，包括第1行的操作，一共封装了4个操作</p>
</li>
<li><p>在第18行调用start方法后，就会并发地执行这4个操作，也就是会在不同线程中执行</p>
<pre><code>  1 2013-02-02 21:38:46.102 thread[4602:c07] 又执行了1个新的操作，线程：&lt;NSThread: 0x7121d50&gt;&#123;name = (null), num = 1&#125;
  2 2013-02-02 21:38:46.102 thread[4602:3f03] 又执行了1个新的操作，线程：&lt;NSThread: 0x742e1d0&gt;&#123;name = (null), num = 5&#125;
  3 2013-02-02 21:38:46.102 thread[4602:1b03] 执行第1次操作，线程：&lt;NSThread: 0x742de50&gt;&#123;name = (null), num = 3&#125;
  4 2013-02-02 21:38:46.102 thread[4602:1303] 又执行了1个新的操作，线程：&lt;NSThread: 0x7157bf0&gt;&#123;name = (null), num = 4&#125;
</code></pre>
</li>
</ul>
<p>可以看出，每个操作所在线程的num值都不一样，说明是不同线程</p>
<h2 id="NSOperation的其他用法"><a href="#NSOperation的其他用法" class="headerlink" title="NSOperation的其他用法"></a>NSOperation的其他用法</h2><h3 id="a-取消操作"><a href="#a-取消操作" class="headerlink" title="a.取消操作"></a>a.取消操作</h3><p>operation开始执行之后, 默认会一直执行操作直到完成，我们也可以调用cancel方法中途取消操作</p>
<pre><code>[operation cancel];
</code></pre>
<h3 id="b-在操作完成后做一些事情"><a href="#b-在操作完成后做一些事情" class="headerlink" title="b.在操作完成后做一些事情"></a>b.在操作完成后做一些事情</h3><p>如果想在一个NSOperation执行完毕后做一些事情，就调用NSOperation的setCompletionBlock方法来设置想做的事情</p>
<pre><code>operation.completionBlock = ^() &#123;
    NSLog(@&quot;执行完毕&quot;);
&#125;;
</code></pre>
<p>当operation封装的操作执行完毕后，就会回调Block里面的内容</p>
<h2 id="自定义NSOperation"><a href="#自定义NSOperation" class="headerlink" title="自定义NSOperation"></a>自定义NSOperation</h2><p>如果<code>NSInvocationOperation</code>和<code>NSBlockOperation</code>不能满足需求，我们可以直接新建子类继承NSOperation，并添加任何需要执行的操作。如果只是简单地自定义NSOperation，只需要重载<code>-(void)main</code>这个方法，在这个方法里面添加需要执行的操作。</p>
<p>下面写个子类DownloadOperation来下载图片</p>
<h3 id="a-继承NSOperation，重写main方法"><a href="#a-继承NSOperation，重写main方法" class="headerlink" title="a.继承NSOperation，重写main方法"></a>a.继承NSOperation，重写main方法</h3><p><em>DownloadOperation.h</em></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">DownloadOperationDelegate</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DownloadOperation</span> : <span class="title">NSOperation</span></span></span><br><span class="line"><span class="comment">// 图片的url路径</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *imageUrl;</span><br><span class="line"><span class="comment">// 代理</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="type">id</span>&lt;DownloadOperationDelegate&gt; delegate;</span><br><span class="line"></span><br><span class="line">- (<span class="type">id</span>)initWithUrl:(<span class="built_in">NSString</span> *)url delegate:(<span class="type">id</span>&lt;DownloadOperationDelegate&gt;)delegate;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 图片下载的协议</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">DownloadOperationDelegate</span> &lt;<span class="title">NSObject</span>&gt;</span></span><br><span class="line">- (<span class="type">void</span>)downloadFinishWithImage:(<span class="built_in">UIImage</span> *)image;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p><em>DownloadOperation.m</em></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="string">&quot;DownloadOperation.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">DownloadOperation</span></span></span><br><span class="line"><span class="keyword">@synthesize</span> delegate = _delegate;</span><br><span class="line"><span class="keyword">@synthesize</span> imageUrl = _imageUrl;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化</span></span><br><span class="line">- (<span class="type">id</span>)initWithUrl:(<span class="built_in">NSString</span> *)url delegate:(<span class="type">id</span>&lt;DownloadOperationDelegate&gt;)delegate &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="variable language_">super</span> init]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.imageUrl = url;</span><br><span class="line">        <span class="keyword">self</span>.delegate = delegate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 释放内存</span></span><br><span class="line">- (<span class="type">void</span>)dealloc &#123;</span><br><span class="line">    [<span class="variable language_">super</span> dealloc];</span><br><span class="line">    [_imageUrl release];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行主任务</span></span><br><span class="line">- (<span class="type">void</span>)main &#123;</span><br><span class="line">    <span class="comment">// 新建一个自动释放池，如果是异步执行操作，那么将无法访问到主线程的自动释放池</span></span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在第22行重载了main方法，等会就把下载图片的代码写到这个方法中</li>
<li>如果这个DownloadOperation是在异步线程中执行操作，也就是说main方法在异步线程调用，那么将无法访问主线程的自动释放池，所以在第24行创建了一个属于当前线程的自动释放池</li>
</ul>
<h3 id="b-正确响应取消事件"><a href="#b-正确响应取消事件" class="headerlink" title="b.正确响应取消事件"></a>b.正确响应取消事件</h3><ul>
<li>默认情况下，一个NSOperation开始执行之后，会一直执行任务到结束，就比如上面的DownloadOperation，默认会执行完main方法中的所有代码</li>
<li>NSOperation提供了一个cancel方法，可以取消当前的操作。</li>
<li>如果是自定义NSOperation的话，需要手动处理这个取消事件。比如，一旦调用了cancel方法，应该马上终止main方法的执行，并及时回收一些资源。</li>
<li>处理取消事件的具体做法是：在<code>main</code>方法中定期地调用<code>isCancelled</code>方法检测操作是否已经被取消，也就是说是否调用了<code>cancel</code>方法，如果返回YES，表示已取消，则立即让main方法返回。</li>
<li>以下地方可能需要调用<code>isCancelled</code>方法:<ol>
<li>在执行任何实际的工作之前，也就是在main方法的开头。因为取消可能发生在任何时候，甚至在operation执行之前。</li>
<li>执行了一段耗时的操作之后也需要检测操作是否已经被取消</li>
</ol>
</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)main &#123;</span><br><span class="line">    <span class="comment">// 新建一个自动释放池，如果是异步执行操作，那么将无法访问到主线程的自动释放池</span></span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.isCancelled) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取图片数据</span></span><br><span class="line">        <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="keyword">self</span>.imageUrl];</span><br><span class="line">        <span class="built_in">NSData</span> *imageData = [<span class="built_in">NSData</span> dataWithContentsOfURL:url];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.isCancelled) &#123;</span><br><span class="line">            url = <span class="literal">nil</span>;</span><br><span class="line">            imageData = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化图片</span></span><br><span class="line">        <span class="built_in">UIImage</span> *image = [<span class="built_in">UIImage</span> imageWithData:imageData];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.isCancelled) &#123;</span><br><span class="line">            image = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span>.delegate respondsToSelector:<span class="keyword">@selector</span>(downloadFinishWithImage:)]) &#123;</span><br><span class="line">            <span class="comment">// 把图片数据传回到主线程</span></span><br><span class="line">            [(<span class="built_in">NSObject</span> *)<span class="keyword">self</span>.delegate performSelectorOnMainThread:<span class="keyword">@selector</span>(downloadFinishWithImage:) withObject:image waitUntilDone:<span class="literal">NO</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>在第4行main方法的开头就先判断operation有没有被取消。如果被取消了，那就没有必要往下执行了</li>
<li>经过第8行下载图片后，在第10行也需要判断操作有没有被取消</li>
<li>总之，执行了一段比较耗时的操作之后，都需要判断操作有没有被取消</li>
<li>图片下载完毕后，在第26行将图片数据传递给了代理(delegate)对象</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li>NSHipster 的<a target="_blank" rel="noopener" href="http://nshipster.com/nsoperation/">NSOperation</a></li>
<li>雷纯锋的博客的<a target="_blank" rel="noopener" href="http://www.leichunfeng.com/blog/2015/07/29/ios-concurrency-programming-operation-queues/">《iOS 并发编程之 Operation Queues》</a></li>
<li>objc的并发编程指南<a target="_blank" rel="noopener" href="http://www.objc.io/issue-2/">《Concurrent Programming》</a></li>
<li><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/10373331/nsoperation-vs-grand-central-dispatch">StackOverflow: NSOperation vs. Grand Central Dispatch</a></li>
<li><a target="_blank" rel="noopener" href="http://eschatologist.net/blog/?p=232">Blog: When to use NSOperation vs. GCD</a></li>
</ul>
<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com/">http://blog.wangruofeng007.com</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/13/2016-01-13-ioszhong-de-hong-mo-shi-jian-he-shou-shi-chu-li/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/13/2016-01-13-ioszhong-de-hong-mo-shi-jian-he-shou-shi-chu-li/" class="post-title-link" itemprop="url">iOS 中的触摸事件和手势处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-13 05:05:09" itemprop="dateCreated datePublished" datetime="2016-01-13T05:05:09+08:00">2016-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-03 13:51:32" itemprop="dateModified" datetime="2024-11-03T13:51:32+08:00">2024-11-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">系统原理</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
  
    <a title="disqus" href="/2016/01/13/2016-01-13-ioszhong-de-hong-mo-shi-jian-he-shou-shi-chu-li/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/13/2016-01-13-ioszhong-de-hong-mo-shi-jian-he-shou-shi-chu-li/" itemprop="commentCount"></span>
    </a>
  </span>
  
 <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="iOS-触摸事件分类"><a href="#iOS-触摸事件分类" class="headerlink" title="iOS 触摸事件分类"></a>iOS 触摸事件分类</h3><ul>
<li>触摸事件</li>
<li>加速事件</li>
<li>远程事件</li>
</ul>
<h3 id="谁能处理触摸事件"><a href="#谁能处理触摸事件" class="headerlink" title="谁能处理触摸事件?"></a>谁能处理触摸事件?</h3><p>响应者对象</p>
<p>在 iOS 中不是任何对象都能处理事件,只有继承了  <code>UIResponder</code>  的对象才能接收并处理事件.我们称之为响应者对象.</p>
<p><code>UIApplication</code>、<code>UIViewController</code>、<code>UIView</code> 都继承自 <code>UIResponder</code>,因此它们都是响应者对象,都能够接收并处理事件.</p>
<h3 id="UIResponder"><a href="#UIResponder" class="headerlink" title="UIResponder"></a>UIResponder</h3><p>UIResponder 内部提供了方法来处理事件</p>
<ol>
<li><p>触摸事件</p>
<p> 一次完成的触摸过程,会经历 3 个状态, UIView 的触摸事件处理</p>
<ul>
<li>一根或多根手指开始触摸 view,系统会自动调用 view 下面的方法: <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)touchesBegan:(<span class="built_in">NSSet</span> *)touches withEvent:(<span class="built_in">UIEvent</span> *)event;  <span class="comment">//触摸开始</span></span><br></pre></td></tr></table></figure></li>
<li>一根或者多根手指在 view 上移动，系统会自动调用 view 下面的方法（随着手指的移动，会持续调用该方法） <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)touchesMoved:(<span class="built_in">NSSet</span> *)touches withEvent:(<span class="built_in">UIEvent</span> *)event;  <span class="comment">//触摸移动</span></span><br></pre></td></tr></table></figure></li>
<li>一根或者多根手指离开 view，系统会自动调用 view 下面的方法 <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)touchesEnded:(<span class="built_in">NSSet</span> *)touches withEvent:(<span class="built_in">UIEvent</span> *)event;  <span class="comment">//触摸结束</span></span><br></pre></td></tr></table></figure></li>
<li>触摸结束前，某个系统事件（例如电话呼入   ）会打断触摸过程，系统会自动调用 view 下面的方法 <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)touchesCancelled:(<span class="built_in">NSSet</span> *)touches withEvent:(<span class="built_in">UIEvent</span> *)event; <span class="comment">//触摸取消(可能会经历)</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p> 4 个触摸事件的处理方法中，都有 NSSet *touches 和 UIEvent *event 两个参数:</p>
<ul>
<li>一次完整的触摸过程，只会产生一个事件对象，4 个触摸方法都是同一个 event 参数</li>
<li>如果两根手指同时触摸一个 view，那么 view 只会调用一次 touchesBegan:withEvent: 方法，touches 参数中装着两个 UITouch 对象；</li>
<li>如果这两根手指一前一后分开触摸同一个 view，那么 view 会分别调用两次 touchesBegan:withEvent:方法， 并且每次调用时的 touches 参数只包含一个 UITouch 对象；</li>
<li>根据 touches 中 UITouch 个数可以判断出使单点触摸还是多点触摸</li>
</ul>
<p> 提示：touches 中存放的都是 UITouch 对象。</p>
</li>
<li><p>加速计事件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)motionBegan:(<span class="built_in">UIEventSubtype</span>)motion withEvent:(<span class="built_in">UIEvent</span> *)event;    </span><br><span class="line">- (<span class="type">void</span>)motionEnded:(<span class="built_in">UIEventSubtype</span>)motion withEvent:(<span class="built_in">UIEvent</span> *)event;    </span><br><span class="line">- (<span class="type">void</span>)motionCancelled:(<span class="built_in">UIEventSubtype</span>)motion withEvent:(<span class="built_in">UIEvent</span> *)event;</span><br></pre></td></tr></table></figure>
</li>
<li><p>远程控制事件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">void</span>)remoteControlReceivedWithEvent:(<span class="built_in">UIEvent</span> *)event;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="UITouch"><a href="#UITouch" class="headerlink" title="UITouch"></a>UITouch</h3><p>当用户用一根手指触摸屏幕时，会创建一个与手指相关联的 UITouch 对象；一根手指对应一个 UITouch 对象<br>UITouch 的作用:</p>
<ul>
<li>保存跟手指相关的信息，比如触摸的位置、时间、阶段；</li>
<li>当手指移动时，系统会更新同一个 UITouch 对象，使之能够一直保存该手指的触摸位置；</li>
<li>当手指离开屏幕时，系统会销毁相应的 UITouch 对象。</li>
</ul>
<p>提示：iPhone 开发中，要避免使用双击事件。</p>
<p>UITouch 的属性:<br>触摸产生时所处的窗口:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">readonly</span>,<span class="keyword">retain</span>) <span class="built_in">UIWindow</span> *window;</span><br></pre></td></tr></table></figure>

<p>触摸产生时所处的视图</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">readonly</span>,<span class="keyword">retain</span>) <span class="built_in">UIView</span> *view;</span><br></pre></td></tr></table></figure>

<p>短时间内点按屏幕的次数，可以根据 tapCount 判断单击、双击或更多地点击</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">readonly</span>) <span class="built_in">NSUInteger</span> tapCount;</span><br></pre></td></tr></table></figure>

<p>记录了触摸事件产生或变化时的时间，单位是秒</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">readonly</span>) <span class="built_in">NSTimeInterval</span> timestamp;</span><br></pre></td></tr></table></figure>

<p>当前触摸事件所处的状态</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">UITouchPhase 是一个枚举类型，包含：</span></span><br><span class="line"><span class="comment">UITouchPhaseBegan（触摸开始）</span></span><br><span class="line"><span class="comment">UITouchPhaseMoved（接触点移动）</span></span><br><span class="line"><span class="comment">UITouchPhaseStationary（接触点无移动）</span></span><br><span class="line"><span class="comment">UITouchPhaseEnded（触摸结束）</span></span><br><span class="line"><span class="comment">UITouchPhaseCancelled（触摸取消）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">readonly</span>) <span class="built_in">UITouchPhase</span> phase;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>UITouch 的方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">CGPoint</span>)locationInView:(<span class="built_in">UIView</span> *)view;</span><br></pre></td></tr></table></figure>

<p>1.返回值表示触摸在 view 上的位置；<br>2.这里返回的位置是针对 view 坐标系的,（以 view 的左上角为原点（0，0））；<br>3.调用时传入的 view 参数为 nil 的话，返回的是触摸点在 UIWindow 的位置。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">CGPoint</span>)previousLocationInView:(<span class="built_in">UIView</span> *)view;</span><br></pre></td></tr></table></figure>

<p>该方法记录了前一个触摸点的位置；</p>
<h3 id="UIEvent"><a href="#UIEvent" class="headerlink" title="UIEvent"></a>UIEvent</h3><blockquote>
<p>每产生一个事件，就会产生一个 UIEvent 对象；<br>UIEvent:称为事件对象，记录事件产生的时刻和类型。</p>
</blockquote>
<p>常见属性：<br>1.事件类型</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">readonly</span>) <span class="built_in">UIEventType</span>  type;</span><br><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">readonly</span>) <span class="built_in">UIEventSubtype</span>  subtype;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span></span><br><span class="line"><span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, <span class="built_in">UIEventType</span>) &#123;</span><br><span class="line">    <span class="built_in">UIEventTypeTouches</span>,</span><br><span class="line">    <span class="built_in">UIEventTypeMotion</span>,</span><br><span class="line">    <span class="built_in">UIEventTypeRemoteControl</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span></span><br><span class="line"><span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, <span class="built_in">UIEventSubtype</span>) &#123;</span><br><span class="line">    <span class="comment">// available in iPhone OS 3.0</span></span><br><span class="line">    <span class="built_in">UIEventSubtypeNone</span>                              = <span class="number">0</span>,    <span class="comment">// for UIEventTypeMotion, available in iPhone OS 3.0</span></span><br><span class="line">    <span class="built_in">UIEventSubtypeMotionShake</span>                       = <span class="number">1</span>,</span><br><span class="line">    <span class="comment">// for UIEventTypeRemoteControl, available in iOS 4.0</span></span><br><span class="line">    <span class="built_in">UIEventSubtypeRemoteControlPlay</span>                 = <span class="number">100</span>,</span><br><span class="line">    <span class="built_in">UIEventSubtypeRemoteControlPause</span>                = <span class="number">101</span>,</span><br><span class="line">    <span class="built_in">UIEventSubtypeRemoteControlStop</span>                 = <span class="number">102</span>,</span><br><span class="line">    <span class="built_in">UIEventSubtypeRemoteControlTogglePlayPause</span>      = <span class="number">103</span>,</span><br><span class="line">    <span class="built_in">UIEventSubtypeRemoteControlNextTrack</span>            = <span class="number">104</span>,    <span class="built_in">UIEventSubtypeRemoteControlPreviousTrack</span>        = <span class="number">105</span>,</span><br><span class="line">    <span class="built_in">UIEventSubtypeRemoteControlBeginSeekingBackward</span> = <span class="number">106</span>,    <span class="built_in">UIEventSubtypeRemoteControlEndSeekingBackward</span>   = <span class="number">107</span>,    <span class="built_in">UIEventSubtypeRemoteControlBeginSeekingForward</span>  = <span class="number">108</span>,    <span class="built_in">UIEventSubtypeRemoteControlEndSeekingForward</span>    = <span class="number">109</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>2.事件产生的时间</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>,<span class="keyword">readonly</span>) <span class="built_in">NSTimeInterval</span>  timestamp;</span><br></pre></td></tr></table></figure>

<p> UIEvent 还提供了相应的方法可以获得在某个 view 上面的触摸对象（UITouch）。</p>
<p> 触摸事件的产生：</p>
<ol>
<li>发生触摸事件后，系统会将该事件加入到一个由 UIApplication 管理的事件队列中；</li>
<li>UIApplication 会从事件队列中取出最前面的事件，并将事件分发下去以便处理，通常，先发送事件给应用程序的主窗口（keyWindow）；</li>
<li>主窗口会在视图层次结构中找到一个最合适的视图控件来处理触摸事件，这也是整个事件处理过程的第一步；</li>
<li>找到合适的视图控件后，就会调用视图控件的 touches 方法来做具体的事件处理。</li>
</ol>
<p>触摸事件的传递：</p>
<blockquote>
<p>触摸事件的传递是从父控件传递到子控件；<br>如果父控件不能接收触摸事件，那么子控件就不可能接收到触摸事件。<br><img src="http://ww4.sinaimg.cn/mw690/64124373gw1eznrp087anj205t07rdfx.jpg" alt="触摸事件"><br><img src="http://ww2.sinaimg.cn/mw690/64124373gw1eznrrf36ymj2097077dhc.jpg" alt="触摸事件 2"></p>
</blockquote>
<p>UIView 不接收触摸事件的三种情况:<br>不接受用户交互 ：</p>
<ol>
<li>userInteractionEnable &#x3D; NO;</li>
<li>隐藏 ：hidden &#x3D; YES;</li>
<li>透明：alpha &#x3D; 0.0 ~ 0.01</li>
</ol>
<p>提示：UIImageView 的 userInteractionEnable 默认就是 NO，因此 UIImageView 以及它的子控件默认是不能接收触摸事件的。</p>
<p>触摸事件处理的详细过程：</p>
<ol>
<li>用户点击屏幕后产生的一个触摸事件，经过一些列的传递过程后，会找到最合适的视图控件来处理这个事件</li>
<li>找到最合适的视图控件后，就会调用控件的 touches 方法来作具体的事件处理<br> touchesBegan…<br> touchesMoved…<br> touchedEnded…</li>
</ol>
<p>这些 touches 方法的默认做法是将事件顺着响应者链条向上传递，将事件交给上一个响应者进行处理</p>
<p>响应者链的事件传递过程：</p>
<ol>
<li>如果 view 的控制器存在，就传递给控制器；如果控制器不存在，则将其传递给它的父视图；</li>
<li>在视图层次结构最顶级的视图，如果也不能处理收到的事件或消息，则其将事件或消息传递给 window 对象进行处理。</li>
<li>如果 window 对象也不处理，则其将事件或消息传递给 UIApplication 对象；</li>
<li>如果 UIApplication 也不能处理该事件或消息，则将其丢弃</li>
</ol>
<h3 id="监听触摸事件的做法"><a href="#监听触摸事件的做法" class="headerlink" title="监听触摸事件的做法"></a>监听触摸事件的做法</h3><p>如果想监听一个 view 上面的触摸事件，之前的做法是：</p>
<ol>
<li>自定义一个 view；</li>
<li>实现 view 的 touches 方法，在方法内部实现具体处理代码。<br> 通过 touches 方法监听 view 触摸事件，有很明显的几个缺点：<ul>
<li>必须得自定义 view；</li>
<li>由于是在 view 内部的 touches 方法中监听触摸事件，因此默认情况下，无法让其他外界对象监听 view 的触摸事件；</li>
<li>不容易区分用户的具体手势行为。</li>
</ul>
</li>
</ol>
<p>iOS 3.2 之后，苹果推出了手势识别功能（Gesture Recognizer）,在触摸事件处理方面，大大简化了开发者的开发难度。</p>
<h3 id="UIGestureRescognizer"><a href="#UIGestureRescognizer" class="headerlink" title="UIGestureRescognizer"></a>UIGestureRescognizer</h3><p>为了完成手势识别，必须借助于手势识别器：UIGestureRecognizer 。<br>利用 UIGestureRecognizer,能轻松识别用户在某个 view 上面做的一些常见手势。<br>UIGestureRecognizer 是一个抽象类，定义了所有的手势基本行为，使用它的子类才能处理具体的手势</p>
<ul>
<li>UITapGestureRecognizer(敲击)</li>
<li>UIPinchGestureRecognizer(捏合，用于缩放)</li>
<li>UIPanGestureRecognizer(拖拽)</li>
<li>UISwipeGestureRecognizer(轻扫)</li>
<li>UIRotationGestureRecognizer(旋转)</li>
<li>UILongPressGestureRecognizer(长按)</li>
</ul>
<p>每一个手势识别器的用法都差不多，比如 UITapGestureRecognizer 的使用步骤如下:</p>
<ol>
<li>创建手势识别器对象；<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">UITapGestureRecognizer</span> *tap = [[<span class="built_in">UITapGestureRecognizer</span> alloc] init];</span><br></pre></td></tr></table></figure></li>
<li>设置手势识别器对象的具体属性；<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 连续敲击 2 次</span></span><br><span class="line">tap.numberOfTapsRequired = <span class="number">2</span>;</span><br><span class="line"><span class="comment">// 需要 2 根手指一起敲击</span></span><br><span class="line">tap.numberOfTouchesRequired = <span class="number">2</span>;</span><br></pre></td></tr></table></figure></li>
<li>添加手势识别器到对应的 view 上<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.iconView addGestureRecognizer:tap];</span><br></pre></td></tr></table></figure></li>
<li>监听手势的触发<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[tap addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(tapIconView:)];</span><br></pre></td></tr></table></figure></li>
</ol>
<p>手势识别的状态</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, <span class="built_in">UIGestureRecognizerState</span>) &#123;</span><br><span class="line">    <span class="comment">// 没有触摸事件发生，所有手势识别的默认状态</span></span><br><span class="line">    <span class="built_in">UIGestureRecognizerStatePossible</span>,</span><br><span class="line">    <span class="comment">// 一个手势已经开始但尚未改变或者完成时</span></span><br><span class="line">    <span class="built_in">UIGestureRecognizerStateBegan</span>,</span><br><span class="line">    <span class="comment">// 手势状态改变</span></span><br><span class="line">    <span class="built_in">UIGestureRecognizerStateChanged</span>,</span><br><span class="line">    <span class="comment">// 手势完成</span></span><br><span class="line">    <span class="built_in">UIGestureRecognizerStateEnded</span>,</span><br><span class="line">    <span class="comment">// 手势取消，恢复至 Possible 状态</span></span><br><span class="line">    <span class="built_in">UIGestureRecognizerStateCancelled</span>,</span><br><span class="line">    <span class="comment">// 手势失败，恢复至 Possible 状态</span></span><br><span class="line">    <span class="built_in">UIGestureRecognizerStateFailed</span>,</span><br><span class="line">    <span class="comment">// 识别到手势识别</span></span><br><span class="line">    <span class="built_in">UIGestureRecognizerStateRecognized</span> = <span class="built_in">UIGestureRecognizerStateEnded</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com/">http://blog.wangruofeng007.com</a></p>
<!-- processed -->
<!-- processed 2 -->
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/13/2016-01-13-iosli-cheng-bei-shi-jian/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/13/2016-01-13-iosli-cheng-bei-shi-jian/" class="post-title-link" itemprop="url">iOS 里程碑事件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-13 04:46:48" itemprop="dateCreated datePublished" datetime="2016-01-13T04:46:48+08:00">2016-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-03 13:43:30" itemprop="dateModified" datetime="2024-11-03T13:43:30+08:00">2024-11-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%B5%84%E6%96%99%E6%94%B6%E9%9B%86/" itemprop="url" rel="index"><span itemprop="name">资料收集</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
  
    <a title="disqus" href="/2016/01/13/2016-01-13-iosli-cheng-bei-shi-jian/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/13/2016-01-13-iosli-cheng-bei-shi-jian/" itemprop="commentCount"></span>
    </a>
  </span>
  
 <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>441</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>记录 iOS 各种重要里程碑事件</p>
</blockquote>
<h3 id="私有成员变量的实现"><a href="#私有成员变量的实现" class="headerlink" title="私有成员变量的实现"></a>私有成员变量的实现</h3><p>1.0 时代，在.h 文件采用 <code>@private</code> 关键词</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> : <span class="title">UIViewController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">@private</span></span><br><span class="line">    <span class="built_in">NSInteger</span> _value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.0 时代 通过在.m 文件通过 <code>匿名Category</code> </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">NSInteger</span> value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>3.0 时代 2013 年的 WWDC 允许在 .m 的 <code>@implementation </code> 中</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span> </span>&#123;</span><br><span class="line">    <span class="built_in">NSInteger</span> _value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="ARC-推出"><a href="#ARC-推出" class="headerlink" title="ARC 推出"></a>ARC 推出</h3><p>2011</p>
<h3 id="自动生成-getter-和-setter-方法的-synthesize-2012"><a href="#自动生成-getter-和-setter-方法的-synthesize-2012" class="headerlink" title="自动生成 getter 和 setter 方法的 @synthesize 2012"></a>自动生成 getter 和 setter 方法的 <code>@synthesize</code> 2012</h3><h3 id="AutoLayout-引入"><a href="#AutoLayout-引入" class="headerlink" title="AutoLayout 引入"></a>AutoLayout 引入</h3><p>iOS 6.0</p>
<h3 id="Swift"><a href="#Swift" class="headerlink" title="Swift"></a>Swift</h3><ul>
<li><a target="_blank" rel="noopener" href="http://baike.baidu.com/view/404495.htm">WWDC</a> 1.0 版本发布 – 2014.06.02 </li>
<li>Swift 2.0 发布 – 2015.08.07</li>
<li>Open Source – 2015.12.04</li>
</ul>
<h3 id="Size-Classes"><a href="#Size-Classes" class="headerlink" title="Size Classes"></a>Size Classes</h3><p>iOS 8.0</p>
<h3 id="Blocks"><a href="#Blocks" class="headerlink" title="Blocks"></a>Blocks</h3><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Mac_OS_X_Snow_Leopard">Mac OS X 10.6 “Snow Leopard”</a> and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/IOS">iOS 4.0</a></p>
<h3 id="Objective-C-2-0"><a href="#Objective-C-2-0" class="headerlink" title="Objective-C 2.0"></a>Objective-C 2.0</h3><p>At the <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Apple_Worldwide_Developers_Conference">2006 Worldwide Developers Conference</a> release of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Objective-C#Objective-C_2.0">Objective-C 2.0</a></p>
<h3 id="Watch-OS"><a href="#Watch-OS" class="headerlink" title="Watch OS"></a>Watch OS</h3><p>2015.05.21</p>
<h3 id="iOS-API-Differences"><a href="#iOS-API-Differences" class="headerlink" title="iOS API Differences"></a>iOS API Differences</h3><h4 id="iOS-2-1-to-iOS-2-2-API-Differences"><a href="#iOS-2-1-to-iOS-2-2-API-Differences" class="headerlink" title="iOS 2.1 to iOS 2.2 API Differences"></a>iOS 2.1 to iOS 2.2 API Differences</h4><p>Added frameworks:</p>
<ul>
<li>AVFoundation</li>
</ul>
<h4 id="iOS-2-2-to-iOS-3-0-API-Differences"><a href="#iOS-2-2-to-iOS-3-0-API-Differences" class="headerlink" title="iOS 2.2 to iOS 3.0 API Differences"></a>iOS 2.2 to iOS 3.0 API Differences</h4><p>Added frameworks:</p>
<ul>
<li>CoreData</li>
<li>ExternalAccessory</li>
<li>GameKit</li>
<li>MapKit</li>
<li>MessageUI</li>
<li>MobileCoreServices</li>
<li>StoreKit</li>
</ul>
<h4 id="iOS-3-2-to-iOS-4-0-API-Differences"><a href="#iOS-3-2-to-iOS-4-0-API-Differences" class="headerlink" title="iOS 3.2 to iOS 4.0 API Differences"></a>iOS 3.2 to iOS 4.0 API Differences</h4><p>Added frameworks:</p>
<ul>
<li>Accelerate</li>
<li>AssetsLibrary</li>
<li>CoreMedia</li>
<li>CoreMotion</li>
<li>CoreTelephony</li>
<li>CoreVideo</li>
<li>EventKit</li>
<li>EventKitUI</li>
<li>iAd</li>
<li>ImageIO</li>
<li>QuickLook</li>
</ul>
<h4 id="iOS-4-3-to-iOS-5-0-API-Differences"><a href="#iOS-4-3-to-iOS-5-0-API-Differences" class="headerlink" title="iOS 4.3 to iOS 5.0 API Differences"></a>iOS 4.3 to iOS 5.0 API Differences</h4><p>Added frameworks</p>
<ul>
<li>Accounts</li>
<li>CoreBluetooth</li>
<li>CoreImage</li>
<li>GLKit</li>
<li>GSS</li>
<li>NewsstandKit</li>
<li>Twitter</li>
</ul>
<h4 id="5-1-to-iOS-6-0-API-Differences"><a href="#5-1-to-iOS-6-0-API-Differences" class="headerlink" title="5.1 to iOS 6.0 API Differences"></a>5.1 to iOS 6.0 API Differences</h4><p>Added frameworks</p>
<ul>
<li>AdSupport</li>
<li>MediaToolbox</li>
<li>PassKit</li>
<li>Social</li>
</ul>
<h4 id="6-1-to-iOS-7-0-API-Differences"><a href="#6-1-to-iOS-7-0-API-Differences" class="headerlink" title="6.1 to iOS 7.0 API Differences"></a>6.1 to iOS 7.0 API Differences</h4><p>Added frameworks</p>
<ul>
<li>GameController</li>
<li>JavaScriptCore</li>
<li>MediaAccessibility</li>
<li>MultipeerConnectivity</li>
<li>SafariServices</li>
<li>SpriteKit</li>
</ul>
<h4 id="iOS-7-1-to-iOS-8-0-API-Differences"><a href="#iOS-7-1-to-iOS-8-0-API-Differences" class="headerlink" title="iOS 7.1 to iOS 8.0 API Differences"></a>iOS 7.1 to iOS 8.0 API Differences</h4><p>Added frameworks</p>
<ul>
<li>Accelerate</li>
<li>Accounts</li>
<li>AddressBook</li>
<li>AddressBookUI</li>
<li>AudioToolbox</li>
<li>AudioUnit</li>
<li>AVFoundation</li>
<li>AVKit (Added)</li>
<li>CFNetwork</li>
<li>CloudKit (Added)</li>
<li>CoreAudio</li>
<li>CoreAudioKit (Added)</li>
<li>CoreAuthentication (Added)</li>
<li>CoreBluetooth</li>
<li>CoreData</li>
<li>CoreFoundation</li>
<li>CoreImage</li>
<li>CoreLocation</li>
<li>CoreMedia</li>
<li>CoreMotion</li>
<li>CoreText</li>
<li>CoreVideo</li>
<li>EventKit</li>
<li>EventKitUI</li>
<li>ExternalAccessory</li>
<li>Foundation</li>
<li>GameController</li>
<li>GameKit</li>
<li>GLKit</li>
<li>GSS</li>
<li>HealthKit (Added)</li>
<li>HomeKit (Added)</li>
<li>iAd</li>
<li>ImageIO</li>
<li>IOKit</li>
<li>JavaScriptCore</li>
<li>LocalAuthentication (Added)</li>
<li>MapKit</li>
<li>MediaAccessibility</li>
<li>MediaPlayer</li>
<li>MessageUI</li>
<li>Metal (Added)</li>
<li>MobileCoreServices</li>
<li>MultipeerConnectivity</li>
<li>NetworkExtension (Added)</li>
<li>NewsstandKit</li>
<li>NotificationCenter (Added)</li>
<li>OpenGLES</li>
<li>PassKit</li>
<li>Photos (Added)</li>
<li>PhotosUI (Added)</li>
<li>PushKit (Added)</li>
<li>QuartzCore</li>
<li>QuickLook</li>
<li>SceneKit (Added)</li>
<li>Security</li>
<li>Social</li>
<li>SpriteKit</li>
<li>StoreKit</li>
<li>UIKit</li>
<li>VideoToolbox</li>
<li>WebKit (Added)</li>
</ul>
<h4 id="iOS-8-3-to-iOS-9-0-API-Differences"><a href="#iOS-8-3-to-iOS-9-0-API-Differences" class="headerlink" title="iOS 8.3 to iOS 9.0 API Differences"></a>iOS 8.3 to iOS 9.0 API Differences</h4><p>Added frameworks</p>
<p>Objective-C</p>
<ul>
<li>&#x2F;usr&#x2F;include</li>
<li>Accelerate</li>
<li>Accounts</li>
<li>AddressBook</li>
<li>AddressBookUI</li>
<li>AssetsLibrary</li>
<li>AudioToolbox</li>
<li>AudioUnit</li>
<li>AVFoundation</li>
<li>AVKit</li>
<li>CFNetwork</li>
<li>CloudKit</li>
<li>Contacts (Added)</li>
<li>ContactsUI (Added)</li>
<li>CoreAudio</li>
<li>CoreAudioKit</li>
<li>CoreBluetooth</li>
<li>CoreData</li>
<li>CoreFoundation</li>
<li>CoreGraphics</li>
<li>CoreImage</li>
<li>CoreLocation</li>
<li>CoreMedia</li>
<li>CoreMIDI</li>
<li>CoreMotion</li>
<li>CoreSpotlight (Added)</li>
<li>CoreTelephony</li>
<li>CoreText</li>
<li>CoreVideo</li>
<li>EventKit</li>
<li>EventKitUI</li>
<li>ExternalAccessory</li>
<li>Foundation</li>
<li>GameController</li>
<li>GameKit</li>
<li>GameplayKit (Added)</li>
<li>GLKit</li>
<li>GSS</li>
<li>HealthKit</li>
<li>HomeKit</li>
<li>iAd</li>
<li>ImageIO</li>
<li>JavaScriptCore</li>
<li>LocalAuthentication</li>
<li>MapKit</li>
<li>MediaPlayer</li>
<li>MediaToolbox</li>
<li>MessageUI</li>
<li>Metal</li>
<li>MetalKit (Added)</li>
<li>MetalPerformanceShaders (Added)</li>
<li>MobileCoreServices</li>
<li>ModelIO (Added)</li>
<li>MultipeerConnectivity</li>
<li>NetworkExtension</li>
<li>NewsstandKit</li>
<li>OpenAL</li>
<li>PassKit</li>
<li>Photos</li>
<li>PushKit</li>
<li>QuartzCore</li>
<li>QuickLook</li>
<li>ReplayKit (Added)</li>
<li>SafariServices</li>
<li>SceneKit</li>
<li>Security</li>
<li>SpriteKit</li>
<li>StoreKit</li>
<li>SystemConfiguration</li>
<li>UIKit</li>
<li>VideoToolbox</li>
<li>WatchConnectivity (Added)</li>
<li>WatchKit</li>
<li>WebKit</li>
</ul>
<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com/">http://blog.wangruofeng007.com</a></p>
<!-- processed 2 -->

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/13/2016-01-13-you-ya-chu-li-uiimagetu-pian-xuan-zhuan/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/13/2016-01-13-you-ya-chu-li-uiimagetu-pian-xuan-zhuan/" class="post-title-link" itemprop="url">优雅处理 UIImage 图片旋转</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-13 04:38:49" itemprop="dateCreated datePublished" datetime="2016-01-13T04:38:49+08:00">2016-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-03 14:27:49" itemprop="dateModified" datetime="2024-11-03T14:27:49+08:00">2024-11-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
  
    <a title="disqus" href="/2016/01/13/2016-01-13-you-ya-chu-li-uiimagetu-pian-xuan-zhuan/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/13/2016-01-13-you-ya-chu-li-uiimagetu-pian-xuan-zhuan/" itemprop="commentCount"></span>
    </a>
  </span>
  
 <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="UIImag-构造方式"><a href="#UIImag-构造方式" class="headerlink" title="UIImag 构造方式"></a>UIImag 构造方式</h2><p>UIImag 构造方式大致有 4 种方式</p>
<ul>
<li>从本地 bundle 中加载 <code>imageNamed:</code> ，传入一个 bundle 的文件名即可</li>
<li>从本地一个文件路径读取 <code>imageWithContentsOfFile:</code> ，需要传一个文件的文件路径 path</li>
<li>通过二进制数据 <code>NSData</code> 来创建 <code>imageWithData:</code> * 通过一个 <code>CoreGraphics</code> 的 <code>CGImageRef</code> 来创建， <code>initWithCGImage:</code> * 通过一个 <code>CoreImage</code> 的 <code>CIImage</code> 来创建 <code>initWithCIImage</code> 通过查阅 Apple 官网文档我们发现有 2 个这样的方法，今天就来一探究竟</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">UIImage</span> *)imageWithCGImage:(<span class="built_in">CGImageRef</span>)cgImage scale:(<span class="built_in">CGFloat</span>)scale orientation:(<span class="built_in">UIImageOrientation</span>)orientation <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">4</span>_0);</span><br><span class="line">+ (<span class="built_in">UIImage</span> *)imageWithCIImage:(<span class="built_in">CIImage</span> *)ciImage scale:(<span class="built_in">CGFloat</span>)scale orientation:(<span class="built_in">UIImageOrientation</span>)orientation <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0);</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithCGImage:(<span class="built_in">CGImageRef</span>)cgImage scale:(<span class="built_in">CGFloat</span>)scale orientation:(<span class="built_in">UIImageOrientation</span>)orientation <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">4</span>_0);</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithCIImage:(<span class="built_in">CIImage</span> *)ciImage scale:(<span class="built_in">CGFloat</span>)scale orientation:(<span class="built_in">UIImageOrientation</span>)orientation <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">6</span>_0);</span><br></pre></td></tr></table></figure>

<p>2 个类方法 2 个实例方法都是类似，这里以 <code>CGImageRef</code> 为例</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">UIImage</span> *)imageWithCGImage:(<span class="built_in">CGImageRef</span>)cgImage scale:(<span class="built_in">CGFloat</span>)scale orientation:(<span class="built_in">UIImageOrientation</span>)orientation <span class="built_in">NS_AVAILABLE_IOS</span>(<span class="number">4</span>_0);</span><br></pre></td></tr></table></figure>

<ol>
<li><p>新建的 Xcode 工程选择 single Application</p>
</li>
<li><p>在 storyboard 中拖一个 <code>UIImageView</code> 设置它水平垂直居中对齐，宽带高度随便设一个值不要太大就行，设置 <code>UIImageView</code> 的 <code>contentMode</code> 为 <code>Aspect Fit</code> 方便查看以免变形</p>
</li>
<li><p>在 <code>UIImageView</code> 下发放一个 <code>UIButton</code> 控件方便后面好对图片进行旋转操作</p>
</li>
<li><p>在 viewController 中建立一个 <code>UIImageView</code> 引用,拉出一个 rotate 按钮的 <code>IBAction</code>  现在大概界面大概这样<br> <img src="/images/common/image_rotate.jpg" alt="UIImageOrientation 效果图"></p>
</li>
<li><p>下面我们实现<br> <code>- (IBAction)rotateImage:(id)sender &#123;&#125;</code> 这个方法</p>
</li>
</ol>
<blockquote>
<p>在这里我们想通过点击按钮实现图片旋转<br> 为了方便使用我们使用 Category 的方式实现<br> 新建一个 UIImage 的分类取名叫 Rotate</p>
</blockquote>
<blockquote>
<p>这里需要传一张要处理的图片和一个待处理成的图片方向</p>
</blockquote>
   <figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">UIImage</span> *)rotateImage:(<span class="built_in">UIImage</span> *)oldImage</span><br><span class="line">         orientation:(<span class="built_in">UIImageOrientation</span>)orientation;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">    + (<span class="built_in">UIImage</span> *)rotateImage:(<span class="built_in">UIImage</span> *)oldImage orientation:(<span class="built_in">UIImageOrientation</span>)orientation&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UIImage</span> *newImage = [<span class="built_in">UIImage</span> imageWithCGImage:oldImage.CGImage scale:<span class="number">1</span> orientation:orientation];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSString</span> *orientationStr = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">switch</span> (orientation) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationUp</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationUp&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationDown</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationDown&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationLeft</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationLeft&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationRight</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationRight&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationUpMirrored</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationUpMirrored&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationDownMirrored</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationDownMirrored&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationLeftMirrored</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationLeftMirrored&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationRightMirrored</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationRightMirrored&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;current orientation: %@&quot;</span>,orientationStr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newImage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 button 点击事件触发时的这样使用</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">IBAction</span>)rotateImage:(<span class="type">id</span>)sender &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UIImage</span> *oldImage = <span class="keyword">self</span>.imgView.image;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UIImage</span> *rotatedImage = [<span class="built_in">UIImage</span> rotateImage:oldImage orientation:<span class="built_in">UIImageOrientationLeft</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.imgView.image = rotatedImage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击按钮测试发现第一次没问题，但是重逢点击无效<br>原来 <code>+ (UIImage *)imageWithCGImage:(CGImageRef)cgImage scale:(CGFloat)scale orientation:(UIImageOrientation)orientation</code> 方法执行原理是执行前通过 <code>@property(nonatomic,readonly) UIImageOrientation imageOrientation;</code> 接口先判断当前图片的方向是否为将要旋转的方向，如果是就直接返回不做处理，如果不是再作旋转处理，也就是说这个方法并没有实际上旋转 image 的数据，只是用一个枚举标记旋转的状态</p>
<p>如果我们想每次旋转需要直接改变原始 image 的数据该怎么办呢？<br>在这里我们通过 <code>CGBitmapContext</code> ,使用 <code>CGContextRotateCTM</code> 来设置旋转，再把 UIImage 通过 <code>drawInRect</code> 重新绘制出来，通过 <code>UIGraphicsGetImageFromCurrentImageContext</code> 获得处理后的图片</p>
<p>下面是具体实现</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">UIImage</span> *)fixedRotation&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.imageOrientation == <span class="built_in">UIImageOrientationUp</span>) <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">    <span class="built_in">CGAffineTransform</span> transform = <span class="built_in">CGAffineTransformIdentity</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">self</span>.imageOrientation) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationDown</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationDownMirrored</span>:</span><br><span class="line">            transform = <span class="built_in">CGAffineTransformTranslate</span>(transform, <span class="keyword">self</span>.size.width, <span class="keyword">self</span>.size.height);</span><br><span class="line">            transform = <span class="built_in">CGAffineTransformRotate</span>(transform, M_PI);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationLeft</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationLeftMirrored</span>:</span><br><span class="line">            transform = <span class="built_in">CGAffineTransformTranslate</span>(transform, <span class="keyword">self</span>.size.width, <span class="number">0</span>);</span><br><span class="line">            transform = <span class="built_in">CGAffineTransformRotate</span>(transform, M_PI_2);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationRight</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationRightMirrored</span>:</span><br><span class="line">            transform = <span class="built_in">CGAffineTransformTranslate</span>(transform, <span class="number">0</span>, <span class="keyword">self</span>.size.height);</span><br><span class="line">            transform = <span class="built_in">CGAffineTransformRotate</span>(transform, -M_PI_2);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationUp</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationUpMirrored</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">self</span>.imageOrientation) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationUpMirrored</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationDownMirrored</span>:</span><br><span class="line">            transform = <span class="built_in">CGAffineTransformTranslate</span>(transform, <span class="keyword">self</span>.size.width, <span class="number">0</span>);</span><br><span class="line">            transform = <span class="built_in">CGAffineTransformScale</span>(transform, <span class="number">-1</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationLeftMirrored</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationRightMirrored</span>:</span><br><span class="line">            transform = <span class="built_in">CGAffineTransformTranslate</span>(transform, <span class="keyword">self</span>.size.height, <span class="number">0</span>);</span><br><span class="line">            transform = <span class="built_in">CGAffineTransformScale</span>(transform, <span class="number">-1</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationUp</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationDown</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationLeft</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationRight</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now we draw the underlying CGImage into a new context, applying the transform</span></span><br><span class="line">    <span class="comment">// calculated above.</span></span><br><span class="line">    <span class="built_in">CGContextRef</span> ctx = <span class="built_in">CGBitmapContextCreate</span>(<span class="literal">NULL</span>, <span class="keyword">self</span>.size.width, <span class="keyword">self</span>.size.height,</span><br><span class="line">                                             <span class="built_in">CGImageGetBitsPerComponent</span>(<span class="keyword">self</span>.CGImage), <span class="number">0</span>,</span><br><span class="line">                                             <span class="built_in">CGImageGetColorSpace</span>(<span class="keyword">self</span>.CGImage),</span><br><span class="line">                                             <span class="built_in">CGImageGetBitmapInfo</span>(<span class="keyword">self</span>.CGImage));</span><br><span class="line">    <span class="built_in">CGContextConcatCTM</span>(ctx, transform);</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">self</span>.imageOrientation) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationLeft</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationLeftMirrored</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationRight</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationRightMirrored</span>:</span><br><span class="line">            <span class="comment">// Grr...</span></span><br><span class="line">            <span class="built_in">CGContextDrawImage</span>(ctx, <span class="built_in">CGRectMake</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="keyword">self</span>.size.height,<span class="keyword">self</span>.size.width), <span class="keyword">self</span>.CGImage);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">CGContextDrawImage</span>(ctx, <span class="built_in">CGRectMake</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="keyword">self</span>.size.width,<span class="keyword">self</span>.size.height), <span class="keyword">self</span>.CGImage);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// And now we just create a new UIImage from the drawing context</span></span><br><span class="line">    <span class="built_in">CGImageRef</span> cgimg = <span class="built_in">CGBitmapContextCreateImage</span>(ctx);</span><br><span class="line">    <span class="built_in">UIImage</span> *img = [<span class="built_in">UIImage</span> imageWithCGImage:cgimg];</span><br><span class="line">    <span class="built_in">CGContextRelease</span>(ctx);</span><br><span class="line">    <span class="built_in">CGImageRelease</span>(cgimg);</span><br><span class="line">    <span class="keyword">return</span> img;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在再优化一下原来 <code>+ (UIImage *)rotateImage:(UIImage *)oldImage orientation:(UIImageOrientation)orientation</code> 方法,修改成这样</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">UIImage</span> *)rotateImage:(<span class="built_in">UIImage</span> *)oldImage orientation:(<span class="built_in">UIImageOrientation</span>)orientation&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">UIImage</span> *newImage = [<span class="built_in">UIImage</span> imageWithCGImage:oldImage.CGImage scale:<span class="number">1</span> orientation:orientation];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//fix original Image with gived orientation.</span></span><br><span class="line">    <span class="built_in">UIImage</span> *fixedRotationImage = [newImage fixedRotation];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSString</span> *orientationStr = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">switch</span> (orientation) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationUp</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationUp&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationDown</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationDown&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationLeft</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationLeft&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationRight</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationRight&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationUpMirrored</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationUpMirrored&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationDownMirrored</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationDownMirrored&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationLeftMirrored</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationLeftMirrored&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">UIImageOrientationRightMirrored</span>: &#123;</span><br><span class="line">            orientationStr = <span class="string">@&quot;UIImageOrientationRightMirrored&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;current orientation: %@&quot;</span>,orientationStr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fixedRotationImage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 现在再测试一下，well，It‘s OK。</p>
<p> have fun!!!</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.galloway.me.uk/2012/01/uiimageorientation-exif-orientation-sample-images/">UIImageOrientation &#x2F; EXIF orientation sample images</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIImage_Class/#//apple_ref/c/tdef/UIImageOrientation">Apple-UIImage Class Reference</a></li>
<li><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/8915630/ios-uiimageview-how-to-handle-uiimage-image-orientation">ios-uiimageview-how-to-handle-uiimage-image-orientation</a></li>
</ul>
<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com/">http://blog.wangruofeng007.com</a></p>
<!-- processed 2 -->

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/13/2016-01-13-dong-hua-hui-zhi-cashapelayerde-lu-jing-cgpath/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/13/2016-01-13-dong-hua-hui-zhi-cashapelayerde-lu-jing-cgpath/" class="post-title-link" itemprop="url">用 CAShapeLayer 动画绘制 CGPath</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-13 04:35:42" itemprop="dateCreated datePublished" datetime="2016-01-13T04:35:42+08:00">2016-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-03 13:32:35" itemprop="dateModified" datetime="2024-11-03T13:32:35+08:00">2024-11-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8A%A8%E7%94%BB/" itemprop="url" rel="index"><span itemprop="name">动画</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
  
    <a title="disqus" href="/2016/01/13/2016-01-13-dong-hua-hui-zhi-cashapelayerde-lu-jing-cgpath/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/13/2016-01-13-dong-hua-hui-zhi-cashapelayerde-lu-jing-cgpath/" itemprop="commentCount"></span>
    </a>
  </span>
  
 <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>1.2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>4 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="这是什么？"><a href="#这是什么？" class="headerlink" title="这是什么？"></a>这是什么？</h4><blockquote>
<p>此文将讲解通过形状图层 <code>CAShaperLayer</code> 的 <code>strokeStart</code> 和 <code>strokeEnd</code> 来实现动画绘制路径 <code>CGPath</code> ,此文是<a target="_blank" rel="noopener" href="http://oleb.net/">By Ole Begemann</a>创建于 December 18, 2010,当时是发布 iOS SDK 4.2 时 <code>CAShapeLayer</code> 新增加的两个属性<a target="_blank" rel="noopener" href="http://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CAShapeLayer_class/Reference/Reference.html#//apple_ref/doc/uid/TP40008314-CH1-SW16">strokeStart</a>和<a target="_blank" rel="noopener" href="http://developer.apple.com/library/ios/documentation/GraphicsImaging/Reference/CAShapeLayer_class/Reference/Reference.html#//apple_ref/doc/uid/TP40008314-CH1-SW15">strokeEnd</a>,这两个值是两个浮点数取值范围 0.0~1.0,用来表明形状图层所指向的路径在绘制开始和结束路径中的相对位置。</p>
</blockquote>
<p> <code>strokeStart</code> 默认值是0.0， <code>strokeEnd</code> 默认值是1.0，显然这会导致形状图层的路径将一整个被绘制。假如，你想说，如果设置了layer.strokeEnd &#x3D; 0.5f,只让她绘制前半部分，那该多好。</p>
<p>真正有趣的事情是这些接口都是可动画的。通过动画绘制 <code>strokeEnd</code> 从 0.0 到 1.0 在几秒内，我们就能很容易自己绘制路径像下面这样写：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CABasicAnimation</span> *pathAnimation = [<span class="built_in">CABasicAnimation</span> animationWithKeyPath:<span class="string">@&quot;strokeEnd&quot;</span>];</span><br><span class="line">pathAnimation.duration = <span class="number">10.0</span>;</span><br><span class="line">pathAnimation.fromValue = [<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">0.0</span>f];</span><br><span class="line">pathAnimation.toValue = [<span class="built_in">NSNumber</span> numberWithFloat:<span class="number">1.0</span>f];</span><br><span class="line">[<span class="keyword">self</span>.pathLayer addAnimation:pathAnimation forKey:<span class="string">@&quot;strokeEndAnimation&quot;</span>];</span><br></pre></td></tr></table></figure>

<p>最后，再添加第二个图层包含一个铅笔图片，使用关键帧动画 <code>CAKeyframeAnimation</code> 来让它随着这个路径以相同的速度绘制，就可以达到完美的错觉效果：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CAKeyframeAnimation</span> *penAnimation = [<span class="built_in">CAKeyframeAnimation</span> animationWithKeyPath:<span class="string">@&quot;position&quot;</span>];</span><br><span class="line">penAnimation.duration = <span class="number">10.0</span>;</span><br><span class="line">penAnimation.path = <span class="keyword">self</span>.pathLayer.path;</span><br><span class="line">penAnimation.calculationMode = kCAAnimationPaced;</span><br><span class="line">[<span class="keyword">self</span>.penLayer addAnimation:penAnimation forKey:<span class="string">@&quot;penAnimation&quot;</span>];</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://oleb.net/media/AnimatedPathsHausVomNikolaus.mp4">绘制普通路径效果视频</a></p>
<p><a target="_blank" rel="noopener" href="http://oleb.net/media/AnimatedPathsHausVomNikolaus.mp4">下载地址</a></p>
<p>这个对文本一样有效；我们只需要把字符转化成 <code>CGPath</code> 。 <code>Core Text</code> 提供了那样的功能的函数，<a target="_blank" rel="noopener" href="http://developer.apple.com/library/ios/documentation/Carbon/Reference/CTFontRef/Reference/reference.html#//apple_ref/c/func/CTFontCreatePathForGlyph">CTFontCreatePathForGlyph( )</a>。为了使用它，我们需要创建一个带属性的字符串用我们想要渲染的文本，先把它们分割成行在分割成一个个字符。在把所有的字符转换成路径后，我们以子路径方式把它添加到一个单个的 <code>CGPath</code> 路径中。更多细节可以查看<a target="_blank" rel="noopener" href="http://www.codeproject.com/script/Membership/View.aspx?mid=2887692">Ohmu</a>写的<a target="_blank" rel="noopener" href="http://www.codeproject.com/KB/iPhone/Glyph.aspx">Low-level text rendering</a>这篇文章。结果看以来非常的炫酷：</p>
<p><a target="_blank" rel="noopener" href="http://oleb.net/media/AnimatedPathsHelloWorld.mp4">绘制文字路径效果视频</a></p>
<p><a target="_blank" rel="noopener" href="http://oleb.net/media/AnimatedPathsHelloWorld.mp4">下载地址</a></p>
<p>从 Github 上获得<a target="_blank" rel="noopener" href="http://github.com/ole/Animated-Paths">iPad 版的样品工程</a></p>
<h4 id="你将学到的知识点"><a href="#你将学到的知识点" class="headerlink" title="你将学到的知识点"></a>你将学到的知识点</h4><ul>
<li>使用 <code>CAShapeLayer</code> 的 <code>strokeStart</code> 和 <code>strokeEnd</code> 来实现路径动画,比较高级复杂的效果像 google 的下拉刷新转圈就可以从这里引申去实现。</li>
<li><code>CABasicAnimation</code> 和 <code>CABasicAnimation</code> 使用</li>
<li>深入理解 <code>CAShapeLayer</code> 和 <code>CALayer</code> * 通过文本创建路径，核心函数 <code>CTFontCreatePathForGlyph()</code></li>
</ul>
<h4 id="补充说明"><a href="#补充说明" class="headerlink" title="补充说明"></a>补充说明</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CAShapeLayer</span> *pathLayer = [<span class="built_in">CAShapeLayer</span> layer];</span><br><span class="line">pathLayer.frame = <span class="keyword">self</span>.animationLayer.bounds;</span><br><span class="line">pathLayer.bounds = pathRect;</span><br><span class="line">pathLayer.geometryFlipped = <span class="literal">YES</span>;</span><br><span class="line">pathLayer.path = path.CGPath;</span><br><span class="line">pathLayer.strokeColor = [[<span class="built_in">UIColor</span> blackColor] <span class="built_in">CGColor</span>];</span><br><span class="line">pathLayer.fillColor = <span class="literal">nil</span>;</span><br><span class="line">pathLayer.lineWidth = <span class="number">10.0</span>f;</span><br><span class="line">pathLayer.lineJoin = kCALineJoinBevel;</span><br><span class="line"></span><br><span class="line">[<span class="keyword">self</span>.animationLayer addSublayer:pathLayer];</span><br></pre></td></tr></table></figure>

<p>有一点非常重要，CALayer 在 iOS 系统中相对坐标系是以屏幕左上 <code>top-left</code> 为坐标原点的，在 Mac OS X 上以坐下 <code>bottom-left</code> 为坐标原点,但是可以通过 <code>CALayer</code> 的接口 <code>geometryFlipped</code> 垂直翻转坐标系，这个值默认是 <code>NO</code> ，设置成 <code>YES</code> 就可以把坐标系转换成左下 <code>bottom-left</code> 了，这里作者使用的左下 <code>bottom-left</code> 的坐标系。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">getter</span>=isGeometryFlipped) <span class="type">BOOL</span> geometryFlipped;</span><br></pre></td></tr></table></figure>
<p>关于这个属性使用时需要特别注意</p>
<ol>
<li>翻转会同时作用于它的子图层</li>
<li>即使这个属性设置成 <code>YES</code> ,图片的 <code>orientation</code> 仍然是不变的（也就是说当设置 <code>flipped=YES</code> 和 <code>flipped=NO</code> 时一个 <code>CGImageRef</code> 储存在 <code>contents</code> 接口中的内容将会显示一致，赋值并不会真正变换底层的图层）</li>
</ol>
<h4 id="pathLayer-动画实现原理"><a href="#pathLayer-动画实现原理" class="headerlink" title="pathLayer 动画实现原理"></a>pathLayer 动画实现原理</h4><ol>
<li>先创建一个动画用的图层 <code>animationLayer</code> 类型 <code>CALayer</code> ，用来充当动画的画布。</li>
<li>创建真正的路径图层 <code>pathLayer</code> 类型为 <code>CAShapeLayer</code> ,让它的坐标系垂直翻转，并且让图层宽高同时向内收缩 100 个点,通过 <code>CGRectInset(CGRect rect, CGFloat dx, CGFloat dy)</code> 实现</li>
<li>把 <code>pathLayer</code> 添加到 <code>animationLayer</code> 的子图层中去</li>
<li>创建一个铅笔图层 <code>penLayer</code> 类型为 <code>CALayer</code> ,把它添加到 <code>pathLayer</code> 去</li>
<li>对 <code>pathLayer</code> 添加 <code>CABasicAnimation</code> 动画，动画属性为 <code>strokeEnd</code> 6. 对 <code>penLayer</code> 添加 <code>CAKeyframeAnimation</code> 动画，动画属性为 <code>position</code> #### textLayer 动画实现原理</li>
<li>先创建一个动画用的图层 <code>animationLayer</code> 类型 <code>CALayer</code> ，用来充当动画的画布</li>
<li>Create path from text,See:<a target="_blank" rel="noopener" href="http://www.codeproject.com/KB/iPhone/Glyph.aspx">http://www.codeproject.com/KB/iPhone/Glyph.aspx</a>，最终保存到一个类型为 <code>CGMutablePathRef</code> 的 letter 中</li>
<li>通过 letter 来创建文字 <code>UIBezierPath</code> 类型的 <code>path</code> 4. 通过 path 再创建 <code>CAShapeLayer</code> pathLayer,并且把 pathLayer 添加到 <code>animationLayer</code> 中去</li>
<li>创建一个铅笔图层 <code>penLayer</code> 类型为 <code>CALayer</code> ,把它添加到 <code>pathLayer</code> 去</li>
<li>对 <code>pathLayer</code> 添加 <code>CABasicAnimation</code> 动画，动画属性为 <code>strokeEnd</code> 6. 对 <code>penLayer</code> 添加 <code>CAKeyframeAnimation</code> 动画，动画属性为 <code>position</code></li>
</ol>
<h4 id="修复一处-bug"><a href="#修复一处-bug" class="headerlink" title="修复一处 bug"></a>修复一处 bug</h4><p>重复点击 <code>UISegmentedControl</code> 导致铅笔消失，这是设置了 <code>penAnimation.delegate = self;</code> 在代理方法里面没有判断结束直接将设置 <code>self.penLayer.hidden = YES</code> ，导致连续切换时铅笔不见了，要修复这个 bug 只需加一个判断<code>if (flag) self.penLayer.hidden = YES; </code>即可,这样的意思是只有当动画完成时才设置<code> self.penLayer.hidden</code>的值，好了现在已经非常完美了，快去动手自己试试吧！🍺</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://oleb.net/blog/2010/12/animating-drawing-of-cgpath-with-cashapelayer/">原文链接</a></li>
</ul>
<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com/">http://blog.wangruofeng007.com</a></p>
<!-- processed 2 -->

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/13/2016-01-13-blogwang-zhan-bei-wang-lu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/13/2016-01-13-blogwang-zhan-bei-wang-lu/" class="post-title-link" itemprop="url">Blog 网站备忘录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-13 04:29:59" itemprop="dateCreated datePublished" datetime="2016-01-13T04:29:59+08:00">2016-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-03 13:32:35" itemprop="dateModified" datetime="2024-11-03T13:32:35+08:00">2024-11-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%B5%84%E6%96%99%E6%94%B6%E9%9B%86/" itemprop="url" rel="index"><span itemprop="name">资料收集</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
  
    <a title="disqus" href="/2016/01/13/2016-01-13-blogwang-zhan-bei-wang-lu/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/13/2016-01-13-blogwang-zhan-bei-wang-lu/" itemprop="commentCount"></span>
    </a>
  </span>
  
 <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>787</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>3 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简书"><a href="#简书" class="headerlink" title="简书"></a>简书</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/users/b82d2721ba07/latest_articles">叶孤城___</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/users/39eeabac725a/latest_articles">MarkNote</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/users/384f80cdc57b/latest_articles">lp_马建成</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/users/7ba5d9065301/latest_articles">seedante
</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/users/960f3b94323a/latest_articles">大灰灰 iOS</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jianshu.com/users/56475732c6e9/latest_articles">StrongX</a></li>
</ul>
<h2 id="国内个人"><a href="#国内个人" class="headerlink" title="国内个人"></a>国内个人</h2><ul>
<li><a target="_blank" rel="noopener" href="http://onevcat.com/?from=inf&wvr=5&loc=infblog">猫神 onevcat</a> – 地球人都知道</li>
<li><a target="_blank" rel="noopener" href="http://blog.devtang.com/">唐巧</a>–猿题库作者</li>
<li><a target="_blank" rel="noopener" href="http://blog.txx.im/?from=inf&wvr=5&loc=infblog">虾神</a>–话说你们晓得虾神年纪多大么？反正我是觉得白活了。90 后太厉害了。</li>
<li><a target="_blank" rel="noopener" href="http://blog.sunnyxx.com/2015/05/17/cell-height-calculation/">sunnyxx</a> – <a target="_blank" rel="noopener" href="https://github.com/forkingdog/FDFullscreenPopGesture">FDFullscreenPopGesture</a>作者，值得关注</li>
<li><a target="_blank" rel="noopener" href="https://github.com/nixzhu/dev-blog">nixzhu</a>–有几篇翻译的文章质量不错</li>
<li><a target="_blank" rel="noopener" href="http://beyondvincent.com/">破船之家</a>–这让我想起，喝上一杯朗姆酒🍺</li>
<li><a target="_blank" rel="noopener" href="http://limboy.me/">Limboy</a> – 蘑菇街一位资深 iOS 程序员</li>
<li><a target="_blank" rel="noopener" href="http://macshuo.com/?page_id=93">MacTalk-池建强的随想录</a>–Mac 开发大牛</li>
<li><a target="_blank" rel="noopener" href="http://www.xuanyusong.com/">雨松 MOMO</a>–专注移动互联网，专注 Unity3D 游戏开发,国内最早开发 Unity3d 的大神之一</li>
<li><a target="_blank" rel="noopener" href="http://yulingtianxia.com/">玉令天下的博客</a> – 关于 runtime 的资料整理得非常不错</li>
<li><a target="_blank" rel="noopener" href="http://chun.tips/">Chun Tips</a> – 对 Runtime,RunLoop,AutoLayout 讲解得非常详细 ❤️</li>
<li><a target="_blank" rel="noopener" href="http://blog.treney.com/">鹏威の博客</a> – 非常炫酷的博客，值得学习</li>
<li><a target="_blank" rel="noopener" href="https://www.mgenware.com/blog/">mgenware</a> – 往全栈方向发展 ing</li>
</ul>
<h2 id="国外个人"><a href="#国外个人" class="headerlink" title="国外个人"></a>国外个人</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.mikeash.com/">mikeash</a>–白天飞行员，晚上程序员 ：] just this guy, you know?</li>
<li><a target="_blank" rel="noopener" href="https://www.shinobicontrols.com/blog">shinobicontrols</a>–iOS 最新 API 以及新功能用法</li>
<li><a target="_blank" rel="noopener" href="http://iosdevelopertips.com/user-interface/custom-visual-calendar-control-for-ios.html">iosdevelopertips</a>–教程配合 Demo 让你学习成长立竿见影</li>
<li><a target="_blank" rel="noopener" href="http://iosdevweekly.com/">iosdevweekly</a>–很棒的个人技术博客网，已发表 230 篇文章</li>
<li><a target="_blank" rel="noopener" href="http://ios-goodies.com/">ios-goodies</a>–iOS,UI,UX,Objective-c,Swift,Xcode</li>
<li><a target="_blank" rel="noopener" href="http://nshipster.cn/authors/mattt-thompson/">mattt-thompson</a> – 不用解释</li>
<li><a target="_blank" rel="noopener" href="http://subjc.com/">subjc</a> –Subjective-C is a study of innovative iOS interfaces.</li>
<li><a target="_blank" rel="noopener" href="http://www.thinkandbuild.it/">thinkandbuild</a>–《Introduction To 3D Drawing in CoreAnimtion》作者</li>
<li><a target="_blank" rel="noopener" href="http://robb.is/">robb.is</a>–《How to build a nice Hamburger transition in swift》作者</li>
<li><a target="_blank" rel="noopener" href="http://commandshift.co.uk/">commandshift</a>–不多说，质量极高</li>
<li><a target="_blank" rel="noopener" href="http://indieambitions.com/">indieambitions</a>–raywenderlich 常驻作者之一的 blog，非常赞。</li>
<li><a target="_blank" rel="noopener" href="http://nvie.com/">nvie</a>–国外一个大神的 blog，讲得比较杂，git，ios，python 都有涉猎，但是每篇都很精彩。</li>
<li><a target="_blank" rel="noopener" href="http://stuartkhall.com/">stuartkhall</a>–很多关于 app 上线运营之类的 blog，值得一看。</li>
<li><a target="_blank" rel="noopener" href="http://blog.ittybittyapps.com/">ittybittyapps</a>–神器 Reveal 的作者的 blog。</li>
<li><a target="_blank" rel="noopener" href="http://adoptioncurve.net/">adoptioncurve</a>–更新极快，当时 iOS8 还没出几个周，作者就写了篇 sizeclass 解析。非常棒</li>
<li><a target="_blank" rel="noopener" href="http://ciechanowski.me/">ciechanowski</a>–各种数学上几何变化</li>
<li><a target="_blank" rel="noopener" href="https://www.bignerdranch.com/blog/">bignerdranch</a></li>
<li><a target="_blank" rel="noopener" href="http://www.cocoawithlove.com/">cocoawithlove</a>–2008-2011 的老文章，现在没怎么跟新了</li>
<li><a target="_blank" rel="noopener" href="http://blog.codinghorror.com/">codinghorror</a> –<a target="_blank" rel="noopener" href="https://twitter.com/codinghorror">Jeff Atwood </a>主站</li>
<li><a target="_blank" rel="noopener" href="http://www.g8production.com/">g8production</a></li>
<li><a target="_blank" rel="noopener" href="http://lucida.me/about/">lucida</a> – 我比较佩服一名程序员，想学算法找他推荐咯😁</li>
</ul>
<h2 id="团体-blog"><a href="#团体-blog" class="headerlink" title="团体 blog"></a>团体 blog</h2><ul>
<li><a target="_blank" rel="noopener" href="http://blog.ibireme.com/">ibireme</a>–最近很🔥的 YYKit 的作者</li>
<li><a target="_blank" rel="noopener" href="http://tech.glowing.com/cn/">Glow 技术团队</a></li>
<li><a target="_blank" rel="noopener" href="http://tech.meituan.com/">美团点评技术团队</a></li>
</ul>
<h2 id="优质-iOS-学习资源"><a href="#优质-iOS-学习资源" class="headerlink" title="优质 iOS 学习资源"></a>优质 iOS 学习资源</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/">github</a>–这个不用我说吧</li>
<li><a target="_blank" rel="noopener" href="http://stackoverflow.com/">stackoverflow</a>–最专业的问答社区</li>
<li><a target="_blank" rel="noopener" href="http://www.raywenderlich.com/">raywenderlich</a>–iOS 界的百科全书</li>
<li><a target="_blank" rel="noopener" href="http://nshipster.com/">nshipster</a>–里面文章质量非常的高，最喜欢的几个网站之一<a target="_blank" rel="noopener" href="https://github.com/AFNetworking/AFNetworking">AFNetworkting</a>的作者<a target="_blank" rel="noopener" href="http://nshipster.com/authors/mattt-thompson/">Mattt Thompson</a>–经常出没</li>
<li><a target="_blank" rel="noopener" href="http://nshipster.cn/">nshipster 中国</a></li>
<li><a target="_blank" rel="noopener" href="http://www.objc.io/">objc.io</a>–这个也不用多说了，Raywenderlich 是百科全书的话，这个就是深入深入再深入</li>
<li><a target="_blank" rel="noopener" href="http://objcio.cn/">objc 中国</a></li>
<li><a target="_blank" rel="noopener" href="https://realm.io/">realm.io</a>–一个跨平台的移动数据库引擎</li>
<li><a target="_blank" rel="noopener" href="http://tutsplus.com/">tutsplus</a>–也是包罗万象的一个网站，有 web ios ui，不比 Raywenderlich 逊色。</li>
<li><a target="_blank" rel="noopener" href="https://maniacdev.com/">maniacdev</a>–类似 Raywenderlich，文章质量高，而且涵盖面广</li>
<li><a target="_blank" rel="noopener" href="https://www.appcoda.com/">Appcoda</a> – 技术类学习网站，里面的技术更新挺及时的</li>
</ul>
<h2 id="中文网站"><a href="#中文网站" class="headerlink" title="中文网站"></a>中文网站</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.cocoachina.com/">cocoachina</a></li>
<li><a target="_blank" rel="noopener" href="http://www.code4app.com/">code4app</a></li>
<li><a target="_blank" rel="noopener" href="http://www.tairan.com/">泰然网</a> –游戏教程不错的网站</li>
<li><a target="_blank" rel="noopener" href="http://blog.jobbole.com/">伯乐在线</a></li>
</ul>
<h2 id="Swift："><a href="#Swift：" class="headerlink" title="Swift："></a>Swift：</h2><ul>
<li><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/swift/">介紹 | 《The Swift Programming Language》中文版</a></li>
<li><a target="_blank" rel="noopener" href="http://swifter.tips/">Swift 必备 Tips</a> – 猫神的杰作</li>
<li><a target="_blank" rel="noopener" href="http://letsswift.com/swift-site-index/">Let’s Swift </a> – Swift 站点导航</li>
<li><a target="_blank" rel="noopener" href="https://objectivec2swift.com/#/converter/code">Swiftify | Objective-C to Swift Converter </a> – 辅助将旧的* Objective-C 代码转成 Swift。</li>
<li><a target="_blank" rel="noopener" href="https://swift.org/">Swift.org</a> – Apple Swift 官网</li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/swift/blog/">Swift - Blog</a> – Apple Swift 官方博客</li>
<li><a target="_blank" rel="noopener" href="https://github.com/CocoaChina-editors/Welcome-to-Swift">CocoaChina 小组翻译的 Swift 版本</a></li>
<li><a target="_blank" rel="noopener" href="http://www.tutorialspoint.com/swift/swift_environment.htm">tutorialspoint</a> – 有一些 Swift 教程</li>
</ul>
<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com/">http://blog.wangruofeng007.com</a></p>
<!-- processed 2 -->

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.wangruofeng007.com/2016/01/13/2016-01-13-autoreleasingde-li-jie/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="王若风">
      <meta itemprop="description" content="王若风的技术博客">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="王若风的技术博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/13/2016-01-13-autoreleasingde-li-jie/" class="post-title-link" itemprop="url">__autoreleasing 的理解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-01-13 04:27:10" itemprop="dateCreated datePublished" datetime="2016-01-13T04:27:10+08:00">2016-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-11-03 13:32:35" itemprop="dateModified" datetime="2024-11-03T13:32:35+08:00">2024-11-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B3%BB%E7%BB%9F%E5%8E%9F%E7%90%86/" itemprop="url" rel="index"><span itemprop="name">系统原理</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
  
    <a title="disqus" href="/2016/01/13/2016-01-13-autoreleasingde-li-jie/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/13/2016-01-13-autoreleasingde-li-jie/" itemprop="commentCount"></span>
    </a>
  </span>
  
 <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>293</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="autoreleasing-修饰符"><a href="#autoreleasing-修饰符" class="headerlink" title="__autoreleasing 修饰符"></a>__autoreleasing 修饰符</h3><p>将对象赋值给附有 __autoreleasing 修饰符的变量等同于 ARC 无效时调用对象的 autorelease 方法。我们通过以下源代码来看一下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">    <span class="type">id</span> __autoreleasing obj  = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该源代码主要将 NSObject 类对象注册到 autoreleasepool 中，可作如下变换：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 编译器的模拟代码 */</span></span><br><span class="line"><span class="type">id</span> pool = objc_autoreleasePoolPush();</span><br><span class="line"><span class="type">id</span> obj = objc_msgSend(<span class="built_in">NSObject</span>, <span class="keyword">@selector</span>(alloc));</span><br><span class="line">objc_msgSend(obj, <span class="keyword">@selector</span>(init));</span><br><span class="line">objc_autorelease(obj);</span><br><span class="line">objc_autoreleasePoolPop(pool);</span><br></pre></td></tr></table></figure>

<p>这与苹果的 autorelease 实现中的说明（参考 1.2.7 节）完全相同。虽然 ARC 有效和无效时，其在源代码上的表现有所不同，但 autorelease 的功能完全一样。</p>
<p>在 alloc&#x2F;new&#x2F;copy&#x2F;mutableCopy 方法群之外的方法中使用注册到 autoreleasepool 中的对象会如何呢？下面我们来看看 NSMutableArray 类的 array 类方法。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">    <span class="type">id</span> __autoreleasing obj = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这与前面的源代码有何不同呢？</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 编译器的模拟代码 */</span></span><br><span class="line"><span class="type">id</span> pool = objc_autoreleasePoolPush();</span><br><span class="line"><span class="type">id</span> obj = objc_msgSend(<span class="built_in">NSMutableArray</span>, <span class="keyword">@selector</span>(array));</span><br><span class="line">objc_retainAutoreleasedReturnValue(obj);</span><br><span class="line">objc_autorelease(obj);</span><br><span class="line">objc_autoreleasePoolPop(pool);</span><br></pre></td></tr></table></figure>
<p>虽然持有对象的方法从 alloc 方法变为 objc_retainAutoreleasedReturnValue 函数， 但注册 autoreleasepool 的方法没有改变，仍是 objc_autorelease 函数。</p>
<p>备注：欢迎转载，但请一定注明出处！ <a href="http://blog.wangruofeng007.com/">http://blog.wangruofeng007.com</a></p>
<!-- processed 2 -->

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



                        </div>
                        

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

                    </div>
                        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">王若风</p>
  <div class="site-description" itemprop="description">王若风的技术博客</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">74</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">56</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/wangruofeng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wangruofeng" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wangruofeng007@gmail.com" title="E-Mail → mailto:wangruofeng007@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/oneruofeng" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;oneruofeng" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://instagram.com/ace_freeman007" title="Instagram → https:&#x2F;&#x2F;instagram.com&#x2F;ace_freeman007" rel="noopener" target="_blank"><i class="fab fa-instagram fa-fw"></i>Instagram</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


                </div>
            </main>

            <footer class="footer">
                <div class="footer-inner">
                    

                    

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">王若风</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">112k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">6:48</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

                    








                </div>
            </footer>
        </div>

        
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




        
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>














        
            <script
                type="text/javascript"
                src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
        
            

            

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://wangruofeng007.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

    </body>
</html>